import { NextRequest, NextResponse } from "next/server";
import { checkoutFormSchema } from "@/lib/validations/checkout";

/**
 * Sanitize Ùˆ Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙˆØ±ÙˆØ¯ÛŒâ€ŒÙ‡Ø§
 */
function sanitizeString(value: any): string {
  if (typeof value !== "string") return "";
  return value.trim();
}

function sanitizeNumber(value: any): number {
  const num = typeof value === "number" ? value : parseFloat(value);
  return isNaN(num) ? 0 : num;
}

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const {
      items,
      formData,
      total,
      shippingCost,
      shippingMethod,
    } = body;

    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
    if (!items || !Array.isArray(items) || items.length === 0) {
      return NextResponse.json(
        { error: "Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª" },
        { status: 400 }
      );
    }

    // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­ØµÙˆÙ„Ø§Øª
    if (items.length > 50) {
      return NextResponse.json(
        { error: "Ø­Ø¯Ø§Ú©Ø«Ø± 50 Ù…Ø­ØµÙˆÙ„ Ø¯Ø± Ù‡Ø± Ø³ÙØ§Ø±Ø´ Ù…Ø¬Ø§Ø² Ø§Ø³Øª" },
        { status: 400 }
      );
    }

    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù‡Ø± Ø¢ÛŒØªÙ…
    for (const item of items) {
      if (!item.id || !item.name || !item.price || !item.quantity) {
        return NextResponse.json(
          { error: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø­ØµÙˆÙ„ Ù†Ø§Ù‚Øµ Ø§Ø³Øª" },
          { status: 400 }
        );
      }

      const quantity = sanitizeNumber(item.quantity);
      const price = sanitizeNumber(item.price);

      if (quantity <= 0 || quantity > 1000) {
        return NextResponse.json(
          { error: `ØªØ¹Ø¯Ø§Ø¯ Ù…Ø­ØµÙˆÙ„ "${item.name}" Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª (1-1000)` },
          { status: 400 }
        );
      }

      if (price < 0 || price > 100000000) {
        return NextResponse.json(
          { error: `Ù‚ÛŒÙ…Øª Ù…Ø­ØµÙˆÙ„ "${item.name}" Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª` },
          { status: 400 }
        );
      }

      if (!item.image || typeof item.image !== "string") {
        return NextResponse.json(
          { error: `ØªØµÙˆÛŒØ± Ù…Ø­ØµÙˆÙ„ "${item.name}" Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª` },
          { status: 400 }
        );
      }
    }

    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ ÙØ±Ù… Ø¨Ø§ zod
    try {
      await checkoutFormSchema.parseAsync(formData);
    } catch (validationError: any) {
      return NextResponse.json(
        { 
          error: "Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ù… Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª",
          details: validationError.errors || validationError.message
        },
        { status: 400 }
      );
    }

    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ù…Ø¨Ù„Øº
    const sanitizedTotal = sanitizeNumber(total);
    const sanitizedShippingCost = sanitizeNumber(shippingCost || 0);

    if (sanitizedTotal <= 0 || !isFinite(sanitizedTotal)) {
      return NextResponse.json(
        { error: "Ù…Ø¨Ù„Øº Ø³ÙØ§Ø±Ø´ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª" },
        { status: 400 }
      );
    }

    if (sanitizedShippingCost < 0 || !isFinite(sanitizedShippingCost)) {
      return NextResponse.json(
        { error: "Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª" },
        { status: 400 }
      );
    }

    // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù…Ø¨Ù„Øº Ú©Ù„
    const maxOrderAmount = 100000000; // 100 Ù…ÛŒÙ„ÛŒÙˆÙ† ØªÙˆÙ…Ø§Ù†
    if (sanitizedTotal > maxOrderAmount) {
      return NextResponse.json(
        { error: `Ù…Ø¨Ù„Øº Ø³ÙØ§Ø±Ø´ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¨ÛŒØ´ØªØ± Ø§Ø² ${maxOrderAmount.toLocaleString("fa-IR")} ØªÙˆÙ…Ø§Ù† Ø¨Ø§Ø´Ø¯` },
        { status: 400 }
      );
    }

    // Ø§Ø¹ØªØ¨Ø§Ø±Ø³Ù†Ø¬ÛŒ Ø±ÙˆØ´ Ø§Ø±Ø³Ø§Ù„
    if (shippingMethod && shippingMethod !== "air" && shippingMethod !== "sea") {
      return NextResponse.json(
        { error: "Ø±ÙˆØ´ Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª" },
        { status: 400 }
      );
    }

    // ØªÙˆÙ„ÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´
    const generateOrderNumber = () => {
      const timestamp = Date.now();
      const random = Math.floor(Math.random() * 1000).toString().padStart(3, "0");
      return `ORD-${timestamp}-${random}`;
    };

    // Sanitize Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù…
    const sanitizedFormData = {
      firstName: sanitizeString(formData.firstName),
      lastName: sanitizeString(formData.lastName),
      phone: sanitizeString(formData.phone).replace(/\D/g, ""),
      email: sanitizeString(formData.email).toLowerCase(),
      address: sanitizeString(formData.address),
      city: sanitizeString(formData.city),
      postalCode: formData.postalCode ? sanitizeString(formData.postalCode).replace(/\D/g, "") : undefined,
      province: formData.province ? sanitizeString(formData.province) : "",
      notes: formData.notes ? sanitizeString(formData.notes) : undefined,
    };

    // Ø³Ø§Ø®Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÙØ§Ø±Ø´ Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ sanitize Ø´Ø¯Ù‡
    const orderData = {
      items: items.map((item: any) => ({
        id: sanitizeString(item.id),
        productId: sanitizeString(item.id),
        name: sanitizeString(item.name),
        price: sanitizeNumber(item.price),
        quantity: Math.floor(sanitizeNumber(item.quantity)),
        image: sanitizeString(item.image),
      })),
      total: Math.round(sanitizedTotal - sanitizedShippingCost),
      shippingCost: Math.round(sanitizedShippingCost),
      shippingMethod: (shippingMethod || "air") as "air" | "sea",
      status: "pending" as const,
      paymentStatus: "paid" as const, // Ú†ÙˆÙ† ÙØ¹Ù„Ø§Ù‹ Ø¯Ø±Ú¯Ø§Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ØªØµÙ„ Ù†ÛŒØ³ØªØŒ Ø³ÙØ§Ø±Ø´ Ø¨Ù‡ ØµÙˆØ±Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡ Ø«Ø¨Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯
      customerName: `${sanitizedFormData.firstName} ${sanitizedFormData.lastName}`.trim(),
      customerPhone: sanitizedFormData.phone,
      customerEmail: sanitizedFormData.email || undefined,
      shippingAddress: {
        province: sanitizedFormData.province,
        city: sanitizedFormData.city,
        address: sanitizedFormData.address,
        postalCode: sanitizedFormData.postalCode || undefined,
      },
      notes: sanitizedFormData.notes || undefined,
      userId: "guest", // Ø¯Ø± Ø¢ÛŒÙ†Ø¯Ù‡ Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ø§Ø² session Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ø±Ø¯
      orderNumber: generateOrderNumber(),
    };

    // Save order to database using backend service
