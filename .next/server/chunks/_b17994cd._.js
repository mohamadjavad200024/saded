module.exports=[46469,e=>{"use strict";var t=e.i(92208);function r(e){if(!e||"string"!=typeof e)return!1;try{let t=e.replace(/\s+/g,"").replace(/[^\d+]/g,"");if(!t||0===t.length)return!1;let r=t.replace(/^(\+98|0098)/,"");return r.startsWith("0")&&(r=r.substring(1)),/^9\d{9}$/.test(r)}catch{return!1}}function n(e){let t=[];return e.length<6?(t.push("رمز عبور باید حداقل 6 کاراکتر باشد"),{valid:!1,errors:t}):e.length>128?(t.push("رمز عبور نمی‌تواند بیشتر از 128 کاراکتر باشد"),{valid:!1,errors:t}):{valid:!0,errors:[]}}let o=t.object({name:t.string().min(2,"نام باید حداقل 2 کاراکتر باشد").max(100,"نام نمی‌تواند بیشتر از 100 کاراکتر باشد").regex(/^[\u0600-\u06FFa-zA-Z\s]+$/,"نام باید فقط شامل حروف فارسی یا انگلیسی باشد"),phone:t.string().min(1,"شماره تماس الزامی است").refine(e=>{try{return r(e)}catch{return!1}},{message:"شماره تماس معتبر نیست. فرمت صحیح: 09123456789"}),password:t.string().min(6,"رمز عبور باید حداقل 6 کاراکتر باشد").max(128,"رمز عبور نمی‌تواند بیشتر از 128 کاراکتر باشد")}),a=t.object({phone:t.string().min(1,"شماره تماس الزامی است").refine(e=>{try{return r(e)}catch{return!1}},{message:"شماره تماس معتبر نیست. فرمت صحیح: 09123456789"}),password:t.string().min(1,"رمز عبور الزامی است").max(128,"رمز عبور نمی‌تواند بیشتر از 128 کاراکتر باشد")});function i(e){if(!e||"string"!=typeof e)throw Error("شماره تماس معتبر نیست");let t=e.trim().replace(/\s+/g,"").replace(/[^\d+]/g,"");if(!t||0===t.length)throw Error("شماره تماس معتبر نیست");if((t=t.replace(/^(\+98|0098)/,"")).startsWith("0")||(t="0"+t),11!==t.length)throw Error(`شماره تماس باید دقیقاً 11 رقم باشد (${t.length} رقم وارد شده: ${t})`);if(!t.startsWith("09"))throw Error(`شماره تماس باید با 09 شروع شود (شروع شده با: ${t.substring(0,2)})`);if(!/^\d+$/.test(t))throw Error("شماره تماس باید فقط شامل اعداد باشد");return t}e.s(["loginSchema",0,a,"normalizePhone",()=>i,"registerSchema",0,o,"validateIranianPhone",()=>r,"validateStrongPassword",()=>n])},74378,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),o=e.i(59756),a=e.i(61916),i=e.i(14444),s=e.i(10680),l=e.i(69741),u=e.i(16795),d=e.i(87718),c=e.i(95169),p=e.i(47587),h=e.i(66012),g=e.i(70101),E=e.i(26937),R=e.i(10372),m=e.i(93695);e.i(52474);var f=e.i(220),A=e.i(89171),w=e.i(12e3),v=e.i(17939),N=e.i(39142),C=e.i(40911),S=e.i(49632),T=e.i(46469),_=e.i(25686);async function O(e){try{let t;await (0,_.ensureAuthTables)();let{phone:r,password:n}=await e.json().catch(()=>{throw new N.AppError("Invalid JSON in request body",400,"INVALID_JSON")});try{T.loginSchema.parse({phone:r,password:n})}catch(r){let e=r.errors||[],t=e[0];throw new N.AppError(t?.message||"اطلاعات وارد شده معتبر نیست",400,"VALIDATION_ERROR",e)}try{t=(0,T.normalizePhone)(r.trim()),C.logger.info("Login - Phone normalized:",{original:r,normalized:t,originalLength:r.length,normalizedLength:t.length})}catch(e){throw C.logger.error("Login - Phone normalization error:",{phone:r,error:e.message}),new N.AppError(e.message||"شماره تماس معتبر نیست. فرمت صحیح: 09123456789",400,"INVALID_PHONE")}let o=await (0,w.getRow)("SELECT id, name, phone, password, role, enabled, createdAt FROM users WHERE BINARY phone = ? AND phone IS NOT NULL AND phone != '' AND LENGTH(phone) = 11",[t]);if(C.logger.info("Login - User lookup result:",{normalizedPhone:t,found:!!o,userId:o?.id,userPhone:o?.phone,userPhoneLength:o?.phone?.length}),!o)throw new N.AppError("شماره تماس یا رمز عبور اشتباه است",401,"INVALID_CREDENTIALS");if("admin"===o.role)throw new N.AppError("ادمین باید از صفحه ورود ادمین استفاده کند",403,"ADMIN_MUST_USE_ADMIN_LOGIN");if(!o.enabled)throw new N.AppError("حساب کاربری شما غیرفعال است",403,"USER_DISABLED");if(!await S.default.compare(n,o.password))throw new N.AppError("شماره تماس یا رمز عبور اشتباه است",401,"INVALID_CREDENTIALS");C.logger.info("User logged in successfully:",{id:o.id,phone:o.phone});let a=await (0,_.createSession)(o.id,e);C.logger.info("Session created:",{userId:o.id,hasToken:!!a,tokenLength:a?.length});let i=A.NextResponse.json({success:!0,data:{user:{id:o.id,name:o.name,phone:o.phone,role:o.role,createdAt:o.createdAt},message:"ورود موفق"}});(0,_.setSessionCookie)(i,a,e);let s=i.cookies.get("saded_session")?.value,l=i.headers.get("set-cookie");return C.logger.info("Session cookie verification:",{hasCookie:!!s,cookieLength:s?.length,matchesToken:s===a,hasSetCookieHeader:!!l,setCookieHeaderPreview:l?l.substring(0,150):null,requestUrl:e.url,requestHost:e.nextUrl.hostname}),i}catch(t){if(C.logger.error("POST /api/auth/login error:",t),t instanceof N.AppError)return(0,v.createErrorResponse)(t);if(t?.message?.includes("not available")||t?.code==="DATABASE_NOT_AVAILABLE"||t?.code==="ECONNREFUSED"||t?.code==="ETIMEDOUT"||t?.code==="ECONNRESET"||t?.code==="PROTOCOL_CONNECTION_LOST"||t?.message?.includes("connect")||t?.message?.includes("timeout"))return C.logger.error("Database connection error during login:",t),(0,v.createErrorResponse)(new N.AppError("دیتابیس در دسترس نیست. لطفاً اطمینان حاصل کنید که MySQL (XAMPP) نصب و در حال اجرا است.",503,"DATABASE_NOT_AVAILABLE"));let e=t?.message||"خطا در ورود";return(0,v.createErrorResponse)(new N.AppError(e,500,"LOGIN_ERROR"))}}e.s(["POST",()=>O],72735);var I=e.i(72735);let P=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/auth/login/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:x,workUnitAsyncStorage:y,serverHooks:b}=P;function L(){return(0,n.patchFetch)({workAsyncStorage:x,workUnitAsyncStorage:y})}async function D(e,t,n){P.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let A="/api/auth/login/route";A=A.replace(/\/index$/,"")||"/";let w=await P.prepare(e,t,{srcPage:A,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:v,params:N,nextConfig:C,parsedUrl:S,isDraftMode:T,prerenderManifest:_,routerServerContext:O,isOnDemandRevalidate:I,revalidateOnlyGenerated:x,resolvedPathname:y,clientReferenceManifest:b,serverActionsManifest:L}=w,D=(0,l.normalizeAppPath)(A),k=!!(_.dynamicRoutes[D]||_.routes[y]),U=async()=>((null==O?void 0:O.render404)?await O.render404(e,t,S,!1):t.end("This page could not be found"),null);if(k&&!T){let e=!!_.routes[y],t=_.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await U();throw new m.NoFallbackError}}let H=null;!k||P.isDev||T||(H="/index"===(H=y)?"/":H);let M=!0===P.isDev||!k,q=k&&!M;L&&b&&(0,i.setReferenceManifestsSingleton)({page:A,clientReferenceManifest:b,serverActionsManifest:L,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:L})});let $=e.method||"GET",j=(0,a.getTracer)(),F=j.getActiveScopeSpan(),B={params:N,prerenderManifest:_,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>P.onRequestError(e,t,n,O)},sharedContext:{buildId:v}},V=new u.NodeNextRequest(e),z=new u.NodeNextResponse(t),K=d.NextRequestAdapter.fromNodeNextRequest(V,(0,d.signalFromNodeResponse)(t));try{let i=async e=>P.handle(K,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=j.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${$} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${A}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var a,l;let u=async({previousCacheEntry:r})=>{try{if(!s&&I&&x&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await i(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=B.renderOpts.collectedTags;if(!k)return await (0,h.sendResponse)(V,z,a,B.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[R.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,n=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:A,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:I})},O),t}},d=await P.handleResponse({req:e,nextConfig:C,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:_,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:x,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:s});if(!k)return null;if((null==d||null==(a=d.value)?void 0:a.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",I?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&k||c.delete(R.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,E.getCacheControlHeader)(d.cacheControl)),await (0,h.sendResponse)(V,z,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};F?await l(F):await j.withPropagatedContext(e.headers,()=>j.trace(c.BaseServerSpan.handleRequest,{spanName:`${$} ${A}`,kind:a.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:I})}),k)throw t;return await (0,h.sendResponse)(V,z,new Response(null,{status:500})),null}}e.s(["handler",()=>D,"patchFetch",()=>L,"routeModule",()=>P,"serverHooks",()=>b,"workAsyncStorage",()=>x,"workUnitAsyncStorage",()=>y],74378)},6149,e=>{e.v(t=>Promise.all(["server/chunks/[externals]_util_be9989c7._.js","server/chunks/_19ab7056._.js","server/chunks/[root-of-the-server]__473dce0e._.js"].map(t=>e.l(t))).then(()=>t(85238)))}];

//# sourceMappingURL=_b17994cd._.js.map