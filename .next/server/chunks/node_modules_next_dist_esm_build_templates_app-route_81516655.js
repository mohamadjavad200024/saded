module.exports=[86577,e=>{"use strict";var t=e.i(47909),a=e.i(74017),i=e.i(96250),n=e.i(59756),r=e.i(61916),o=e.i(14444),s=e.i(10680),l=e.i(69741),p=e.i(16795),c=e.i(87718),u=e.i(95169),d=e.i(47587),g=e.i(66012),h=e.i(70101),m=e.i(26937),E=e.i(10372),b=e.i(93695);e.i(52474);var R=e.i(220),f=e.i(12e3),S=e.i(17939),v=e.i(39142),A=e.i(2572),C=e.i(38339),P=e.i(40911),w=e.i(92208);let N=w.object({name:w.string().min(1,"نام محصول الزامی است").max(255,"نام محصول نمی‌تواند بیشتر از 255 کاراکتر باشد"),description:w.string().min(1,"توضیحات محصول الزامی است").max(5e3,"توضیحات محصول نمی‌تواند بیشتر از 5000 کاراکتر باشد"),price:w.number().positive("قیمت محصول باید مثبت باشد").max(1e9,"قیمت محصول نمی‌تواند بیشتر از 1 میلیارد تومان باشد"),originalPrice:w.number().positive().max(1e9).optional().nullable(),brand:w.string().min(1,"برند محصول الزامی است").max(100,"برند محصول نمی‌تواند بیشتر از 100 کاراکتر باشد"),category:w.string().min(1,"دسته‌بندی محصول الزامی است").max(100,"دسته‌بندی محصول نمی‌تواند بیشتر از 100 کاراکتر باشد"),vehicle:w.string().max(255,"شناسه خودرو نمی‌تواند بیشتر از 255 کاراکتر باشد").optional().nullable(),model:w.string().max(255,"مدل نمی‌تواند بیشتر از 255 کاراکتر باشد").optional().nullable(),vin:w.string().max(50,"VIN نمی‌تواند بیشتر از 50 کاراکتر باشد").optional().nullable(),vinEnabled:w.boolean().default(!1),airShippingEnabled:w.boolean().default(!0),seaShippingEnabled:w.boolean().default(!0),airShippingCost:w.number().nonnegative().max(1e7).optional().nullable(),seaShippingCost:w.number().nonnegative().max(1e7).optional().nullable(),stockCount:w.number().int("تعداد موجودی باید عدد صحیح باشد").nonnegative("تعداد موجودی نمی‌تواند منفی باشد").default(0),inStock:w.boolean().default(!0),enabled:w.boolean().default(!0),images:w.array(w.string().url("آدرس تصویر نامعتبر است")).min(1,"حداقل یک تصویر الزامی است").max(20,"نمی‌توانید بیشتر از 20 تصویر اضافه کنید"),tags:w.array(w.string()).max(50).default([]),specifications:w.record(w.any()).default({})});N.partial(),w.object({search:w.string().max(200).optional(),minPrice:w.number().nonnegative().optional(),maxPrice:w.number().nonnegative().optional(),brands:w.array(w.string()).optional(),categories:w.array(w.string()).optional(),inStock:w.boolean().optional(),page:w.number().int().positive().default(1),limit:w.number().int().positive().max(1e3).default(50)});var y=e.i(8776);function O(e){if(!e||"string"!=typeof e||""===e.trim())return!1;let t=e.trim();if(t.startsWith("data:image")||t.startsWith("data:"))return!!(t.includes(";base64,")&&t.length>50||t.startsWith("data:image")&&t.length>50)||function(e){if(!e||"string"!=typeof e||!e.startsWith("data:image/")||!e.includes(";base64,"))return!1;let t=e.split(";base64,")[1];return!!t&&""!==t.trim()&&!!/^[A-Za-z0-9+/]*={0,2}$/.test(t)&&!(e.length>0xf00000)&&0!==t.trim().length}(t);if(t.startsWith("blob:")||t.startsWith("/"))return!0;try{let e=new URL(t);return"http:"===e.protocol||"https:"===e.protocol}catch{return!1}}function T(e,t){if(!e||"string"!=typeof e||""===e.trim())return"";let a=e.trim();if(a.startsWith("http://")||a.startsWith("https://")||a.startsWith("data:image")||a.startsWith("data:")||a.startsWith("blob:"))return a;if(a.length>100&&/^[A-Za-z0-9+/=]+$/.test(a))return"";if(a.startsWith("/"))return t?`${t}${a}`:a;try{return new URL(a).toString()}catch{return""}}async function x(t){let a=await (0,C.rateLimit)(100,6e4)(t);if(a)return a;try{let a,{searchParams:i}=new URL(t.url),n=Math.max(1,parseInt(i.get("page")||"1",10)),r=Math.min(1e3,Math.max(1,parseInt(i.get("limit")||"50",10))),o=(n-1)*r,s="true"===i.get("all"),l=0,p=[];try{let{testConnection:t}=await e.A(41613);if(!await t())return P.logger.warn("⚠️ Database connection test failed - returning empty products"),(0,S.createSuccessResponse)([],200,{page:n,limit:r,total:0,totalPages:0})}catch(e){return P.logger.warn("⚠️ Database connection test error - returning empty products:",e),(0,S.createSuccessResponse)([],200,{page:n,limit:r,total:0,totalPages:0})}try{let e=A.cacheKeys.products(n,r,s?"all":"enabled"),t=A.cache.get(e);if(t)return(0,S.createSuccessResponse)(t.products,200,{page:n,limit:r,total:t.total,totalPages:Math.ceil(t.total/r)});a=await (0,f.getRows)(s?"SELECT COUNT(*) as count FROM products":"SELECT COUNT(*) as count FROM products WHERE enabled = TRUE"),l=a[0]?.count||0,p=await (0,f.getRows)(s?"SELECT * FROM products ORDER BY `createdAt` DESC LIMIT ? OFFSET ?":"SELECT * FROM products WHERE enabled = TRUE ORDER BY `createdAt` DESC LIMIT ? OFFSET ?",[r,o]),A.cache.set(e,{products:p,total:l},3e5)}catch(e){if(P.logger.error("Database error in GET /api/products:",{message:e?.message,code:e?.code,stack:e?.stack}),e?.code==="ECONNREFUSED"||e?.code==="ETIMEDOUT"||e?.code==="ENOTFOUND"||e?.message?.includes("connection")||e?.message?.includes("timeout"))throw new v.AppError("خطا در اتصال به دیتابیس. لطفاً مطمئن شوید که دیتابیس در حال اجرا است.",503,"DATABASE_CONNECTION_ERROR",void 0);throw new v.AppError(`خطا در دریافت محصولات: ${e?.message||"خطای نامشخص"}`,500,"DATABASE_ERROR",void 0)}let c=p.map(e=>{let t=(0,y.normalizeImages)(e.images).map(e=>{if(!e||"string"!=typeof e)return null;let t=e.trim();if(""===t)return null;if(t.startsWith("data:image")||t.startsWith("data:"))return t.includes(";base64,")&&t.length>50||t.startsWith("data:image")&&t.length>50?t:null;let a=T(t);return a&&O(a)?a:null}).filter(e=>null!==e);return{...e,images:t,tags:(0,y.normalizeTags)(e.tags),specifications:(0,y.normalizeSpecifications)(e.specifications),price:Number(e.price),originalPrice:e.originalPrice?Number(e.originalPrice):void 0,stockCount:Number(e.stockCount),inStock:!!e.inStock,enabled:!!e.enabled,vinEnabled:!!e.vinEnabled,airShippingEnabled:!!e.airShippingEnabled,seaShippingEnabled:!!e.seaShippingEnabled,airShippingCost:null!==e.airShippingCost&&void 0!==e.airShippingCost?Number(e.airShippingCost):null,seaShippingCost:null!==e.seaShippingCost&&void 0!==e.seaShippingCost?Number(e.seaShippingCost):null,createdAt:e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt),updatedAt:e.updatedAt instanceof Date?e.updatedAt:new Date(e.updatedAt)}}),u=Math.ceil(l/r);return(0,S.createSuccessResponse)(c,200,{page:n,limit:r,total:l,totalPages:u})}catch(e){return(0,S.createErrorResponse)(e)}}async function D(e){try{let t=await e.json().catch(()=>{throw new v.AppError("Invalid JSON in request body",400,"INVALID_JSON")});if(t.name&&void 0!==t.price&&!t.filters){let e;try{e=N.parse(t)}catch(a){let e=a.errors||[],t=e[0];throw new v.AppError(t?.message||"اطلاعات محصول نامعتبر است",400,"VALIDATION_ERROR",e)}let{name:a,description:i,price:n,originalPrice:r,brand:o,category:s,vehicle:l,model:p,vin:c,vinEnabled:u,airShippingEnabled:d,seaShippingEnabled:g,airShippingCost:h,seaShippingCost:m,stockCount:E,inStock:b,enabled:R,images:A,tags:C,specifications:w}=e,x=`product-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,D=new Date().toISOString(),I={id:x,name:a.trim(),description:i.trim(),price:Math.round(n),originalPrice:r?Math.round(r):null,brand:o.trim(),category:s.trim(),vehicle:l?l.trim():null,model:p?p.trim():null,vin:c&&u?c.trim():null,vinEnabled:!!u,airShippingEnabled:"boolean"==typeof d?d:!0===d||"true"===d||1===d,seaShippingEnabled:"boolean"==typeof g?g:!0===g||"true"===g||1===g,airShippingCost:null!=h?Math.max(0,Math.round(h)):null,seaShippingCost:null!=m?Math.max(0,Math.round(m)):null,stockCount:Math.max(0,Math.round(E||0)),inStock:!1!==b,enabled:!1!==R,images:Array.isArray(A)?A.map(e=>{if(!e||"string"!=typeof e)return null;let t=e.trim();if(""===t)return null;if(t.startsWith("data:image")||t.startsWith("data:"))return t.includes(";base64,")&&t.length>50||t.startsWith("data:image")&&t.length>50?t:null;let a=T(t);return a&&O(a)?a:null}).filter(e=>null!==e):[],tags:C&&Array.isArray(C)?C:[],specifications:w&&"object"==typeof w?w:{},createdAt:D,updatedAt:D};try{let e=await (0,f.runQuery)(`INSERT INTO products (id, name, description, price, \`originalPrice\`, brand, category, vehicle, model, vin, \`vinEnabled\`, \`airShippingEnabled\`, \`seaShippingEnabled\`, \`airShippingCost\`, \`seaShippingCost\`, \`stockCount\`, \`inStock\`, enabled, images, tags, specifications, \`createdAt\`, \`updatedAt\`)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,[I.id,I.name,I.description,I.price,I.originalPrice,I.brand,I.category,I.vehicle,I.model,I.vin,I.vinEnabled,I.airShippingEnabled,I.seaShippingEnabled,I.airShippingCost,I.seaShippingCost,I.stockCount,I.inStock,I.enabled,JSON.stringify(I.images),JSON.stringify(I.tags),JSON.stringify(I.specifications),I.createdAt,I.updatedAt]);P.logger.debug("Product inserted successfully:",{id:x,changes:e.changes})}catch(e){throw P.logger.error("Error inserting product:",e),new v.AppError(`خطا در ذخیره محصول: ${e?.message||"خطای نامشخص"}`,500,"INSERT_ERROR",void 0)}let U=await (0,f.getRow)("SELECT * FROM products WHERE id = ?",[x]);if(!U)throw P.logger.error("Product not found after insert:",x),new v.AppError("محصول ایجاد شد اما پیدا نشد",500,"PRODUCT_NOT_FOUND");let M=(0,y.normalizeImages)(U.images).map(e=>{if(!e||"string"!=typeof e)return null;let t=e.trim();if(""===t)return null;if(t.startsWith("data:image")&&t.includes(";base64,")&&t.length>50)return t;let a=T(t);return a&&O(a)?a:null}).filter(e=>null!==e),k={...U,images:M,tags:(0,y.normalizeTags)(U.tags),specifications:(0,y.normalizeSpecifications)(U.specifications),price:Number(U.price),originalPrice:U.originalPrice?Number(U.originalPrice):void 0,stockCount:Number(U.stockCount),inStock:!!U.inStock,enabled:!!U.enabled,vinEnabled:!!U.vinEnabled,airShippingEnabled:!!U.airShippingEnabled,seaShippingEnabled:!!U.seaShippingEnabled,airShippingCost:null!==U.airShippingCost&&void 0!==U.airShippingCost?Number(U.airShippingCost):null,seaShippingCost:null!==U.seaShippingCost&&void 0!==U.seaShippingCost?Number(U.seaShippingCost):null,createdAt:U.createdAt instanceof Date?U.createdAt:new Date(U.createdAt),updatedAt:U.updatedAt instanceof Date?U.updatedAt:new Date(U.updatedAt)};return(0,S.createSuccessResponse)(k,201)}let a=t.filters||t||{},i=Math.max(1,parseInt(t.page||"1",10)),n=Math.min(100,Math.max(1,parseInt(t.limit||"50",10))),r=(i-1)*n,o="WHERE enabled = TRUE",s=[];if(a.vin)o+=" AND vinEnabled = TRUE AND UPPER(vin) = UPPER(?)",s.push(a.vin.trim());else if(a.search){let e=`%${a.search.trim()}%`;o+=" AND (UPPER(name) LIKE UPPER(?) OR UPPER(description) LIKE UPPER(?) OR UPPER(brand) LIKE UPPER(?) OR UPPER(category) LIKE UPPER(?) OR UPPER(vin) LIKE UPPER(?) OR UPPER(CAST(tags AS CHAR)) LIKE UPPER(?) OR UPPER(CAST(specifications AS CHAR)) LIKE UPPER(?))",s.push(e,e,e,e,e,e,e)}void 0!==a.minPrice&&(o+=" AND price >= ?",s.push(a.minPrice)),void 0!==a.maxPrice&&(o+=" AND price <= ?",s.push(a.maxPrice)),a.brands&&a.brands.length>0&&(o+=` AND brand IN (${a.brands.map(()=>"?").join(",")})`,s.push(...a.brands)),a.categories&&a.categories.length>0&&(o+=` AND category IN (${a.categories.map(()=>"?").join(",")})`,s.push(...a.categories)),a.vehicle&&(o+=" AND vehicle = ?",s.push(a.vehicle)),void 0!==a.inStock&&(o+=" AND inStock = ?",s.push(!!a.inStock));let l=`SELECT COUNT(*) as count FROM products ${o}`,p=await (0,f.getRows)(l,s),c=p[0]?.count||0,u=`SELECT * FROM products ${o} ORDER BY \`createdAt\` DESC LIMIT ? OFFSET ?`,d=(await (0,f.getRows)(u,[...s,n,r])).map(e=>{let t=(0,y.normalizeImages)(e.images).map(e=>{if(!e||"string"!=typeof e)return null;let t=e.trim();if(""===t)return null;if(t.startsWith("data:image")||t.startsWith("data:"))return t.includes(";base64,")&&t.length>50||t.startsWith("data:image")&&t.length>50?t:null;let a=T(t);return a&&O(a)?a:null}).filter(e=>null!==e);return{...e,images:t,tags:(0,y.normalizeTags)(e.tags),specifications:(0,y.normalizeSpecifications)(e.specifications),price:Number(e.price),originalPrice:e.originalPrice?Number(e.originalPrice):void 0,stockCount:Number(e.stockCount),inStock:!!e.inStock,enabled:!!e.enabled,vinEnabled:!!e.vinEnabled,airShippingEnabled:!!e.airShippingEnabled,seaShippingEnabled:!!e.seaShippingEnabled,airShippingCost:null!==e.airShippingCost&&void 0!==e.airShippingCost?Number(e.airShippingCost):null,seaShippingCost:null!==e.seaShippingCost&&void 0!==e.seaShippingCost?Number(e.seaShippingCost):null,createdAt:e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt),updatedAt:e.updatedAt instanceof Date?e.updatedAt:new Date(e.updatedAt)}}),g=Math.ceil(c/n);return(0,S.createSuccessResponse)(d,200,{page:i,limit:n,total:c,totalPages:g})}catch(e){return(0,S.createErrorResponse)(e)}}e.s(["GET",()=>x,"POST",()=>D],55773);var I=e.i(55773);let U=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/products/route",pathname:"/api/products",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/products/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:M,workUnitAsyncStorage:k,serverHooks:L}=U;function W(){return(0,i.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:k})}async function _(e,t,i){U.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/products/route";f=f.replace(/\/index$/,"")||"/";let S=await U.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!S)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:v,params:A,nextConfig:C,parsedUrl:P,isDraftMode:w,prerenderManifest:N,routerServerContext:y,isOnDemandRevalidate:O,revalidateOnlyGenerated:T,resolvedPathname:x,clientReferenceManifest:D,serverActionsManifest:I}=S,M=(0,l.normalizeAppPath)(f),k=!!(N.dynamicRoutes[M]||N.routes[x]),L=async()=>((null==y?void 0:y.render404)?await y.render404(e,t,P,!1):t.end("This page could not be found"),null);if(k&&!w){let e=!!N.routes[x],t=N.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(C.experimental.adapterPath)return await L();throw new b.NoFallbackError}}let W=null;!k||U.isDev||w||(W="/index"===(W=x)?"/":W);let _=!0===U.isDev||!k,F=k&&!_;I&&D&&(0,o.setReferenceManifestsSingleton)({page:f,clientReferenceManifest:D,serverActionsManifest:I,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:I})});let H=e.method||"GET",$=(0,r.getTracer)(),K=$.getActiveScopeSpan(),q={params:A,prerenderManifest:N,renderOpts:{experimental:{authInterrupts:!!C.experimental.authInterrupts},cacheComponents:!!C.cacheComponents,supportsDynamicResponse:_,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:C.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i)=>U.onRequestError(e,t,i,y)},sharedContext:{buildId:v}},j=new p.NodeNextRequest(e),z=new p.NodeNextResponse(t),B=c.NextRequestAdapter.fromNodeNextRequest(j,(0,c.signalFromNodeResponse)(t));try{let o=async e=>U.handle(B,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=$.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${H} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${f}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var r,l;let p=async({previousCacheEntry:a})=>{try{if(!s&&O&&T&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(n);e.fetchMetrics=q.renderOpts.fetchMetrics;let l=q.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let p=q.renderOpts.collectedTags;if(!k)return await (0,g.sendResponse)(j,z,r,q.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(r.headers);p&&(t[E.NEXT_CACHE_TAGS_HEADER]=p),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,i=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:R.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==a?void 0:a.isStale)&&await U.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:O})},y),t}},c=await U.handleResponse({req:e,nextConfig:C,cacheKey:W,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:N,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:T,responseGenerator:p,waitUntil:i.waitUntil,isMinimalMode:s});if(!k)return null;if((null==c||null==(r=c.value)?void 0:r.kind)!==R.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",O?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),w&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&k||u.delete(E.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,g.sendResponse)(j,z,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};K?await l(K):await $.withPropagatedContext(e.headers,()=>$.trace(u.BaseServerSpan.handleRequest,{spanName:`${H} ${f}`,kind:r.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof b.NoFallbackError||await U.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:O})}),k)throw t;return await (0,g.sendResponse)(j,z,new Response(null,{status:500})),null}}e.s(["handler",()=>_,"patchFetch",()=>W,"routeModule",()=>U,"serverHooks",()=>L,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>k],86577)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_81516655.js.map