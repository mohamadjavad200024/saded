module.exports=[41483,e=>{"use strict";var t=e.i(47909),r=e.i(74017),o=e.i(96250),a=e.i(59756),s=e.i(61916),i=e.i(14444),n=e.i(10680),d=e.i(69741),l=e.i(16795),p=e.i(87718),u=e.i(95169),c=e.i(47587),m=e.i(66012),h=e.i(70101),g=e.i(26937),E=e.i(10372),A=e.i(93695);e.i(52474);var N=e.i(220),R=e.i(92208),f=e.i(15235);let T=R.object({firstName:R.string().min(1,"ูุงู ุงูุฒุงู ุงุณุช"),lastName:R.string().optional(),phone:R.string().min(10,"ุดูุงุฑู ุชููู ุจุงุฏ ุญุฏุงูู 10 ุฑูู ุจุงุดุฏ").regex(/^[0-9]+$/,"ุดูุงุฑู ุชููู ุจุงุฏ ููุท ุนุฏุฏ ุจุงุดุฏ"),email:R.union([R.string().email("ุงูู ูุงูุนุชุจุฑ ุงุณุช"),R.literal("")]).optional(),addressType:R.enum(["location","postalCode","address"],{required_error:"ููุน ุขุฏุฑุณ ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ"}),location:R.string().optional(),address:R.string().optional(),city:R.string().optional(),postalCode:R.string().optional().refine(e=>!e||""===e||/^[0-9]{10}$/.test(e),{message:"ฺฉุฏ ูพุณุช ุจุงุฏ 10 ุฑูู ุจุงุดุฏ"}),province:R.string().optional(),notes:R.string().max(500,"ุงุฏุฏุงุดุช ููโุชูุงูุฏ ุจุดุชุฑ ุงุฒ 500 ฺฉุงุฑุงฺฉุชุฑ ุจุงุดุฏ").optional()}).superRefine((e,t)=>{"location"!==e.addressType||e.location&&0!==e.location.trim().length||t.addIssue({code:f.ZodIssueCode.custom,message:"ูุทูุงู ููฺฉุดู ุฑุง ูุงุฑุฏ ฺฉูุฏ",path:["location"]}),"postalCode"===e.addressType&&(e.postalCode&&0!==e.postalCode.trim().length?/^[0-9]{10}$/.test(e.postalCode)||t.addIssue({code:f.ZodIssueCode.custom,message:"ฺฉุฏ ูพุณุช ุจุงุฏ 10 ุฑูู ุจุงุดุฏ",path:["postalCode"]}):t.addIssue({code:f.ZodIssueCode.custom,message:"ูุทูุงู ฺฉุฏ ูพุณุช ุฑุง ูุงุฑุฏ ฺฉูุฏ",path:["postalCode"]})),"address"===e.addressType&&(!e.address||e.address.trim().length<5)&&t.addIssue({code:f.ZodIssueCode.custom,message:"ุขุฏุฑุณ ุจุงุฏ ุญุฏุงูู 5 ฺฉุงุฑุงฺฉุชุฑ ุจุงุดุฏ",path:["address"]})});var I=e.i(17939),w=e.i(39142),C=e.i(12e3),y=e.i(40911),O=e.i(25686);function S(e){return"string"!=typeof e?"":e.trim()}function v(e){let t="number"==typeof e?e:parseFloat(e);return isNaN(t)?0:t}async function _(e){try{let t,r,o;try{await (0,C.runQuery)(`
        CREATE TABLE IF NOT EXISTS orders (
          id VARCHAR(255) PRIMARY KEY,
          \`orderNumber\` VARCHAR(255) UNIQUE NOT NULL,
          \`userId\` VARCHAR(255),
          \`customerName\` VARCHAR(255) NOT NULL,
          \`customerPhone\` VARCHAR(255) NOT NULL,
          \`customerEmail\` VARCHAR(255),
          items JSON NOT NULL DEFAULT ('[]'),
          total BIGINT NOT NULL,
          \`shippingCost\` BIGINT NOT NULL,
          \`shippingMethod\` VARCHAR(50) NOT NULL,
          \`shippingAddress\` JSON NOT NULL DEFAULT ('{}'),
          status VARCHAR(50) NOT NULL DEFAULT 'pending',
          \`paymentStatus\` VARCHAR(50) NOT NULL DEFAULT 'pending',
          notes TEXT,
          \`createdAt\` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
          \`updatedAt\` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci
      `),y.logger.debug("Orders table ensured")}catch(e){y.logger.warn("Error ensuring orders table (might already exist):",e?.message)}let a=await (0,O.getSessionUserFromRequest)(e);if(console.log("[POST /api/orders/create] Session check:",{hasSessionUser:!!a,userId:a?.id,sessionUserId:a?.id,sessionUserRole:a?.role}),!a||!a.id)throw new w.AppError("ุจุฑุง ุซุจุช ุณูุงุฑุด ุจุงุฏ ูุงุฑุฏ ุญุณุงุจ ฺฉุงุฑุจุฑ ุฎูุฏ ุดูุฏ",401,"UNAUTHORIZED");let s=a.id;y.logger.info(`๐ฆ Creating order with userId: ${s}`);let{items:i,formData:n,total:d,shippingCost:l,shippingMethod:p}=await e.json().catch(()=>{throw new w.AppError("Invalid JSON in request body",400,"INVALID_JSON")});if(!i||!Array.isArray(i)||0===i.length)throw new w.AppError("ุณุจุฏ ุฎุฑุฏ ุฎุงู ุงุณุช",400,"EMPTY_CART");if(y.logger.debug("Received items for order creation:",i.map(e=>({id:e?.id,name:e?.name,price:e?.price,quantity:e?.quantity,hasImage:!!e?.image}))),i.length>50)throw new w.AppError("ุญุฏุงฺฉุซุฑ 50 ูุญุตูู ุฏุฑ ูุฑ ุณูุงุฑุด ูุฌุงุฒ ุงุณุช",400,"CART_LIMIT_EXCEEDED");for(let e of i){if(!e||"object"!=typeof e)throw new w.AppError("ุขุชู ุณูุงุฑุด ูุงูุนุชุจุฑ ุงุณุช",400,"INVALID_ITEM");if(!e.id||"string"!=typeof e.id||""===e.id.trim())throw new w.AppError(`ุดูุงุณู ูุญุตูู ูุงูุนุชุจุฑ ุงุณุช. ุขุชู: ${JSON.stringify(e)}`,400,"INVALID_ITEM_ID");if(!e.name||"string"!=typeof e.name||""===e.name.trim())throw new w.AppError(`ูุงู ูุญุตูู ูุงูุนุชุจุฑ ุงุณุช. ุดูุงุณู: ${e.id}`,400,"INVALID_ITEM_NAME");if(void 0===e.price||null===e.price)throw new w.AppError(`ููุช ูุญุตูู "${e.name||e.id}" ูุดุฎุต ูุดุฏู ุงุณุช`,400,"MISSING_PRICE");let t=v(e.price);if(t<=0||t>1e9)throw new w.AppError(`ููุช ูุญุตูู "${e.name}" ูุงูุนุชุจุฑ ุงุณุช (${t}) - ุญุฏุงฺฉุซุฑ ููุช ูุฌุงุฒ: 1,000,000,000 ุชููุงู`,400,"INVALID_PRICE");if(void 0===e.quantity||null===e.quantity)throw new w.AppError(`ุชุนุฏุงุฏ ูุญุตูู "${e.name||e.id}" ูุดุฎุต ูุดุฏู ุงุณุช`,400,"MISSING_QUANTITY");let r=v(e.quantity);if(r<=0||r>1e3)throw new w.AppError(`ุชุนุฏุงุฏ ูุญุตูู "${e.name}" ูุงูุนุชุจุฑ ุงุณุช (${r}) - ุจุงุฏ ุจู 1 ุชุง 1000 ุจุงุดุฏ`,400,"INVALID_QUANTITY");if(void 0!==e.image&&null!==e.image&&"string"!=typeof e.image)throw new w.AppError(`ุชุตูุฑ ูุญุตูู "${e.name}" ูุงูุนุชุจุฑ ุงุณุช`,400,"INVALID_IMAGE")}try{await T.parseAsync(n)}catch(e){throw new w.AppError("ุงุทูุงุนุงุช ูุฑู ูุงูุนุชุจุฑ ุงุณุช",400,"VALIDATION_ERROR",e.errors||e.message)}let u=v(d),c=v(l||0);if(u<=0||!isFinite(u))throw new w.AppError("ูุจูุบ ุณูุงุฑุด ูุงูุนุชุจุฑ ุงุณุช",400,"INVALID_TOTAL");if(c<0||!isFinite(c))throw new w.AppError("ูุฒูู ุงุฑุณุงู ูุงูุนุชุจุฑ ุงุณุช",400,"INVALID_SHIPPING_COST");if(u>1e10)throw new w.AppError(`ูุจูุบ ุณูุงุฑุด ููโุชูุงูุฏ ุจุดุชุฑ ุงุฒ ${1e10.toLocaleString("fa-IR")} ุชููุงู ุจุงุดุฏ`,400,"ORDER_AMOUNT_EXCEEDED");if(p&&"air"!==p&&"sea"!==p)throw new w.AppError("ุฑูุด ุงุฑุณุงู ูุงูุนุชุจุฑ ุงุณุช",400,"INVALID_SHIPPING_METHOD");if(p)for(let e of i)try{let t=await (0,C.getRow)('SELECT "airShippingEnabled", "seaShippingEnabled" FROM products WHERE id = ?',[e.id]);if(t){if("air"===p&&!t.airShippingEnabled)throw new w.AppError(`ุฑูุด ุงุฑุณุงู ููุง ุจุฑุง ูุญุตูู "${e.name}" ูุนุงู ูุณุช`,400,"SHIPPING_METHOD_NOT_AVAILABLE");if("sea"===p&&!t.seaShippingEnabled)throw new w.AppError(`ุฑูุด ุงุฑุณุงู ุฏุฑุง ุจุฑุง ูุญุตูู "${e.name}" ูุนุงู ูุณุช`,400,"SHIPPING_METHOD_NOT_AVAILABLE")}}catch(t){if(t instanceof w.AppError)throw t;y.logger.warn(`Product ${e.id} not found, skipping shipping method validation`)}let m={firstName:S(n.firstName),lastName:S(n.lastName||""),phone:S(n.phone).replace(/\D/g,""),email:n.email?S(n.email).toLowerCase():void 0,addressType:n.addressType||"address",location:n.location?S(n.location):void 0,address:n.address?S(n.address):void 0,city:n.city?S(n.city):void 0,postalCode:n.postalCode?S(n.postalCode).replace(/\D/g,""):void 0,province:n.province?S(n.province):"",notes:n.notes?S(n.notes):void 0},h={addressType:m.addressType,province:m.province||void 0};"location"===m.addressType?h.location=m.location:"postalCode"===m.addressType?h.postalCode=m.postalCode:(h.address=m.address,h.city=m.city,m.postalCode&&(h.postalCode=m.postalCode));let g={items:i.map(e=>({id:S(e.id),productId:S(e.id),name:S(e.name),price:v(e.price),quantity:Math.floor(v(e.quantity)),image:e.image?S(e.image):""})),total:Math.round(u-c),shippingCost:Math.round(c),shippingMethod:p||"air",status:"pending",paymentStatus:"paid",customerName:`${m.firstName}${m.lastName?` ${m.lastName}`:""}`.trim(),customerPhone:m.phone,customerEmail:m.email||void 0,shippingAddress:h,notes:m.notes||void 0,userId:s,orderNumber:(r=Date.now(),o=Math.floor(1e3*Math.random()).toString().padStart(3,"0"),`ORD-${r}-${o}`)},E=`order-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,A=new Date().toISOString(),N=String(s);y.logger.info(`๐ฆ Attempting to insert order: ${g.orderNumber}`,{id:E,userId:N,customerName:g.customerName,customerPhone:g.customerPhone,total:g.total,itemsCount:g.items.length});try{let e=await (0,C.runQuery)(`INSERT INTO orders (id, \`orderNumber\`, \`userId\`, \`customerName\`, \`customerPhone\`, \`customerEmail\`, items, total, \`shippingCost\`, \`shippingMethod\`, \`shippingAddress\`, status, \`paymentStatus\`, notes, \`createdAt\`, \`updatedAt\`)
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,[E,g.orderNumber,N,g.customerName,g.customerPhone,g.customerEmail||null,JSON.stringify(g.items),g.total,g.shippingCost,g.shippingMethod,JSON.stringify(g.shippingAddress),g.status,g.paymentStatus,g.notes||null,A,A]);y.logger.info(`โ Order inserted successfully: ${g.orderNumber}`,{id:E,affectedRows:e.changes,insertId:e.lastInsertRowid})}catch(e){throw y.logger.error(`โ Error inserting order: ${g.orderNumber}`,{id:E,error:e?.message,code:e?.code,sqlState:e?.sqlState,errno:e?.errno,stack:e?.stack}),new w.AppError(`ุฎุทุง ุฏุฑ ุฐุฎุฑู ุณูุงุฑุด ุฏุฑ ุฏุชุงุจุณ: ${e?.message||"ุฎุทุง ูุงูุดุฎุต"}`,500,"ORDER_INSERT_ERROR",{originalError:e?.code,orderNumber:g.orderNumber})}y.logger.info(`โ Order created successfully: ${g.orderNumber} with userId: ${N}`);try{if(!(t=await (0,C.getRow)("SELECT * FROM orders WHERE id = ?",[E])))throw y.logger.error(`โ Order not found after insert: ${E}`,{orderNumber:g.orderNumber}),new w.AppError("ุณูุงุฑุด ุซุจุช ุดุฏ ุงูุง ุจุงุฒุงุจ ูุดุฏ",500,"ORDER_NOT_FOUND_AFTER_INSERT");y.logger.info(`โ Order fetched successfully: ${g.orderNumber}`,{id:t.id,userId:t.userId})}catch(e){throw y.logger.error(`โ Error fetching order after insert: ${E}`,{error:e?.message,code:e?.code}),new w.AppError(`ุฎุทุง ุฏุฑ ุจุงุฒุงุจ ุณูุงุฑุด: ${e?.message||"ุฎุทุง ูุงูุดุฎุต"}`,500,"ORDER_FETCH_ERROR")}let R={...t,items:Array.isArray(t.items)?t.items:"string"==typeof t.items?JSON.parse(t.items):[],shippingAddress:"object"==typeof t.shippingAddress&&null!==t.shippingAddress?t.shippingAddress:"string"==typeof t.shippingAddress?JSON.parse(t.shippingAddress):{},total:Number(t.total),shippingCost:Number(t.shippingCost),createdAt:t.createdAt instanceof Date?t.createdAt:new Date(t.createdAt),updatedAt:t.updatedAt instanceof Date?t.updatedAt:new Date(t.updatedAt)};return(0,I.createSuccessResponse)({order:R},201)}catch(e){return(0,I.createErrorResponse)(e)}}e.s(["POST",()=>_],72168);var L=e.i(72168);let D=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/orders/create/route",pathname:"/api/orders/create",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/orders/create/route.ts",nextConfigOutput:"",userland:L}),{workAsyncStorage:b,workUnitAsyncStorage:M,serverHooks:U}=D;function P(){return(0,o.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:M})}async function $(e,t,o){D.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/orders/create/route";R=R.replace(/\/index$/,"")||"/";let f=await D.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:T,params:I,nextConfig:w,parsedUrl:C,isDraftMode:y,prerenderManifest:O,routerServerContext:S,isOnDemandRevalidate:v,revalidateOnlyGenerated:_,resolvedPathname:L,clientReferenceManifest:b,serverActionsManifest:M}=f,U=(0,d.normalizeAppPath)(R),P=!!(O.dynamicRoutes[U]||O.routes[L]),$=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,C,!1):t.end("This page could not be found"),null);if(P&&!y){let e=!!O.routes[L],t=O.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await $();throw new A.NoFallbackError}}let H=null;!P||D.isDev||y||(H="/index"===(H=L)?"/":H);let x=!0===D.isDev||!P,q=P&&!x;M&&b&&(0,i.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:b,serverActionsManifest:M,serverModuleMap:(0,n.createServerModuleMap)({serverActionsManifest:M})});let V=e.method||"GET",F=(0,s.getTracer)(),k=F.getActiveScopeSpan(),G={params:I,prerenderManifest:O,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:x,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:o.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,o)=>D.onRequestError(e,t,o,S)},sharedContext:{buildId:T}},j=new l.NodeNextRequest(e),B=new l.NodeNextResponse(t),J=p.NextRequestAdapter.fromNodeNextRequest(j,(0,p.signalFromNodeResponse)(t));try{let i=async e=>D.handle(J,G).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=r.get("next.route");if(o){let t=`${V} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":t}),e.updateName(t)}else e.updateName(`${V} ${R}`)}),n=!!(0,a.getRequestMeta)(e,"minimalMode"),d=async a=>{var s,d;let l=async({previousCacheEntry:r})=>{try{if(!n&&v&&_&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let s=await i(a);e.fetchMetrics=G.renderOpts.fetchMetrics;let d=G.renderOpts.pendingWaitUntil;d&&o.waitUntil&&(o.waitUntil(d),d=void 0);let l=G.renderOpts.collectedTags;if(!P)return await (0,m.sendResponse)(j,B,s,G.renderOpts.pendingWaitUntil),null;{let e=await s.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(s.headers);l&&(t[E.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==G.renderOpts.collectedRevalidate&&!(G.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&G.renderOpts.collectedRevalidate,o=void 0===G.renderOpts.collectedExpire||G.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:G.renderOpts.collectedExpire;return{value:{kind:N.CachedRouteKind.APP_ROUTE,status:s.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:o}}}}catch(t){throw(null==r?void 0:r.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:v})},S),t}},p=await D.handleResponse({req:e,nextConfig:w,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:O,isRoutePPREnabled:!1,isOnDemandRevalidate:v,revalidateOnlyGenerated:_,responseGenerator:l,waitUntil:o.waitUntil,isMinimalMode:n});if(!P)return null;if((null==p||null==(s=p.value)?void 0:s.kind)!==N.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==p||null==(d=p.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});n||t.setHeader("x-nextjs-cache",v?"REVALIDATED":p.isMiss?"MISS":p.isStale?"STALE":"HIT"),y&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(p.value.headers);return n&&P||u.delete(E.NEXT_CACHE_TAGS_HEADER),!p.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(p.cacheControl)),await (0,m.sendResponse)(j,B,new Response(p.value.body,{headers:u,status:p.value.status||200})),null};k?await d(k):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${V} ${R}`,kind:s.SpanKind.SERVER,attributes:{"http.method":V,"http.target":e.url}},d))}catch(t){if(t instanceof A.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:v})}),P)throw t;return await (0,m.sendResponse)(j,B,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>P,"routeModule",()=>D,"serverHooks",()=>U,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>M],41483)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_1544df71.js.map