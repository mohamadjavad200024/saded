module.exports=[41483,e=>{"use strict";var t=e.i(47909),r=e.i(74017),i=e.i(96250),a=e.i(59756),n=e.i(61916),o=e.i(14444),s=e.i(10680),d=e.i(69741),p=e.i(16795),l=e.i(87718),u=e.i(95169),c=e.i(47587),h=e.i(66012),m=e.i(70101),g=e.i(26937),E=e.i(10372),A=e.i(93695);e.i(52474);var f=e.i(220),w=e.i(92208);let R=w.object({firstName:w.string().min(1,"نام الزامی است"),lastName:w.string().min(1,"نام خانوادگی الزامی است"),phone:w.string().min(10,"شماره تلفن باید حداقل 10 رقم باشد").regex(/^[0-9]+$/,"شماره تلفن باید فقط عدد باشد"),email:w.union([w.string().email("ایمیل نامعتبر است"),w.literal("")]).optional(),address:w.string().min(5,"آدرس باید حداقل 5 کاراکتر باشد"),city:w.string().min(1,"شهر الزامی است"),postalCode:w.string().optional().refine(e=>!e||""===e||/^[0-9]{10}$/.test(e),{message:"کد پستی باید 10 رقم باشد"}),province:w.string().optional(),notes:w.string().max(500,"یادداشت نمی‌تواند بیشتر از 500 کاراکتر باشد").optional()});var I=e.i(17939),N=e.i(39142),v=e.i(12e3),y=e.i(40911),C=e.i(68876);function S(e){return"string"!=typeof e?"":e.trim()}function T(e){let t="number"==typeof e?e:parseFloat(e);return isNaN(t)?0:t}async function _(e){try{let t,r,i=null;try{let t=await (0,C.requireAuth)(e);t&&t.userId&&(i=t.userId,y.logger.info(`Order will be linked to userId: ${i}`))}catch(e){y.logger.debug("Guest checkout - no userId")}let a=i||"guest",{items:n,formData:o,total:s,shippingCost:d,shippingMethod:p}=await e.json().catch(()=>{throw new N.AppError("Invalid JSON in request body",400,"INVALID_JSON")});if(!n||!Array.isArray(n)||0===n.length)throw new N.AppError("سبد خرید خالی است",400,"EMPTY_CART");if(y.logger.debug("Received items for order creation:",n.map(e=>({id:e?.id,name:e?.name,price:e?.price,quantity:e?.quantity,hasImage:!!e?.image}))),n.length>50)throw new N.AppError("حداکثر 50 محصول در هر سفارش مجاز است",400,"CART_LIMIT_EXCEEDED");for(let e of n){if(!e||"object"!=typeof e)throw new N.AppError("آیتم سفارش نامعتبر است",400,"INVALID_ITEM");if(!e.id||"string"!=typeof e.id||""===e.id.trim())throw new N.AppError(`شناسه محصول نامعتبر است. آیتم: ${JSON.stringify(e)}`,400,"INVALID_ITEM_ID");if(!e.name||"string"!=typeof e.name||""===e.name.trim())throw new N.AppError(`نام محصول نامعتبر است. شناسه: ${e.id}`,400,"INVALID_ITEM_NAME");if(void 0===e.price||null===e.price)throw new N.AppError(`قیمت محصول "${e.name||e.id}" مشخص نشده است`,400,"MISSING_PRICE");let t=T(e.price);if(t<=0||t>1e8)throw new N.AppError(`قیمت محصول "${e.name}" نامعتبر است (${t})`,400,"INVALID_PRICE");if(void 0===e.quantity||null===e.quantity)throw new N.AppError(`تعداد محصول "${e.name||e.id}" مشخص نشده است`,400,"MISSING_QUANTITY");let r=T(e.quantity);if(r<=0||r>1e3)throw new N.AppError(`تعداد محصول "${e.name}" نامعتبر است (${r}) - باید بین 1 تا 1000 باشد`,400,"INVALID_QUANTITY");if(void 0!==e.image&&null!==e.image&&"string"!=typeof e.image)throw new N.AppError(`تصویر محصول "${e.name}" نامعتبر است`,400,"INVALID_IMAGE")}try{await R.parseAsync(o)}catch(e){throw new N.AppError("اطلاعات فرم نامعتبر است",400,"VALIDATION_ERROR",e.errors||e.message)}let l=T(s),u=T(d||0);if(l<=0||!isFinite(l))throw new N.AppError("مبلغ سفارش نامعتبر است",400,"INVALID_TOTAL");if(u<0||!isFinite(u))throw new N.AppError("هزینه ارسال نامعتبر است",400,"INVALID_SHIPPING_COST");if(l>1e8)throw new N.AppError(`مبلغ سفارش نمی‌تواند بیشتر از ${1e8.toLocaleString("fa-IR")} تومان باشد`,400,"ORDER_AMOUNT_EXCEEDED");if(p&&"air"!==p&&"sea"!==p)throw new N.AppError("روش ارسال نامعتبر است",400,"INVALID_SHIPPING_METHOD");if(p)for(let e of n)try{let t=await (0,v.getRow)('SELECT "airShippingEnabled", "seaShippingEnabled" FROM products WHERE id = ?',[e.id]);if(t){if("air"===p&&!t.airShippingEnabled)throw new N.AppError(`روش ارسال هوایی برای محصول "${e.name}" فعال نیست`,400,"SHIPPING_METHOD_NOT_AVAILABLE");if("sea"===p&&!t.seaShippingEnabled)throw new N.AppError(`روش ارسال دریایی برای محصول "${e.name}" فعال نیست`,400,"SHIPPING_METHOD_NOT_AVAILABLE")}}catch(t){if(t instanceof N.AppError)throw t;y.logger.warn(`Product ${e.id} not found, skipping shipping method validation`)}let c={firstName:S(o.firstName),lastName:S(o.lastName),phone:S(o.phone).replace(/\D/g,""),email:S(o.email).toLowerCase(),address:S(o.address),city:S(o.city),postalCode:o.postalCode?S(o.postalCode).replace(/\D/g,""):void 0,province:o.province?S(o.province):"",notes:o.notes?S(o.notes):void 0},h={items:n.map(e=>({id:S(e.id),productId:S(e.id),name:S(e.name),price:T(e.price),quantity:Math.floor(T(e.quantity)),image:e.image?S(e.image):""})),total:Math.round(l-u),shippingCost:Math.round(u),shippingMethod:p||"air",status:"pending",paymentStatus:"paid",customerName:`${c.firstName} ${c.lastName}`.trim(),customerPhone:c.phone,customerEmail:c.email||void 0,shippingAddress:{province:c.province,city:c.city,address:c.address,postalCode:c.postalCode||void 0},notes:c.notes||void 0,userId:a,orderNumber:(t=Date.now(),r=Math.floor(1e3*Math.random()).toString().padStart(3,"0"),`ORD-${t}-${r}`)},m=`order-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,g=new Date().toISOString();await (0,v.runQuery)(`INSERT INTO orders (id, \`orderNumber\`, \`userId\`, \`customerName\`, \`customerPhone\`, \`customerEmail\`, items, total, \`shippingCost\`, \`shippingMethod\`, \`shippingAddress\`, status, \`paymentStatus\`, notes, \`createdAt\`, \`updatedAt\`)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,[m,h.orderNumber,a,h.customerName,h.customerPhone,h.customerEmail||null,JSON.stringify(h.items),h.total,h.shippingCost,h.shippingMethod,JSON.stringify(h.shippingAddress),h.status,h.paymentStatus,h.notes||null,g,g]);let E=await (0,v.getRow)("SELECT * FROM orders WHERE id = ?",[m]),A={...E,items:Array.isArray(E.items)?E.items:"string"==typeof E.items?JSON.parse(E.items):[],shippingAddress:"object"==typeof E.shippingAddress&&null!==E.shippingAddress?E.shippingAddress:"string"==typeof E.shippingAddress?JSON.parse(E.shippingAddress):{},total:Number(E.total),shippingCost:Number(E.shippingCost),createdAt:E.createdAt instanceof Date?E.createdAt:new Date(E.createdAt),updatedAt:E.updatedAt instanceof Date?E.updatedAt:new Date(E.updatedAt)};return(0,I.createSuccessResponse)({order:A},201)}catch(e){return(0,I.createErrorResponse)(e)}}e.s(["POST",()=>_],72168);var O=e.i(72168);let D=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/orders/create/route",pathname:"/api/orders/create",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/orders/create/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:M,workUnitAsyncStorage:b,serverHooks:P}=D;function x(){return(0,i.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:b})}async function $(e,t,i){D.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/orders/create/route";w=w.replace(/\/index$/,"")||"/";let R=await D.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:I,params:N,nextConfig:v,parsedUrl:y,isDraftMode:C,prerenderManifest:S,routerServerContext:T,isOnDemandRevalidate:_,revalidateOnlyGenerated:O,resolvedPathname:M,clientReferenceManifest:b,serverActionsManifest:P}=R,x=(0,d.normalizeAppPath)(w),$=!!(S.dynamicRoutes[x]||S.routes[M]),L=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,y,!1):t.end("This page could not be found"),null);if($&&!C){let e=!!S.routes[M],t=S.dynamicRoutes[x];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await L();throw new A.NoFallbackError}}let H=null;!$||D.isDev||C||(H="/index"===(H=M)?"/":H);let q=!0===D.isDev||!$,U=$&&!q;P&&b&&(0,o.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:b,serverActionsManifest:P,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:P})});let V=e.method||"GET",k=(0,n.getTracer)(),F=k.getActiveScopeSpan(),j={params:N,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,i)=>D.onRequestError(e,t,i,T)},sharedContext:{buildId:I}},G=new p.NodeNextRequest(e),K=new p.NodeNextResponse(t),B=l.NextRequestAdapter.fromNodeNextRequest(G,(0,l.signalFromNodeResponse)(t));try{let o=async e=>D.handle(B,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=k.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=r.get("next.route");if(i){let t=`${V} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${V} ${w}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),d=async a=>{var n,d;let p=async({previousCacheEntry:r})=>{try{if(!s&&_&&O&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(a);e.fetchMetrics=j.renderOpts.fetchMetrics;let d=j.renderOpts.pendingWaitUntil;d&&i.waitUntil&&(i.waitUntil(d),d=void 0);let p=j.renderOpts.collectedTags;if(!$)return await (0,h.sendResponse)(G,K,n,j.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);p&&(t[E.NEXT_CACHE_TAGS_HEADER]=p),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,i=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:i}}}}catch(t){throw(null==r?void 0:r.isStale)&&await D.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:_})},T),t}},l=await D.handleResponse({req:e,nextConfig:v,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:O,responseGenerator:p,waitUntil:i.waitUntil,isMinimalMode:s});if(!$)return null;if((null==l||null==(n=l.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",_?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(l.value.headers);return s&&$||u.delete(E.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(l.cacheControl)),await (0,h.sendResponse)(G,K,new Response(l.value.body,{headers:u,status:l.value.status||200})),null};F?await d(F):await k.withPropagatedContext(e.headers,()=>k.trace(u.BaseServerSpan.handleRequest,{spanName:`${V} ${w}`,kind:n.SpanKind.SERVER,attributes:{"http.method":V,"http.target":e.url}},d))}catch(t){if(t instanceof A.NoFallbackError||await D.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:_})}),$)throw t;return await (0,h.sendResponse)(G,K,new Response(null,{status:500})),null}}e.s(["handler",()=>$,"patchFetch",()=>x,"routeModule",()=>D,"serverHooks",()=>P,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>b],41483)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_1544df71.js.map