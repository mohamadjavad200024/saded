module.exports=[41483,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),i=e.i(59756),n=e.i(61916),o=e.i(14444),s=e.i(10680),d=e.i(69741),p=e.i(16795),l=e.i(87718),u=e.i(95169),c=e.i(47587),h=e.i(66012),m=e.i(70101),g=e.i(26937),E=e.i(10372),A=e.i(93695);e.i(52474);var f=e.i(220),w=e.i(92208);let R=w.object({firstName:w.string().min(1,"نام الزامی است"),lastName:w.string().min(1,"نام خانوادگی الزامی است"),phone:w.string().min(10,"شماره تلفن باید حداقل 10 رقم باشد").regex(/^[0-9]+$/,"شماره تلفن باید فقط عدد باشد"),email:w.union([w.string().email("ایمیل نامعتبر است"),w.literal("")]).optional(),address:w.string().min(5,"آدرس باید حداقل 5 کاراکتر باشد"),city:w.string().min(1,"شهر الزامی است"),postalCode:w.string().optional().refine(e=>!e||""===e||/^[0-9]{10}$/.test(e),{message:"کد پستی باید 10 رقم باشد"}),province:w.string().optional(),notes:w.string().max(500,"یادداشت نمی‌تواند بیشتر از 500 کاراکتر باشد").optional()});var N=e.i(17939),I=e.i(39142),v=e.i(12e3),y=e.i(40911);function C(e){return"string"!=typeof e?"":e.trim()}function S(e){let t="number"==typeof e?e:parseFloat(e);return isNaN(t)?0:t}async function T(e){try{let t,r,{items:a,formData:i,total:n,shippingCost:o,shippingMethod:s}=await e.json().catch(()=>{throw new I.AppError("Invalid JSON in request body",400,"INVALID_JSON")});if(!a||!Array.isArray(a)||0===a.length)throw new I.AppError("سبد خرید خالی است",400,"EMPTY_CART");if(y.logger.debug("Received items for order creation:",a.map(e=>({id:e?.id,name:e?.name,price:e?.price,quantity:e?.quantity,hasImage:!!e?.image}))),a.length>50)throw new I.AppError("حداکثر 50 محصول در هر سفارش مجاز است",400,"CART_LIMIT_EXCEEDED");for(let e of a){if(!e||"object"!=typeof e)throw new I.AppError("آیتم سفارش نامعتبر است",400,"INVALID_ITEM");if(!e.id||"string"!=typeof e.id||""===e.id.trim())throw new I.AppError(`شناسه محصول نامعتبر است. آیتم: ${JSON.stringify(e)}`,400,"INVALID_ITEM_ID");if(!e.name||"string"!=typeof e.name||""===e.name.trim())throw new I.AppError(`نام محصول نامعتبر است. شناسه: ${e.id}`,400,"INVALID_ITEM_NAME");if(void 0===e.price||null===e.price)throw new I.AppError(`قیمت محصول "${e.name||e.id}" مشخص نشده است`,400,"MISSING_PRICE");let t=S(e.price);if(t<=0||t>1e8)throw new I.AppError(`قیمت محصول "${e.name}" نامعتبر است (${t})`,400,"INVALID_PRICE");if(void 0===e.quantity||null===e.quantity)throw new I.AppError(`تعداد محصول "${e.name||e.id}" مشخص نشده است`,400,"MISSING_QUANTITY");let r=S(e.quantity);if(r<=0||r>1e3)throw new I.AppError(`تعداد محصول "${e.name}" نامعتبر است (${r}) - باید بین 1 تا 1000 باشد`,400,"INVALID_QUANTITY");if(void 0!==e.image&&null!==e.image&&"string"!=typeof e.image)throw new I.AppError(`تصویر محصول "${e.name}" نامعتبر است`,400,"INVALID_IMAGE")}try{await R.parseAsync(i)}catch(e){throw new I.AppError("اطلاعات فرم نامعتبر است",400,"VALIDATION_ERROR",e.errors||e.message)}let d=S(n),p=S(o||0);if(d<=0||!isFinite(d))throw new I.AppError("مبلغ سفارش نامعتبر است",400,"INVALID_TOTAL");if(p<0||!isFinite(p))throw new I.AppError("هزینه ارسال نامعتبر است",400,"INVALID_SHIPPING_COST");if(d>1e8)throw new I.AppError(`مبلغ سفارش نمی‌تواند بیشتر از ${1e8.toLocaleString("fa-IR")} تومان باشد`,400,"ORDER_AMOUNT_EXCEEDED");if(s&&"air"!==s&&"sea"!==s)throw new I.AppError("روش ارسال نامعتبر است",400,"INVALID_SHIPPING_METHOD");if(s)for(let e of a)try{let t=await (0,v.getRow)('SELECT "airShippingEnabled", "seaShippingEnabled" FROM products WHERE id = ?',[e.id]);if(t){if("air"===s&&!t.airShippingEnabled)throw new I.AppError(`روش ارسال هوایی برای محصول "${e.name}" فعال نیست`,400,"SHIPPING_METHOD_NOT_AVAILABLE");if("sea"===s&&!t.seaShippingEnabled)throw new I.AppError(`روش ارسال دریایی برای محصول "${e.name}" فعال نیست`,400,"SHIPPING_METHOD_NOT_AVAILABLE")}}catch(t){if(t instanceof I.AppError)throw t;y.logger.warn(`Product ${e.id} not found, skipping shipping method validation`)}let l={firstName:C(i.firstName),lastName:C(i.lastName),phone:C(i.phone).replace(/\D/g,""),email:C(i.email).toLowerCase(),address:C(i.address),city:C(i.city),postalCode:i.postalCode?C(i.postalCode).replace(/\D/g,""):void 0,province:i.province?C(i.province):"",notes:i.notes?C(i.notes):void 0},u={items:a.map(e=>({id:C(e.id),productId:C(e.id),name:C(e.name),price:S(e.price),quantity:Math.floor(S(e.quantity)),image:e.image?C(e.image):""})),total:Math.round(d-p),shippingCost:Math.round(p),shippingMethod:s||"air",status:"pending",paymentStatus:"paid",customerName:`${l.firstName} ${l.lastName}`.trim(),customerPhone:l.phone,customerEmail:l.email||void 0,shippingAddress:{province:l.province,city:l.city,address:l.address,postalCode:l.postalCode||void 0},notes:l.notes||void 0,userId:e.headers.get("x-user-id")||"guest",orderNumber:(t=Date.now(),r=Math.floor(1e3*Math.random()).toString().padStart(3,"0"),`ORD-${t}-${r}`)},c=`order-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,h=new Date().toISOString();await (0,v.runQuery)(`INSERT INTO orders (id, \`orderNumber\`, \`userId\`, \`customerName\`, \`customerPhone\`, \`customerEmail\`, items, total, \`shippingCost\`, \`shippingMethod\`, \`shippingAddress\`, status, \`paymentStatus\`, notes, \`createdAt\`, \`updatedAt\`)
       VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,[c,u.orderNumber,u.userId,u.customerName,u.customerPhone,u.customerEmail||null,JSON.stringify(u.items),u.total,u.shippingCost,u.shippingMethod,JSON.stringify(u.shippingAddress),u.status,u.paymentStatus,u.notes||null,h,h]);let m=await (0,v.getRow)("SELECT * FROM orders WHERE id = ?",[c]),g={...m,items:Array.isArray(m.items)?m.items:"string"==typeof m.items?JSON.parse(m.items):[],shippingAddress:"object"==typeof m.shippingAddress&&null!==m.shippingAddress?m.shippingAddress:"string"==typeof m.shippingAddress?JSON.parse(m.shippingAddress):{},total:Number(m.total),shippingCost:Number(m.shippingCost),createdAt:m.createdAt instanceof Date?m.createdAt:new Date(m.createdAt),updatedAt:m.updatedAt instanceof Date?m.updatedAt:new Date(m.updatedAt)};return(0,N.createSuccessResponse)({order:g},201)}catch(e){return(0,N.createErrorResponse)(e)}}e.s(["POST",()=>T],72168);var _=e.i(72168);let O=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/orders/create/route",pathname:"/api/orders/create",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/orders/create/route.ts",nextConfigOutput:"",userland:_}),{workAsyncStorage:D,workUnitAsyncStorage:M,serverHooks:P}=O;function b(){return(0,a.patchFetch)({workAsyncStorage:D,workUnitAsyncStorage:M})}async function x(e,t,a){O.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let w="/api/orders/create/route";w=w.replace(/\/index$/,"")||"/";let R=await O.prepare(e,t,{srcPage:w,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:N,params:I,nextConfig:v,parsedUrl:y,isDraftMode:C,prerenderManifest:S,routerServerContext:T,isOnDemandRevalidate:_,revalidateOnlyGenerated:D,resolvedPathname:M,clientReferenceManifest:P,serverActionsManifest:b}=R,x=(0,d.normalizeAppPath)(w),$=!!(S.dynamicRoutes[x]||S.routes[M]),L=async()=>((null==T?void 0:T.render404)?await T.render404(e,t,y,!1):t.end("This page could not be found"),null);if($&&!C){let e=!!S.routes[M],t=S.dynamicRoutes[x];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await L();throw new A.NoFallbackError}}let H=null;!$||O.isDev||C||(H="/index"===(H=M)?"/":H);let q=!0===O.isDev||!$,U=$&&!q;b&&P&&(0,o.setReferenceManifestsSingleton)({page:w,clientReferenceManifest:P,serverActionsManifest:b,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:b})});let V=e.method||"GET",k=(0,n.getTracer)(),F=k.getActiveScopeSpan(),j={params:I,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>O.onRequestError(e,t,a,T)},sharedContext:{buildId:N}},G=new p.NodeNextRequest(e),K=new p.NodeNextResponse(t),B=l.NextRequestAdapter.fromNodeNextRequest(G,(0,l.signalFromNodeResponse)(t));try{let o=async e=>O.handle(B,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=k.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${V} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${V} ${w}`)}),s=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var n,d;let p=async({previousCacheEntry:r})=>{try{if(!s&&_&&D&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await o(i);e.fetchMetrics=j.renderOpts.fetchMetrics;let d=j.renderOpts.pendingWaitUntil;d&&a.waitUntil&&(a.waitUntil(d),d=void 0);let p=j.renderOpts.collectedTags;if(!$)return await (0,h.sendResponse)(G,K,n,j.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);p&&(t[E.NEXT_CACHE_TAGS_HEADER]=p),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=E.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,a=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=E.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await O.onRequestError(e,t,{routerKind:"App Router",routePath:w,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:_})},T),t}},l=await O.handleResponse({req:e,nextConfig:v,cacheKey:H,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:_,revalidateOnlyGenerated:D,responseGenerator:p,waitUntil:a.waitUntil,isMinimalMode:s});if(!$)return null;if((null==l||null==(n=l.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(d=l.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",_?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(l.value.headers);return s&&$||u.delete(E.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(l.cacheControl)),await (0,h.sendResponse)(G,K,new Response(l.value.body,{headers:u,status:l.value.status||200})),null};F?await d(F):await k.withPropagatedContext(e.headers,()=>k.trace(u.BaseServerSpan.handleRequest,{spanName:`${V} ${w}`,kind:n.SpanKind.SERVER,attributes:{"http.method":V,"http.target":e.url}},d))}catch(t){if(t instanceof A.NoFallbackError||await O.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:_})}),$)throw t;return await (0,h.sendResponse)(G,K,new Response(null,{status:500})),null}}e.s(["handler",()=>x,"patchFetch",()=>b,"routeModule",()=>O,"serverHooks",()=>P,"workAsyncStorage",()=>D,"workUnitAsyncStorage",()=>M],41483)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_1544df71.js.map