{"version":3,"sources":["../../../lib/db/index.ts","../../../lib/logger.ts","../../../lib/api-route-helpers.ts","../../../lib/api-error-handler.ts","../../../lib/auth/session.ts"],"sourcesContent":["/**\n * Database Wrapper\n * \n * این فایل یک interface یکپارچه برای استفاده از MySQL فراهم می‌کند\n */\n\n/**\n * Get single row from database\n */\nexport async function getRow<T extends Record<string, any> = any>(\n  sql: string,\n  params: any[] = []\n): Promise<T | null> {\n  try {\n    const { queryOne } = await import(\"./mysql\");\n    // Convert double-quoted column names to backticks for MySQL\n    const mysqlSql = convertToMySQLSQL(sql);\n    return await queryOne<T>(mysqlSql, params);\n  } catch (error: any) {\n    console.error(\"Database error in getRow:\", {\n      sql,\n      params,\n      error: error?.message,\n      code: error?.code,\n    });\n    throw error;\n  }\n}\n\n/**\n * Get multiple rows from database\n */\nexport async function getRows<T extends Record<string, any> = any>(\n  sql: string,\n  params: any[] = []\n): Promise<T[]> {\n  try {\n    const { queryAll } = await import(\"./mysql\");\n    // Convert double-quoted column names to backticks for MySQL\n    const mysqlSql = convertToMySQLSQL(sql);\n    return await queryAll<T>(mysqlSql, params);\n  } catch (error: any) {\n    console.error(\"Database error in getRows:\", {\n      sql,\n      params,\n      error: error?.message,\n      code: error?.code,\n    });\n    throw error;\n  }\n}\n\n/**\n * Run a query (INSERT, UPDATE, DELETE)\n */\nexport async function runQuery(\n  sql: string,\n  params: any[] = []\n): Promise<{ changes: number; lastInsertRowid?: number }> {\n  const { query } = await import(\"./mysql\");\n  const mysqlSql = convertToMySQLSQL(sql);\n  const result = await query(mysqlSql, params);\n  return {\n    changes: result.affectedRows || result.rowCount || 0,\n    lastInsertRowid: result.insertId || undefined,\n  };\n}\n\n/**\n * Convert SQL to MySQL SQL\n * - Converts double-quoted column names to backticks\n * - Converts PostgreSQL $1, $2, etc. placeholders to MySQL ? placeholders\n * - Converts ON CONFLICT to ON DUPLICATE KEY UPDATE\n * - MySQL uses ? placeholders (already correct)\n */\nfunction convertToMySQLSQL(sql: string): string {\n  let mysqlSql = sql;\n\n  // Convert PostgreSQL $1, $2, etc. placeholders to MySQL ? placeholders\n  // First, extract all $N placeholders and their positions\n  const placeholderRegex = /\\$(\\d+)/g;\n  const placeholders: Array<{ index: number; position: number }> = [];\n  let match;\n  while ((match = placeholderRegex.exec(sql)) !== null) {\n    placeholders.push({\n      index: parseInt(match[1], 10),\n      position: match.index,\n    });\n  }\n\n  // Replace placeholders in reverse order to maintain positions\n  if (placeholders.length > 0) {\n    // Sort by position in reverse order\n    placeholders.sort((a, b) => b.position - a.position);\n    \n    // Replace each $N with ?\n    for (const placeholder of placeholders) {\n      mysqlSql = mysqlSql.substring(0, placeholder.position) + \n                 '?' + \n                 mysqlSql.substring(placeholder.position + `$${placeholder.index}`.length);\n    }\n  }\n\n  // Convert double-quoted column names to backticks for MySQL\n  // Match \"columnName\" and replace with `columnName`\n  mysqlSql = mysqlSql.replace(/\"([^\"]+)\"/g, '`$1`');\n\n  // Convert PostgreSQL ON CONFLICT to MySQL ON DUPLICATE KEY UPDATE\n  mysqlSql = mysqlSql.replace(\n    /ON CONFLICT\\s*\\(([^)]+)\\)\\s*DO UPDATE SET\\s*(.+)/gi,\n    (match, conflictColumns, updateClause) => {\n      // Convert EXCLUDED.columnName to VALUES(columnName)\n      const convertedUpdate = updateClause.replace(/EXCLUDED\\.(\\w+)/gi, 'VALUES($1)');\n      return `ON DUPLICATE KEY UPDATE ${convertedUpdate}`;\n    }\n  );\n\n  // Remove MySQL-incompatible syntax like ::jsonb (legacy PostgreSQL syntax)\n  mysqlSql = mysqlSql.replace(/::jsonb/g, '');\n  mysqlSql = mysqlSql.replace(/::json/g, '');\n\n  return mysqlSql;\n}\n\n/**\n * Initialize database\n */\nexport async function initializeDatabase(): Promise<void> {\n  const { ensureDatabase, initializeTables } = await import(\"./mysql\");\n  await ensureDatabase();\n  await initializeTables();\n}\n\n/**\n * Test database connection\n */\nexport async function testConnection(): Promise<boolean> {\n  try {\n    const { testConnection } = await import(\"./mysql\");\n    return await testConnection();\n  } catch (error) {\n    return false;\n  }\n}\n\n/**\n * Get database type\n */\nexport function getDatabaseType(): \"mysql\" | \"none\" {\n  return \"mysql\";\n}\n","/**\r\n * Centralized logging utility\r\n * Disables console.log in production for better performance\r\n */\r\n\r\ntype LogLevel = 'log' | 'error' | 'warn' | 'info' | 'debug';\r\n\r\nclass Logger {\r\n  private isDevelopment = process.env.NODE_ENV === 'development';\r\n  private isProduction = process.env.NODE_ENV === 'production';\r\n\r\n  private shouldLog(level: LogLevel): boolean {\r\n    // Always log errors and warnings\r\n    if (level === 'error' || level === 'warn') {\r\n      return true;\r\n    }\r\n    // Only log other levels in development\r\n    return this.isDevelopment;\r\n  }\r\n\r\n  log(...args: any[]): void {\r\n    if (this.shouldLog('log')) {\r\n      console.log(...args);\r\n    }\r\n  }\r\n\r\n  error(...args: any[]): void {\r\n    console.error(...args);\r\n  }\r\n\r\n  warn(...args: any[]): void {\r\n    console.warn(...args);\r\n  }\r\n\r\n  info(...args: any[]): void {\r\n    if (this.shouldLog('info')) {\r\n      console.info(...args);\r\n    }\r\n  }\r\n\r\n  debug(...args: any[]): void {\r\n    if (this.shouldLog('debug')) {\r\n      console.debug(...args);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Log database query (only in development)\r\n   */\r\n  dbQuery(query: string, params?: any[]): void {\r\n    if (this.isDevelopment) {\r\n      console.log('[DB Query]', query.substring(0, 100), params ? `[${params.length} params]` : '');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Log API request (only in development)\r\n   */\r\n  apiRequest(method: string, path: string, statusCode?: number): void {\r\n    if (this.isDevelopment) {\r\n      console.log(`[API] ${method} ${path}${statusCode ? ` ${statusCode}` : ''}`);\r\n    }\r\n  }\r\n}\r\n\r\nexport const logger = new Logger();\r\n\r\n","/**\r\n * API Route Helpers\r\n * Provides standardized error handling and response formatting for API routes\r\n */\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { logError, AppError } from \"./api-error-handler\";\r\n\r\nexport interface ApiRouteError {\r\n  message: string;\r\n  status?: number;\r\n  code?: string;\r\n  details?: unknown;\r\n}\r\n\r\n/**\r\n * Create standardized error response\r\n */\r\nexport function createErrorResponse(\r\n  error: unknown,\r\n  defaultStatus: number = 500\r\n): NextResponse {\r\n  let message = \"خطای سرور\";\r\n  let status = defaultStatus;\r\n  let code: string | undefined;\r\n  let details: unknown;\r\n\r\n  // Handle AppError specifically (most common case)\r\n  if (error instanceof AppError) {\r\n    message = error.message;\r\n    status = error.status || defaultStatus;\r\n    code = error.code;\r\n    details = error.details;\r\n  } else if (error instanceof Error) {\r\n    message = error.message;\r\n    if (\"status\" in error && typeof error.status === \"number\") {\r\n      status = error.status;\r\n    }\r\n    if (\"code\" in error && typeof error.code === \"string\") {\r\n      code = error.code;\r\n    }\r\n    if (\"details\" in error) {\r\n      details = error.details;\r\n    }\r\n  } else if (typeof error === \"string\") {\r\n    message = error;\r\n  } else if (error && typeof error === \"object\" && \"message\" in error) {\r\n    message = String(error.message);\r\n    if (\"status\" in error && typeof error.status === \"number\") {\r\n      status = error.status;\r\n    }\r\n    if (\"code\" in error && typeof error.code === \"string\") {\r\n      code = error.code as string;\r\n    }\r\n  }\r\n\r\n  // Log error in development\r\n  logError(error, \"API Route\");\r\n\r\n  return NextResponse.json(\r\n    {\r\n      success: false,\r\n      error: message,\r\n      ...(code ? { code } : {}),\r\n      ...(process.env.NODE_ENV === \"development\" && details ? { details } : {}),\r\n    },\r\n    { status }\r\n  );\r\n}\r\n\r\n/**\r\n * Create standardized success response\r\n */\r\nexport function createSuccessResponse<T>(\r\n  data: T,\r\n  status: number = 200,\r\n  pagination?: {\r\n    page: number;\r\n    limit: number;\r\n    total: number;\r\n    totalPages: number;\r\n  }\r\n): NextResponse {\r\n  return NextResponse.json(\r\n    {\r\n      success: true,\r\n      data,\r\n      ...(pagination && { pagination }),\r\n    },\r\n    { status }\r\n  );\r\n}\r\n\r\n/**\r\n * Wrap route handler with error handling\r\n */\r\nexport function withErrorHandling(\r\n  handler: (request: Request, context?: any) => Promise<NextResponse>\r\n) {\r\n  return async (request: Request, context?: any): Promise<NextResponse> => {\r\n    try {\r\n      return await handler(request, context);\r\n    } catch (error) {\r\n      return createErrorResponse(error);\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Validate request body\r\n */\r\nexport function validateRequestBody<T>(\r\n  body: unknown,\r\n  validator?: (data: unknown) => data is T\r\n): T {\r\n  if (!body) {\r\n    throw new Error(\"Request body is required\");\r\n  }\r\n\r\n  if (validator && !validator(body)) {\r\n    throw new Error(\"Invalid request body\");\r\n  }\r\n\r\n  return body as T;\r\n}\r\n\r\n","/**\r\n * Centralized Error Handler\r\n * Provides consistent error handling and logging across the application\r\n */\r\n\r\nexport interface ApiError {\r\n  message: string;\r\n  status?: number;\r\n  code?: string;\r\n  details?: unknown;\r\n}\r\n\r\nexport class AppError extends Error {\r\n  status?: number;\r\n  code?: string;\r\n  details?: unknown;\r\n\r\n  constructor(message: string, status?: number, code?: string, details?: unknown) {\r\n    super(message);\r\n    this.name = \"AppError\";\r\n    this.status = status;\r\n    this.code = code;\r\n    this.details = details;\r\n    Object.setPrototypeOf(this, AppError.prototype);\r\n  }\r\n}\r\n\r\n/**\r\n * Network error types\r\n */\r\nexport enum NetworkErrorType {\r\n  TIMEOUT = \"TIMEOUT\",\r\n  NETWORK = \"NETWORK\",\r\n  ABORTED = \"ABORTED\",\r\n  UNKNOWN = \"UNKNOWN\",\r\n}\r\n\r\nexport class NetworkError extends Error {\r\n  type: NetworkErrorType;\r\n  originalError?: Error;\r\n\r\n  constructor(\r\n    message: string,\r\n    type: NetworkErrorType = NetworkErrorType.UNKNOWN,\r\n    originalError?: Error\r\n  ) {\r\n    super(message);\r\n    this.name = \"NetworkError\";\r\n    this.type = type;\r\n    this.originalError = originalError;\r\n    Object.setPrototypeOf(this, NetworkError.prototype);\r\n  }\r\n}\r\n\r\n/**\r\n * Import centralized logger\r\n */\r\nimport { logger } from \"@/lib/logger\";\r\n\r\n/**\r\n * Parse error from various sources\r\n */\r\nexport function parseError(error: unknown): ApiError {\r\n  if (error instanceof AppError) {\r\n    return {\r\n      message: error.message,\r\n      status: error.status,\r\n      code: error.code,\r\n      details: error.details,\r\n    };\r\n  }\r\n\r\n  if (error instanceof NetworkError) {\r\n    return {\r\n      message: error.message,\r\n      code: error.type,\r\n      details: error.originalError,\r\n    };\r\n  }\r\n\r\n  if (error instanceof Error) {\r\n    return {\r\n      message: error.message,\r\n    };\r\n  }\r\n\r\n  if (typeof error === \"string\") {\r\n    return {\r\n      message: error,\r\n    };\r\n  }\r\n\r\n  return {\r\n    message: \"خطای نامشخص رخ داد\",\r\n  };\r\n}\r\n\r\n/**\r\n * Get user-friendly error message\r\n */\r\nexport function getUserFriendlyMessage(error: unknown): string {\r\n  const parsed = parseError(error);\r\n\r\n  // Network errors\r\n  if (parsed.code === NetworkErrorType.TIMEOUT) {\r\n    return \"درخواست شما به دلیل طولانی شدن زمان پاسخ لغو شد. لطفاً دوباره تلاش کنید.\";\r\n  }\r\n\r\n  if (parsed.code === NetworkErrorType.NETWORK) {\r\n    return \"خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کنید.\";\r\n  }\r\n\r\n  if (parsed.code === NetworkErrorType.ABORTED) {\r\n    return \"درخواست لغو شد.\";\r\n  }\r\n\r\n  // HTTP status codes\r\n  if (parsed.status) {\r\n    switch (parsed.status) {\r\n      case 400:\r\n        return parsed.message || \"درخواست نامعتبر است.\";\r\n      case 401:\r\n        return \"لطفاً دوباره وارد شوید.\";\r\n      case 403:\r\n        return \"شما دسترسی به این منبع ندارید.\";\r\n      case 404:\r\n        return \"منبع مورد نظر یافت نشد.\";\r\n      case 429:\r\n        return \"تعداد درخواست‌های شما بیش از حد مجاز است. لطفاً کمی صبر کنید.\";\r\n      case 500:\r\n        return \"خطای سرور. لطفاً بعداً تلاش کنید.\";\r\n      case 502:\r\n      case 503:\r\n      case 504:\r\n        return \"سرور در دسترس نیست. لطفاً بعداً تلاش کنید.\";\r\n      default:\r\n        return parsed.message || \"خطایی رخ داد.\";\r\n    }\r\n  }\r\n\r\n  return parsed.message || \"خطای نامشخص رخ داد.\";\r\n}\r\n\r\n/**\r\n * Log error (only in development)\r\n */\r\nexport function logError(error: unknown, context?: string): void {\r\n  const parsed = parseError(error);\r\n  const contextMsg = context ? `[${context}] ` : \"\";\r\n  \r\n  logger.error(`${contextMsg}${parsed.message}`, {\r\n    status: parsed.status,\r\n    code: parsed.code,\r\n    details: parsed.details,\r\n  });\r\n}\r\n","import { NextRequest, NextResponse } from \"next/server\";\nimport crypto from \"crypto\";\nimport { getRow, getRows, runQuery } from \"@/lib/db/index\";\nimport { AppError } from \"@/lib/api-error-handler\";\n\nexport const SESSION_COOKIE_NAME = \"saded_session\";\n\n// Session نامحدود - تا زمانی که کاربر logout نکند\n// برای امنیت، از maxAge بسیار طولانی استفاده می‌کنیم (10 سال)\nconst SESSION_MAX_AGE_SECONDS = 10 * 365 * 24 * 60 * 60; // 10 years in seconds\n\nfunction nowIso(): string {\n  // MySQL friendly datetime (YYYY-MM-DD HH:mm:ss)\n  return new Date().toISOString().slice(0, 19).replace(\"T\", \" \");\n}\n\n// Function removed - sessions are now unlimited, no expiration needed\n\nexport function sha256Hex(input: string): string {\n  return crypto.createHash(\"sha256\").update(input).digest(\"hex\");\n}\n\nexport function isHttpsRequest(request: NextRequest): boolean {\n  const proto = request.headers.get(\"x-forwarded-proto\") || request.nextUrl.protocol.replace(\":\", \"\");\n  return proto === \"https\";\n}\n\nexport function getSessionCookieOptions(request: NextRequest) {\n  // Important: if your site is served over http (Not secure), Secure cookies won't set.\n  // In development, we use http, so secure must be false\n  const isProduction = process.env.NODE_ENV === \"production\";\n  const isLocalhost = request.nextUrl.hostname === \"localhost\" || \n                      request.nextUrl.hostname === \"127.0.0.1\" ||\n                      request.nextUrl.hostname === \"::1\";\n  \n  // Never use secure on localhost - it prevents cookie from being set\n  const secure = isProduction && !isLocalhost && isHttpsRequest(request);\n  \n  return {\n    httpOnly: true,\n    secure: secure, // false on localhost, true only in production with HTTPS\n    sameSite: \"lax\" as const, // lax allows cookies to be sent with same-site requests\n    path: \"/\",\n    maxAge: SESSION_MAX_AGE_SECONDS, // 10 years - effectively unlimited until logout\n    // Ensure domain is not set (allows cookie to work on localhost)\n    // domain is not set by default, which is correct for localhost\n    // In development, explicitly set sameSite to 'lax' to ensure cookies work\n    ...(process.env.NODE_ENV === 'development' && {\n      sameSite: \"lax\" as const,\n    }),\n  };\n}\n\nexport async function ensureAuthTables(): Promise<void> {\n  try {\n    // Users table\n    await runQuery(`\n      CREATE TABLE IF NOT EXISTS users (\n      id VARCHAR(255) PRIMARY KEY,\n      name VARCHAR(255) NOT NULL,\n      phone VARCHAR(32) NOT NULL,\n      password VARCHAR(255) NOT NULL,\n      role VARCHAR(50) NOT NULL DEFAULT 'user',\n      enabled BOOLEAN DEFAULT TRUE,\n      createdAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      updatedAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n      UNIQUE KEY uniq_users_phone (phone)\n    )\n  `);\n\n  // If table already existed with different schema/indexes, normalize it:\n  // - Only `phone` should be unique (besides PRIMARY id)\n  // - Remove other UNIQUE indexes that can block registration (e.g. old email unique)\n  // - Ensure phone is NOT NULL\n  try {\n    // Remove invalid rows (NULL/empty phone) to avoid ALTER failures\n    await runQuery(`DELETE FROM users WHERE phone IS NULL OR TRIM(phone) = ''`);\n\n    // Ensure phone column is NOT NULL (keep type small)\n    await runQuery(`ALTER TABLE users MODIFY phone VARCHAR(32) NOT NULL`);\n\n    // Read indexes\n    const indexRows = await getRows<any>(`SHOW INDEX FROM users`);\n    const uniqueIndexToColumns = new Map<string, string[]>();\n\n    for (const r of indexRows) {\n      const keyName = String(r.Key_name ?? r.key_name ?? r.KEY_NAME ?? \"\");\n      const nonUnique = Number(r.Non_unique ?? r.non_unique ?? r.NON_UNIQUE ?? 1);\n      const colName = String(r.Column_name ?? r.column_name ?? r.COLUMN_NAME ?? \"\");\n      if (!keyName || !colName) continue;\n      if (nonUnique !== 0) continue;\n      const cols = uniqueIndexToColumns.get(keyName) || [];\n      cols.push(colName);\n      uniqueIndexToColumns.set(keyName, cols);\n    }\n\n    // Find which unique index (if any) is exactly on phone\n    let phoneUniqueIndexName: string | null = null;\n    for (const [key, cols] of uniqueIndexToColumns.entries()) {\n      if (key === \"PRIMARY\") continue;\n      const normalizedCols = cols.map((c) => c.toLowerCase()).sort();\n      if (normalizedCols.length === 1 && normalizedCols[0] === \"phone\") {\n        phoneUniqueIndexName = key;\n        break;\n      }\n    }\n\n    // Ensure we have a unique index on phone with our preferred name\n    if (!phoneUniqueIndexName) {\n      await runQuery(`ALTER TABLE users ADD UNIQUE KEY uniq_users_phone (phone)`);\n      phoneUniqueIndexName = \"uniq_users_phone\";\n    }\n\n    // Drop any other UNIQUE indexes (only PRIMARY + phone unique should remain)\n    for (const key of uniqueIndexToColumns.keys()) {\n      if (key === \"PRIMARY\") continue;\n      if (key === phoneUniqueIndexName) continue;\n      // Drop (might fail if permissions; ignore)\n      try {\n        await runQuery(`ALTER TABLE users DROP INDEX \\`${key}\\``);\n      } catch {\n        // ignore\n      }\n    }\n  } catch {\n    // Best-effort; do not block auth if ALTER is not permitted\n  }\n\n  // Sessions table\n  // Note: expiresAt is kept for backward compatibility but not enforced (sessions are unlimited)\n  await runQuery(`\n    CREATE TABLE IF NOT EXISTS sessions (\n      id VARCHAR(255) PRIMARY KEY,\n      userId VARCHAR(255) NOT NULL,\n      tokenHash CHAR(64) NOT NULL,\n      expiresAt TIMESTAMP NULL DEFAULT NULL,\n      createdAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\n      lastSeenAt TIMESTAMP NULL DEFAULT NULL,\n      userAgent VARCHAR(255) NULL DEFAULT NULL,\n      ip VARCHAR(64) NULL DEFAULT NULL,\n      UNIQUE KEY uniq_sessions_tokenHash (tokenHash),\n      KEY idx_sessions_userId (userId),\n      KEY idx_sessions_expiresAt (expiresAt)\n    )\n  `);\n  \n    // Migrate existing sessions: set expiresAt to NULL for unlimited sessions\n    try {\n      await runQuery(`UPDATE sessions SET expiresAt = NULL WHERE expiresAt IS NOT NULL`);\n    } catch {\n      // Best-effort migration, ignore errors\n    }\n  } catch (error: any) {\n    // If database is not available, log but don't throw - allow app to continue\n    if (error?.code === 'ECONNRESET' || \n        error?.code === 'PROTOCOL_CONNECTION_LOST' ||\n        error?.code === 'ETIMEDOUT' ||\n        error?.code === 'ECONNREFUSED' ||\n        error?.message?.includes('closed state')) {\n      logger.warn(\"Database connection error in ensureAuthTables, will retry on next request:\", error?.code);\n      // Don't throw - allow route to continue (it will handle the error)\n      return;\n    }\n    // For other errors, log and rethrow\n    logger.error(\"Error ensuring auth tables:\", error);\n    throw error;\n  }\n}\n\nexport type SessionUser = {\n  id: string;\n  name: string;\n  phone: string;\n  role: string;\n  enabled: boolean;\n  createdAt: string;\n};\n\nexport async function createSession(userId: string, request: NextRequest): Promise<string> {\n  await ensureAuthTables();\n\n  const token = crypto.randomBytes(32).toString(\"base64url\");\n  const tokenHash = sha256Hex(token);\n  const sessionId = `sess_${Date.now()}_${crypto.randomBytes(6).toString(\"hex\")}`;\n  // Session نامحدود - expiresAt را NULL می‌گذاریم\n  const expiresAt = null;\n\n  const ua = request.headers.get(\"user-agent\");\n  const ip = request.headers.get(\"x-forwarded-for\")?.split(\",\")[0]?.trim() || null;\n\n  await runQuery(\n    `INSERT INTO sessions (id, userId, tokenHash, expiresAt, createdAt, lastSeenAt, userAgent, ip)\n     VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,\n    [\n      sessionId,\n      userId,\n      tokenHash,\n      expiresAt,\n      nowIso(),\n      nowIso(),\n      ua || null,\n      ip,\n    ]\n  );\n\n  return token;\n}\n\nexport async function getSessionUserFromRequest(request: NextRequest): Promise<SessionUser | null> {\n  // Try to get cookie from both cookies.get() and headers\n  let token = request.cookies.get(SESSION_COOKIE_NAME)?.value;\n  \n  // Fallback: try to parse from cookie header directly\n  if (!token) {\n    const cookieHeader = request.headers.get('cookie');\n    if (cookieHeader) {\n      const cookies = cookieHeader.split(';').map(c => c.trim());\n      for (const cookie of cookies) {\n        const [name, value] = cookie.split('=');\n        if (name === SESSION_COOKIE_NAME && value) {\n          token = decodeURIComponent(value);\n          break;\n        }\n      }\n    }\n  }\n  \n  if (!token) {\n    // Debug: log if cookie is missing - use console.log for visibility\n    const allCookies = request.cookies.getAll();\n    const cookieNames = allCookies.map(c => c.name);\n    const cookieHeader = request.headers.get('cookie');\n    console.log('[Session] ❌ No session cookie found!');\n    console.log('[Session] Available cookies:', cookieNames);\n    console.log('[Session] Looking for cookie:', SESSION_COOKIE_NAME);\n    console.log('[Session] Request URL:', request.url);\n    console.log('[Session] Cookie header:', cookieHeader ? cookieHeader.substring(0, 300) : 'no cookie header');\n    console.log('[Session] Request hostname:', request.nextUrl.hostname);\n    console.log('[Session] Request protocol:', request.nextUrl.protocol);\n    if (process.env.NODE_ENV === 'development') {\n      console.debug('[Session] No session cookie found. Available cookies:', cookieNames);\n    }\n    return null;\n  }\n  \n  console.log('[Session] ✅ Session token found, length:', token.length);\n\n  // Only touch DB if a session cookie exists (prevents hanging on DB when user is not logged in)\n  try {\n    await ensureAuthTables();\n  } catch (error: any) {\n    // If database is not available, return null (user not authenticated)\n    if (error?.code === 'ECONNRESET' || \n        error?.code === 'PROTOCOL_CONNECTION_LOST' ||\n        error?.code === 'ETIMEDOUT' ||\n        error?.code === 'ECONNREFUSED' ||\n        error?.message?.includes('closed state')) {\n      logger.warn(\"Database connection error in getSessionUserFromRequest, returning null:\", error?.code);\n      return null;\n    }\n    // For other errors, rethrow\n    throw error;\n  }\n\n  const tokenHash = sha256Hex(token);\n  let row;\n  try {\n    row = await getRow<{\n      sessionId: string;\n      userId: string;\n      expiresAt: string;\n      enabled: any;\n      role: string;\n      name: string;\n      phone: string;\n      createdAt: string;\n    }>(\n      `SELECT s.id as sessionId, s.userId, s.expiresAt, u.enabled, u.role, u.name, u.phone, u.createdAt\n       FROM sessions s\n       JOIN users u ON u.id = s.userId\n       WHERE s.tokenHash = ?\n       LIMIT 1`,\n      [tokenHash]\n    );\n  } catch (error: any) {\n    // If database is not available, return null (user not authenticated)\n    if (error?.code === 'ECONNRESET' || \n        error?.code === 'PROTOCOL_CONNECTION_LOST' ||\n        error?.code === 'ETIMEDOUT' ||\n        error?.code === 'ECONNREFUSED' ||\n        error?.message?.includes('closed state')) {\n      logger.warn(\"Database connection error in getSessionUserFromRequest query, returning null:\", error?.code);\n      return null;\n    }\n    // For other errors, rethrow\n    throw error;\n  }\n\n  if (!row) return null;\n\n  // Session نامحدود - بررسی expiration را حذف می‌کنیم\n  // فقط اگر expiresAt وجود داشته باشد و منقضی شده باشد، آن را حذف می‌کنیم\n  // (برای backward compatibility با sessions قدیمی)\n  if (row.expiresAt) {\n    const expires = new Date(row.expiresAt);\n    if (!Number.isNaN(expires.getTime()) && expires.getTime() < Date.now()) {\n      // Expired: delete it\n      await runQuery(`DELETE FROM sessions WHERE tokenHash = ?`, [tokenHash]);\n      return null;\n    }\n  }\n\n  // Touch session (ignore errors - not critical)\n  try {\n    await runQuery(`UPDATE sessions SET lastSeenAt = ? WHERE id = ?`, [nowIso(), row.sessionId]);\n  } catch (error: any) {\n    // Ignore connection errors when touching session - not critical\n    if (error?.code === 'ECONNRESET' || \n        error?.code === 'PROTOCOL_CONNECTION_LOST' ||\n        error?.code === 'ETIMEDOUT' ||\n        error?.code === 'ECONNREFUSED' ||\n        error?.message?.includes('closed state')) {\n      // Silent ignore - session touch is not critical\n    } else {\n      // Log other errors but don't fail\n      logger.debug(\"Error touching session (non-critical):\", error?.code);\n    }\n  }\n\n  return {\n    id: row.userId,\n    name: row.name,\n    phone: row.phone,\n    role: row.role || \"user\",\n    enabled: Boolean(row.enabled),\n    createdAt: row.createdAt,\n  };\n}\n\nexport async function clearSession(request: NextRequest): Promise<void> {\n  const token = request.cookies.get(SESSION_COOKIE_NAME)?.value;\n  if (!token) return;\n  await ensureAuthTables();\n  const tokenHash = sha256Hex(token);\n  await runQuery(`DELETE FROM sessions WHERE tokenHash = ?`, [tokenHash]);\n}\n\nexport function setSessionCookie(response: NextResponse, token: string, request: NextRequest) {\n  const options = getSessionCookieOptions(request);\n  \n  // CRITICAL: In Next.js, we should ONLY use response.cookies.set()\n  // Setting headers directly can cause conflicts\n  // Make sure all options are explicitly set\n  response.cookies.set(SESSION_COOKIE_NAME, token, {\n    httpOnly: true,\n    secure: options.secure,\n    sameSite: options.sameSite,\n    path: \"/\",\n    maxAge: options.maxAge,\n    // DO NOT set domain - it breaks localhost\n    // DO NOT set expires - use maxAge instead\n  });\n  \n  // Debug in development\n  if (process.env.NODE_ENV === 'development') {\n    const cookieValue = response.cookies.get(SESSION_COOKIE_NAME)?.value;\n    const allCookies = response.cookies.getAll();\n    console.log('[Session] Cookie set:', {\n      name: SESSION_COOKIE_NAME,\n      hasToken: !!token,\n      tokenLength: token?.length,\n      cookieValueInResponse: !!cookieValue,\n      cookieValueMatches: cookieValue === token,\n      maxAge: options.maxAge,\n      expiresIn: \"unlimited (until logout)\",\n      secure: options.secure,\n      sameSite: options.sameSite,\n      requestHost: request.nextUrl.hostname,\n      requestProtocol: request.nextUrl.protocol,\n      allCookiesCount: allCookies.length,\n      cookieNames: allCookies.map(c => c.name),\n    });\n  }\n}\n\nexport function clearSessionCookie(response: NextResponse, request: NextRequest) {\n  response.cookies.set(SESSION_COOKIE_NAME, \"\", {\n    ...getSessionCookieOptions(request),\n    maxAge: 0,\n  });\n}\n\n\n"],"names":[],"mappings":"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"}