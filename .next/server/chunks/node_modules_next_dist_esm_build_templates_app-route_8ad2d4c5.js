module.exports=[89124,e=>{"use strict";var r=e.i(47909),t=e.i(74017),o=e.i(96250),n=e.i(59756),a=e.i(61916),s=e.i(14444),i=e.i(10680),l=e.i(69741),d=e.i(16795),c=e.i(87718),u=e.i(95169),p=e.i(47587),E=e.i(66012),h=e.i(70101),g=e.i(26937),R=e.i(10372),A=e.i(93695);e.i(52474);var T=e.i(220),m=e.i(12e3),N=e.i(17939),w=e.i(39142),S=e.i(40911),O=e.i(49632),f=e.i(46469);async function I(e){try{let r,t,o;try{r=await e.json()}catch(e){throw S.logger.error("JSON parse error:",e),new w.AppError("فرمت درخواست نامعتبر است",400,"INVALID_JSON")}let{name:n,phone:a,password:s}=r||{};if(!n||"string"!=typeof n||""===n.trim())throw new w.AppError("نام الزامی است",400,"MISSING_NAME");if(!a||"string"!=typeof a||""===a.trim())throw new w.AppError("شماره تماس الزامی است",400,"MISSING_PHONE");if(!s||"string"!=typeof s||""===s.trim())throw new w.AppError("رمز عبور الزامی است",400,"MISSING_PASSWORD");try{f.registerSchema.parse({name:n.trim(),phone:a.trim(),password:s})}catch(t){let e=t.errors||[],r=e[0];throw S.logger.warn("Validation error:",{errors:e,input:{name:n,phone:"***"}}),new w.AppError(r?.message||"اطلاعات وارد شده معتبر نیست",400,"VALIDATION_ERROR",e)}let i=(0,f.validateStrongPassword)(s);!i.valid&&i.errors.length>0&&S.logger.warn("Weak password detected:",i.errors);try{t=(0,f.normalizePhone)(a.trim()),S.logger.info("Phone normalized:",{original:a,normalized:t,originalLength:a.length,normalizedLength:t.length})}catch(e){throw S.logger.error("Phone normalization error:",{phone:a,error:e.message}),new w.AppError(e.message||"شماره تماس معتبر نیست. فرمت صحیح: 09123456789",400,"INVALID_PHONE")}try{await (0,m.runQuery)(`
        CREATE TABLE IF NOT EXISTS users (
          id VARCHAR(255) PRIMARY KEY,
          name VARCHAR(255) NOT NULL,
          phone VARCHAR(255) UNIQUE NOT NULL,
          password VARCHAR(255) NOT NULL,
          role VARCHAR(50) NOT NULL DEFAULT 'user',
          enabled BOOLEAN DEFAULT TRUE,
          createdAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
          updatedAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
        )
      `),S.logger.debug("Users table checked/created successfully")}catch(e){if(e?.code!=="ER_TABLE_EXISTS_ERROR"&&!e?.message?.includes("already exists")&&!e?.message?.includes("Duplicate table"))throw S.logger.error("Error creating users table:",{code:e?.code,message:e?.message,sqlState:e?.sqlState}),new w.AppError("خطا در ایجاد جدول کاربران",500,"TABLE_CREATION_ERROR")}let l=null;try{if(l=await (0,m.getRow)("SELECT id, phone FROM users WHERE BINARY phone = ? AND phone IS NOT NULL AND phone != '' AND LENGTH(phone) = 11",[t]),S.logger.info("Duplicate check result:",{normalizedPhone:t,normalizedPhoneLength:t.length,found:!!l,existingPhone:l?.phone,existingPhoneLength:l?.phone?.length,existingId:l?.id}),!l)try{let e=await (0,m.getRows)("SELECT id, phone FROM users WHERE phone LIKE ? AND phone IS NOT NULL AND phone != '' LIMIT 5",[`%${t.slice(-4)}%`]);e&&e.length>0&&S.logger.info("Similar phones found:",{normalizedPhone:t,similarPhones:e.map(e=>e.phone)})}catch(e){S.logger.debug("Error checking similar phones:",e.message)}}catch(e){if(S.logger.error("Error checking existing user:",{code:e?.code,message:e?.message,phone:t,sqlState:e?.sqlState,errno:e?.errno}),e?.code==="ECONNREFUSED"||e?.code==="ETIMEDOUT"||e?.code==="ECONNRESET"||e?.message?.includes("connect")||e?.message?.includes("timeout"))throw new w.AppError("دیتابیس در دسترس نیست",503,"DATABASE_NOT_AVAILABLE");throw e}if(l)throw S.logger.warn("Duplicate phone detected:",{normalizedPhone:t,existingUserId:l.id,existingUserPhone:l.phone,phonesMatch:l.phone===t}),new w.AppError("شماره تماس قبلاً ثبت شده است",400,"DUPLICATE_PHONE");try{o=await O.default.hash(s,10),S.logger.debug("Password hashed successfully")}catch(e){throw S.logger.error("Password hashing error:",e),new w.AppError("خطا در پردازش رمز عبور",500,"PASSWORD_HASH_ERROR")}let d=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,c=new Date().toISOString().slice(0,19).replace("T"," ");try{await (0,m.runQuery)(`INSERT INTO users (id, name, phone, password, role, enabled, createdAt, updatedAt)
         VALUES (?, ?, ?, ?, 'user', TRUE, ?, ?)`,[d,n.trim(),t,o,c,c]),S.logger.debug("User inserted successfully:",{id:d,phone:t})}catch(e){if(S.logger.error("Error inserting user:",{code:e?.code,message:e?.message,sqlState:e?.sqlState,errno:e?.errno}),e?.code==="ER_DUP_ENTRY"||e?.errno===1062)throw new w.AppError("شماره تماس قبلاً ثبت شده است",400,"DUPLICATE_PHONE");if(e?.code==="ECONNREFUSED"||e?.code==="ETIMEDOUT"||e?.code==="ECONNRESET"||e?.message?.includes("connect")||e?.message?.includes("timeout"))throw new w.AppError("دیتابیس در دسترس نیست",503,"DATABASE_NOT_AVAILABLE");throw new w.AppError(`خطا در ثبت کاربر: ${e?.message||"خطای نامشخص"}`,500,"USER_INSERT_ERROR")}let u=null;try{u=await (0,m.getRow)("SELECT id, name, phone, role, createdAt FROM users WHERE id = ?",[d])}catch(e){throw S.logger.error("Error selecting created user:",{code:e?.code,message:e?.message,id:d}),new w.AppError("خطا در دریافت اطلاعات کاربر",500,"USER_SELECT_ERROR")}if(!u)throw S.logger.error("User created but not found:",{id:d,phone:t}),new w.AppError("خطا در ایجاد کاربر",500,"USER_CREATION_ERROR");return S.logger.info("User registered successfully:",{id:d,phone:a.trim()}),(0,N.createSuccessResponse)({user:{id:u.id,name:u.name,phone:u.phone,createdAt:u.createdAt},message:"ثبت‌نام با موفقیت انجام شد"})}catch(r){if(S.logger.error("POST /api/auth/register error:",{message:r?.message,code:r?.code,errno:r?.errno,sqlState:r?.sqlState,stack:void 0}),r instanceof w.AppError)return(0,N.createErrorResponse)(r);if(r?.message?.includes("not available")||r?.code==="DATABASE_NOT_AVAILABLE"||r?.code==="ECONNREFUSED"||r?.code==="ETIMEDOUT"||r?.code==="ECONNRESET"||r?.code==="PROTOCOL_CONNECTION_LOST"||r?.message?.includes("connect")||r?.message?.includes("timeout")||r?.message?.includes("Connection lost"))return(0,N.createErrorResponse)(new w.AppError("دیتابیس در دسترس نیست. لطفاً دوباره تلاش کنید",503,"DATABASE_NOT_AVAILABLE"));if(r?.name==="ZodError"||r?.issues){let e=r?.issues?.[0]||r?.errors?.[0];return(0,N.createErrorResponse)(new w.AppError(e?.message||"اطلاعات وارد شده معتبر نیست",400,"VALIDATION_ERROR"))}let e=r?.message||"خطا در ثبت‌نام. لطفاً دوباره تلاش کنید";return(0,N.createErrorResponse)(new w.AppError(e,500,"REGISTRATION_ERROR",void 0))}}e.s(["POST",()=>I],81450);var C=e.i(81450);let _=new r.AppRouteRouteModule({definition:{kind:t.RouteKind.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/auth/register/route.ts",nextConfigOutput:"",userland:C}),{workAsyncStorage:L,workUnitAsyncStorage:U,serverHooks:v}=_;function P(){return(0,o.patchFetch)({workAsyncStorage:L,workUnitAsyncStorage:U})}async function y(e,r,o){_.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let m="/api/auth/register/route";m=m.replace(/\/index$/,"")||"/";let N=await _.prepare(e,r,{srcPage:m,multiZoneDraftMode:!1});if(!N)return r.statusCode=400,r.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:w,params:S,nextConfig:O,parsedUrl:f,isDraftMode:I,prerenderManifest:C,routerServerContext:L,isOnDemandRevalidate:U,revalidateOnlyGenerated:v,resolvedPathname:P,clientReferenceManifest:y,serverActionsManifest:D}=N,M=(0,l.normalizeAppPath)(m),x=!!(C.dynamicRoutes[M]||C.routes[P]),b=async()=>((null==L?void 0:L.render404)?await L.render404(e,r,f,!1):r.end("This page could not be found"),null);if(x&&!I){let e=!!C.routes[P],r=C.dynamicRoutes[M];if(r&&!1===r.fallback&&!e){if(O.experimental.adapterPath)return await b();throw new A.NoFallbackError}}let H=null;!x||_.isDev||I||(H="/index"===(H=P)?"/":H);let q=!0===_.isDev||!x,k=x&&!q;D&&y&&(0,s.setReferenceManifestsSingleton)({page:m,clientReferenceManifest:y,serverActionsManifest:D,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:D})});let F=e.method||"GET",B=(0,a.getTracer)(),V=B.getActiveScopeSpan(),$={params:S,prerenderManifest:C,renderOpts:{experimental:{authInterrupts:!!O.experimental.authInterrupts},cacheComponents:!!O.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:O.cacheLife,waitUntil:o.waitUntil,onClose:e=>{r.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(r,t,o)=>_.onRequestError(e,r,o,L)},sharedContext:{buildId:w}},K=new d.NodeNextRequest(e),j=new d.NodeNextResponse(r),G=c.NextRequestAdapter.fromNodeNextRequest(K,(0,c.signalFromNodeResponse)(r));try{let s=async e=>_.handle(G,$).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let t=B.getRootSpanAttributes();if(!t)return;if(t.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${t.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=t.get("next.route");if(o){let r=`${F} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":r}),e.updateName(r)}else e.updateName(`${F} ${m}`)}),i=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var a,l;let d=async({previousCacheEntry:t})=>{try{if(!i&&U&&v&&!t)return r.statusCode=404,r.setHeader("x-nextjs-cache","REVALIDATED"),r.end("This page could not be found"),null;let a=await s(n);e.fetchMetrics=$.renderOpts.fetchMetrics;let l=$.renderOpts.pendingWaitUntil;l&&o.waitUntil&&(o.waitUntil(l),l=void 0);let d=$.renderOpts.collectedTags;if(!x)return await (0,E.sendResponse)(K,j,a,$.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),r=(0,h.toNodeOutgoingHttpHeaders)(a.headers);d&&(r[R.NEXT_CACHE_TAGS_HEADER]=d),!r["content-type"]&&e.type&&(r["content-type"]=e.type);let t=void 0!==$.renderOpts.collectedRevalidate&&!($.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&$.renderOpts.collectedRevalidate,o=void 0===$.renderOpts.collectedExpire||$.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:$.renderOpts.collectedExpire;return{value:{kind:T.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:r},cacheControl:{revalidate:t,expire:o}}}}catch(r){throw(null==t?void 0:t.isStale)&&await _.onRequestError(e,r,{routerKind:"App Router",routePath:m,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:U})},L),r}},c=await _.handleResponse({req:e,nextConfig:O,cacheKey:H,routeKind:t.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:C,isRoutePPREnabled:!1,isOnDemandRevalidate:U,revalidateOnlyGenerated:v,responseGenerator:d,waitUntil:o.waitUntil,isMinimalMode:i});if(!x)return null;if((null==c||null==(a=c.value)?void 0:a.kind)!==T.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||r.setHeader("x-nextjs-cache",U?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),I&&r.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,h.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&x||u.delete(R.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||r.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,E.sendResponse)(K,j,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};V?await l(V):await B.withPropagatedContext(e.headers,()=>B.trace(u.BaseServerSpan.handleRequest,{spanName:`${F} ${m}`,kind:a.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(r){if(r instanceof A.NoFallbackError||await _.onRequestError(e,r,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:U})}),x)throw r;return await (0,E.sendResponse)(K,j,new Response(null,{status:500})),null}}e.s(["handler",()=>y,"patchFetch",()=>P,"routeModule",()=>_,"serverHooks",()=>v,"workAsyncStorage",()=>L,"workUnitAsyncStorage",()=>U],89124)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_8ad2d4c5.js.map