module.exports=[89124,e=>{"use strict";var r=e.i(47909),t=e.i(74017),o=e.i(96250),a=e.i(59756),n=e.i(61916),s=e.i(14444),i=e.i(10680),l=e.i(69741),d=e.i(16795),u=e.i(87718),c=e.i(95169),p=e.i(47587),E=e.i(66012),h=e.i(70101),g=e.i(26937),R=e.i(10372),A=e.i(93695);e.i(52474);var w=e.i(220),m=e.i(89171),f=e.i(12e3),S=e.i(17939),O=e.i(39142),N=e.i(40911),T=e.i(49632),_=e.i(46469),v=e.i(25686);async function C(e){try{let r,t,o;await (0,v.ensureAuthTables)();try{r=await e.json()}catch(e){throw N.logger.error("JSON parse error:",e),new O.AppError("فرمت درخواست نامعتبر است",400,"INVALID_JSON")}let{name:a,phone:n,password:s}=r||{};if(!a||"string"!=typeof a||""===a.trim())throw new O.AppError("نام الزامی است",400,"MISSING_NAME");if(!n||"string"!=typeof n||""===n.trim())throw new O.AppError("شماره تماس الزامی است",400,"MISSING_PHONE");if(!s||"string"!=typeof s||""===s.trim())throw new O.AppError("رمز عبور الزامی است",400,"MISSING_PASSWORD");try{_.registerSchema.parse({name:a.trim(),phone:n.trim(),password:s})}catch(t){let e=t.errors||[],r=e[0];throw N.logger.warn("Validation error:",{errors:e,input:{name:a,phone:"***"}}),new O.AppError(r?.message||"اطلاعات وارد شده معتبر نیست",400,"VALIDATION_ERROR",e)}let i=(0,_.validateStrongPassword)(s);!i.valid&&i.errors.length>0&&N.logger.warn("Weak password detected:",i.errors);try{t=(0,_.normalizePhone)(n.trim()),N.logger.info("Phone normalized:",{original:n,normalized:t,originalLength:n.length,normalizedLength:t.length})}catch(e){throw N.logger.error("Phone normalization error:",{phone:n,error:e.message}),new O.AppError(e.message||"شماره تماس معتبر نیست. فرمت صحیح: 09123456789",400,"INVALID_PHONE")}if(await (0,f.getRow)("SELECT id, role FROM users WHERE phone = ? AND role = 'admin' LIMIT 1",[t]))throw new O.AppError("این شماره تماس متعلق به ادمین است. لطفاً از صفحه ورود ادمین استفاده کنید",403,"ADMIN_PHONE_NOT_ALLOWED");try{o=await T.default.hash(s,10),N.logger.debug("Password hashed successfully")}catch(e){throw N.logger.error("Password hashing error:",e),new O.AppError("خطا در پردازش رمز عبور",500,"PASSWORD_HASH_ERROR")}let l=`user_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,d=new Date().toISOString().slice(0,19).replace("T"," ");try{await (0,f.runQuery)(`INSERT INTO users (id, name, phone, password, role, enabled, createdAt, updatedAt)
         VALUES (?, ?, ?, ?, 'user', TRUE, ?, ?)`,[l,a.trim(),t,o,d,d]),N.logger.debug("User inserted successfully:",{id:l,phone:t})}catch(e){if(N.logger.error("Error inserting user:",{code:e?.code,message:e?.message,sqlState:e?.sqlState,errno:e?.errno}),e?.code==="ER_DUP_ENTRY"||e?.errno===1062){let r=e?.sqlMessage||e?.message||"",t=r.match(/for key '([^']+)'/i),o=t?.[1]||"";if(/phone/i.test(r)||/uniq_users_phone/i.test(r)||/phone/i.test(o)||/uniq_users_phone/i.test(o))throw new O.AppError("شماره تماس قبلاً ثبت شده است",400,"DUPLICATE_PHONE");throw new O.AppError("خطا: رکورد تکراری (کلید یکتا)",409,"DUPLICATE_KEY")}if(e?.code==="ECONNREFUSED"||e?.code==="ETIMEDOUT"||e?.code==="ECONNRESET"||e?.message?.includes("connect")||e?.message?.includes("timeout"))throw new O.AppError("دیتابیس در دسترس نیست",503,"DATABASE_NOT_AVAILABLE");throw new O.AppError(`خطا در ثبت کاربر: ${e?.message||"خطای نامشخص"}`,500,"USER_INSERT_ERROR")}let u=null;try{u=await (0,f.getRow)("SELECT id, name, phone, role, createdAt FROM users WHERE id = ?",[l])}catch(e){throw N.logger.error("Error selecting created user:",{code:e?.code,message:e?.message,id:l}),new O.AppError("خطا در دریافت اطلاعات کاربر",500,"USER_SELECT_ERROR")}if(!u)throw N.logger.error("User created but not found:",{id:l,phone:t}),new O.AppError("خطا در ایجاد کاربر",500,"USER_CREATION_ERROR");N.logger.info("User registered successfully:",{id:l,phone:n.trim()});let c=await (0,v.createSession)(u.id,e),p=m.NextResponse.json({success:!0,data:{user:{id:u.id,name:u.name,phone:u.phone,createdAt:u.createdAt},message:"ثبت‌نام با موفقیت انجام شد"}});return(0,v.setSessionCookie)(p,c,e),p}catch(r){if(N.logger.error("POST /api/auth/register error:",{message:r?.message,code:r?.code,errno:r?.errno,sqlState:r?.sqlState,stack:void 0}),r instanceof O.AppError)return(0,S.createErrorResponse)(r);if(r?.message?.includes("not available")||r?.code==="DATABASE_NOT_AVAILABLE"||r?.code==="ECONNREFUSED"||r?.code==="ETIMEDOUT"||r?.code==="ECONNRESET"||r?.code==="PROTOCOL_CONNECTION_LOST"||r?.message?.includes("connect")||r?.message?.includes("timeout")||r?.message?.includes("Connection lost"))return(0,S.createErrorResponse)(new O.AppError("دیتابیس در دسترس نیست. لطفاً دوباره تلاش کنید",503,"DATABASE_NOT_AVAILABLE"));if(r?.name==="ZodError"||r?.issues){let e=r?.issues?.[0]||r?.errors?.[0];return(0,S.createErrorResponse)(new O.AppError(e?.message||"اطلاعات وارد شده معتبر نیست",400,"VALIDATION_ERROR"))}let e=r?.message||"خطا در ثبت‌نام. لطفاً دوباره تلاش کنید";return(0,S.createErrorResponse)(new O.AppError(e,500,"REGISTRATION_ERROR",void 0))}}e.s(["POST",()=>C],81450);var I=e.i(81450);let y=new r.AppRouteRouteModule({definition:{kind:t.RouteKind.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/auth/register/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:P,workUnitAsyncStorage:D,serverHooks:x}=y;function U(){return(0,o.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:D})}async function b(e,r,o){y.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let m="/api/auth/register/route";m=m.replace(/\/index$/,"")||"/";let f=await y.prepare(e,r,{srcPage:m,multiZoneDraftMode:!1});if(!f)return r.statusCode=400,r.end("Bad Request"),null==o.waitUntil||o.waitUntil.call(o,Promise.resolve()),null;let{buildId:S,params:O,nextConfig:N,parsedUrl:T,isDraftMode:_,prerenderManifest:v,routerServerContext:C,isOnDemandRevalidate:I,revalidateOnlyGenerated:P,resolvedPathname:D,clientReferenceManifest:x,serverActionsManifest:U}=f,b=(0,l.normalizeAppPath)(m),L=!!(v.dynamicRoutes[b]||v.routes[D]),M=async()=>((null==C?void 0:C.render404)?await C.render404(e,r,T,!1):r.end("This page could not be found"),null);if(L&&!_){let e=!!v.routes[D],r=v.dynamicRoutes[b];if(r&&!1===r.fallback&&!e){if(N.experimental.adapterPath)return await M();throw new A.NoFallbackError}}let H=null;!L||y.isDev||_||(H="/index"===(H=D)?"/":H);let q=!0===y.isDev||!L,k=L&&!q;U&&x&&(0,s.setReferenceManifestsSingleton)({page:m,clientReferenceManifest:x,serverActionsManifest:U,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:U})});let F=e.method||"GET",V=(0,n.getTracer)(),$=V.getActiveScopeSpan(),B={params:O,prerenderManifest:v,renderOpts:{experimental:{authInterrupts:!!N.experimental.authInterrupts},cacheComponents:!!N.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:N.cacheLife,waitUntil:o.waitUntil,onClose:e=>{r.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(r,t,o)=>y.onRequestError(e,r,o,C)},sharedContext:{buildId:S}},j=new d.NodeNextRequest(e),K=new d.NodeNextResponse(r),W=u.NextRequestAdapter.fromNodeNextRequest(j,(0,u.signalFromNodeResponse)(r));try{let s=async e=>y.handle(W,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":r.statusCode,"next.rsc":!1});let t=V.getRootSpanAttributes();if(!t)return;if(t.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${t.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let o=t.get("next.route");if(o){let r=`${F} ${o}`;e.setAttributes({"next.route":o,"http.route":o,"next.span_name":r}),e.updateName(r)}else e.updateName(`${F} ${m}`)}),i=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var n,l;let d=async({previousCacheEntry:t})=>{try{if(!i&&I&&P&&!t)return r.statusCode=404,r.setHeader("x-nextjs-cache","REVALIDATED"),r.end("This page could not be found"),null;let n=await s(a);e.fetchMetrics=B.renderOpts.fetchMetrics;let l=B.renderOpts.pendingWaitUntil;l&&o.waitUntil&&(o.waitUntil(l),l=void 0);let d=B.renderOpts.collectedTags;if(!L)return await (0,E.sendResponse)(j,K,n,B.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),r=(0,h.toNodeOutgoingHttpHeaders)(n.headers);d&&(r[R.NEXT_CACHE_TAGS_HEADER]=d),!r["content-type"]&&e.type&&(r["content-type"]=e.type);let t=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,o=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:w.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:r},cacheControl:{revalidate:t,expire:o}}}}catch(r){throw(null==t?void 0:t.isStale)&&await y.onRequestError(e,r,{routerKind:"App Router",routePath:m,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:I})},C),r}},u=await y.handleResponse({req:e,nextConfig:N,cacheKey:H,routeKind:t.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:v,isRoutePPREnabled:!1,isOnDemandRevalidate:I,revalidateOnlyGenerated:P,responseGenerator:d,waitUntil:o.waitUntil,isMinimalMode:i});if(!L)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==w.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||r.setHeader("x-nextjs-cache",I?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),_&&r.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,h.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&L||c.delete(R.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||r.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,g.getCacheControlHeader)(u.cacheControl)),await (0,E.sendResponse)(j,K,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};$?await l($):await V.withPropagatedContext(e.headers,()=>V.trace(c.BaseServerSpan.handleRequest,{spanName:`${F} ${m}`,kind:n.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(r){if(r instanceof A.NoFallbackError||await y.onRequestError(e,r,{routerKind:"App Router",routePath:b,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:I})}),L)throw r;return await (0,E.sendResponse)(j,K,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>U,"routeModule",()=>y,"serverHooks",()=>x,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>D],89124)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_8ad2d4c5.js.map