module.exports=[81585,e=>{"use strict";var t=e.i(47909),r=e.i(74017),s=e.i(96250),o=e.i(59756),a=e.i(61916),n=e.i(14444),i=e.i(10680),l=e.i(69741),d=e.i(16795),u=e.i(87718),p=e.i(95169),c=e.i(47587),h=e.i(66012),g=e.i(70101),m=e.i(26937),R=e.i(10372),E=e.i(93695);e.i(52474);var A=e.i(220),f=e.i(12e3),S=e.i(17939),w=e.i(39142),N=e.i(25686);async function y(e){try{let{searchParams:t}=new URL(e.url),r=t.get("orderNumber"),s=await (0,N.getSessionUserFromRequest)(e),o=s?.role==="admin",a=s?.id||null,n=e.headers.get("cookie"),i=e.cookies.getAll();if(console.log("[GET /api/orders] Session check:",{hasSessionUser:!!s,userId:a,isAdmin:o,role:s?.role,sessionUserId:s?.id,sessionUserRole:s?.role,enabled:s?.enabled,cookieHeader:n?n.substring(0,200):"no cookie header",cookieCount:i.length,cookieNames:i.map(e=>e.name)}),!s){let t=e.headers.get("x-user-id");if(t){console.log("[GET /api/orders] Using userId from header (fallback):",t);let e=await (0,f.getRow)("SELECT id, name, phone, role, enabled, createdAt FROM users WHERE id = ?",[t]);e&&e.enabled&&(s={id:e.id,name:e.name,phone:e.phone,role:e.role||"user",enabled:!!e.enabled,createdAt:e.createdAt||new Date().toISOString()},o="admin"===s.role,a=s.id,console.log("[GET /api/orders] Fallback user found:",a))}}let l="SELECT * FROM orders",d=[],u=[];if(r)u.push("(`orderNumber` = ? OR id = ?)"),d.push(r,r);else if(!o)if(a)u.push("`userId` = ?"),d.push(String(a));else throw new w.AppError("برای مشاهده سفارش‌ها باید وارد حساب کاربری خود شوید",401,"UNAUTHORIZED");u.length>0&&(l+=" WHERE "+u.join(" AND ")),l+=" ORDER BY `createdAt` DESC",console.log("[GET /api/orders] Query:",l),console.log("[GET /api/orders] Params:",d),console.log("[GET /api/orders] User context:",{userId:a,isAdmin:o,hasSession:!!s});let p=await (0,f.getRows)("SELECT id, orderNumber, userId, customerName, customerPhone, status, paymentStatus, createdAt FROM orders ORDER BY createdAt DESC LIMIT 10");console.log("[GET /api/orders] DEBUG - All orders in DB (first 10):",p.length),p.forEach((e,t)=>{console.log(`  [${t+1}] Order ${e.orderNumber}: userId=${null===e.userId?"NULL":`"${e.userId}"`} (type: ${typeof e.userId}), customer=${e.customerName}, phone=${e.customerPhone}`)});let c=await (0,f.getRows)(l,d.length>0?d:void 0);console.log("[GET /api/orders] Found orders after filter:",c.length),c.length>0?console.log("[GET /api/orders] First order userId:",c[0]?.userId,"type:",typeof c[0]?.userId):p.length>0&&a&&(console.log("[GET /api/orders] ⚠️ WARNING: Orders exist in DB but none match userId filter!"),console.log("[GET /api/orders] ⚠️ Searching userId:",a,"type:",typeof a),console.log("[GET /api/orders] ⚠️ Session user phone:",s?.phone),p.forEach(e=>{if(e.userId){let t=String(e.userId)===String(a),r=s?.phone&&e.customerPhone&&String(e.customerPhone).replace(/\D/g,"")===String(s.phone).replace(/\D/g,"");console.log(`  - Order ${e.orderNumber}: userId="${e.userId}" (match: ${t}), phone="${e.customerPhone}" (match: ${r})`)}else if(s?.phone){let t=e.customerPhone&&String(e.customerPhone).replace(/\D/g,"")===String(s.phone).replace(/\D/g,"");console.log(`  - Order ${e.orderNumber}: userId=NULL, phone="${e.customerPhone}" (match: ${t})`)}}));let h=c.map(e=>({...e,items:Array.isArray(e.items)?e.items:"string"==typeof e.items?JSON.parse(e.items):[],shippingAddress:"object"==typeof e.shippingAddress&&null!==e.shippingAddress?e.shippingAddress:"string"==typeof e.shippingAddress?JSON.parse(e.shippingAddress):{},total:Number(e.total),shippingCost:Number(e.shippingCost),createdAt:e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt),updatedAt:e.updatedAt instanceof Date?e.updatedAt:new Date(e.updatedAt)}));return(0,S.createSuccessResponse)(h,200,{page:1,limit:h.length,total:h.length,totalPages:1})}catch(e){return(0,S.createErrorResponse)(e)}}async function T(e){try{let t=await e.json().catch(()=>({}))||{},r=await (0,N.getSessionUserFromRequest)(e),s=r?.role==="admin",o=r?.id||null;console.log("[POST /api/orders] Session check:",{hasSessionUser:!!r,userId:o,isAdmin:s,role:r?.role,sessionUserId:r?.id,sessionUserRole:r?.role});let a="SELECT * FROM orders WHERE 1=1",n=[];if(!s)if(o)a+=" AND `userId` = ?",n.push(String(o));else throw new w.AppError("برای مشاهده سفارش‌ها باید وارد حساب کاربری خود شوید",401,"UNAUTHORIZED");if(t.status&&t.status.length>0&&(a+=` AND status IN (${t.status.map(()=>"?").join(",")})`,n.push(...t.status)),t.paymentStatus&&t.paymentStatus.length>0&&(a+=` AND \`paymentStatus\` IN (${t.paymentStatus.map(()=>"?").join(",")})`,n.push(...t.paymentStatus)),t.search){a+=" AND (`orderNumber` LIKE ? OR `customerName` LIKE ? OR `customerPhone` LIKE ?)";let e=`%${t.search}%`;n.push(e,e,e)}t.dateFrom&&(a+=" AND `createdAt` >= ?",n.push(t.dateFrom.toISOString())),t.dateTo&&(a+=" AND `createdAt` <= ?",n.push(t.dateTo.toISOString())),a+=" ORDER BY `createdAt` DESC",console.log("[POST /api/orders] Query:",a),console.log("[POST /api/orders] Params:",n),console.log("[POST /api/orders] User context:",{userId:o,isAdmin:s,hasSession:!!r});let i=await (0,f.getRows)(a,n);console.log("[POST /api/orders] Found orders:",i.length),i.length>0&&console.log("[POST /api/orders] First order userId:",i[0]?.userId,"type:",typeof i[0]?.userId);let l=i.map(e=>({...e,items:Array.isArray(e.items)?e.items:"string"==typeof e.items?JSON.parse(e.items):[],shippingAddress:"object"==typeof e.shippingAddress&&null!==e.shippingAddress?e.shippingAddress:"string"==typeof e.shippingAddress?JSON.parse(e.shippingAddress):{},total:Number(e.total),shippingCost:Number(e.shippingCost),createdAt:e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt),updatedAt:e.updatedAt instanceof Date?e.updatedAt:new Date(e.updatedAt)}));return(0,S.createSuccessResponse)(l,200,{page:1,limit:l.length,total:l.length,totalPages:1})}catch(e){return(0,S.createErrorResponse)(e)}}e.s(["GET",()=>y,"POST",()=>T],48035);var I=e.i(48035);let O=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/orders/route",pathname:"/api/orders",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/orders/route.ts",nextConfigOutput:"",userland:I}),{workAsyncStorage:v,workUnitAsyncStorage:C,serverHooks:b}=O;function D(){return(0,s.patchFetch)({workAsyncStorage:v,workUnitAsyncStorage:C})}async function P(e,t,s){O.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/orders/route";f=f.replace(/\/index$/,"")||"/";let S=await O.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!S)return t.statusCode=400,t.end("Bad Request"),null==s.waitUntil||s.waitUntil.call(s,Promise.resolve()),null;let{buildId:w,params:N,nextConfig:y,parsedUrl:T,isDraftMode:I,prerenderManifest:v,routerServerContext:C,isOnDemandRevalidate:b,revalidateOnlyGenerated:D,resolvedPathname:P,clientReferenceManifest:x,serverActionsManifest:U}=S,$=(0,l.normalizeAppPath)(f),k=!!(v.dynamicRoutes[$]||v.routes[P]),H=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,T,!1):t.end("This page could not be found"),null);if(k&&!I){let e=!!v.routes[P],t=v.dynamicRoutes[$];if(t&&!1===t.fallback&&!e){if(y.experimental.adapterPath)return await H();throw new E.NoFallbackError}}let F=null;!k||O.isDev||I||(F="/index"===(F=P)?"/":F);let M=!0===O.isDev||!k,_=k&&!M;U&&x&&(0,n.setReferenceManifestsSingleton)({page:f,clientReferenceManifest:x,serverActionsManifest:U,serverModuleMap:(0,i.createServerModuleMap)({serverActionsManifest:U})});let G=e.method||"GET",L=(0,a.getTracer)(),q=L.getActiveScopeSpan(),j={params:N,prerenderManifest:v,renderOpts:{experimental:{authInterrupts:!!y.experimental.authInterrupts},cacheComponents:!!y.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:y.cacheLife,waitUntil:s.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s)=>O.onRequestError(e,t,s,C)},sharedContext:{buildId:w}},B=new d.NodeNextRequest(e),K=new d.NodeNextResponse(t),W=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let n=async e=>O.handle(W,j).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=L.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${G} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${G} ${f}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var a,l;let d=async({previousCacheEntry:r})=>{try{if(!i&&b&&D&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await n(o);e.fetchMetrics=j.renderOpts.fetchMetrics;let l=j.renderOpts.pendingWaitUntil;l&&s.waitUntil&&(s.waitUntil(l),l=void 0);let d=j.renderOpts.collectedTags;if(!k)return await (0,h.sendResponse)(B,K,a,j.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(a.headers);d&&(t[R.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==j.renderOpts.collectedRevalidate&&!(j.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&j.renderOpts.collectedRevalidate,s=void 0===j.renderOpts.collectedExpire||j.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:j.renderOpts.collectedExpire;return{value:{kind:A.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==r?void 0:r.isStale)&&await O.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:b})},C),t}},u=await O.handleResponse({req:e,nextConfig:y,cacheKey:F,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:v,isRoutePPREnabled:!1,isOnDemandRevalidate:b,revalidateOnlyGenerated:D,responseGenerator:d,waitUntil:s.waitUntil,isMinimalMode:i});if(!k)return null;if((null==u||null==(a=u.value)?void 0:a.kind)!==A.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",b?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return i&&k||p.delete(R.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,m.getCacheControlHeader)(u.cacheControl)),await (0,h.sendResponse)(B,K,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};q?await l(q):await L.withPropagatedContext(e.headers,()=>L.trace(p.BaseServerSpan.handleRequest,{spanName:`${G} ${f}`,kind:a.SpanKind.SERVER,attributes:{"http.method":G,"http.target":e.url}},l))}catch(t){if(t instanceof E.NoFallbackError||await O.onRequestError(e,t,{routerKind:"App Router",routePath:$,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:_,isOnDemandRevalidate:b})}),k)throw t;return await (0,h.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>P,"patchFetch",()=>D,"routeModule",()=>O,"serverHooks",()=>b,"workAsyncStorage",()=>v,"workUnitAsyncStorage",()=>C],81585)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_947b242c.js.map