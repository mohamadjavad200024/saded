module.exports=[298,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(53071),e=a.i(40695),f=a.i(5522),g=a.i(45222),h=a.i(87532),i=a.i(46842),j=a.i(63519),k=a.i(33508),l=a.i(96221),m=a.i(5784),n=a.i(46271),o=a.i(62036),p=a.i(77687),q=a.i(42964),r=a.i(9655),s=a.i(62478),t=a.i(54161),u=a.i(54917),v=a.i(20610),w=a.i(4720),x=a.i(24987),y=a.i(4975),z=a.i(23808),A=a.i(10448),B=a.i(81560),C=a.i(79360),D=a.i(76504);function E({message:a,index:c,totalMessages:d,onReply:f,onEdit:g,onDelete:h}){return(0,b.jsx)(n.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},transition:{duration:.2,ease:"easeOut"},className:`flex ${"user"===a.sender?"justify-end":"justify-start"} items-end gap-2 group`,children:(0,b.jsxs)("div",{className:`max-w-[85%] sm:max-w-[75%] md:max-w-[70%] rounded-lg px-2.5 sm:px-3 py-2 transition-all ${"user"===a.sender?"bg-primary text-primary-foreground":"bg-muted text-foreground border border-border/40"}`,children:[a.text&&(0,b.jsx)("p",{className:"text-xs sm:text-sm leading-relaxed whitespace-pre-wrap break-words mb-1.5",children:a.text}),a.attachments&&a.attachments.length>0&&(0,b.jsx)("div",{className:`space-y-2 ${a.text?"mt-2":""}`,children:a.attachments.map((a,c)=>(0,b.jsxs)("div",{className:"rounded overflow-hidden",children:["image"===a.type&&a.url&&(0,b.jsx)("img",{src:a.url,alt:a.name||"تصویر",className:"max-w-full max-h-[150px] sm:max-h-[180px] rounded cursor-pointer hover:opacity-90 transition-all",onClick:()=>window.open(a.url,"_blank")}),"file"===a.type&&(0,b.jsxs)("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",download:a.name,className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,b.jsx)(w.FileText,{className:"h-3.5 w-3.5"}),(0,b.jsx)("span",{className:"font-medium truncate",children:a.name||"فایل"})]}),"location"===a.type&&(0,b.jsxs)("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,b.jsx)(x.MapPin,{className:"h-3.5 w-3.5"}),(0,b.jsx)("span",{className:"font-medium",children:a.name||"موقعیت"})]}),"audio"===a.type&&a.url&&(0,b.jsxs)("div",{className:"flex items-center gap-2 p-2 bg-background/50 rounded",children:[(0,b.jsx)(y.Mic,{className:"h-3.5 w-3.5"}),(0,b.jsx)("audio",{controls:!0,className:"flex-1 h-7 text-xs",children:(0,b.jsx)("source",{src:a.url})})]})]},a.id||c))}),(0,b.jsxs)("div",{className:`flex items-center gap-1.5 mt-1.5 pt-1.5 border-t ${"user"===a.sender?"border-primary-foreground/20 justify-end":"border-border/30 justify-start"}`,children:[(0,b.jsx)("span",{className:`text-[10px] sm:text-xs ${"user"===a.sender?"text-primary-foreground/70":"text-muted-foreground"}`,children:new Date(a.timestamp).toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}),a.status&&"user"===a.sender&&(0,b.jsx)(v.CheckCheck,{className:`h-3 w-3 ${"read"===a.status?"text-primary-foreground/70":"text-primary-foreground/40"}`}),(0,b.jsx)("div",{className:"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity",children:(f||g||h)&&(0,b.jsxs)(D.DropdownMenu,{children:[(0,b.jsx)(D.DropdownMenuTrigger,{asChild:!0,children:(0,b.jsx)(e.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 hover:bg-background/20",onClick:a=>{a.stopPropagation()},title:"گزینه‌های بیشتر",children:(0,b.jsx)(C.MoreVertical,{className:"h-3.5 w-3.5"})})}),(0,b.jsxs)(D.DropdownMenuContent,{align:"user"===a.sender?"end":"start",className:"min-w-[140px]",onClick:a=>a.stopPropagation(),children:[f&&(0,b.jsxs)(D.DropdownMenuItem,{onClick:b=>{b.stopPropagation(),f(a)},className:"cursor-pointer",children:[(0,b.jsx)(z.Reply,{className:"h-4 w-4 ml-2"}),(0,b.jsx)("span",{children:"پاسخ"})]}),g&&"user"===a.sender&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(D.DropdownMenuSeparator,{}),(0,b.jsxs)(D.DropdownMenuItem,{onClick:b=>{b.stopPropagation(),g(a)},className:"cursor-pointer",children:[(0,b.jsx)(A.Edit2,{className:"h-4 w-4 ml-2"}),(0,b.jsx)("span",{children:"ویرایش"})]})]}),h&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(D.DropdownMenuSeparator,{}),(0,b.jsxs)(D.DropdownMenuItem,{onClick:b=>{b.stopPropagation(),confirm("آیا مطمئن هستید که می‌خواهید این پیام را حذف کنید؟")&&h(a.id)},className:"cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10",children:[(0,b.jsx)(B.Trash2,{className:"h-4 w-4 ml-2"}),(0,b.jsx)("span",{children:"حذف"})]})]})]})]})})]})]})},a.id)}var F=a.i(46893),G=a.i(92759),H=a.i(38632),I=a.i(83952),J=a.i(48124);function K({message:a,onMessageChange:c,onSend:d,isSending:f,attachments:g,onRemoveAttachment:h,showAttachmentOptions:i,onToggleAttachmentOptions:j,isRecording:m,recordingTime:p,audioUrl:q,onStartRecording:r,onStopRecording:s,onCancelRecording:t,onSaveRecording:u,formatTime:v,imageInputRef:z,fileInputRef:A,onFileSelect:B,onLocationShare:C,onCheckMicrophonePermission:D,toast:E}){return(0,b.jsxs)("div",{className:"border-t border-border/40 p-2 sm:p-3 bg-background",children:[(m||q)&&(0,b.jsx)(n.motion.div,{initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},className:"flex items-center gap-2 p-2 mb-2 bg-destructive/10 border border-destructive/30 rounded-lg",children:m?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(n.motion.div,{animate:{scale:[1,1.1,1]},transition:{repeat:1/0,duration:1},className:"p-1.5 rounded-full bg-destructive/20",children:(0,b.jsx)(y.Mic,{className:"h-3.5 w-3.5 text-destructive"})}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("p",{className:"text-xs font-medium text-destructive leading-tight",children:"در حال ضبط"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground font-mono",children:v(p)})]}),(0,b.jsx)(e.Button,{variant:"ghost",size:"icon",onClick:s,className:"h-7 w-7 text-destructive hover:bg-destructive/10 rounded-lg",children:(0,b.jsx)(J.Square,{className:"h-3 w-3 fill-current"})})]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("div",{className:"p-1.5 rounded-full bg-primary/20",children:(0,b.jsx)(y.Mic,{className:"h-3.5 w-3.5 text-primary"})}),(0,b.jsxs)("div",{className:"flex-1",children:[(0,b.jsx)("p",{className:"text-xs font-medium leading-tight",children:"پیام صوتی آماده است"}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground font-mono",children:v(p)})]}),(0,b.jsx)(e.Button,{variant:"ghost",size:"icon",onClick:t,className:"h-7 w-7 text-muted-foreground hover:text-destructive rounded-lg",children:(0,b.jsx)(k.X,{className:"h-3.5 w-3.5"})}),(0,b.jsx)(e.Button,{onClick:u,size:"sm",className:"h-7 px-3 text-xs rounded-lg",children:"ذخیره"})]})}),(0,b.jsx)("div",{className:"flex items-end gap-2",children:(0,b.jsxs)("div",{className:"flex-1 relative",children:[g.length>0&&(0,b.jsx)("div",{className:"absolute top-2 right-2 left-2 z-10 pointer-events-none overflow-hidden",children:(0,b.jsx)("div",{className:"overflow-x-auto overflow-y-hidden scroll-smooth w-full [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]",children:(0,b.jsx)("div",{className:"flex items-center gap-1.5 flex-nowrap",children:g.map(a=>(0,b.jsxs)("div",{className:"relative group pointer-events-auto flex-shrink-0 w-auto",children:[(0,b.jsxs)("div",{className:"bg-card/95 backdrop-blur-sm rounded-md p-1 border border-border/40 shadow-sm",children:["image"===a.type&&a.url&&(0,b.jsx)("img",{src:a.url,alt:a.name||"تصویر",className:"w-10 h-10 object-cover rounded"}),"file"===a.type&&(0,b.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,b.jsx)(w.FileText,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,b.jsx)("p",{className:"text-[10px] truncate max-w-[50px] font-medium leading-tight",children:a.name})]}),"location"===a.type&&(0,b.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,b.jsx)(x.MapPin,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,b.jsx)("span",{className:"text-[10px] font-medium whitespace-nowrap leading-tight",children:"موقعیت"})]}),"audio"===a.type&&(0,b.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,b.jsx)(y.Mic,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,b.jsx)("span",{className:"text-[10px] font-medium whitespace-nowrap leading-tight",children:a.duration?v(a.duration):"صدا"})]})]}),(0,b.jsx)("button",{onClick:()=>h(a.id),className:"absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm z-20 hover:scale-110",children:(0,b.jsx)(k.X,{className:"h-2.5 w-2.5"})})]},a.id))})})}),(0,b.jsx)(F.Textarea,{value:a,onChange:c,onKeyDown:b=>{"Enter"===b.key&&!b.shiftKey&&(b.preventDefault(),(a.trim()||g.length>0)&&d())},placeholder:"پیام خود را بنویسید...",className:`min-h-[44px] max-h-[100px] resize-none text-sm leading-relaxed rounded-lg border pr-20 pl-3 py-2 ${g.length>0?"pt-12":""}`}),(0,b.jsx)(o.AnimatePresence,{children:i&&(0,b.jsxs)(n.motion.div,{initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},className:"absolute bottom-full right-0 mb-2 flex gap-2 p-2 bg-card rounded-lg border border-border/50 shadow-lg z-10",children:[(0,b.jsx)(e.Button,{variant:"ghost",size:"icon",onClick:()=>{z.current?.click(),j()},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",disabled:m,children:(0,b.jsx)(H.Image,{className:"h-3.5 w-3.5"})}),(0,b.jsx)(e.Button,{variant:"ghost",size:"icon",onClick:()=>{A.current?.click(),j()},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",disabled:m,children:(0,b.jsx)(w.FileText,{className:"h-3.5 w-3.5"})}),(0,b.jsx)(e.Button,{variant:"ghost",size:"icon",onClick:C,className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",disabled:m,children:(0,b.jsx)(x.MapPin,{className:"h-3.5 w-3.5"})}),(0,b.jsx)(e.Button,{variant:"ghost",size:"icon",onClick:async()=>{j(),m?s():(await D()||E({title:"نیاز به دسترسی میکروفون",description:"برای ضبط صدا، لطفاً دسترسی میکروفون را در تنظیمات مرورگر فعال کنید.",variant:"destructive",duration:5e3}),r())},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",disabled:m,children:m?(0,b.jsx)(y.Mic,{className:"h-3.5 w-3.5 text-destructive"}):(0,b.jsx)(y.Mic,{className:"h-3.5 w-3.5"})})]})}),(0,b.jsx)("input",{ref:z,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:a=>B(a,"image")}),(0,b.jsx)("input",{ref:A,type:"file",multiple:!0,className:"hidden",onChange:a=>B(a,"file")}),(0,b.jsxs)("div",{className:"absolute bottom-2 right-2 flex items-center gap-1",children:[(0,b.jsx)(e.Button,{variant:"ghost",size:"icon",onClick:j,className:`h-7 w-7 rounded-lg transition-all ${i?"bg-primary/10 text-primary":"hover:bg-muted/60 text-muted-foreground hover:text-foreground"}`,children:(0,b.jsx)(I.Paperclip,{className:"h-4 w-4"})}),(a.trim()||g.length>0)&&!m&&(0,b.jsx)(b.Fragment,{children:f?(0,b.jsx)(l.Loader2,{className:"h-4 w-4 text-primary animate-spin"}):(0,b.jsx)(e.Button,{onClick:d,size:"icon",className:"h-7 w-7 rounded-lg transition-all",children:(0,b.jsx)(G.Send,{className:"h-3.5 w-3.5"})})})]})]})})]})}function L({isOpen:a,onOpenChange:v}){let{toast:w}=(0,p.useToast)(),{setOnline:x,isOnline:y}=(0,q.useAdminPresence)({enabled:!0,heartbeatInterval:15e3}),[z,A]=(0,c.useState)([]),[B,C]=(0,c.useState)(null),[D,F]=(0,c.useState)([]),[G,H]=(0,c.useState)(!1),[I,J]=(0,c.useState)(""),[L,M]=(0,c.useState)(!1),[N,O]=(0,c.useState)(null),[P,Q]=(0,c.useState)(null),R=(0,c.useRef)(null),S=(0,c.useRef)(null),T=(0,c.useRef)(null),U=(0,c.useRef)(null),[V,W]=(0,c.useState)(!1),X=function(){let{toast:a}=(0,p.useToast)(),[b,d]=(0,c.useState)([]),[e,f]=(0,c.useState)(!1),[g,h]=(0,c.useState)(0),[i,j]=(0,c.useState)(null),[k,l]=(0,c.useState)(null),[m,n]=(0,c.useState)(!1),o=(0,c.useRef)(null),q=(0,c.useRef)([]),r=(0,c.useRef)(null),s=(0,c.useRef)(null),t=(0,c.useRef)(null),v=(0,c.useCallback)(async(b,c,d=0)=>{try{let a=new FormData;a.append("file",b),a.append("type",c);let d=await fetch("/api/chat/upload",{method:"POST",body:a});if(!d.ok){let a=await d.json().catch(()=>({error:"خطا در آپلود فایل"}));throw Error(a.error||"خطا در آپلود فایل")}return(await d.json()).data.url}catch(e){if(d<3&&(e.message?.includes("fetch")||e.message?.includes("network")||e.message?.includes("timeout")||"NETWORK_ERROR"===e.code||"TypeError"===e.name)){let e=2e3*Math.pow(2,d);return 0===d&&a({title:"در حال تلاش مجدد...",description:"خطا در آپلود فایل. در حال تلاش مجدد...",duration:2e3}),await new Promise(a=>setTimeout(a,e)),v(b,c,d+1)}throw a({title:"خطا در آپلود فایل",description:e.message||"لطفاً دوباره تلاش کنید",variant:"destructive"}),e}},[a]),w=(0,c.useCallback)(async(a,b)=>{let c=a.target.files;if(c&&0!==c.length){for(let a of Array.from(c))try{let c=await v(a,b),e={id:Date.now().toString()+Math.random(),type:b,name:a.name,size:a.size,url:c};d(a=>[...a,e])}catch(a){}a.target.value=""}},[v]),x=(0,c.useCallback)(a=>{d(b=>b.filter(b=>b.id!==a))},[]),y=(0,c.useCallback)(()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(a=>{let b={id:Date.now().toString(),type:"location",url:`https://www.google.com/maps?q=${a.coords.latitude},${a.coords.longitude}`,name:"موقعیت مکانی"};d(a=>[...a,b]),n(!1)},b=>{u.logger.error("Error getting location:",b),a({title:"خطا",description:"خطا در دریافت موقعیت مکانی",variant:"destructive"})}):a({title:"خطا",description:"مرورگر شما از موقعیت مکانی پشتیبانی نمی‌کند",variant:"destructive"})},[a]),z=(0,c.useCallback)(async()=>{try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(a=>a.stop()),!0}catch(a){return!1}},[]),A=(0,c.useCallback)(async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void a({title:"مرورگر شما پشتیبانی نمی‌کند",description:"مرورگر شما از ضبط صدا پشتیبانی نمی‌کند. لطفاً از مرورگر جدیدتری استفاده کنید.",variant:"destructive"});let b=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),c=new MediaRecorder(b,{mimeType:MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":MediaRecorder.isTypeSupported("audio/mp4")?"audio/mp4":"audio/webm"});o.current=c,q.current=[],c.ondataavailable=a=>{a.data.size>0&&q.current.push(a.data)},c.onstop=()=>{let a=new Blob(q.current,{type:c.mimeType||"audio/webm"});j(a);let d=URL.createObjectURL(a);l(d),b.getTracks().forEach(a=>a.stop())},c.onerror=b=>{u.logger.error("MediaRecorder error:",b),a({title:"خطا در ضبط صدا",description:"خطایی در هنگام ضبط صدا رخ داد. لطفاً دوباره تلاش کنید.",variant:"destructive"}),B()},c.start(),f(!0),h(0),n(!1),r.current=setInterval(()=>{h(a=>a+1)},1e3),a({title:"ضبط صدا شروع شد",description:"در حال ضبط پیام صوتی..."})}catch(d){let b="دسترسی به میکروفون مجاز نیست.",c="";"NotAllowedError"===d.name||"PermissionDeniedError"===d.name?(b="دسترسی به میکروفون رد شد",c="لطفاً در تنظیمات مرورگر خود، دسترسی میکروفون را فعال کنید."):"NotFoundError"===d.name||"DevicesNotFoundError"===d.name?(b="میکروفون یافت نشد",c="لطفاً مطمئن شوید که میکروفون به دستگاه شما متصل است."):"NotReadableError"===d.name||"TrackStartError"===d.name?(b="میکروفون در حال استفاده است",c="میکروفون توسط برنامه دیگری استفاده می‌شود. لطفاً آن را ببندید."):c="لطفاً دوباره تلاش کنید یا صفحه را رفرش کنید.",a({title:b,description:c,variant:"destructive",duration:5e3})}},[a]),B=(0,c.useCallback)(()=>{if(o.current&&"inactive"!==o.current.state)try{o.current.stop(),f(!1),r.current&&clearInterval(r.current),a({title:"ضبط صدا متوقف شد",description:"پیام صوتی شما آماده است. می‌توانید آن را ذخیره یا لغو کنید."})}catch(b){u.logger.error("Error stopping recording:",b),a({title:"خطا",description:"خطایی در توقف ضبط رخ داد.",variant:"destructive"})}},[a]),C=(0,c.useCallback)(()=>{B(),j(null),k&&(URL.revokeObjectURL(k),l(null)),h(0)},[k,B]),D=(0,c.useCallback)(async()=>{if(i&&k)try{let a="webm",b=i.type||"audio/webm";b.includes("mp4")||b.includes("m4a")?a="m4a":b.includes("ogg")?a="ogg":b.includes("wav")&&(a="wav");let c=new File([i],`audio-${Date.now()}.${a}`,{type:b}),e=await v(c,"audio"),f={id:Date.now().toString(),type:"audio",url:e,name:`پیام صوتی ${E(g)}`,size:i.size,duration:g};return d(a=>[...a,f]),j(null),k&&URL.revokeObjectURL(k),l(null),h(0),f}catch(a){}return null},[i,k,g,v]),E=(0,c.useCallback)(a=>{let b=Math.floor(a/60);return`${b}:${(a%60).toString().padStart(2,"0")}`},[]);return{attachments:b,setAttachments:d,isRecording:e,recordingTime:g,audioBlob:i,audioUrl:k,showAttachmentOptions:m,setShowAttachmentOptions:n,uploadFile:v,handleFileSelect:w,handleRemoveAttachment:x,handleLocationShare:y,startRecording:A,stopRecording:B,cancelRecording:C,saveRecording:D,formatTime:E,formatFileSize:(0,c.useCallback)(a=>a<1024?a+" B":a<1048576?(a/1024).toFixed(1)+" KB":(a/1048576).toFixed(1)+" MB",[]),checkMicrophonePermission:z,imageInputRef:s,fileInputRef:t}}(),Y=function({chatId:a,sender:b,customerInfo:d,onMessageSent:e}){let{toast:f}=(0,p.useToast)(),[g,h]=(0,c.useState)(""),[i,j]=(0,c.useState)(!1),[k,l]=(0,c.useState)(!1),m=(0,c.useRef)(null),n=(0,c.useRef)(null),o=(0,c.useCallback)(async c=>{if(a)try{await fetch("/api/chat/typing",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:a,sender:b,isTyping:c})})}catch(a){u.logger.error("Error sending typing status:",a)}},[a,b]),q=(0,c.useCallback)(b=>{h(b.target.value),a&&(m.current&&clearTimeout(m.current),b.target.value.trim().length>0?(o(!0),m.current=setTimeout(()=>{o(!1)},2e3)):o(!1))},[a,o]),r=(0,c.useCallback)(async()=>{if(a)try{let c=await fetch(`/api/chat/typing?chatId=${a}&sender=${"user"===b?"support":"user"}`);if(c.ok){let a=await c.json();a.success&&l(a.data.isTyping||!1)}}catch(a){u.logger.error("Error checking typing status:",a)}},[a,b]);(0,c.useEffect)(()=>{if(!a){l(!1),n.current&&(clearInterval(n.current),n.current=null);return}return r(),n.current=setInterval(()=>{r()},2e3),()=>{n.current&&(clearInterval(n.current),n.current=null),m.current&&(clearTimeout(m.current),m.current=null),o(!1)}},[a,r,o]);let s=(0,c.useCallback)(async(c,g=[])=>{if(!c.trim()&&0===g.length||!a)return null;let h=g.filter(a=>{let b=a.url;return b&&!b.startsWith("blob:")&&!b.startsWith("data:")&&(b.startsWith("http")||b.startsWith("/"))});if(!c.trim()&&0===h.length)return f({title:"خطا",description:"لطفاً یک پیام یا فایل معتبر اضافه کنید",variant:"destructive"}),null;let i={id:`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,text:c,sender:b,timestamp:new Date,attachments:h.length>0?h:void 0};try{j(!0),m.current&&clearTimeout(m.current),o(!1);let b={chatId:a,messages:[{id:i.id,text:i.text,sender:i.sender,timestamp:i.timestamp.toISOString(),attachments:i.attachments||[]}]};if(d&&(b.customerInfo=d),!(await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(b)})).ok)throw Error("خطا در ارسال پیام");return e&&e(),i}catch(a){return u.logger.error("Error sending message:",a),f({title:"خطا",description:"خطا در ارسال پیام",variant:"destructive"}),null}finally{j(!1)}},[a,b,d,f,e,o]),t=(0,c.useCallback)(async(a=[],b)=>{let c=g;b&&(c=`در پاسخ به: ${b.text}

${g}`);let d=await s(c,a);return d?(h(""),d):null},[g,s]);return{message:g,setMessage:h,isSending:i,isTyping:k,handleMessageChange:q,sendMessage:s,handleSend:t}}({chatId:B?.id||null,sender:"support",customerInfo:B?{name:B.customerName,phone:B.customerPhone,email:B.customerEmail}:void 0,onMessageSent:()=>{Z(),B&&_(B.id,!1)}}),Z=(0,c.useCallback)(async(a=!0)=>{try{a&&H(!0);let b=await fetch("/api/chat");if(!b.ok)throw Error("خطا در بارگذاری چت‌ها");let c=await b.json();if(c.success&&c.data.chats){let a=await Promise.all(c.data.chats.map(async a=>{try{let b=await fetch(`/api/chat?chatId=${a.id}`);if(b.ok){let c=await b.json();if(c.success&&c.data.messages){let b=c.data.messages,d=b[b.length-1];return{...a,lastMessage:d?.text||"",lastMessageTime:d?.createdAt||a.updatedAt,unreadCount:a.unreadCount||0}}}}catch(a){u.logger.error("Error loading last message:",a)}return{...a,unreadCount:a.unreadCount||0}}));A(a)}}catch(b){u.logger.error("Error loading chats:",b),a&&w({title:"خطا",description:"خطا در بارگذاری چت‌ها",variant:"destructive"})}finally{a&&H(!1)}},[w]),$=(0,c.useCallback)(async()=>{try{let a=await fetch("/api/chat");if(!a.ok)return;let b=await a.json();if(b.success&&b.data.chats){let a=b.data.chats.map(async a=>{try{let b=await fetch(`/api/chat?chatId=${a.id}`);if(b.ok){let c=await b.json();if(c.success&&c.data.messages){let b=c.data.messages,d=b[b.length-1];return{...a,lastMessage:d?.text||"",lastMessageTime:d?.createdAt||a.updatedAt,unreadCount:a.unreadCount||0}}}}catch(a){}return{...a,unreadCount:a.unreadCount||0}}),c=(await Promise.allSettled(a)).filter(a=>"fulfilled"===a.status).map(a=>a.value);A(a=>{let b=new Map(c.map(a=>[a.id,a])),d=new Set(a.map(a=>a.id)),e=a.map(a=>{let c=b.get(a.id);return c&&(c.unreadCount!==a.unreadCount||c.lastMessage!==a.lastMessage||c.lastMessageTime!==a.lastMessageTime)?{...a,...c}:a});return c.forEach(a=>{d.has(a.id)||e.push(a)}),e})}}catch(a){}},[]),_=(0,c.useCallback)(async(a,b=!1)=>{try{b&&H(!0);let c=`/api/chat?chatId=${a}`;!b&&T.current&&(c+=`&lastMessageId=${T.current}`);let d=await fetch(c);if(!d.ok)throw Error("خطا در بارگذاری پیام‌ها");let e=await d.json();if(e.success&&e.data.messages){let a=e.data.messages.map(a=>{let b=[];if(a.attachments){if(Array.isArray(a.attachments))b=a.attachments;else if("string"==typeof a.attachments)try{let c=JSON.parse(a.attachments);b=Array.isArray(c)?c:[c]}catch(a){u.logger.error("Error parsing attachments:",a)}}return{id:a.id,text:a.text||"",sender:a.sender,timestamp:new Date(a.createdAt),attachments:b,status:a.status||("user"===a.sender?"sent":void 0)}});if(B)try{let a=await fetch(`/api/chat/unread-count?chatId=${B.id}`);if(a.ok){let b=await a.json();if(b.success&&b.data){let a=b.data.unreadCount||0;A(b=>b.map(b=>b.id===B.id?{...b,unreadCount:a}:b))}}}catch(a){}b?(F(a),a.length>0&&(T.current=a[a.length-1].id)):F(b=>{let c=new Set(b.map(a=>a.id)),d=a.filter(a=>!c.has(a.id));return d.length>0?(T.current=d[d.length-1].id,[...b,...d]):b})}}catch(a){u.logger.error("Error loading messages:",a),b&&w({title:"خطا",description:"خطا در بارگذاری پیام‌ها",variant:"destructive"})}finally{b&&H(!1)}},[B,w]),aa=(0,c.useCallback)(async a=>{try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:a,sender:"support",action:"delivered"})})}catch(a){}},[]),ab=(0,c.useCallback)(async a=>{try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:a,sender:"support",action:"read"})})}catch(a){}},[]),ac=(0,c.useCallback)(async a=>{C(a),T.current=null,ab(a.id).catch(()=>{}),aa(a.id),_(a.id,!0),A(b=>b.map(b=>b.id===a.id?{...b,unreadCount:0}:b))},[_,ab,aa]),ad=(0,c.useCallback)(async()=>{if(B)try{let a=await fetch(`/api/chat/typing?chatId=${B.id}&sender=user`);if(a.ok){let b=await a.json();b.success&&M(b.data.isTyping||!1)}}catch(a){}},[B]),ae=(0,c.useCallback)(a=>{O(a),Q(null)},[]),af=(0,c.useCallback)(a=>{Q(a),O(null),Y.handleMessageChange({target:{value:a.text||""}})},[Y]),ag=(0,c.useCallback)(async a=>{if(B)try{if((await fetch(`/api/chat/message/${a}`,{method:"DELETE"})).ok)F(b=>b.filter(b=>b.id!==a)),w({title:"موفق",description:"پیام با موفقیت حذف شد"});else throw Error("خطا در حذف پیام")}catch(a){u.logger.error("Error deleting message:",a),w({title:"خطا",description:"خطا در حذف پیام",variant:"destructive"})}},[B,w]),ah=(0,c.useCallback)(async()=>{if(!B)return;if(P){try{(await fetch(`/api/chat/message/${P.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:Y.message,attachments:X.attachments})})).ok&&(F(a=>a.map(a=>a.id===P.id?{...a,text:Y.message,attachments:X.attachments}:a)),Q(null),Y.handleMessageChange({target:{value:""}}),X.setAttachments([]),w({title:"موفق",description:"پیام ویرایش شد"}))}catch(a){u.logger.error("Error editing message:",a),w({title:"خطا",description:"خطا در ویرایش پیام",variant:"destructive"})}return}let a=await Y.handleSend(X.attachments,N);a&&(F(b=>[...b,a]),X.setAttachments([]),X.setShowAttachmentOptions(!1),O(null),setTimeout(()=>{aj(!1),setTimeout(()=>{ai()},500)},150),X.audioBlob&&X.audioUrl&&await X.saveRecording())},[B,Y,X,P,N,w]),ai=(0,c.useCallback)(()=>{if(!S.current||!B)return void W(!1);let a=S.current;W(a.scrollHeight-a.scrollTop-a.clientHeight>150)},[B]),aj=(0,c.useCallback)((a=!1)=>{R.current&&(R.current.scrollIntoView({behavior:a?"auto":"smooth",block:"end"}),setTimeout(()=>{W(!1)},300))},[]);(0,c.useEffect)(()=>{let a=S.current;if(!a||!B)return void W(!1);let b=()=>{ai()};return a.addEventListener("scroll",b,{passive:!0}),ai(),setTimeout(()=>{ai()},100),()=>{a.removeEventListener("scroll",b)}},[B,ai,D.length]);let ak=(0,c.useRef)(!1);(0,c.useEffect)(()=>{if(B&&D.length>0&&!ak.current){ak.current=!0;let a=setTimeout(()=>{aj(!0),setTimeout(()=>{ai()},500)},200);return()=>clearTimeout(a)}B||(ak.current=!1)},[B,D.length,aj,ai]),(0,c.useEffect)(()=>{if(D.length>0&&B){let a=setTimeout(()=>{ai()},200);return()=>clearTimeout(a)}},[D.length,ai,B]),(0,c.useEffect)(()=>{if(!B||!a){M(!1),U.current&&(clearInterval(U.current),U.current=null);return}aa(B.id),ab(B.id).catch(()=>{}),ad(),U.current=setInterval(()=>{ad()},3e3);let b=setInterval(()=>{_(B.id,!1),aa(B.id),ab(B.id).catch(()=>{})},5e3);return()=>{clearInterval(b),U.current&&(clearInterval(U.current),U.current=null)}},[B,a,ad,_,aa,ab]),(0,c.useEffect)(()=>{if(a){Z(!0),C(null),F([]),x(!0);let a=setInterval(()=>{$()},15e3);return()=>{clearInterval(a)}}x(!1)},[a,x,$,Z]),(0,c.useEffect)(()=>{let b=async b=>{let{chatId:c}=b.detail;c&&(a||v(!0),setTimeout(async()=>{0===z.length&&await Z();let a=z.find(a=>a.id===c);if(a)ac(a);else try{let a=await fetch(`/api/chat?chatId=${c}`);if(a.ok){let b=await a.json();if(b.success&&b.data){let a={id:b.data.id,customerName:b.data.customerName||"کاربر",customerPhone:b.data.customerPhone||"",status:b.data.status||"active",createdAt:b.data.createdAt||new Date().toISOString(),updatedAt:b.data.updatedAt||new Date().toISOString(),lastMessage:b.data.lastMessage||"",lastMessageTime:b.data.lastMessageTime};ac(a)}}}catch(a){u.logger.error("Error loading chat:",a)}},300))};return window.addEventListener("openChat",b),()=>{window.removeEventListener("openChat",b)}},[a,z,v,Z,ac]),(0,c.useEffect)(()=>{},[]);let al=z.filter(a=>a.customerName.toLowerCase().includes(I.toLowerCase())||a.customerPhone.includes(I));return(0,b.jsx)(d.Sheet,{open:a,onOpenChange:v,"data-admin-chat-open":a?"true":"false","data-selected-chat-id":B?.id||"",children:(0,b.jsx)(d.SheetContent,{side:"left",className:"w-full sm:w-[500px] md:w-[600px] p-0 flex flex-col shadow-2xl !h-screen !max-h-screen overflow-hidden",children:B?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(d.SheetHeader,{className:"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b border-border/40 px-4 sm:px-6 py-2",children:(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(e.Button,{variant:"ghost",size:"icon",onClick:async()=>{C(null),F([]),T.current=null,await Z()},className:"h-8 w-8 rounded-lg hover:bg-muted/60 transition-all",children:(0,b.jsx)(k.X,{className:"h-4 w-4"})}),(0,b.jsx)("div",{className:"flex-1 min-w-0",children:(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsx)(d.SheetTitle,{className:"text-base font-semibold truncate",children:B.customerName}),(0,b.jsx)(r.OnlineStatusBadge,{isOnline:y,showText:!1})]})})]})}),(0,b.jsxs)("div",{ref:S,className:"flex-1 min-h-0 overflow-y-auto p-4 sm:p-5 md:p-6 space-y-4 sm:space-y-5 bg-gradient-to-b from-background via-background to-muted/5",children:[G?(0,b.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,b.jsx)(l.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):0===D.length?(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center px-6",children:[(0,b.jsx)(g.MessageCircle,{className:"h-14 w-14 text-muted-foreground/50 mb-5"}),(0,b.jsx)("p",{className:"text-muted-foreground text-base font-medium leading-relaxed",children:"هنوز پیامی ارسال نشده است"})]}):(0,b.jsxs)(b.Fragment,{children:[D.map((a,c)=>(0,b.jsx)(E,{message:a,index:c,totalMessages:D.length,onReply:ae,onEdit:af,onDelete:ag},a.id)),L&&(0,b.jsx)(n.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"flex justify-start items-end gap-2.5",children:(0,b.jsx)(s.TypingIndicator,{})})]}),(0,b.jsx)("div",{ref:R})]}),(0,b.jsxs)("div",{className:"sticky bottom-0 z-10 bg-background/95 backdrop-blur-sm border-t border-border/40 flex-shrink-0 relative pb-safe",style:{paddingBottom:"max(0.5rem, env(safe-area-inset-bottom))"},children:[(0,b.jsx)(o.AnimatePresence,{children:V&&(0,b.jsx)(n.motion.div,{initial:{opacity:0,y:10,scale:.9},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.9},className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 z-10",children:(0,b.jsx)(e.Button,{onClick:()=>aj(!1),size:"icon",className:"h-9 w-9 rounded-full shadow-lg hover:shadow-xl bg-primary text-primary-foreground hover:bg-primary/90 transition-all",title:"برو به آخرین پیام",children:(0,b.jsx)(m.ChevronDown,{className:"h-4 w-4"})})})}),(0,b.jsx)(K,{message:Y.message,onMessageChange:Y.handleMessageChange,onSend:ah,isSending:Y.isSending,attachments:X.attachments,onRemoveAttachment:X.handleRemoveAttachment,showAttachmentOptions:X.showAttachmentOptions,onToggleAttachmentOptions:()=>X.setShowAttachmentOptions(!X.showAttachmentOptions),isRecording:X.isRecording,recordingTime:X.recordingTime,audioUrl:X.audioUrl,onStartRecording:X.startRecording,onStopRecording:X.stopRecording,onCancelRecording:X.cancelRecording,onSaveRecording:async()=>{let a=await X.saveRecording();a&&X.setAttachments(b=>[...b,a])},formatTime:X.formatTime,imageInputRef:X.imageInputRef,fileInputRef:X.fileInputRef,onFileSelect:X.handleFileSelect,onLocationShare:X.handleLocationShare,onCheckMicrophonePermission:X.checkMicrophonePermission,toast:w})]})]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)(d.SheetHeader,{className:"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b border-border/40 px-4 sm:px-6 py-2",children:[(0,b.jsxs)(d.SheetTitle,{className:"flex items-center gap-2 text-base font-semibold",children:[(0,b.jsx)(g.MessageCircle,{className:"h-5 w-5"}),"چت‌های کاربران"]}),(0,b.jsx)("div",{className:"mt-2",children:(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)(h.Search,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,b.jsx)(f.Input,{type:"search",placeholder:"جستجوی کاربر...",value:I,onChange:a=>J(a.target.value),className:"pr-10 h-9 text-sm border rounded-lg"})]})})]}),(0,b.jsx)("div",{className:"flex-1 min-h-0 overflow-y-auto bg-gradient-to-b from-background to-muted/5",children:G?(0,b.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,b.jsx)(l.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):0===al.length?(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center px-6",children:[(0,b.jsx)(g.MessageCircle,{className:"h-14 w-14 text-muted-foreground/50 mb-5"}),(0,b.jsx)("p",{className:"text-muted-foreground text-base font-medium leading-relaxed",children:"چتی یافت نشد"})]}):(0,b.jsx)("div",{className:"divide-y divide-border/50",children:al.map(a=>(0,b.jsx)(n.motion.button,{onClick:()=>ac(a),className:`w-full p-5 text-right hover:bg-muted/50 transition-all duration-200 rounded-lg ${a.unreadCount&&a.unreadCount>0?"bg-primary/5 border-r-4 border-primary shadow-md":"hover:shadow-sm"}`,whileHover:{backgroundColor:a.unreadCount&&a.unreadCount>0?"rgba(var(--primary), 0.1)":"rgba(0,0,0,0.05)"},initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.2},children:(0,b.jsxs)("div",{className:"flex items-start gap-4",children:[(0,b.jsx)("div",{className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0 shadow-md border-2 border-primary/30",children:(0,b.jsx)(i.User,{className:"h-5 w-5 sm:h-6 sm:w-6 text-primary"})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2.5 flex-1 min-w-0",children:[(0,b.jsx)("p",{className:`font-semibold text-sm sm:text-base truncate leading-tight ${a.unreadCount&&a.unreadCount>0?"font-bold":""}`,children:a.customerName}),a.unreadCount&&a.unreadCount>0&&(0,b.jsx)(n.motion.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:15},children:(0,b.jsx)(t.Badge,{variant:"destructive",className:"h-6 w-6 px-0 text-xs font-bold flex-shrink-0 shadow-lg animate-pulse flex items-center justify-center",children:"!"})})]}),a.lastMessageTime&&(0,b.jsx)("span",{className:"text-xs text-muted-foreground flex-shrink-0 mr-2 font-medium",children:new Date(a.lastMessageTime).toLocaleDateString("fa-IR",{month:"short",day:"numeric"})})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2.5 text-sm text-muted-foreground mb-1.5",children:[(0,b.jsx)(j.Phone,{className:"h-4 w-4"}),(0,b.jsx)("span",{className:"font-medium",children:a.customerPhone})]}),a.lastMessage&&(0,b.jsx)("p",{className:"text-sm text-muted-foreground mt-2 truncate leading-relaxed",children:a.lastMessage})]})]})},a.id))})})]})})})}a.s(["AdminChat",()=>L],298)}];

//# sourceMappingURL=components_admin_admin-chat_tsx_95bb9762._.js.map