module.exports=[57576,a=>{"use strict";var b=a.i(84280),c=a.i(80794),d=a.i(99209),e=a.i(54917);function f({isUser:a=!1,chatId:f,onNewMessage:g}){let{showNotification:h}=(0,c.useNotifications)(),{showMessageNotification:i}=(0,d.usePersistentNotifications)(),j=(0,b.useRef)({isOnline:!1,lastChecked:0}),k=(0,b.useRef)(null),l=(0,b.useRef)(null),m=(0,b.useRef)(0),n=(0,b.useRef)(new Set),o=(0,b.useRef)(new Map),p=(0,b.useRef)(new Map);(0,b.useEffect)(()=>{},[a,f]);let q=(0,b.useCallback)(async()=>{try{let a=Date.now();if(a-j.current.lastChecked<5e3)return j.current.isOnline;let b=await fetch("/api/admin/presence");if(!b.ok)return!1;let c=await b.json();if(c.success&&c.data?.admins&&Array.isArray(c.data.admins)){let b=c.data.admins.length>0;return j.current={isOnline:b,lastChecked:a},b}return!1}catch(a){return e.logger.error("Error checking admin status:",a),!1}},[]),r=(0,b.useCallback)(async()=>{try{let b,c,d="";if(a){if(!f)return;d=`/api/chat?chatId=${f}`,l.current&&"1"!==l.current&&(d+=`&lastMessageId=${l.current}`)}else d="/api/chat";try{let a=new AbortController,c=setTimeout(()=>a.abort(),1e4);b=await fetch(d,{signal:a.signal}),clearTimeout(c)}catch(a){a instanceof Error&&"AbortError"!==a.name&&e.logger.warn("[Chat Polling] Network error (will retry):",a.message);return}if(!b.ok){if(429===b.status){let a=b.headers.get("Retry-After");a&&parseInt(a,10);return}b.status;return}try{c=await b.json()}catch(a){e.logger.error("Error parsing chat response:",a);return}if(a){if(c.success&&c.data?.messages&&Array.isArray(c.data.messages)){let a=c.data.messages,b=a.filter(a=>"support"===a.sender&&!n.current.has(a.id));if(b.length>0){let d=b[b.length-1],j=d.text||"پیام جدید دریافت شد",k=j.length>50?j.substring(0,50)+"...":j;b.forEach(a=>{n.current.add(a.id)});let m=a.map(a=>a.id);m.length>0&&(l.current=m[m.length-1]);let r=await q();{let a=`user-${f}-${d.id}`,b=Date.now(),j=p.current.get(a)||0;if(b-j<5e3){e.logger.debug(`[User Notification] ⏭️ Skipping duplicate notification for ${f}`),g&&g(d,c.data.chat);return}let l=o.current.get(a);l&&clearTimeout(l);let m=setTimeout(()=>{e.logger.debug("New support message detected, showing notification:",k),p.current.set(a,Date.now()),h({title:"پیام جدید از پشتیبانی",body:k,tag:`support-${d.id}`,requireInteraction:!1,sound:!0}).catch(a=>{e.logger.error("[User Notification] Error showing browser notification:",a)}),i("پشتیبانی",k,{onOpen:()=>{g&&g(d)},chatId:f||void 0,metadata:{messageId:d.id,chatId:f,isAdminOffline:!r,isAdmin:!1}}),o.current.delete(a)},300);o.current.set(a,m)}g&&g(d,c.data.chat)}else if(a.length>0){let b=a[a.length-1].id;b!==l.current&&(l.current=b)}}}else if(c.success&&c.data?.chats&&Array.isArray(c.data.chats)){let a=c.data.chats;for(let b of(e.logger.debug(`[Admin Polling] ✅ Polling active - Checking ${a.length} chats for new messages`),a))try{let a,c=m.current>0?m.current:Date.now()-6e4,d=new Date(c).toISOString();try{let c=new AbortController,e=setTimeout(()=>c.abort(),5e3);a=await fetch(`/api/chat?chatId=${b.id}&since=${d}`,{signal:c.signal}),clearTimeout(e)}catch(a){continue}if(!a.ok){a.status;continue}let f=await a.json();if(f.success&&f.data?.messages&&Array.isArray(f.data.messages)){let a=f.data.messages;e.logger.debug(`[Admin Polling] Chat ${b.id} (${b.customerName}): Found ${a.length} total messages`);let d=a.filter(a=>{let b="user"===a.sender,d=!n.current.has(a.id),f=new Date(a.createdAt).getTime()>c;return f&&!b&&e.logger.debug(`[Admin Polling] Skipping message from ${a.sender} (only user messages trigger notifications)`),b&&d&&f});if(e.logger.debug(`[Admin Polling] Chat ${b.id}: Found ${d.length} new user messages (received from user)`),a.filter(a=>"support"===a.sender&&new Date(a.createdAt).getTime()>c).length,d.length>0){let a=d[d.length-1];if("user"!==a.sender){e.logger.warn(`[Admin Notification] ⚠️ Skipping notification - message sender is "${a.sender}", expected "user"`),n.current.add(a.id);continue}if(n.current.has(a.id)){e.logger.debug(`[Admin Notification] Message ${a.id} already processed, skipping`);continue}e.logger.debug(`[Admin Notification] Chat ${b.id} (${b.customerName}): isOpen=false, messageId=${a.id}`);let c=`admin-${b.id}-${a.id}`,f=Date.now(),h=p.current.get(c)||0;if(f-h<5e3){e.logger.debug(`[Admin Notification] ⏭️ Skipping duplicate notification for chat ${b.id} (shown ${Math.round((f-h)/1e3)}s ago)`),n.current.add(a.id),g&&g(a,b);continue}n.current.add(a.id),g&&g(a,b)}}else e.logger.warn(`[Admin Polling] Chat ${b.id}: Invalid response format`,f)}catch(a){e.logger.error(`[Admin Polling] Error polling chat ${b.id}:`,a)}m.current=Date.now(),e.logger.debug(`[Admin Polling] ✅ Polling completed, next poll in 3 seconds`)}else e.logger.warn("[Admin Polling] Invalid response format or no chats found",c)}catch(a){}},[a,f,h,i,g,q]);return(0,b.useEffect)(()=>{if(a){let a=f||null;if(!a)return void e.logger.debug("Global polling: No chatId found, skipping polling");e.logger.debug("Global polling: Starting polling for chatId:",a)}else e.logger.debug("Global polling: Starting admin polling");return e.logger.debug("[Admin Polling] Starting initial poll..."),r(),k.current=setInterval(()=>{r()},5e3),()=>{k.current&&(clearInterval(k.current),k.current=null),o.current.forEach(a=>clearTimeout(a)),o.current.clear()}},[r,a,f]),{stopPolling:()=>{k.current&&(clearInterval(k.current),k.current=null),o.current.forEach(a=>clearTimeout(a)),o.current.clear()}}}a.s(["useGlobalChatPolling",()=>f])},9924,a=>{"use strict";let b=(0,a.i(60600).default)("Bell",[["path",{d:"M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9",key:"1qo2s2"}],["path",{d:"M10.3 21a1.94 1.94 0 0 0 3.4 0",key:"qgo35s"}]]);a.s(["Bell",()=>b],9924)},26621,30877,a=>{"use strict";var b=a.i(17163),c=a.i(84280),d=a.i(19349),e=a.i(89033),f=a.i(14218),g=a.i(96822),h=a.i(40391),i=a.i(9924),j=a.i(26271),k=a.i(86947),l=a.i(24116),m=a.i(40695),n=a.i(54161),o=a.i(97895);function p({notification:a,onConfirm:p,onDismiss:q,onMarkAsRead:r}){var s;let t,u,v,w=(a=>{switch(a){case"message":return e.MessageCircle;case"order":return k.ShoppingCart;case"alert":return g.AlertCircle;case"system":return h.Info;default:return i.Bell}})(a.type),[x,y]=c.useState(!1);return(0,b.jsx)(d.motion.div,{initial:{opacity:0,y:-50,scale:.95,x:20},animate:{opacity:1,y:0,scale:1,x:0},exit:{opacity:0,y:-20,scale:.95,x:20,transition:{duration:.2}},whileHover:{scale:1.02,y:-2},transition:{type:"spring",stiffness:300,damping:25},className:(0,o.cn)("relative w-full max-w-lg sm:max-w-xl pointer-events-auto",!a.read&&"ring-2 ring-primary/40 shadow-lg"),onAnimationComplete:()=>{"urgent"!==a.priority&&"message"!==a.type||x||y(!0)},children:(0,b.jsxs)(d.motion.div,{className:(0,o.cn)("group relative w-full rounded-lg sm:rounded-xl py-2 px-2.5 sm:py-3 sm:px-4 shadow-sm sm:shadow-lg backdrop-blur-sm sm:backdrop-blur-md transition-all duration-300 cursor-pointer border","urgent"===a.priority?"bg-gradient-to-br from-red-50/95 via-background to-red-50/60 dark:from-red-950/30 dark:via-background dark:to-red-950/15 border-red-200/50 dark:border-red-800/30 hover:border-red-300 dark:hover:border-red-700":"high"===a.priority?"bg-gradient-to-br from-orange-50/60 via-background to-orange-50/40 dark:from-orange-950/15 dark:via-background dark:to-orange-950/8 border-orange-200/40 dark:border-orange-800/20 hover:border-orange-300 dark:hover:border-orange-700":"bg-gradient-to-br from-background via-background to-primary/8 border-border/50 hover:border-primary/30",!a.read&&"shadow-md hover:shadow-lg"),onClick:()=>{p&&p(),a.onConfirm&&a.onConfirm(),r&&r()},whileHover:{boxShadow:"0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)"},children:[(0,b.jsx)("div",{className:(0,o.cn)("absolute top-0 right-0 left-0 h-0.5 sm:h-1 rounded-t-lg sm:rounded-t-xl",(a=>{switch(a){case"urgent":return"bg-red-500";case"high":return"bg-orange-500";case"medium":default:return"bg-blue-500";case"low":return"bg-gray-500"}})(a.priority))}),!a.read&&(0,b.jsx)(d.motion.div,{className:"absolute top-1.5 left-1.5 sm:top-2 sm:left-2 w-2 h-2 sm:w-2.5 sm:h-2.5 rounded-full bg-primary shadow-lg",animate:{scale:[1,1.3,1],opacity:[1,.7,1]},transition:{repeat:1/0,duration:2},children:(0,b.jsx)(d.motion.div,{className:"absolute inset-0 rounded-full bg-primary/50",animate:{scale:[1,2,2],opacity:[.5,0,0]},transition:{repeat:1/0,duration:2}})}),(0,b.jsxs)("div",{className:"flex items-start gap-1.5 sm:gap-3",children:[(0,b.jsxs)(d.motion.div,{className:"relative flex-shrink-0",initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.1},children:[a.avatar?(0,b.jsxs)(d.motion.div,{className:"relative w-7 h-7 sm:w-10 sm:h-10 rounded-full overflow-hidden ring-2 ring-primary/30 shadow-md",whileHover:{scale:1.1},transition:{type:"spring",stiffness:400,damping:17},children:[(0,b.jsx)("img",{src:a.avatar,alt:a.sender||a.title,className:"w-full h-full object-cover"}),!a.read&&(0,b.jsx)(d.motion.div,{className:"absolute -bottom-0.5 -right-0.5 w-3 h-3 sm:w-3.5 sm:h-3.5 bg-green-500 rounded-full border-2 border-background",initial:{scale:0},animate:{scale:1},transition:{delay:.2}})]}):(0,b.jsx)(d.motion.div,{className:(0,o.cn)("w-7 h-7 sm:w-10 sm:h-10 rounded-full flex items-center justify-center shadow-md ring-2 ring-primary/20","message"===a.type?"bg-gradient-to-br from-primary/25 via-primary/20 to-accent/25":"order"===a.type?"bg-gradient-to-br from-green-500/25 via-green-500/20 to-green-400/25":"bg-gradient-to-br from-blue-500/25 via-blue-500/20 to-blue-400/25"),whileHover:{scale:1.1,rotate:5},transition:{type:"spring",stiffness:400,damping:17},children:(0,b.jsx)(w,{className:"h-3.5 w-3.5 sm:h-5 sm:w-5 text-primary"})}),"urgent"===a.priority&&(0,b.jsx)(d.motion.div,{className:"absolute -top-0.5 -right-0.5 sm:-top-1 sm:-right-1 w-4 h-4 sm:w-5 sm:h-5 bg-red-500 rounded-full border border-background sm:border-2 shadow-md sm:shadow-lg flex items-center justify-center",animate:{scale:[1,1.2,1]},transition:{repeat:1/0,duration:1},children:(0,b.jsx)(i.Bell,{className:"h-2.5 w-2.5 sm:h-3 sm:w-3 text-white"})})]}),(0,b.jsx)("div",{className:"flex-1 min-w-0 space-y-1 sm:space-y-2",children:(0,b.jsxs)("div",{className:"flex items-start justify-between gap-1 sm:gap-2",children:[(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex items-center gap-1 sm:gap-1.5 mb-0.5 sm:mb-1 flex-wrap",children:[(0,b.jsx)("h4",{className:"text-xs sm:text-sm font-semibold text-foreground truncate",children:a.title}),(0,b.jsx)(n.Badge,{variant:(a=>{switch(a){case"urgent":return"destructive";case"high":return"secondary";default:return"default"}})(a.priority),className:"text-[9px] sm:text-[10px] px-1 sm:px-1.5 py-0 h-4 sm:h-5",children:"urgent"===a.priority?"فوری":"high"===a.priority?"مهم":"medium"===a.priority?"متوسط":"کم"})]}),a.sender&&(0,b.jsxs)("p",{className:"text-[9px] sm:text-[10px] text-muted-foreground mb-0.5 sm:mb-1 flex items-center gap-0.5 sm:gap-1",children:[(0,b.jsx)(j.User,{className:"h-2 w-2 sm:h-2.5 sm:w-2.5"}),a.sender]}),(0,b.jsx)(d.motion.p,{className:(0,o.cn)("text-[10px] sm:text-xs text-muted-foreground leading-tight sm:leading-relaxed transition-all duration-300",x?"line-clamp-none":"line-clamp-2"),initial:{opacity:.8},animate:{opacity:1},transition:{delay:.1},children:a.message}),(0,b.jsxs)("div",{className:"flex items-center gap-1 sm:gap-1.5 mt-0.5 sm:mt-1 text-[9px] sm:text-[10px] text-muted-foreground",children:[(0,b.jsx)(l.Clock,{className:"h-2 w-2 sm:h-2.5 sm:w-2.5"}),(0,b.jsx)("span",{children:(s=a.timestamp,v=Math.floor((u=Math.floor((t=Math.floor((Date.now()-s)/1e3))/60))/60),t<60?"همین الان":u<60?`${u} دقیقه پیش`:v<24?`${v} ساعت پیش`:new Date(s).toLocaleDateString("fa-IR",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}))})]})]}),(0,b.jsx)(d.motion.div,{whileHover:{scale:1.1},whileTap:{scale:.9},children:(0,b.jsx)(m.Button,{variant:"ghost",size:"icon",onClick:b=>{b.stopPropagation(),q&&q(),a.onDismiss&&a.onDismiss()},className:"h-5 w-5 sm:h-7 sm:w-7 rounded-full hover:bg-destructive/10 hover:text-destructive flex-shrink-0 transition-colors",children:(0,b.jsx)(f.X,{className:"h-2.5 w-2.5 sm:h-3.5 sm:w-3.5"})})})]})})]}),(0,b.jsx)("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/3 sm:from-primary/5 via-transparent to-accent/3 sm:to-accent/5 pointer-events-none rounded-lg sm:rounded-xl"}),"urgent"===a.priority&&(0,b.jsx)(d.motion.div,{className:"absolute inset-0 rounded-lg sm:rounded-xl border border-red-500/20 sm:border-2 sm:border-red-500/30",animate:{opacity:[.5,1,.5],scale:[1,1.02,1]},transition:{repeat:1/0,duration:2}})]})})}var q=a.i(65840),r=a.i(99209);function s({position:a="top-right",maxNotifications:e=5,className:f}){let g,{notifications:h,markAsRead:j,markAllAsRead:k,dismissNotification:l,unreadCount:m}=(0,r.usePersistentNotifications)(),[s,t]=c.useState(null);c.useEffect(()=>{let a=()=>{};a();let b=b=>{"admin_selected_chat_id"===b.key&&a()},c=a=>{a.detail?.chatId&&t(a.detail.chatId)},d=()=>{t(null)};window.addEventListener("storage",b),window.addEventListener("openChat",c),window.addEventListener("chatOpened",a=>{a.detail?.chatId&&t(a.detail.chatId)}),window.addEventListener("closeChat",d),window.addEventListener("chatClosed",d);let e=setInterval(a,500);return()=>{window.removeEventListener("storage",b),window.removeEventListener("openChat",c),window.removeEventListener("closeChat",d),clearInterval(e)}},[]);let u=h.filter(a=>!!a.persistent&&!a.dismissed&&(!(a.metadata?.isAdmin&&a.metadata?.chatId)||!s||a.metadata.chatId!==s)).sort((a,b)=>{if(a.read!==b.read)return a.read?1:-1;let c={urgent:4,high:3,medium:2,low:1},d=(c[b.priority]||0)-(c[a.priority]||0);return 0!==d?d:b.timestamp-a.timestamp}).slice(0,e);return 0===u.length?null:(0,b.jsxs)("div",{className:(0,o.cn)("fixed z-[9999] pointer-events-none flex flex-col gap-2 sm:gap-3",{"top-right":"top-4 right-4","top-left":"top-4 left-4","bottom-right":"bottom-4 right-4","bottom-left":"bottom-4 left-4"}[a],f),children:[(0,b.jsx)(q.AnimatePresence,{mode:"popLayout",children:u.map((c,e)=>(0,b.jsx)(d.motion.div,{layout:!0,initial:{opacity:0,scale:.8,y:-20,x:a.includes("right")?20:-20},animate:{opacity:1,scale:1,y:0,x:0},exit:{opacity:0,scale:.8,y:-20,x:a.includes("right")?20:-20,transition:{duration:.2}},transition:{type:"spring",stiffness:300,damping:25,delay:.05*e},className:"pointer-events-auto",children:(0,b.jsx)(p,{notification:c,onConfirm:()=>{if(c.metadata?.chatId){let a=new CustomEvent("openChat",{detail:{chatId:c.metadata.chatId,isAdmin:!1!==c.metadata.isAdmin}});window.dispatchEvent(a)}c.onConfirm&&c.onConfirm(),j(c.id),l(c.id)},onDismiss:()=>{l(c.id)},onMarkAsRead:()=>{j(c.id)}})},c.id))}),(g=u.filter(a=>!a.read).length)>0?(0,b.jsx)(d.motion.div,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},exit:{scale:0,rotate:180},transition:{type:"spring",stiffness:300,damping:20},className:(0,o.cn)("fixed pointer-events-none z-[10000]","top-right"===a?"top-2 right-2":"top-left"===a?"top-2 left-2":"bottom-right"===a?"bottom-2 right-2":"bottom-2 left-2"),children:(0,b.jsxs)(n.Badge,{variant:"destructive",className:"h-6 px-2 text-xs font-bold shadow-lg flex items-center gap-1.5 animate-pulse",children:[(0,b.jsx)(i.Bell,{className:"h-3 w-3"}),g]})}):null]})}a.s(["NotificationCenter",()=>s],30877),a.s([],26621)},16591,65602,a=>{"use strict";var b,c=a.i(17163),d=a.i(84280),e=a.i(96822),f=a.i(42261),g=a.i(97895);let h=(0,f.cva)("relative w-full rounded-lg border p-4 [&>svg~*]:pr-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:right-4 [&>svg]:top-4 [&>svg]:text-foreground",{variants:{variant:{default:"bg-background text-foreground",destructive:"border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive bg-destructive/10",warning:"border-yellow-500/50 text-yellow-700 dark:text-yellow-400 dark:border-yellow-400 [&>svg]:text-yellow-600 dark:[&>svg]:text-yellow-400 bg-yellow-50 dark:bg-yellow-950/20"}},defaultVariants:{variant:"default"}}),i=d.forwardRef(({className:a,variant:b,...d},e)=>(0,c.jsx)("div",{ref:e,role:"alert",className:(0,g.cn)(h({variant:b}),a),...d}));i.displayName="Alert";let j=d.forwardRef(({className:a,...b},d)=>(0,c.jsx)("h5",{ref:d,className:(0,g.cn)("mb-1 font-medium leading-none tracking-tight",a),...b}));j.displayName="AlertTitle";let k=d.forwardRef(({className:a,...b},d)=>(0,c.jsx)("div",{ref:d,className:(0,g.cn)("text-sm [&_p]:leading-relaxed",a),...b}));k.displayName="AlertDescription",a.s(["Alert",()=>i,"AlertDescription",()=>k,"AlertTitle",()=>j],65602);var l=a.i(40695);let m=new class{isDevelopment=!1;isProduction=!0;shouldLog(a){return"error"===a||"warn"===a||this.isDevelopment}log(...a){this.shouldLog("log")&&console.log(...a)}error(...a){console.error(...a)}warn(...a){console.warn(...a)}info(...a){this.shouldLog("info")&&console.info(...a)}debug(...a){this.shouldLog("debug")&&console.debug(...a)}dbQuery(a,b){this.isDevelopment&&console.log("[DB Query]",a.substring(0,100),b?`[${b.length} params]`:"")}apiRequest(a,b,c){this.isDevelopment&&console.log(`[API] ${a} ${b}${c?` ${c}`:""}`)}};class n extends Error{status;code;details;constructor(a,b,c,d){super(a),this.name="AppError",this.status=b,this.code=c,this.details=d,Object.setPrototypeOf(this,n.prototype)}}(b={}).TIMEOUT="TIMEOUT",b.NETWORK="NETWORK",b.ABORTED="ABORTED",b.UNKNOWN="UNKNOWN";class o extends Error{type;originalError;constructor(a,b="UNKNOWN",c){super(a),this.name="NetworkError",this.type=b,this.originalError=c,Object.setPrototypeOf(this,o.prototype)}}class p extends d.default.Component{constructor(a){super(a),this.state={hasError:!1,error:null}}static getDerivedStateFromError(a){return{hasError:!0,error:a}}componentDidCatch(a,b){let c,d;c=a instanceof n?{message:a.message,status:a.status,code:a.code,details:a.details}:a instanceof o?{message:a.message,code:a.type,details:a.originalError}:a instanceof Error?{message:a.message}:"string"==typeof a?{message:a}:{message:"خطای نامشخص رخ داد"},d="[ErrorBoundary] ",m.error(`${d}${c.message}`,{status:c.status,code:c.code,details:c.details})}handleReset=()=>{this.setState({hasError:!1,error:null})};render(){return this.state.hasError?this.props.fallback?this.props.fallback:(0,c.jsx)("div",{className:"min-h-screen flex items-center justify-center p-4",children:(0,c.jsxs)(i,{variant:"destructive",className:"max-w-md",children:[(0,c.jsx)(e.AlertCircle,{className:"h-4 w-4"}),(0,c.jsx)(j,{children:"خطایی رخ داد"}),(0,c.jsxs)(k,{className:"mt-2",children:[(0,c.jsx)("p",{className:"mb-4",children:"متأسفانه خطایی در سیستم رخ داده است. لطفاً صفحه را رفرش کنید."}),!1,(0,c.jsx)(l.Button,{onClick:this.handleReset,className:"mt-4",variant:"outline",children:"تلاش مجدد"})]})]})}):this.props.children}}a.s(["ErrorBoundary",()=>p],16591)}];

//# sourceMappingURL=_c42d7d4b._.js.map