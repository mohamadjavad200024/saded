{"version":3,"sources":["../../../../app/chat/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useState, useRef, useEffect, useCallback } from \"react\";\r\nimport { useRouter } from \"next/navigation\";\r\nimport { Button } from \"@/components/ui/button\";\r\nimport { Textarea } from \"@/components/ui/textarea\";\r\nimport { Input } from \"@/components/ui/input\";\r\nimport {\r\n  DropdownMenu,\r\n  DropdownMenuContent,\r\n  DropdownMenuItem,\r\n  DropdownMenuSeparator,\r\n  DropdownMenuTrigger,\r\n} from \"@/components/ui/dropdown-menu\";\r\nimport {\r\n  Send,\r\n  MessageCircle,\r\n  Phone,\r\n  Mail,\r\n  Image,\r\n  Paperclip,\r\n  MapPin,\r\n  FileText,\r\n  X,\r\n  Mic,\r\n  Square,\r\n  Pause,\r\n  Loader2,\r\n  Check,\r\n  CheckCheck,\r\n  Reply,\r\n  Edit2,\r\n  Trash2,\r\n  MoreVertical,\r\n  ChevronDown,\r\n  ArrowRight,\r\n} from \"lucide-react\";\r\nimport { motion, AnimatePresence } from \"framer-motion\";\r\nimport { useToast } from \"@/hooks/use-toast\";\r\nimport { useNotifications } from \"@/hooks/use-notifications\";\r\nimport { OnlineStatusBadge } from \"@/components/chat/online-status-badge\";\r\nimport { useAdminPresence } from \"@/hooks/use-admin-presence\";\r\nimport { TypingIndicator } from \"@/components/chat/typing-indicator\";\r\nimport { logger } from \"@/lib/logger-client\";\r\nimport { useAuthStore } from \"@/store/auth-store\";\r\n\r\ntype MessageStatus = \"sending\" | \"sent\" | \"delivered\" | \"read\";\r\n\r\ninterface Message {\r\n  id: string;\r\n  text: string;\r\n  sender: \"user\" | \"support\";\r\n  timestamp: Date;\r\n  attachments?: Attachment[];\r\n  status?: MessageStatus;\r\n}\r\n\r\ninterface Attachment {\r\n  id: string;\r\n  type: \"image\" | \"file\" | \"location\" | \"audio\";\r\n  url?: string;\r\n  name?: string;\r\n  size?: number;\r\n  duration?: number;\r\n}\r\n\r\nexport default function ChatPage() {\r\n  const router = useRouter();\r\n  const { toast } = useToast();\r\n  const { showNotification, requestPermission } = useNotifications();\r\n  const { isOnline, lastSeen, checkStatus } = useAdminPresence({\r\n    enabled: true,\r\n    heartbeatInterval: 20000,\r\n  });\r\n  const { user, isAuthenticated } = useAuthStore();\r\n  const [messages, setMessages] = useState<Message[]>([\r\n    {\r\n      id: \"1\",\r\n      text: \"سلام! خوش آمدید. برای خرید سریع لطفاً اطلاعات زیر را وارد کنید:\",\r\n      sender: \"support\",\r\n      timestamp: new Date(),\r\n    },\r\n  ]);\r\n  const [message, setMessage] = useState(\"\");\r\n  const [replyingTo, setReplyingTo] = useState<Message | null>(null);\r\n  const [editingMessage, setEditingMessage] = useState<Message | null>(null);\r\n  const [step, setStep] = useState<\"info\" | \"chat\">(\"info\");\r\n  \r\n  // Load customer info from auth store or localStorage\r\n  const loadCustomerInfo = useCallback(() => {\r\n    if (typeof window === \"undefined\") return { name: \"\", phone: \"\", email: \"\" };\r\n    \r\n    // اگر کاربر لاگین است، از اطلاعات کاربر استفاده کن\r\n    if (isAuthenticated && user) {\r\n      return {\r\n        name: user.name || \"\",\r\n        phone: user.phone || \"\",\r\n        email: \"\",\r\n      };\r\n    }\r\n    \r\n    // در غیر این صورت از localStorage استفاده کن\r\n    try {\r\n      const stored = localStorage.getItem(\"quickBuyChat_customerInfo\");\r\n      if (stored) {\r\n        const parsed = JSON.parse(stored);\r\n        const expiration = parsed.expiration;\r\n        if (expiration && new Date(expiration) > new Date()) {\r\n          return parsed.data;\r\n        } else {\r\n          localStorage.removeItem(\"quickBuyChat_customerInfo\");\r\n        }\r\n      }\r\n    } catch (error) {\r\n      logger.error(\"Error loading customer info:\", error);\r\n    }\r\n    return { name: \"\", phone: \"\", email: \"\" };\r\n  }, [isAuthenticated, user]);\r\n\r\n  const [customerInfo, setCustomerInfo] = useState(loadCustomerInfo);\r\n  \r\n  // Update customer info when auth state changes\r\n  useEffect(() => {\r\n    if (isAuthenticated && user) {\r\n      setCustomerInfo({\r\n        name: user.name || \"\",\r\n        phone: user.phone || \"\",\r\n        email: \"\",\r\n      });\r\n      // اگر اطلاعات کامل است، مستقیماً به chat برو\r\n      if (user.name && user.phone) {\r\n        setStep(\"chat\");\r\n      }\r\n    }\r\n  }, [isAuthenticated, user]);\r\n  const [attachments, setAttachments] = useState<Attachment[]>([]);\r\n  const [showAttachmentOptions, setShowAttachmentOptions] = useState(false);\r\n  const [isRecording, setIsRecording] = useState(false);\r\n  const [recordingTime, setRecordingTime] = useState(0);\r\n  const [audioUrl, setAudioUrl] = useState<string | null>(null);\r\n  const [audioBlob, setAudioBlob] = useState<Blob | null>(null);\r\n  const [isSaving, setIsSaving] = useState(false);\r\n  const [isSupportTyping, setIsSupportTyping] = useState(false);\r\n  const [showScrollToBottom, setShowScrollToBottom] = useState(false);\r\n  const [showPermissionGuide, setShowPermissionGuide] = useState(false);\r\n  const [chatId, setChatId] = useState<string | null>(null);\r\n\r\n  const messagesEndRef = useRef<HTMLDivElement>(null);\r\n  const messagesContainerRef = useRef<HTMLDivElement>(null);\r\n  const textareaRef = useRef<HTMLTextAreaElement>(null);\r\n  const imageInputRef = useRef<HTMLInputElement>(null);\r\n  const fileInputRef = useRef<HTMLInputElement>(null);\r\n  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n  const recordingIntervalRef = useRef<NodeJS.Timeout | null>(null);\r\n  const mediaRecorderRef = useRef<MediaRecorder | null>(null);\r\n  const hasScrolledOnOpenRef = useRef<boolean>(false);\r\n\r\n  // Load chatId from localStorage\r\n  useEffect(() => {\r\n    if (typeof window !== \"undefined\") {\r\n      const storedChatId = localStorage.getItem(\"quickBuyChat_chatId\");\r\n      if (storedChatId) {\r\n        setChatId(storedChatId);\r\n        setStep(\"chat\");\r\n      }\r\n    }\r\n  }, []);\r\n\r\n  // Save customer info to localStorage\r\n  useEffect(() => {\r\n    if (customerInfo.name && customerInfo.phone) {\r\n      const expiration = new Date();\r\n      expiration.setHours(expiration.getHours() + 24);\r\n      localStorage.setItem(\r\n        \"quickBuyChat_customerInfo\",\r\n        JSON.stringify({\r\n          data: customerInfo,\r\n          expiration: expiration.toISOString(),\r\n        })\r\n      );\r\n    }\r\n  }, [customerInfo]);\r\n\r\n  // Handle submit info\r\n  const handleSubmitInfo = useCallback(async () => {\r\n    if (!customerInfo.name || !customerInfo.phone) {\r\n      toast({\r\n        title: \"خطا\",\r\n        description: \"لطفاً نام و شماره تماس را وارد کنید\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const response = await fetch(\"/api/chat\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          customerName: customerInfo.name,\r\n          customerPhone: customerInfo.phone,\r\n          customerEmail: customerInfo.email || undefined,\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) throw new Error(\"خطا در ایجاد چت\");\r\n\r\n      const data = await response.json();\r\n      if (data.success && data.data?.id) {\r\n        const newChatId = data.data.id;\r\n        setChatId(newChatId);\r\n        if (typeof window !== \"undefined\") {\r\n          localStorage.setItem(\"quickBuyChat_chatId\", newChatId);\r\n        }\r\n        setStep(\"chat\");\r\n        setMessages([\r\n          {\r\n            id: \"1\",\r\n            text: \"سلام! خوش آمدید. برای خرید سریع لطفاً اطلاعات زیر را وارد کنید:\",\r\n            sender: \"support\",\r\n            timestamp: new Date(),\r\n          },\r\n        ]);\r\n        pollForNewMessages();\r\n      }\r\n    } catch (error) {\r\n      logger.error(\"Error creating chat:\", error);\r\n      toast({\r\n        title: \"خطا\",\r\n        description: \"خطا در ایجاد چت. لطفاً دوباره تلاش کنید.\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  }, [customerInfo, toast]);\r\n\r\n  // Format time\r\n  const formatTime = useCallback((seconds: number) => {\r\n    const mins = Math.floor(seconds / 60);\r\n    const secs = seconds % 60;\r\n    return `${mins.toString().padStart(2, \"0\")}:${secs.toString().padStart(2, \"0\")}`;\r\n  }, []);\r\n\r\n  // Check microphone permission\r\n  const checkMicrophonePermission = useCallback(async (): Promise<boolean> => {\r\n    try {\r\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n      stream.getTracks().forEach((track) => track.stop());\r\n      return true;\r\n    } catch (error) {\r\n      setShowPermissionGuide(true);\r\n      return false;\r\n    }\r\n  }, []);\r\n\r\n  // Start recording\r\n  const startRecording = useCallback(async () => {\r\n    try {\r\n      const hasPermission = await checkMicrophonePermission();\r\n      if (!hasPermission) return;\r\n\r\n      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });\r\n      const mediaRecorder = new MediaRecorder(stream);\r\n      mediaRecorderRef.current = mediaRecorder;\r\n\r\n      const chunks: Blob[] = [];\r\n      mediaRecorder.ondataavailable = (e) => {\r\n        if (e.data.size > 0) chunks.push(e.data);\r\n      };\r\n\r\n      mediaRecorder.onstop = () => {\r\n        const blob = new Blob(chunks, { type: \"audio/webm\" });\r\n        setAudioBlob(blob);\r\n        const url = URL.createObjectURL(blob);\r\n        setAudioUrl(url);\r\n        stream.getTracks().forEach((track) => track.stop());\r\n      };\r\n\r\n      mediaRecorder.start();\r\n      setIsRecording(true);\r\n      setRecordingTime(0);\r\n\r\n      const interval = setInterval(() => {\r\n        setRecordingTime((prev) => prev + 1);\r\n      }, 1000);\r\n      recordingIntervalRef.current = interval;\r\n    } catch (error) {\r\n      logger.error(\"Error starting recording:\", error);\r\n      toast({\r\n        title: \"خطا\",\r\n        description: \"خطا در شروع ضبط صدا\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n  }, [checkMicrophonePermission, toast]);\r\n\r\n  // Stop recording\r\n  const stopRecording = useCallback(() => {\r\n    if (mediaRecorderRef.current && isRecording) {\r\n      mediaRecorderRef.current.stop();\r\n      setIsRecording(false);\r\n      if (recordingIntervalRef.current) {\r\n        clearInterval(recordingIntervalRef.current);\r\n        recordingIntervalRef.current = null;\r\n      }\r\n    }\r\n  }, [isRecording]);\r\n\r\n  // Cancel recording\r\n  const cancelRecording = useCallback(() => {\r\n    stopRecording();\r\n    setAudioUrl(null);\r\n    setAudioBlob(null);\r\n    setRecordingTime(0);\r\n  }, [stopRecording]);\r\n\r\n  // Save recording\r\n  const saveRecording = useCallback(async () => {\r\n    if (!audioBlob || !audioUrl) return;\r\n\r\n    try {\r\n      setIsSaving(true);\r\n      const formData = new FormData();\r\n      formData.append(\"file\", audioBlob, \"recording.webm\");\r\n      formData.append(\"type\", \"audio\");\r\n\r\n      const response = await fetch(\"/api/chat/upload\", {\r\n        method: \"POST\",\r\n        body: formData,\r\n      });\r\n\r\n      if (!response.ok) throw new Error(\"خطا در آپلود فایل\");\r\n\r\n      const data = await response.json();\r\n      if (data.success && data.data?.url) {\r\n        const attachment: Attachment = {\r\n          id: `audio-${Date.now()}`,\r\n          type: \"audio\",\r\n          url: data.data.url,\r\n          name: \"پیام صوتی\",\r\n          duration: recordingTime,\r\n        };\r\n        setAttachments((prev) => [...prev, attachment]);\r\n        setAudioUrl(null);\r\n        setAudioBlob(null);\r\n        setRecordingTime(0);\r\n      }\r\n    } catch (error) {\r\n      logger.error(\"Error saving recording:\", error);\r\n      toast({\r\n        title: \"خطا\",\r\n        description: \"خطا در ذخیره پیام صوتی\",\r\n        variant: \"destructive\",\r\n      });\r\n    } finally {\r\n      setIsSaving(false);\r\n    }\r\n  }, [audioBlob, audioUrl, recordingTime, toast]);\r\n\r\n  // Handle file select\r\n  const handleFileSelect = useCallback(\r\n    async (e: React.ChangeEvent<HTMLInputElement>, type: \"image\" | \"file\") => {\r\n      const files = e.target.files;\r\n      if (!files || files.length === 0) return;\r\n\r\n      try {\r\n        for (let i = 0; i < files.length; i++) {\r\n          const file = files[i];\r\n          const formData = new FormData();\r\n          formData.append(\"file\", file);\r\n          formData.append(\"type\", type);\r\n\r\n          const response = await fetch(\"/api/chat/upload\", {\r\n            method: \"POST\",\r\n            body: formData,\r\n          });\r\n\r\n          if (!response.ok) throw new Error(\"خطا در آپلود فایل\");\r\n\r\n          const data = await response.json();\r\n          if (data.success && data.data?.url) {\r\n            const attachment: Attachment = {\r\n              id: `${type}-${Date.now()}-${i}`,\r\n              type,\r\n              url: data.data.url,\r\n              name: file.name,\r\n              size: file.size,\r\n            };\r\n            setAttachments((prev) => [...prev, attachment]);\r\n          }\r\n        }\r\n      } catch (error) {\r\n        logger.error(\"Error uploading file:\", error);\r\n        toast({\r\n          title: \"خطا\",\r\n          description: \"خطا در آپلود فایل\",\r\n          variant: \"destructive\",\r\n        });\r\n      }\r\n\r\n      // Reset input\r\n      if (e.target) e.target.value = \"\";\r\n    },\r\n    [toast]\r\n  );\r\n\r\n  // Handle location share\r\n  const handleLocationShare = useCallback(() => {\r\n    if (!navigator.geolocation) {\r\n      toast({\r\n        title: \"خطا\",\r\n        description: \"مرورگر شما از موقعیت‌یابی پشتیبانی نمی‌کند\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    navigator.geolocation.getCurrentPosition(\r\n      (position) => {\r\n        const { latitude, longitude } = position.coords;\r\n        const url = `https://www.google.com/maps?q=${latitude},${longitude}`;\r\n        const attachment: Attachment = {\r\n          id: `location-${Date.now()}`,\r\n          type: \"location\",\r\n          url,\r\n          name: \"موقعیت من\",\r\n        };\r\n        setAttachments((prev) => [...prev, attachment]);\r\n        setShowAttachmentOptions(false);\r\n      },\r\n      (error) => {\r\n        logger.error(\"Error getting location:\", error);\r\n        toast({\r\n          title: \"خطا\",\r\n          description: \"خطا در دریافت موقعیت\",\r\n          variant: \"destructive\",\r\n        });\r\n      }\r\n    );\r\n  }, [toast]);\r\n\r\n  // Remove attachment\r\n  const handleRemoveAttachment = useCallback((id: string) => {\r\n    setAttachments((prev) => prev.filter((att) => att.id !== id));\r\n  }, []);\r\n\r\n  // Send typing status\r\n  const sendTypingStatus = useCallback(\r\n    async (isTyping: boolean) => {\r\n      if (!chatId) return;\r\n\r\n      try {\r\n        await fetch(\"/api/chat/typing\", {\r\n          method: \"POST\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({\r\n            chatId,\r\n            sender: \"user\",\r\n            isTyping,\r\n          }),\r\n        });\r\n      } catch (error) {\r\n        // Silent fail\r\n      }\r\n    },\r\n    [chatId]\r\n  );\r\n\r\n  // Poll for new messages\r\n  const pollForNewMessages = useCallback(async () => {\r\n    if (!chatId) return;\r\n\r\n    try {\r\n      const response = await fetch(`/api/chat?chatId=${chatId}`);\r\n      if (!response.ok) return;\r\n\r\n      const data = await response.json();\r\n      if (data.success && data.data?.messages) {\r\n        const formattedMessages: Message[] = data.data.messages.map((msg: any) => ({\r\n          id: msg.id,\r\n          text: msg.text || \"\",\r\n          sender: msg.sender as \"user\" | \"support\",\r\n          timestamp: new Date(msg.createdAt),\r\n          attachments: msg.attachments ? (Array.isArray(msg.attachments) ? msg.attachments : JSON.parse(msg.attachments)) : [],\r\n          status: msg.status || (msg.sender === \"user\" ? \"sent\" : undefined),\r\n        }));\r\n\r\n        setMessages(formattedMessages);\r\n      }\r\n    } catch (error) {\r\n      logger.error(\"Error polling messages:\", error);\r\n    }\r\n  }, [chatId]);\r\n\r\n  // Check support typing\r\n  const checkSupportTyping = useCallback(async () => {\r\n    if (!chatId) return;\r\n\r\n    try {\r\n      const response = await fetch(`/api/chat/typing?chatId=${chatId}&sender=support`);\r\n      if (response.ok) {\r\n        const data = await response.json();\r\n        if (data.success) {\r\n          setIsSupportTyping(data.data?.isTyping || false);\r\n        }\r\n      }\r\n    } catch (error) {\r\n      // Silent fail\r\n    }\r\n  }, [chatId]);\r\n\r\n  // Handle send message\r\n  const handleSendMessage = useCallback(async () => {\r\n    if (!chatId) {\r\n      toast({\r\n        title: \"خطا\",\r\n        description: \"لطفاً ابتدا اطلاعات خود را وارد کنید\",\r\n        variant: \"destructive\",\r\n      });\r\n      return;\r\n    }\r\n\r\n    if (!message.trim() && attachments.length === 0) return;\r\n\r\n    // If editing, update the message\r\n    if (editingMessage) {\r\n      try {\r\n        const response = await fetch(`/api/chat/message/${editingMessage.id}`, {\r\n          method: \"PATCH\",\r\n          headers: { \"Content-Type\": \"application/json\" },\r\n          body: JSON.stringify({\r\n            text: message,\r\n            attachments: attachments,\r\n          }),\r\n        });\r\n\r\n        if (response.ok) {\r\n          setMessages((prev) =>\r\n            prev.map((msg) =>\r\n              msg.id === editingMessage.id\r\n                ? { ...msg, text: message, attachments: attachments }\r\n                : msg\r\n            )\r\n          );\r\n          setEditingMessage(null);\r\n          setMessage(\"\");\r\n          setAttachments([]);\r\n        }\r\n      } catch (error) {\r\n        logger.error(\"Error editing message:\", error);\r\n      }\r\n      return;\r\n    }\r\n\r\n    const tempId = `temp-${Date.now()}`;\r\n    const newMessage: Message = {\r\n      id: tempId,\r\n      text: message,\r\n      sender: \"user\",\r\n      timestamp: new Date(),\r\n      attachments: attachments,\r\n      status: \"sending\",\r\n    };\r\n\r\n    setMessages((prev) => [...prev, newMessage]);\r\n    setMessage(\"\");\r\n    setAttachments([]);\r\n    setReplyingTo(null);\r\n\r\n    if (typingTimeoutRef.current) {\r\n      clearTimeout(typingTimeoutRef.current);\r\n      typingTimeoutRef.current = null;\r\n    }\r\n    sendTypingStatus(false);\r\n\r\n    try {\r\n      // Prepare message for API\r\n      const messageToSave = {\r\n        id: tempId,\r\n        text: message,\r\n        sender: \"user\",\r\n        timestamp: newMessage.timestamp.toISOString(),\r\n        attachments: attachments.filter((att) => {\r\n          const url = att.url;\r\n          return url && \r\n                 !url.startsWith('blob:') && \r\n                 !url.startsWith('data:') &&\r\n                 (url.startsWith('http') || url.startsWith('/'));\r\n        }),\r\n        status: \"sent\",\r\n      };\r\n\r\n      const response = await fetch(\"/api/chat\", {\r\n        method: \"POST\",\r\n        headers: { \"Content-Type\": \"application/json\" },\r\n        body: JSON.stringify({\r\n          chatId,\r\n          customerInfo: {\r\n            name: customerInfo.name,\r\n            phone: customerInfo.phone,\r\n            email: customerInfo.email || undefined,\r\n          },\r\n          messages: [messageToSave],\r\n        }),\r\n      });\r\n\r\n      if (!response.ok) {\r\n        const errorData = await response.json().catch(() => ({}));\r\n        throw new Error(errorData.message || \"خطا در ارسال پیام\");\r\n      }\r\n\r\n      const data = await response.json();\r\n      if (data.success && data.data?.messages && data.data.messages.length > 0) {\r\n        const savedMessage = data.data.messages[0];\r\n        setMessages((prev) =>\r\n          prev.map((msg) =>\r\n            msg.id === tempId\r\n              ? {\r\n                  ...msg,\r\n                  id: savedMessage.id,\r\n                  status: savedMessage.status || \"sent\",\r\n                }\r\n              : msg\r\n          )\r\n        );\r\n        \r\n        // Update chatId if provided\r\n        if (data.data.chatId && data.data.chatId !== chatId) {\r\n          setChatId(data.data.chatId);\r\n          if (typeof window !== \"undefined\") {\r\n            localStorage.setItem(\"quickBuyChat_chatId\", data.data.chatId);\r\n          }\r\n        }\r\n      }\r\n    } catch (error) {\r\n      logger.error(\"Error sending message:\", error);\r\n      setMessages((prev) => prev.filter((msg) => msg.id !== tempId));\r\n      toast({\r\n        title: \"خطا\",\r\n        description: \"خطا در ارسال پیام\",\r\n        variant: \"destructive\",\r\n      });\r\n    }\r\n\r\n    setTimeout(() => {\r\n      scrollToBottom(false);\r\n    }, 100);\r\n  }, [chatId, message, attachments, replyingTo, editingMessage, sendTypingStatus, toast]);\r\n\r\n  // Handle reply\r\n  const handleReply = useCallback((msg: Message) => {\r\n    setReplyingTo(msg);\r\n    setEditingMessage(null);\r\n  }, []);\r\n\r\n  // Handle edit\r\n  const handleEdit = useCallback((msg: Message) => {\r\n    setEditingMessage(msg);\r\n    setReplyingTo(null);\r\n    setMessage(msg.text || \"\");\r\n  }, []);\r\n\r\n  // Handle delete\r\n  const handleDelete = useCallback(\r\n    async (messageId: string) => {\r\n      try {\r\n        const response = await fetch(`/api/chat/message/${messageId}`, {\r\n          method: \"DELETE\",\r\n        });\r\n\r\n        if (response.ok) {\r\n          setMessages((prev) => prev.filter((msg) => msg.id !== messageId));\r\n        }\r\n      } catch (error) {\r\n        logger.error(\"Error deleting message:\", error);\r\n      }\r\n    },\r\n    []\r\n  );\r\n\r\n  // Scroll to bottom\r\n  const scrollToBottom = useCallback((instant = false) => {\r\n    if (messagesEndRef.current) {\r\n      messagesEndRef.current.scrollIntoView({\r\n        behavior: instant ? \"auto\" : \"smooth\",\r\n        block: \"end\",\r\n      });\r\n    }\r\n  }, []);\r\n\r\n  // Check scroll position\r\n  const checkScrollPosition = useCallback(() => {\r\n    if (!messagesContainerRef.current) {\r\n      setShowScrollToBottom(false);\r\n      return;\r\n    }\r\n    const container = messagesContainerRef.current;\r\n    const threshold = 150;\r\n    const scrollBottom = container.scrollHeight - container.scrollTop - container.clientHeight;\r\n    setShowScrollToBottom(scrollBottom > threshold);\r\n  }, []);\r\n\r\n  // Poll for messages\r\n  useEffect(() => {\r\n    if (!chatId || step !== \"chat\") return;\r\n\r\n    pollForNewMessages();\r\n    const interval = setInterval(() => {\r\n      pollForNewMessages();\r\n      checkSupportTyping();\r\n    }, 3000);\r\n\r\n    return () => clearInterval(interval);\r\n  }, [chatId, step, pollForNewMessages, checkSupportTyping]);\r\n\r\n  // Scroll to bottom on messages change\r\n  useEffect(() => {\r\n    if (messages.length > 0 && step === \"chat\") {\r\n      setTimeout(() => {\r\n        scrollToBottom(true);\r\n        checkScrollPosition();\r\n      }, 100);\r\n    }\r\n  }, [messages.length, step, scrollToBottom, checkScrollPosition]);\r\n\r\n  // Track scroll\r\n  useEffect(() => {\r\n    const container = messagesContainerRef.current;\r\n    if (!container) return;\r\n\r\n    const handleScroll = () => {\r\n      checkScrollPosition();\r\n    };\r\n\r\n    container.addEventListener(\"scroll\", handleScroll, { passive: true });\r\n    return () => container.removeEventListener(\"scroll\", handleScroll);\r\n  }, [checkScrollPosition]);\r\n\r\n  // Request notification permission\r\n  useEffect(() => {\r\n    requestPermission();\r\n  }, [requestPermission]);\r\n\r\n  // Set body and html overflow for chat page\r\n  useEffect(() => {\r\n    const originalBodyOverflow = document.body.style.overflow;\r\n    const originalHtmlOverflow = document.documentElement.style.overflow;\r\n    \r\n    document.body.style.overflow = \"hidden\";\r\n    document.documentElement.style.overflow = \"hidden\";\r\n    \r\n    return () => {\r\n      document.body.style.overflow = originalBodyOverflow;\r\n      document.documentElement.style.overflow = originalHtmlOverflow;\r\n    };\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"flex flex-col overflow-hidden\" style={{ height: '100dvh' }}>\r\n      <main className=\"flex-1 flex flex-col min-h-0 overflow-hidden\">\r\n        {/* Header - Sticky at top */}\r\n        <div className=\"flex-shrink-0 border-b border-border/40 px-4 sm:px-6 py-3 bg-background/95 backdrop-blur-sm\">\r\n          <div className=\"flex items-center gap-2\">\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              onClick={() => router.back()}\r\n              className=\"h-8 w-8 rounded-lg\"\r\n            >\r\n              <ArrowRight className=\"h-4 w-4\" />\r\n            </Button>\r\n            <div className=\"flex-1 min-w-0\">\r\n              <h1 className=\"text-base font-semibold text-foreground flex items-center gap-2\">\r\n                خرید سریع\r\n                {step === \"chat\" && (\r\n                  <OnlineStatusBadge isOnline={isOnline} lastSeen={lastSeen} showText={false} />\r\n                )}\r\n              </h1>\r\n            </div>\r\n            {step === \"chat\" && customerInfo.name && customerInfo.phone && (\r\n              <Button\r\n                variant=\"ghost\"\r\n                size=\"icon\"\r\n                onClick={() => {\r\n                  setStep(\"info\");\r\n                  setMessages([\r\n                    {\r\n                      id: \"1\",\r\n                      text: \"سلام! خوش آمدید. برای خرید سریع لطفاً اطلاعات زیر را وارد کنید:\",\r\n                      sender: \"support\",\r\n                      timestamp: new Date(),\r\n                    },\r\n                  ]);\r\n                }}\r\n                className=\"h-8 w-8 rounded-lg hover:bg-primary/10 transition-colors\"\r\n                title=\"تغییر اطلاعات\"\r\n              >\r\n                <svg\r\n                  className=\"h-4 w-4\"\r\n                  viewBox=\"0 0 24 24\"\r\n                  fill=\"none\"\r\n                  xmlns=\"http://www.w3.org/2000/svg\"\r\n                >\r\n                  <path\r\n                    d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"\r\n                    stroke=\"currentColor\"\r\n                    strokeWidth=\"2\"\r\n                    strokeLinecap=\"round\"\r\n                    strokeLinejoin=\"round\"\r\n                  />\r\n                  <circle\r\n                    cx=\"12\"\r\n                    cy=\"7\"\r\n                    r=\"4\"\r\n                    stroke=\"currentColor\"\r\n                    strokeWidth=\"2\"\r\n                    strokeLinecap=\"round\"\r\n                    strokeLinejoin=\"round\"\r\n                  />\r\n                </svg>\r\n              </Button>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* Content */}\r\n        <div className=\"flex-1 flex flex-col min-h-0 overflow-hidden\">\r\n          {step === \"info\" ? (\r\n            <div className=\"flex-1 overflow-y-auto p-6 sm:p-8 space-y-6 bg-gradient-to-b from-background via-background to-muted/10\">\r\n              {/* Welcome Message */}\r\n              <motion.div\r\n                initial={{ opacity: 0, y: -10 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                className=\"text-center pb-2\"\r\n              >\r\n                <div className=\"inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-primary/20 to-accent/20 mb-3 shadow-lg\">\r\n                  <MessageCircle className=\"h-8 w-8 text-primary\" />\r\n                </div>\r\n                <p className=\"text-sm text-muted-foreground leading-relaxed\">\r\n                  لطفاً اطلاعات زیر را برای شروع خرید سریع وارد کنید\r\n                </p>\r\n              </motion.div>\r\n\r\n              <motion.div\r\n                initial={{ opacity: 0, y: 20 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                className=\"space-y-5\"\r\n              >\r\n                <div className=\"space-y-2\">\r\n                  <label className=\"text-sm font-semibold text-foreground flex items-center gap-2\">\r\n                    <svg\r\n                      className=\"h-4 w-4 text-primary\"\r\n                      viewBox=\"0 0 24 24\"\r\n                      fill=\"none\"\r\n                      xmlns=\"http://www.w3.org/2000/svg\"\r\n                    >\r\n                      <path\r\n                        d=\"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\"\r\n                        stroke=\"currentColor\"\r\n                        strokeWidth=\"2\"\r\n                        strokeLinecap=\"round\"\r\n                        strokeLinejoin=\"round\"\r\n                      />\r\n                      <circle\r\n                        cx=\"12\"\r\n                        cy=\"7\"\r\n                        r=\"4\"\r\n                        stroke=\"currentColor\"\r\n                        strokeWidth=\"2\"\r\n                        strokeLinecap=\"round\"\r\n                        strokeLinejoin=\"round\"\r\n                      />\r\n                    </svg>\r\n                    نام و نام خانوادگی\r\n                    <span className=\"text-destructive text-xs\">*</span>\r\n                  </label>\r\n                  <Input\r\n                    type=\"text\"\r\n                    placeholder=\"مثال: علی احمدی\"\r\n                    value={customerInfo.name}\r\n                    onChange={(e) =>\r\n                      setCustomerInfo({ ...customerInfo, name: e.target.value })\r\n                    }\r\n                    className=\"h-12 text-base border-2 border-border/40 focus:border-primary/60 focus:ring-2 focus:ring-primary/20 rounded-xl transition-all bg-background/50 hover:bg-background\"\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <label className=\"text-sm font-semibold text-foreground flex items-center gap-2\">\r\n                    <Phone className=\"h-4 w-4 text-primary\" />\r\n                    شماره تماس\r\n                    <span className=\"text-destructive text-xs\">*</span>\r\n                  </label>\r\n                  <Input\r\n                    type=\"tel\"\r\n                    placeholder=\"09123456789\"\r\n                    value={customerInfo.phone}\r\n                    onChange={(e) =>\r\n                      setCustomerInfo({ ...customerInfo, phone: e.target.value })\r\n                    }\r\n                    className=\"h-12 text-base border-2 border-border/40 focus:border-primary/60 focus:ring-2 focus:ring-primary/20 rounded-xl transition-all bg-background/50 hover:bg-background\"\r\n                  />\r\n                </div>\r\n\r\n                <div className=\"space-y-2\">\r\n                  <label className=\"text-sm font-semibold text-foreground flex items-center gap-2\">\r\n                    <Mail className=\"h-4 w-4 text-primary\" />\r\n                    ایمیل\r\n                    <span className=\"text-xs text-muted-foreground font-normal\">(اختیاری)</span>\r\n                  </label>\r\n                  <Input\r\n                    type=\"email\"\r\n                    placeholder=\"example@email.com\"\r\n                    value={customerInfo.email}\r\n                    onChange={(e) =>\r\n                      setCustomerInfo({ ...customerInfo, email: e.target.value })\r\n                    }\r\n                    className=\"h-12 text-base border-2 border-border/40 focus:border-primary/60 focus:ring-2 focus:ring-primary/20 rounded-xl transition-all bg-background/50 hover:bg-background\"\r\n                  />\r\n                </div>\r\n              </motion.div>\r\n\r\n              <motion.div\r\n                initial={{ opacity: 0, y: 20 }}\r\n                animate={{ opacity: 1, y: 0 }}\r\n                transition={{ delay: 0.15 }}\r\n                className=\"pt-2\"\r\n              >\r\n                <Button\r\n                  onClick={handleSubmitInfo}\r\n                  disabled={!customerInfo.name || !customerInfo.phone}\r\n                  className=\"w-full h-13 text-base font-semibold bg-gradient-to-r from-primary via-primary to-primary/90 hover:from-primary/90 hover:via-primary/80 hover:to-primary/70 shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transition-all duration-300 disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed rounded-xl\"\r\n                >\r\n                  <span className=\"flex items-center justify-center gap-2\">\r\n                    ادامه\r\n                    <motion.div\r\n                      animate={{ x: [0, 4, 0] }}\r\n                      transition={{ repeat: Infinity, duration: 1.5, delay: 0.5 }}\r\n                    >\r\n                      →\r\n                    </motion.div>\r\n                  </span>\r\n                </Button>\r\n                <p className=\"text-xs text-muted-foreground text-center mt-3\">\r\n                  با ادامه، شما شرایط و قوانین ما را می‌پذیرید\r\n                </p>\r\n              </motion.div>\r\n            </div>\r\n          ) : (\r\n            <>\r\n              {/* Messages */}\r\n              <div\r\n                ref={messagesContainerRef}\r\n                className=\"flex-1 min-h-0 overflow-y-auto p-5 sm:p-6 md:p-8 space-y-5 sm:space-y-6 bg-gradient-to-b from-background via-background/95 to-muted/5 scroll-smooth\"\r\n              >\r\n                {messages.length === 0 && (\r\n                  <motion.div\r\n                    initial={{ opacity: 0, y: 20 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    className=\"flex flex-col items-center justify-center h-full min-h-[200px] text-center px-4\"\r\n                  >\r\n                    <div className=\"w-20 h-20 rounded-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center mb-4 shadow-lg\">\r\n                      <MessageCircle className=\"h-10 w-10 text-primary/60\" />\r\n                    </div>\r\n                    <p className=\"text-muted-foreground text-base font-medium leading-relaxed\">\r\n                      هنوز پیامی ارسال نشده است\r\n                    </p>\r\n                    <p className=\"text-muted-foreground/70 text-sm mt-2 leading-relaxed\">\r\n                      پیام خود را بنویسید...\r\n                    </p>\r\n                  </motion.div>\r\n                )}\r\n                {messages.map((msg) => (\r\n                  <motion.div\r\n                    key={msg.id}\r\n                    initial={{ opacity: 0, y: 10 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    className={`flex ${msg.sender === \"user\" ? \"justify-end\" : \"justify-start\"} items-end gap-2 group`}\r\n                  >\r\n                    <div\r\n                      className={`max-w-[85%] sm:max-w-[75%] md:max-w-[70%] rounded-lg px-2.5 sm:px-3 py-2 transition-all ${\r\n                        msg.sender === \"user\"\r\n                          ? \"bg-primary text-primary-foreground\"\r\n                          : \"bg-muted text-foreground border border-border/40\"\r\n                      }`}\r\n                    >\r\n                      {msg.text && (\r\n                        <p className=\"text-xs sm:text-sm leading-relaxed whitespace-pre-wrap break-words mb-1.5\">\r\n                          {msg.text}\r\n                        </p>\r\n                      )}\r\n                      {msg.attachments && msg.attachments.length > 0 && (\r\n                        <div className={`space-y-2 ${msg.text ? \"mt-2\" : \"\"}`}>\r\n                          {msg.attachments.map((attachment) => (\r\n                            <div key={attachment.id} className=\"rounded-xl overflow-hidden\">\r\n                              {attachment.type === \"image\" && attachment.url && (\r\n                                <img\r\n                                  src={attachment.url}\r\n                                  alt={attachment.name || \"تصویر\"}\r\n                                  className=\"max-w-full max-h-[150px] sm:max-h-[180px] rounded cursor-pointer hover:opacity-90 transition-all\"\r\n                                  onClick={() => window.open(attachment.url, \"_blank\")}\r\n                                />\r\n                              )}\r\n                              {attachment.type === \"file\" && (\r\n                                <a\r\n                                  href={attachment.url}\r\n                                  target=\"_blank\"\r\n                                  rel=\"noopener noreferrer\"\r\n                                  download={attachment.name}\r\n                                  className=\"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs\"\r\n                                >\r\n                                  <FileText className=\"h-3.5 w-3.5\" />\r\n                                  <span className=\"font-medium truncate\">{attachment.name || \"فایل\"}</span>\r\n                                </a>\r\n                              )}\r\n                              {attachment.type === \"location\" && (\r\n                                <a\r\n                                  href={attachment.url}\r\n                                  target=\"_blank\"\r\n                                  rel=\"noopener noreferrer\"\r\n                                  className=\"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs\"\r\n                                >\r\n                                  <MapPin className=\"h-3.5 w-3.5\" />\r\n                                  <span className=\"font-medium\">{attachment.name || \"موقعیت\"}</span>\r\n                                </a>\r\n                              )}\r\n                              {attachment.type === \"audio\" && attachment.url && (\r\n                                <div className=\"flex items-center gap-2 p-2 bg-background/50 rounded\">\r\n                                  <Mic className=\"h-3.5 w-3.5\" />\r\n                                  <audio controls className=\"flex-1 h-7 text-xs\">\r\n                                    <source src={attachment.url} />\r\n                                  </audio>\r\n                                </div>\r\n                              )}\r\n                            </div>\r\n                          ))}\r\n                        </div>\r\n                      )}\r\n                      <div\r\n                        className={`flex items-center gap-1.5 mt-1.5 pt-1.5 border-t ${\r\n                          msg.sender === \"user\"\r\n                            ? \"border-primary-foreground/20 justify-end\"\r\n                            : \"border-border/30 justify-start\"\r\n                        }`}\r\n                      >\r\n                        <span\r\n                          className={`text-[10px] sm:text-xs ${\r\n                            msg.sender === \"user\"\r\n                              ? \"text-primary-foreground/70\"\r\n                              : \"text-muted-foreground\"\r\n                          }`}\r\n                        >\r\n                          {new Date(msg.timestamp).toLocaleTimeString(\"fa-IR\", {\r\n                            hour: \"2-digit\",\r\n                            minute: \"2-digit\",\r\n                          })}\r\n                        </span>\r\n                        {msg.sender === \"user\" && (\r\n                          <>\r\n                            {msg.status === \"sending\" && (\r\n                              <Loader2 className=\"h-3 w-3 text-primary-foreground/50 animate-spin\" />\r\n                            )}\r\n                            {msg.status === \"sent\" && (\r\n                              <Check className=\"h-3 w-3 text-primary-foreground/40\" />\r\n                            )}\r\n                            {msg.status === \"delivered\" && (\r\n                              <CheckCheck className=\"h-3 w-3 text-primary-foreground/40\" />\r\n                            )}\r\n                            {msg.status === \"read\" && (\r\n                              <CheckCheck className=\"h-3 w-3 text-primary-foreground/70\" />\r\n                            )}\r\n                            {!msg.status && (\r\n                              <Check className=\"h-3 w-3 text-primary-foreground/40\" />\r\n                            )}\r\n                          </>\r\n                        )}\r\n                        <div className=\"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                          <DropdownMenu>\r\n                            <DropdownMenuTrigger asChild>\r\n                              <Button\r\n                                variant=\"ghost\"\r\n                                size=\"icon\"\r\n                                className=\"h-6 w-6 hover:bg-background/20\"\r\n                              >\r\n                                <MoreVertical className=\"h-3.5 w-3.5\" />\r\n                              </Button>\r\n                            </DropdownMenuTrigger>\r\n                            <DropdownMenuContent\r\n                              align={msg.sender === \"user\" ? \"end\" : \"start\"}\r\n                              className=\"min-w-[140px]\"\r\n                            >\r\n                              <DropdownMenuItem onClick={() => handleReply(msg)}>\r\n                                <Reply className=\"h-4 w-4 ml-2\" />\r\n                                <span>پاسخ</span>\r\n                              </DropdownMenuItem>\r\n                              {msg.sender === \"user\" && (\r\n                                <>\r\n                                  <DropdownMenuSeparator />\r\n                                  <DropdownMenuItem onClick={() => handleEdit(msg)}>\r\n                                    <Edit2 className=\"h-4 w-4 ml-2\" />\r\n                                    <span>ویرایش</span>\r\n                                  </DropdownMenuItem>\r\n                                </>\r\n                              )}\r\n                              <DropdownMenuSeparator />\r\n                              <DropdownMenuItem\r\n                                onClick={() => {\r\n                                  if (confirm(\"آیا مطمئن هستید که می‌خواهید این پیام را حذف کنید؟\")) {\r\n                                    handleDelete(msg.id);\r\n                                  }\r\n                                }}\r\n                                className=\"text-destructive focus:text-destructive focus:bg-destructive/10\"\r\n                              >\r\n                                <Trash2 className=\"h-4 w-4 ml-2\" />\r\n                                <span>حذف</span>\r\n                              </DropdownMenuItem>\r\n                            </DropdownMenuContent>\r\n                          </DropdownMenu>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  </motion.div>\r\n                ))}\r\n                {isSupportTyping && (\r\n                  <motion.div\r\n                    initial={{ opacity: 0, y: 10 }}\r\n                    animate={{ opacity: 1, y: 0 }}\r\n                    className=\"flex justify-start items-end gap-2.5\"\r\n                  >\r\n                    <TypingIndicator />\r\n                  </motion.div>\r\n                )}\r\n                <div ref={messagesEndRef} />\r\n              </div>\r\n\r\n              {/* Input Area - Fixed at bottom */}\r\n              <div className=\"flex-shrink-0 border-t border-border/40 bg-background/95 backdrop-blur-sm p-2 sm:p-3 space-y-2 relative\">\r\n                {/* Scroll to bottom button */}\r\n                <AnimatePresence>\r\n                  {showScrollToBottom && (\r\n                    <motion.div\r\n                      initial={{ opacity: 0, y: 10, scale: 0.9 }}\r\n                      animate={{ opacity: 1, y: 0, scale: 1 }}\r\n                      exit={{ opacity: 0, y: 10, scale: 0.9 }}\r\n                      className=\"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 z-10\"\r\n                    >\r\n                      <Button\r\n                        onClick={() => scrollToBottom(false)}\r\n                        size=\"icon\"\r\n                        className=\"h-9 w-9 rounded-full shadow-lg hover:shadow-xl bg-primary text-primary-foreground hover:bg-primary/90 transition-all\"\r\n                        title=\"برو به آخرین پیام\"\r\n                      >\r\n                        <ChevronDown className=\"h-4 w-4\" />\r\n                      </Button>\r\n                    </motion.div>\r\n                  )}\r\n                </AnimatePresence>\r\n\r\n                {/* Recording UI */}\r\n                {(isRecording || audioUrl) && (\r\n                  <motion.div\r\n                    initial={{ opacity: 0, y: 10, scale: 0.95 }}\r\n                    animate={{ opacity: 1, y: 0, scale: 1 }}\r\n                    exit={{ opacity: 0, y: 10, scale: 0.95 }}\r\n                    className=\"flex items-center gap-2 p-2 bg-destructive/10 border border-destructive/30 rounded-lg\"\r\n                  >\r\n                    {isRecording ? (\r\n                      <>\r\n                        <motion.div\r\n                          animate={{ scale: [1, 1.1, 1] }}\r\n                          transition={{ repeat: Infinity, duration: 1 }}\r\n                          className=\"p-1.5 rounded-full bg-destructive/20\"\r\n                        >\r\n                          <Mic className=\"h-3.5 w-3.5 text-destructive\" />\r\n                        </motion.div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-medium text-destructive leading-tight\">در حال ضبط</p>\r\n                          <p className=\"text-xs text-muted-foreground font-mono\">{formatTime(recordingTime)}</p>\r\n                        </div>\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"icon\"\r\n                          onClick={stopRecording}\r\n                          className=\"h-7 w-7 text-destructive hover:bg-destructive/10 rounded-lg\"\r\n                        >\r\n                          <Square className=\"h-3 w-3 fill-current\" />\r\n                        </Button>\r\n                      </>\r\n                    ) : (\r\n                      <>\r\n                        <div className=\"p-1.5 rounded-full bg-primary/20\">\r\n                          <Mic className=\"h-3.5 w-3.5 text-primary\" />\r\n                        </div>\r\n                        <div className=\"flex-1\">\r\n                          <p className=\"text-xs font-medium leading-tight\">پیام صوتی آماده است</p>\r\n                          <p className=\"text-xs text-muted-foreground font-mono\">{formatTime(recordingTime)}</p>\r\n                        </div>\r\n                        <Button\r\n                          variant=\"ghost\"\r\n                          size=\"icon\"\r\n                          onClick={cancelRecording}\r\n                          className=\"h-7 w-7 text-muted-foreground hover:text-destructive rounded-lg\"\r\n                        >\r\n                          <X className=\"h-3.5 w-3.5\" />\r\n                        </Button>\r\n                        <Button onClick={saveRecording} size=\"sm\" className=\"h-7 px-3 text-xs rounded-lg\">\r\n                          ذخیره\r\n                        </Button>\r\n                      </>\r\n                    )}\r\n                  </motion.div>\r\n                )}\r\n\r\n                {/* Attachment Options */}\r\n                {showAttachmentOptions && (\r\n                  <motion.div\r\n                    initial={{ opacity: 0, y: 10, scale: 0.95 }}\r\n                    animate={{ opacity: 1, y: 0, scale: 1 }}\r\n                    exit={{ opacity: 0, y: 10, scale: 0.95 }}\r\n                    className=\"flex gap-2 p-2 bg-card rounded-lg border border-border/50 shadow-lg\"\r\n                  >\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"icon\"\r\n                      onClick={() => {\r\n                        imageInputRef.current?.click();\r\n                        setShowAttachmentOptions(false);\r\n                      }}\r\n                      className=\"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg\"\r\n                    >\r\n                      <Image className=\"h-3.5 w-3.5\" />\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"icon\"\r\n                      onClick={() => {\r\n                        fileInputRef.current?.click();\r\n                        setShowAttachmentOptions(false);\r\n                      }}\r\n                      className=\"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg\"\r\n                    >\r\n                      <FileText className=\"h-3.5 w-3.5\" />\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"icon\"\r\n                      onClick={() => {\r\n                        handleLocationShare();\r\n                        setShowAttachmentOptions(false);\r\n                      }}\r\n                      className=\"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg\"\r\n                    >\r\n                      <MapPin className=\"h-3.5 w-3.5\" />\r\n                    </Button>\r\n                    <Button\r\n                      variant=\"ghost\"\r\n                      size=\"icon\"\r\n                      onClick={async () => {\r\n                        setShowAttachmentOptions(false);\r\n                        if (isRecording) {\r\n                          stopRecording();\r\n                        } else {\r\n                          const hasPermission = await checkMicrophonePermission();\r\n                          if (!hasPermission) {\r\n                            toast({\r\n                              title: \"نیاز به دسترسی میکروفون\",\r\n                              description: \"برای ضبط صدا، لطفاً دسترسی میکروفون را در تنظیمات مرورگر فعال کنید.\",\r\n                              variant: \"destructive\",\r\n                              duration: 5000,\r\n                            });\r\n                          }\r\n                          startRecording();\r\n                        }\r\n                      }}\r\n                      className=\"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg\"\r\n                      disabled={isRecording}\r\n                    >\r\n                      {isRecording ? (\r\n                        <Pause className=\"h-3.5 w-3.5 text-destructive\" />\r\n                      ) : (\r\n                        <Mic className=\"h-3.5 w-3.5\" />\r\n                      )}\r\n                    </Button>\r\n                  </motion.div>\r\n                )}\r\n\r\n                {/* Hidden Inputs */}\r\n                <input\r\n                  ref={imageInputRef}\r\n                  type=\"file\"\r\n                  accept=\"image/*\"\r\n                  multiple\r\n                  className=\"hidden\"\r\n                  onChange={(e) => handleFileSelect(e, \"image\")}\r\n                />\r\n                <input\r\n                  ref={fileInputRef}\r\n                  type=\"file\"\r\n                  multiple\r\n                  className=\"hidden\"\r\n                  onChange={(e) => handleFileSelect(e, \"file\")}\r\n                />\r\n\r\n                {/* Input */}\r\n                <div className=\"flex items-end gap-2\">\r\n                  <div className=\"flex-1 relative\">\r\n                    {/* Attachments Preview */}\r\n                    {attachments.length > 0 && (\r\n                      <div className=\"absolute top-2 right-2 left-2 z-10 pointer-events-none overflow-hidden\">\r\n                        <div className=\"overflow-x-auto overflow-y-hidden scroll-smooth w-full [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]\">\r\n                          <div className=\"flex items-center gap-1.5 flex-nowrap\">\r\n                            {attachments.map((attachment) => (\r\n                              <div\r\n                                key={attachment.id}\r\n                                className=\"relative group pointer-events-auto flex-shrink-0 w-auto\"\r\n                              >\r\n                                <div className=\"bg-card/95 backdrop-blur-sm rounded-md p-1 border border-border/40 shadow-sm\">\r\n                                  {attachment.type === \"image\" && attachment.url && (\r\n                                    <img\r\n                                      src={attachment.url}\r\n                                      alt={attachment.name || \"تصویر\"}\r\n                                      className=\"w-10 h-10 object-cover rounded\"\r\n                                    />\r\n                                  )}\r\n                                  {attachment.type === \"file\" && (\r\n                                    <div className=\"flex items-center gap-1 px-1.5 py-1\">\r\n                                      <FileText className=\"h-3 w-3 flex-shrink-0 text-primary\" />\r\n                                      <p className=\"text-[10px] truncate max-w-[50px] font-medium leading-tight\">\r\n                                        {attachment.name}\r\n                                      </p>\r\n                                    </div>\r\n                                  )}\r\n                                  {attachment.type === \"location\" && (\r\n                                    <div className=\"flex items-center gap-1 px-1.5 py-1\">\r\n                                      <MapPin className=\"h-3 w-3 flex-shrink-0 text-primary\" />\r\n                                      <span className=\"text-[10px] font-medium whitespace-nowrap leading-tight\">\r\n                                        موقعیت\r\n                                      </span>\r\n                                    </div>\r\n                                  )}\r\n                                  {attachment.type === \"audio\" && (\r\n                                    <div className=\"flex items-center gap-1 px-1.5 py-1\">\r\n                                      <Mic className=\"h-3 w-3 flex-shrink-0 text-primary\" />\r\n                                      <span className=\"text-[10px] font-medium whitespace-nowrap leading-tight\">\r\n                                        {attachment.duration ? formatTime(attachment.duration) : \"صدا\"}\r\n                                      </span>\r\n                                    </div>\r\n                                  )}\r\n                                </div>\r\n                                <button\r\n                                  onClick={() => handleRemoveAttachment(attachment.id)}\r\n                                  className=\"absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm z-20 hover:scale-110\"\r\n                                >\r\n                                  <X className=\"h-2.5 w-2.5\" />\r\n                                </button>\r\n                              </div>\r\n                            ))}\r\n                          </div>\r\n                        </div>\r\n                      </div>\r\n                    )}\r\n\r\n                    <Textarea\r\n                      ref={textareaRef}\r\n                      value={message}\r\n                      onChange={(e) => {\r\n                        setMessage(e.target.value);\r\n                        if (typingTimeoutRef.current) {\r\n                          clearTimeout(typingTimeoutRef.current);\r\n                        }\r\n                        if (e.target.value.trim().length > 0) {\r\n                          sendTypingStatus(true);\r\n                          typingTimeoutRef.current = setTimeout(() => {\r\n                            sendTypingStatus(false);\r\n                          }, 2000);\r\n                        } else {\r\n                          sendTypingStatus(false);\r\n                        }\r\n                      }}\r\n                      onKeyDown={(e) => {\r\n                        if (e.key === \"Enter\" && !e.shiftKey) {\r\n                          e.preventDefault();\r\n                          if (typingTimeoutRef.current) {\r\n                            clearTimeout(typingTimeoutRef.current);\r\n                          }\r\n                          sendTypingStatus(false);\r\n                          if (message.trim() || attachments.length > 0) {\r\n                            handleSendMessage();\r\n                          }\r\n                        }\r\n                      }}\r\n                      placeholder=\"پیام خود را بنویسید...\"\r\n                      className={`min-h-[44px] max-h-[100px] resize-none text-sm leading-relaxed rounded-lg border pr-20 pl-3 py-2 ${\r\n                        attachments.length > 0 ? \"pt-12\" : \"\"\r\n                      }`}\r\n                    />\r\n\r\n                    {/* Buttons */}\r\n                    <div className=\"absolute bottom-2 right-2 flex items-center gap-1\">\r\n                      <Button\r\n                        variant=\"ghost\"\r\n                        size=\"icon\"\r\n                        onClick={() => setShowAttachmentOptions(!showAttachmentOptions)}\r\n                        className={`h-7 w-7 rounded-lg transition-all ${\r\n                          showAttachmentOptions\r\n                            ? \"bg-primary/10 text-primary\"\r\n                            : \"hover:bg-muted/60 text-muted-foreground hover:text-foreground\"\r\n                        }`}\r\n                      >\r\n                        <Paperclip className=\"h-4 w-4\" />\r\n                      </Button>\r\n                      {(message.trim() || attachments.length > 0) && !isRecording && (\r\n                        <>\r\n                          {isSaving ? (\r\n                            <Loader2 className=\"h-4 w-4 text-primary animate-spin\" />\r\n                          ) : (\r\n                            <Button\r\n                              onClick={handleSendMessage}\r\n                              size=\"icon\"\r\n                              className=\"h-7 w-7 rounded-lg transition-all\"\r\n                            >\r\n                              <Send className=\"h-3.5 w-3.5\" />\r\n                            </Button>\r\n                          )}\r\n                        </>\r\n                      )}\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </>\r\n          )}\r\n        </div>\r\n      </main>\r\n    </div>\r\n  );\r\n}\r\n\r\n"],"names":[],"mappings":"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"}