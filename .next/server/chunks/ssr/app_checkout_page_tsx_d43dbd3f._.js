module.exports=[52694,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944),e=a.i(95245),f=a.i(59501),g=a.i(82329),h=a.i(410),i=a.i(60421),j=a.i(3130),k=a.i(40695),l=a.i(5522),m=a.i(46893),n=a.i(17171),o=a.i(77687),p=a.i(78987),q=a.i(96221),r=a.i(32860),s=a.i(92e3),t=a.i(83497),u=a.i(71987),v=a.i(38246),w=a.i(99614);let x=w.object({firstName:w.string().min(1,"نام الزامی است"),lastName:w.string().min(1,"نام خانوادگی الزامی است"),phone:w.string().min(10,"شماره تلفن باید حداقل 10 رقم باشد").regex(/^[0-9]+$/,"شماره تلفن باید فقط عدد باشد"),email:w.union([w.string().email("ایمیل نامعتبر است"),w.literal("")]).optional(),address:w.string().min(5,"آدرس باید حداقل 5 کاراکتر باشد"),city:w.string().min(1,"شهر الزامی است"),postalCode:w.string().optional().refine(a=>!a||""===a||/^[0-9]{10}$/.test(a),{message:"کد پستی باید 10 رقم باشد"}),province:w.string().optional(),notes:w.string().max(500,"یادداشت نمی‌تواند بیشتر از 500 کاراکتر باشد").optional()});function y(){let a=(0,d.useRouter)(),{toast:w}=(0,o.useToast)(),{items:y,getTotal:z,shippingMethod:A,clearCart:B}=(0,g.useCartStore)(),{addOrder:C}=(0,h.useOrderStore)(),{getProduct:D}=(0,i.useProductStore)(),[E,F]=(0,c.useState)(!1),[G,H]=(0,c.useState)(!1),{register:I,handleSubmit:J,formState:{errors:K},watch:L,setValue:M,reset:N}=(0,e.useForm)({resolver:(0,f.zodResolver)(x),mode:"onChange",defaultValues:{firstName:"",lastName:"",phone:"",email:"",address:"",city:"",postalCode:"",province:"",notes:""}});(0,c.useEffect)(()=>{let a=localStorage.getItem("checkoutData");if(a)try{let b=JSON.parse(a);b.formData&&N({firstName:b.formData.firstName||"",lastName:b.formData.lastName||"",phone:b.formData.phone||"",email:b.formData.email||"",address:b.formData.address||"",city:b.formData.city||"",postalCode:b.formData.postalCode||"",province:b.formData.province||"",notes:b.formData.notes||""})}catch(a){console.error("Error loading checkout data:",a)}},[N]);let O=z(),P=(()=>{if(!A||0===y.length)return 0;let a=0;for(let b of y){let c=D(b.id);if(c){let b="air"===A?c.airShippingCost??null:c.seaShippingCost??null;null!==b&&b>a&&(a=b)}}return 0===a?O>5e5?0:5e4:a})(),Q=O+P,R=async b=>{try{let c;console.log("onSubmit called with data:",b),H(!0),F(!0);let d={firstName:b.firstName.trim(),lastName:b.lastName.trim(),phone:b.phone.replace(/\D/g,""),email:b.email?.trim().toLowerCase()||"",address:b.address.trim(),city:b.city.trim(),postalCode:b.postalCode?.replace(/\D/g,"")||"",province:b.province?.trim()||"",notes:b.notes?.trim()||""};if(console.log("Sanitized data:",d),console.log("Items count:",y.length),console.log("Items:",y),0===y.length){console.error("Cart is empty!"),w({title:"خطا",description:"سبد خرید شما خالی است",variant:"destructive"}),F(!1);return}if(console.log("Final total:",Q),Q<=0||!isFinite(Q)){console.error("Invalid final total:",Q),w({title:"خطا",description:"مبلغ سفارش نامعتبر است",variant:"destructive"}),F(!1);return}console.log("Validating items...");try{c=y.map(a=>{if(console.log("Validating item:",a),!a||"object"!=typeof a)throw console.error("Invalid item object:",a),Error("آیتم سفارش نامعتبر است");if(!a.id||""===String(a.id).trim())throw console.error("Item missing id:",a),Error("شناسه محصول مشخص نشده است");if(!a.name||""===String(a.name).trim())throw console.error("Item missing name:",a),Error(`نام محصول برای شناسه "${a.id}" مشخص نشده است`);if(void 0===a.price||null===a.price||isNaN(Number(a.price)))throw console.error("Item missing or invalid price:",a),Error(`قیمت محصول "${a.name||a.id}" مشخص نشده است`);if(void 0===a.quantity||null===a.quantity||isNaN(Number(a.quantity)))throw console.error("Item missing or invalid quantity:",a),Error(`تعداد محصول "${a.name||a.id}" مشخص نشده است`);let b=a.image?String(a.image).trim():"";if(!b){let c=D(a.id);c&&c.images&&c.images.length>0&&(b=c.images[0])}let c={id:String(a.id).trim(),name:String(a.name).trim(),price:Number(a.price),quantity:Number(a.quantity),image:b||""};return console.log("Validated item:",c),c}),console.log("All items validated:",c)}catch(a){console.error("Validation error:",a),w({title:"خطا",description:a instanceof Error?a.message:"خطا در اعتبارسنجی محصولات",variant:"destructive"}),F(!1);return}console.log("Sending order creation request...");let e=await fetch("/api/orders/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:c,formData:d,total:Q,shippingCost:P,shippingMethod:A})});if(console.log("Order response status:",e.status),!e.ok){let a=await e.json().catch(()=>({}));throw console.error("Order creation failed:",a),Error(a.error||`HTTP error! status: ${e.status}`)}let f=await e.json();console.log("Order created successfully:",f);let g=f.data?.order||f.order;if(!f.success||!g){let a=f.error||"خطا در ثبت سفارش",b=a.includes("database")||a.includes("connection")||a.includes("دیتابیس");w({title:"خطا",description:b?"خطا در اتصال به دیتابیس. لطفاً بعداً تلاش کنید.":a,variant:"destructive"}),F(!1);return}console.log("[Mock Payment] Updating payment status to paid for order:",g.id);let h=await fetch(`/api/orders/${g.id}/payment-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentStatus:"paid"})});if(!h.ok){let a=await h.json().catch(()=>({}));throw console.error("[Mock Payment] Failed to update payment status:",a),Error(a.error||"خطا در به‌روزرسانی وضعیت پرداخت")}let i=await h.json();console.log("[Mock Payment] Payment status updated successfully:",i);let j=i.success&&i.data?i.data:{...g,paymentStatus:"paid"};console.log("[Mock Payment] Adding order to store:",j),C(j),console.log("[Mock Payment] Clearing cart..."),B(),console.log("[Mock Payment] Clearing localStorage..."),localStorage.removeItem("checkoutData"),localStorage.removeItem("pendingOrder"),localStorage.removeItem("dismissedOrderStatusBar"),console.log("[Mock Payment] Showing success toast..."),w({title:"پرداخت موفق",description:"سفارش شما با موفقیت ثبت و پرداخت شد"});let k=j.orderNumber||g.orderNumber;console.log("[Mock Payment] Redirecting to track page with orderNumber:",k),setTimeout(()=>{a.push(`/order/track?orderNumber=${k}`)},1e3)}catch(d){console.error("[Checkout] Order creation error:",{message:d instanceof Error?d.message:"Unknown error",name:d instanceof Error?d.name:"Unknown",...!1});let a=d instanceof Error?d.message:"خطایی در پردازش درخواست رخ داد",b=a.includes("database")||a.includes("connection")||a.includes("دیتابیس"),c=a.includes("fetch")||a.includes("network")||a.includes("Failed to fetch");w({title:"خطا",description:b?"خطا در اتصال به دیتابیس. لطفاً بعداً تلاش کنید.":c?"خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کنید.":a,variant:"destructive"}),F(!1)}};return 0===y.length?(0,b.jsx)("div",{className:"container mx-auto px-4 py-12 sm:py-20",children:(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center py-12 sm:py-20",children:[(0,b.jsx)(p.ShoppingBag,{className:"h-16 w-16 sm:h-24 sm:w-24 text-muted-foreground mb-4"}),(0,b.jsx)("h2",{className:"text-xl sm:text-2xl font-bold mb-2 text-center",children:"سبد خرید شما خالی است"}),(0,b.jsx)("p",{className:"text-sm sm:text-base text-muted-foreground mb-6 text-center",children:"محصولات مورد نظر خود را به سبد خرید اضافه کنید"}),(0,b.jsx)(v.default,{href:"/products",children:(0,b.jsx)(k.Button,{size:"lg",className:"h-11 sm:h-12",children:"مشاهده محصولات"})})]})}):(0,b.jsxs)("div",{className:"container mx-auto px-4 py-6 sm:py-8 md:py-12",children:[(0,b.jsx)("h1",{className:"text-2xl sm:text-3xl font-bold mb-6 sm:mb-8",children:"تکمیل اطلاعات و پرداخت"}),(0,b.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8",children:[(0,b.jsx)("div",{className:"lg:col-span-2",children:(0,b.jsxs)(j.Card,{children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"اطلاعات تحویل"})}),(0,b.jsx)(j.CardContent,{children:(0,b.jsxs)("form",{onSubmit:a=>{a.preventDefault(),console.log("[Form] Submit event triggered"),J(a=>{console.log("[Form] Validation passed, data:",a),R(a)},a=>{console.error("[Form] Validation errors:",a),H(!0);let b=Object.values(a)[0];b&&w({title:"خطا در اعتبارسنجی",description:b.message||"لطفاً تمام فیلدهای الزامی را پر کنید",variant:"destructive"})})(a)},className:"space-y-4 sm:space-y-6",children:[(0,b.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(n.Label,{htmlFor:"firstName",children:["نام ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(l.Input,{id:"firstName",...I("firstName"),placeholder:"نام",className:K.firstName?"border-destructive":""}),K.firstName&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(s.AlertCircle,{className:"h-3 w-3"}),K.firstName.message]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(n.Label,{htmlFor:"lastName",children:["نام خانوادگی ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(l.Input,{id:"lastName",...I("lastName"),placeholder:"نام خانوادگی",className:K.lastName?"border-destructive":""}),K.lastName&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(s.AlertCircle,{className:"h-3 w-3"}),K.lastName.message]})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(n.Label,{htmlFor:"phone",children:["شماره تماس ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(l.Input,{id:"phone",...I("phone"),type:"tel",onChange:a=>{let b=a.target.value.replace(/\D/g,"");b.length<=11&&M("phone",b)},placeholder:"09123456789",maxLength:11,className:K.phone?"border-destructive":""}),K.phone&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(s.AlertCircle,{className:"h-3 w-3"}),K.phone.message]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(n.Label,{htmlFor:"email",children:["ایمیل ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(l.Input,{id:"email",...I("email"),type:"email",placeholder:"example@email.com",className:K.email?"border-destructive":""}),K.email&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(s.AlertCircle,{className:"h-3 w-3"}),K.email.message]})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(n.Label,{htmlFor:"address",children:["آدرس کامل ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(m.Textarea,{id:"address",...I("address"),placeholder:"آدرس کامل تحویل",rows:3,className:K.address?"border-destructive":""}),K.address&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(s.AlertCircle,{className:"h-3 w-3"}),K.address.message]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(n.Label,{htmlFor:"city",children:["شهر ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(l.Input,{id:"city",...I("city"),placeholder:"شهر",className:K.city?"border-destructive":""}),K.city&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(s.AlertCircle,{className:"h-3 w-3"}),K.city.message]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(n.Label,{htmlFor:"postalCode",children:"کد پستی"}),(0,b.jsx)(l.Input,{id:"postalCode",...I("postalCode"),onChange:a=>{let b=a.target.value.replace(/\D/g,"");b.length<=10&&M("postalCode",b)},placeholder:"1234567890",maxLength:10,className:K.postalCode?"border-destructive":""}),K.postalCode&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(s.AlertCircle,{className:"h-3 w-3"}),K.postalCode.message]})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(n.Label,{htmlFor:"province",children:"استان (اختیاری)"}),(0,b.jsx)(l.Input,{id:"province",...I("province"),placeholder:"استان",className:K.province?"border-destructive":""}),K.province&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(s.AlertCircle,{className:"h-3 w-3"}),K.province.message]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(n.Label,{htmlFor:"notes",children:"یادداشت (اختیاری)"}),(0,b.jsx)(m.Textarea,{id:"notes",...I("notes"),placeholder:"یادداشت یا توضیحات اضافی",rows:3,className:K.notes?"border-destructive":""}),K.notes&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(s.AlertCircle,{className:"h-3 w-3"}),K.notes.message]})]}),G&&Object.keys(K).length>0&&(0,b.jsxs)("div",{className:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg",children:[(0,b.jsx)("p",{className:"text-sm text-destructive font-medium mb-2",children:"لطفاً خطاهای زیر را برطرف کنید:"}),(0,b.jsx)("ul",{className:"list-disc list-inside space-y-1 text-sm text-destructive",children:Object.entries(K).map(([a,c])=>(0,b.jsx)("li",{children:c?.message||`${a} نامعتبر است`},a))})]}),(0,b.jsx)(k.Button,{type:"submit",className:"w-full h-11 sm:h-12 text-sm sm:text-base",size:"lg",disabled:E,children:E?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(q.Loader2,{className:"ml-2 h-4 w-4 animate-spin"}),"در حال اتصال به درگاه..."]}):(0,b.jsxs)(b.Fragment,{children:["ادامه به درگاه پرداخت",(0,b.jsx)(r.ArrowRight,{className:"mr-2 h-4 w-4"})]})})]})})]})}),(0,b.jsx)("div",{className:"lg:col-span-1",children:(0,b.jsxs)(j.Card,{className:"sticky top-20 sm:top-24",children:[(0,b.jsx)(j.CardHeader,{children:(0,b.jsx)(j.CardTitle,{children:"خلاصه سفارش"})}),(0,b.jsxs)(j.CardContent,{className:"space-y-4",children:[(0,b.jsx)("div",{className:"space-y-3 max-h-[300px] overflow-y-auto",children:y.map(a=>(0,b.jsxs)("div",{className:"flex gap-3 pb-3 border-b border-border/30 last:border-0",children:[(0,b.jsx)("div",{className:"relative w-16 h-16 bg-muted rounded-lg overflow-hidden flex-shrink-0",children:a.image&&""!==a.image.trim()?(0,b.jsx)(u.default,{src:a.image,alt:a.name,fill:!0,className:"object-cover"}):(0,b.jsx)("div",{className:"w-full h-full flex items-center justify-center text-muted-foreground",children:(0,b.jsx)(t.Package,{className:"h-6 w-6"})})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsx)("h3",{className:"font-medium text-sm line-clamp-2 mb-1",children:a.name}),(0,b.jsxs)("div",{className:"flex justify-between text-sm text-muted-foreground",children:[(0,b.jsxs)("span",{children:["تعداد: ",a.quantity]}),(0,b.jsxs)("span",{className:"font-semibold text-foreground",children:[(a.price*a.quantity).toLocaleString("fa-IR")," ","تومان"]})]})]})]},a.id))}),(0,b.jsxs)("div",{className:"space-y-2 pt-2 border-t border-border/30",children:[(0,b.jsxs)("div",{className:"flex justify-between text-sm sm:text-base",children:[(0,b.jsx)("span",{children:"جمع کل:"}),(0,b.jsxs)("span",{className:"font-semibold",children:[O.toLocaleString("fa-IR")," تومان"]})]}),(0,b.jsxs)("div",{className:"flex justify-between text-sm sm:text-base",children:[(0,b.jsx)("span",{children:"هزینه ارسال:"}),(0,b.jsx)("span",{className:"font-semibold",children:0===P?(0,b.jsx)("span",{className:"text-green-600",children:"رایگان"}):`${P.toLocaleString("fa-IR")} تومان`})]}),A&&(0,b.jsxs)("div",{className:"flex justify-between text-xs text-muted-foreground",children:[(0,b.jsx)("span",{children:"روش ارسال:"}),(0,b.jsx)("span",{children:"air"===A?"هوایی":"دریایی"})]}),(0,b.jsxs)("div",{className:"flex justify-between text-base sm:text-lg font-bold pt-2 border-t border-border/30",children:[(0,b.jsx)("span",{children:"مبلغ نهایی:"}),(0,b.jsxs)("span",{className:"text-primary",children:[Q.toLocaleString("fa-IR")," تومان"]})]})]})]})]})})]})]})}a.s(["default",()=>y],52694)}];

//# sourceMappingURL=app_checkout_page_tsx_d43dbd3f._.js.map