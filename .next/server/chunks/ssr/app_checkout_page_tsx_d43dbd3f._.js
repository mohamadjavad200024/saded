module.exports=[52694,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(50944),e=a.i(95245),f=a.i(59501),g=a.i(82329),h=a.i(410),i=a.i(60421),j=a.i(25173),k=a.i(3130),l=a.i(40695),m=a.i(5522),n=a.i(46893),o=a.i(17171),p=a.i(77687),q=a.i(78987),r=a.i(96221),s=a.i(32860),t=a.i(92e3),u=a.i(83497),v=a.i(71987),w=a.i(38246),x=a.i(99614);let y=x.object({firstName:x.string().min(1,"نام الزامی است"),lastName:x.string().min(1,"نام خانوادگی الزامی است"),phone:x.string().min(10,"شماره تلفن باید حداقل 10 رقم باشد").regex(/^[0-9]+$/,"شماره تلفن باید فقط عدد باشد"),email:x.union([x.string().email("ایمیل نامعتبر است"),x.literal("")]).optional(),address:x.string().min(5,"آدرس باید حداقل 5 کاراکتر باشد"),city:x.string().min(1,"شهر الزامی است"),postalCode:x.string().optional().refine(a=>!a||""===a||/^[0-9]{10}$/.test(a),{message:"کد پستی باید 10 رقم باشد"}),province:x.string().optional(),notes:x.string().max(500,"یادداشت نمی‌تواند بیشتر از 500 کاراکتر باشد").optional()});function z(){let a=(0,d.useRouter)(),{toast:x}=(0,p.useToast)(),{items:z,getTotal:A,shippingMethod:B,clearCart:C}=(0,g.useCartStore)(),{addOrder:D}=(0,h.useOrderStore)(),{getProduct:E}=(0,i.useProductStore)(),{user:F,isAuthenticated:G}=(0,j.useAuthStore)(),[H,I]=(0,c.useState)(!1),[J,K]=(0,c.useState)(!1),{register:L,handleSubmit:M,formState:{errors:N},watch:O,setValue:P,reset:Q}=(0,e.useForm)({resolver:(0,f.zodResolver)(y),mode:"onChange",defaultValues:{firstName:"",lastName:"",phone:"",email:"",address:"",city:"",postalCode:"",province:"",notes:""}});(0,c.useEffect)(()=>{if(G&&F){let a=F.name.split(" ");Q({firstName:a[0]||"",lastName:a.slice(1).join(" ")||"",phone:F.phone||"",email:"",address:"",city:"",postalCode:"",province:"",notes:""})}else{let a=localStorage.getItem("checkoutData");if(a)try{let b=JSON.parse(a);b.formData&&Q({firstName:b.formData.firstName||"",lastName:b.formData.lastName||"",phone:b.formData.phone||"",email:b.formData.email||"",address:b.formData.address||"",city:b.formData.city||"",postalCode:b.formData.postalCode||"",province:b.formData.province||"",notes:b.formData.notes||""})}catch(a){console.error("Error loading checkout data:",a)}}},[Q,G,F]);let R=A(),S=(()=>{if(!B||0===z.length)return 0;let a=0;for(let b of z){let c=E(b.id);if(c){let b="air"===B?c.airShippingCost??null:c.seaShippingCost??null;null!==b&&b>a&&(a=b)}}return 0===a?R>5e5?0:5e4:a})(),T=R+S,U=async b=>{try{let c;console.log("onSubmit called with data:",b),K(!0),I(!0);let d={firstName:b.firstName.trim(),lastName:b.lastName.trim(),phone:b.phone.replace(/\D/g,""),email:b.email?.trim().toLowerCase()||"",address:b.address.trim(),city:b.city.trim(),postalCode:b.postalCode?.replace(/\D/g,"")||"",province:b.province?.trim()||"",notes:b.notes?.trim()||""};if(console.log("Sanitized data:",d),console.log("Items count:",z.length),console.log("Items:",z),0===z.length){console.error("Cart is empty!"),x({title:"خطا",description:"سبد خرید شما خالی است",variant:"destructive"}),I(!1);return}if(console.log("Final total:",T),T<=0||!isFinite(T)){console.error("Invalid final total:",T),x({title:"خطا",description:"مبلغ سفارش نامعتبر است",variant:"destructive"}),I(!1);return}console.log("Validating items...");try{c=z.map(a=>{if(console.log("Validating item:",a),!a||"object"!=typeof a)throw console.error("Invalid item object:",a),Error("آیتم سفارش نامعتبر است");if(!a.id||""===String(a.id).trim())throw console.error("Item missing id:",a),Error("شناسه محصول مشخص نشده است");if(!a.name||""===String(a.name).trim())throw console.error("Item missing name:",a),Error(`نام محصول برای شناسه "${a.id}" مشخص نشده است`);if(void 0===a.price||null===a.price||isNaN(Number(a.price)))throw console.error("Item missing or invalid price:",a),Error(`قیمت محصول "${a.name||a.id}" مشخص نشده است`);if(void 0===a.quantity||null===a.quantity||isNaN(Number(a.quantity)))throw console.error("Item missing or invalid quantity:",a),Error(`تعداد محصول "${a.name||a.id}" مشخص نشده است`);let b=a.image?String(a.image).trim():"";if(!b){let c=E(a.id);c&&c.images&&c.images.length>0&&(b=c.images[0])}let c={id:String(a.id).trim(),name:String(a.name).trim(),price:Number(a.price),quantity:Number(a.quantity),image:b||""};return console.log("Validated item:",c),c}),console.log("All items validated:",c)}catch(a){console.error("Validation error:",a),x({title:"خطا",description:a instanceof Error?a.message:"خطا در اعتبارسنجی محصولات",variant:"destructive"}),I(!1);return}console.log("Sending order creation request...");let e=await fetch("/api/orders/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:c,formData:d,total:T,shippingCost:S,shippingMethod:B})});if(console.log("Order response status:",e.status),!e.ok){let a=await e.json().catch(()=>({}));throw console.error("Order creation failed:",a),Error(a.error||`HTTP error! status: ${e.status}`)}let f=await e.json();console.log("Order created successfully:",f);let g=f.data?.order||f.order;if(!f.success||!g){let a=f.error||"خطا در ثبت سفارش",b=a.includes("database")||a.includes("connection")||a.includes("دیتابیس");x({title:"خطا",description:b?"خطا در اتصال به دیتابیس. لطفاً بعداً تلاش کنید.":a,variant:"destructive"}),I(!1);return}console.log("[Mock Payment] Updating payment status to paid for order:",g.id);let h=await fetch(`/api/orders/${g.id}/payment-status`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({paymentStatus:"paid"})});if(!h.ok){let a=await h.json().catch(()=>({}));throw console.error("[Mock Payment] Failed to update payment status:",a),Error(a.error||"خطا در به‌روزرسانی وضعیت پرداخت")}let i=await h.json();console.log("[Mock Payment] Payment status updated successfully:",i);let j=i.success&&i.data?i.data:{...g,paymentStatus:"paid"};console.log("[Mock Payment] Adding order to store:",j),D(j),console.log("[Mock Payment] Clearing cart..."),C(),console.log("[Mock Payment] Clearing localStorage..."),localStorage.removeItem("checkoutData"),localStorage.removeItem("pendingOrder"),localStorage.removeItem("dismissedOrderStatusBar"),console.log("[Mock Payment] Showing success toast..."),x({title:"پرداخت موفق",description:"سفارش شما با موفقیت ثبت و پرداخت شد"});let k=j.orderNumber||g.orderNumber;console.log("[Mock Payment] Redirecting to track page with orderNumber:",k),setTimeout(()=>{a.push(`/order/track?orderNumber=${k}`)},1e3)}catch(d){console.error("[Checkout] Order creation error:",{message:d instanceof Error?d.message:"Unknown error",name:d instanceof Error?d.name:"Unknown",...!1});let a=d instanceof Error?d.message:"خطایی در پردازش درخواست رخ داد",b=a.includes("database")||a.includes("connection")||a.includes("دیتابیس"),c=a.includes("fetch")||a.includes("network")||a.includes("Failed to fetch");x({title:"خطا",description:b?"خطا در اتصال به دیتابیس. لطفاً بعداً تلاش کنید.":c?"خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کنید.":a,variant:"destructive"}),I(!1)}};return 0===z.length?(0,b.jsx)("div",{className:"container mx-auto px-4 py-12 sm:py-20",children:(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center py-12 sm:py-20",children:[(0,b.jsx)(q.ShoppingBag,{className:"h-16 w-16 sm:h-24 sm:w-24 text-muted-foreground mb-4"}),(0,b.jsx)("h2",{className:"text-xl sm:text-2xl font-bold mb-2 text-center",children:"سبد خرید شما خالی است"}),(0,b.jsx)("p",{className:"text-sm sm:text-base text-muted-foreground mb-6 text-center",children:"محصولات مورد نظر خود را به سبد خرید اضافه کنید"}),(0,b.jsx)(w.default,{href:"/products",children:(0,b.jsx)(l.Button,{size:"lg",className:"h-11 sm:h-12",children:"مشاهده محصولات"})})]})}):(0,b.jsxs)("div",{className:"container mx-auto px-4 py-6 sm:py-8 md:py-12",children:[(0,b.jsx)("h1",{className:"text-2xl sm:text-3xl font-bold mb-6 sm:mb-8",children:"تکمیل اطلاعات و پرداخت"}),(0,b.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 sm:gap-8",children:[(0,b.jsx)("div",{className:"lg:col-span-2",children:(0,b.jsxs)(k.Card,{children:[(0,b.jsx)(k.CardHeader,{children:(0,b.jsx)(k.CardTitle,{children:"اطلاعات تحویل"})}),(0,b.jsx)(k.CardContent,{children:(0,b.jsxs)("form",{onSubmit:a=>{a.preventDefault(),console.log("[Form] Submit event triggered"),M(a=>{console.log("[Form] Validation passed, data:",a),U(a)},a=>{console.error("[Form] Validation errors:",a),K(!0);let b=Object.values(a)[0];b&&x({title:"خطا در اعتبارسنجی",description:b.message||"لطفاً تمام فیلدهای الزامی را پر کنید",variant:"destructive"})})(a)},className:"space-y-4 sm:space-y-6",children:[(0,b.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(o.Label,{htmlFor:"firstName",children:["نام ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(m.Input,{id:"firstName",...L("firstName"),placeholder:"نام",className:N.firstName?"border-destructive":""}),N.firstName&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(t.AlertCircle,{className:"h-3 w-3"}),N.firstName.message]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(o.Label,{htmlFor:"lastName",children:["نام خانوادگی ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(m.Input,{id:"lastName",...L("lastName"),placeholder:"نام خانوادگی",className:N.lastName?"border-destructive":""}),N.lastName&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(t.AlertCircle,{className:"h-3 w-3"}),N.lastName.message]})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(o.Label,{htmlFor:"phone",children:["شماره تماس ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(m.Input,{id:"phone",...L("phone"),type:"tel",onChange:a=>{let b=a.target.value.replace(/\D/g,"");b.length<=11&&P("phone",b)},placeholder:"09123456789",maxLength:11,className:N.phone?"border-destructive":""}),N.phone&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(t.AlertCircle,{className:"h-3 w-3"}),N.phone.message]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(o.Label,{htmlFor:"email",children:["ایمیل ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(m.Input,{id:"email",...L("email"),type:"email",placeholder:"example@email.com",className:N.email?"border-destructive":""}),N.email&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(t.AlertCircle,{className:"h-3 w-3"}),N.email.message]})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(o.Label,{htmlFor:"address",children:["آدرس کامل ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(n.Textarea,{id:"address",...L("address"),placeholder:"آدرس کامل تحویل",rows:3,className:N.address?"border-destructive":""}),N.address&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(t.AlertCircle,{className:"h-3 w-3"}),N.address.message]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(o.Label,{htmlFor:"city",children:["شهر ",(0,b.jsx)("span",{className:"text-destructive",children:"*"})]}),(0,b.jsx)(m.Input,{id:"city",...L("city"),placeholder:"شهر",className:N.city?"border-destructive":""}),N.city&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(t.AlertCircle,{className:"h-3 w-3"}),N.city.message]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(o.Label,{htmlFor:"postalCode",children:"کد پستی"}),(0,b.jsx)(m.Input,{id:"postalCode",...L("postalCode"),onChange:a=>{let b=a.target.value.replace(/\D/g,"");b.length<=10&&P("postalCode",b)},placeholder:"1234567890",maxLength:10,className:N.postalCode?"border-destructive":""}),N.postalCode&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(t.AlertCircle,{className:"h-3 w-3"}),N.postalCode.message]})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(o.Label,{htmlFor:"province",children:"استان (اختیاری)"}),(0,b.jsx)(m.Input,{id:"province",...L("province"),placeholder:"استان",className:N.province?"border-destructive":""}),N.province&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(t.AlertCircle,{className:"h-3 w-3"}),N.province.message]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(o.Label,{htmlFor:"notes",children:"یادداشت (اختیاری)"}),(0,b.jsx)(n.Textarea,{id:"notes",...L("notes"),placeholder:"یادداشت یا توضیحات اضافی",rows:3,className:N.notes?"border-destructive":""}),N.notes&&(0,b.jsxs)("p",{className:"text-sm text-destructive flex items-center gap-1",children:[(0,b.jsx)(t.AlertCircle,{className:"h-3 w-3"}),N.notes.message]})]}),J&&Object.keys(N).length>0&&(0,b.jsxs)("div",{className:"p-4 bg-destructive/10 border border-destructive/20 rounded-lg",children:[(0,b.jsx)("p",{className:"text-sm text-destructive font-medium mb-2",children:"لطفاً خطاهای زیر را برطرف کنید:"}),(0,b.jsx)("ul",{className:"list-disc list-inside space-y-1 text-sm text-destructive",children:Object.entries(N).map(([a,c])=>(0,b.jsx)("li",{children:c?.message||`${a} نامعتبر است`},a))})]}),(0,b.jsx)(l.Button,{type:"submit",className:"w-full h-11 sm:h-12 text-sm sm:text-base",size:"lg",disabled:H,children:H?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(r.Loader2,{className:"ml-2 h-4 w-4 animate-spin"}),"در حال اتصال به درگاه..."]}):(0,b.jsxs)(b.Fragment,{children:["ادامه به درگاه پرداخت",(0,b.jsx)(s.ArrowRight,{className:"mr-2 h-4 w-4"})]})})]})})]})}),(0,b.jsx)("div",{className:"lg:col-span-1",children:(0,b.jsxs)(k.Card,{className:"sticky top-20 sm:top-24",children:[(0,b.jsx)(k.CardHeader,{children:(0,b.jsx)(k.CardTitle,{children:"خلاصه سفارش"})}),(0,b.jsxs)(k.CardContent,{className:"space-y-4",children:[(0,b.jsx)("div",{className:"space-y-3 max-h-[300px] overflow-y-auto",children:z.map(a=>(0,b.jsxs)("div",{className:"flex gap-3 pb-3 border-b border-border/30 last:border-0",children:[(0,b.jsx)("div",{className:"relative w-16 h-16 bg-muted rounded-lg overflow-hidden flex-shrink-0",children:a.image&&""!==a.image.trim()?(0,b.jsx)(v.default,{src:a.image,alt:a.name,fill:!0,className:"object-cover"}):(0,b.jsx)("div",{className:"w-full h-full flex items-center justify-center text-muted-foreground",children:(0,b.jsx)(u.Package,{className:"h-6 w-6"})})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsx)("h3",{className:"font-medium text-sm line-clamp-2 mb-1",children:a.name}),(0,b.jsxs)("div",{className:"flex justify-between text-sm text-muted-foreground",children:[(0,b.jsxs)("span",{children:["تعداد: ",a.quantity]}),(0,b.jsxs)("span",{className:"font-semibold text-foreground",children:[(a.price*a.quantity).toLocaleString("fa-IR")," ","تومان"]})]})]})]},a.id))}),(0,b.jsxs)("div",{className:"space-y-2 pt-2 border-t border-border/30",children:[(0,b.jsxs)("div",{className:"flex justify-between text-sm sm:text-base",children:[(0,b.jsx)("span",{children:"جمع کل:"}),(0,b.jsxs)("span",{className:"font-semibold",children:[R.toLocaleString("fa-IR")," تومان"]})]}),(0,b.jsxs)("div",{className:"flex justify-between text-sm sm:text-base",children:[(0,b.jsx)("span",{children:"هزینه ارسال:"}),(0,b.jsx)("span",{className:"font-semibold",children:0===S?(0,b.jsx)("span",{className:"text-green-600",children:"رایگان"}):`${S.toLocaleString("fa-IR")} تومان`})]}),B&&(0,b.jsxs)("div",{className:"flex justify-between text-xs text-muted-foreground",children:[(0,b.jsx)("span",{children:"روش ارسال:"}),(0,b.jsx)("span",{children:"air"===B?"هوایی":"دریایی"})]}),(0,b.jsxs)("div",{className:"flex justify-between text-base sm:text-lg font-bold pt-2 border-t border-border/30",children:[(0,b.jsx)("span",{children:"مبلغ نهایی:"}),(0,b.jsxs)("span",{className:"text-primary",children:[T.toLocaleString("fa-IR")," تومان"]})]})]})]})]})})]})]})}a.s(["default",()=>z],52694)}];

//# sourceMappingURL=app_checkout_page_tsx_d43dbd3f._.js.map