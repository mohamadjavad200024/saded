module.exports=[46470,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(30553),e=a.i(77192),f=a.i(50104),g=a.i(70121),h=a.i(46872),i=a.i(7827),j=a.i(72752),k=a.i(30656),l=a.i(7554),m="ScrollArea",[n,o]=(0,f.createContextScope)(m),[p,q]=n(m),r=c.forwardRef((a,e)=>{let{__scopeScrollArea:f,type:h="hover",dir:j,scrollHideDelay:k=600,...l}=a,[m,n]=c.useState(null),[o,q]=c.useState(null),[r,s]=c.useState(null),[t,u]=c.useState(null),[v,w]=c.useState(null),[x,y]=c.useState(0),[z,A]=c.useState(0),[B,C]=c.useState(!1),[D,E]=c.useState(!1),F=(0,g.useComposedRefs)(e,a=>n(a)),G=(0,i.useDirection)(j);return(0,b.jsx)(p,{scope:f,type:h,dir:G,scrollHideDelay:k,scrollArea:m,viewport:o,onViewportChange:q,content:r,onContentChange:s,scrollbarX:t,onScrollbarXChange:u,scrollbarXEnabled:B,onScrollbarXEnabledChange:C,scrollbarY:v,onScrollbarYChange:w,scrollbarYEnabled:D,onScrollbarYEnabledChange:E,onCornerWidthChange:y,onCornerHeightChange:A,children:(0,b.jsx)(d.Primitive.div,{dir:G,...l,ref:F,style:{position:"relative","--radix-scroll-area-corner-width":x+"px","--radix-scroll-area-corner-height":z+"px",...a.style}})})});r.displayName=m;var s="ScrollAreaViewport",t=c.forwardRef((a,e)=>{let{__scopeScrollArea:f,children:h,nonce:i,...j}=a,k=q(s,f),l=c.useRef(null),m=(0,g.useComposedRefs)(e,l,k.onViewportChange);return(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)("style",{dangerouslySetInnerHTML:{__html:"[data-radix-scroll-area-viewport]{scrollbar-width:none;-ms-overflow-style:none;-webkit-overflow-scrolling:touch;}[data-radix-scroll-area-viewport]::-webkit-scrollbar{display:none}"},nonce:i}),(0,b.jsx)(d.Primitive.div,{"data-radix-scroll-area-viewport":"",...j,ref:m,style:{overflowX:k.scrollbarXEnabled?"scroll":"hidden",overflowY:k.scrollbarYEnabled?"scroll":"hidden",...a.style},children:(0,b.jsx)("div",{ref:k.onContentChange,style:{minWidth:"100%",display:"table"},children:h})})]})});t.displayName=s;var u="ScrollAreaScrollbar",v=c.forwardRef((a,d)=>{let{forceMount:e,...f}=a,g=q(u,a.__scopeScrollArea),{onScrollbarXEnabledChange:h,onScrollbarYEnabledChange:i}=g,j="horizontal"===a.orientation;return c.useEffect(()=>(j?h(!0):i(!0),()=>{j?h(!1):i(!1)}),[j,h,i]),"hover"===g.type?(0,b.jsx)(w,{...f,ref:d,forceMount:e}):"scroll"===g.type?(0,b.jsx)(x,{...f,ref:d,forceMount:e}):"auto"===g.type?(0,b.jsx)(y,{...f,ref:d,forceMount:e}):"always"===g.type?(0,b.jsx)(z,{...f,ref:d}):null});v.displayName=u;var w=c.forwardRef((a,d)=>{let{forceMount:f,...g}=a,h=q(u,a.__scopeScrollArea),[i,j]=c.useState(!1);return c.useEffect(()=>{let a=h.scrollArea,b=0;if(a){let c=()=>{window.clearTimeout(b),j(!0)},d=()=>{b=window.setTimeout(()=>j(!1),h.scrollHideDelay)};return a.addEventListener("pointerenter",c),a.addEventListener("pointerleave",d),()=>{window.clearTimeout(b),a.removeEventListener("pointerenter",c),a.removeEventListener("pointerleave",d)}}},[h.scrollArea,h.scrollHideDelay]),(0,b.jsx)(e.Presence,{present:f||i,children:(0,b.jsx)(y,{"data-state":i?"visible":"hidden",...g,ref:d})})}),x=c.forwardRef((a,d)=>{var f;let{forceMount:g,...h}=a,i=q(u,a.__scopeScrollArea),j="horizontal"===a.orientation,k=R(()=>n("SCROLL_END"),100),[m,n]=(f={hidden:{SCROLL:"scrolling"},scrolling:{SCROLL_END:"idle",POINTER_ENTER:"interacting"},interacting:{SCROLL:"interacting",POINTER_LEAVE:"idle"},idle:{HIDE:"hidden",SCROLL:"scrolling",POINTER_ENTER:"interacting"}},c.useReducer((a,b)=>f[a][b]??a,"hidden"));return c.useEffect(()=>{if("idle"===m){let a=window.setTimeout(()=>n("HIDE"),i.scrollHideDelay);return()=>window.clearTimeout(a)}},[m,i.scrollHideDelay,n]),c.useEffect(()=>{let a=i.viewport,b=j?"scrollLeft":"scrollTop";if(a){let c=a[b],d=()=>{let d=a[b];c!==d&&(n("SCROLL"),k()),c=d};return a.addEventListener("scroll",d),()=>a.removeEventListener("scroll",d)}},[i.viewport,j,n,k]),(0,b.jsx)(e.Presence,{present:g||"hidden"!==m,children:(0,b.jsx)(z,{"data-state":"hidden"===m?"hidden":"visible",...h,ref:d,onPointerEnter:(0,l.composeEventHandlers)(a.onPointerEnter,()=>n("POINTER_ENTER")),onPointerLeave:(0,l.composeEventHandlers)(a.onPointerLeave,()=>n("POINTER_LEAVE"))})})}),y=c.forwardRef((a,d)=>{let f=q(u,a.__scopeScrollArea),{forceMount:g,...h}=a,[i,j]=c.useState(!1),k="horizontal"===a.orientation,l=R(()=>{if(f.viewport){let a=f.viewport.offsetWidth<f.viewport.scrollWidth,b=f.viewport.offsetHeight<f.viewport.scrollHeight;j(k?a:b)}},10);return S(f.viewport,l),S(f.content,l),(0,b.jsx)(e.Presence,{present:g||i,children:(0,b.jsx)(z,{"data-state":i?"visible":"hidden",...h,ref:d})})}),z=c.forwardRef((a,d)=>{let{orientation:e="vertical",...f}=a,g=q(u,a.__scopeScrollArea),h=c.useRef(null),i=c.useRef(0),[j,k]=c.useState({content:0,viewport:0,scrollbar:{size:0,paddingStart:0,paddingEnd:0}}),l=M(j.viewport,j.content),m={...f,sizes:j,onSizesChange:k,hasThumb:!!(l>0&&l<1),onThumbChange:a=>h.current=a,onThumbPointerUp:()=>i.current=0,onThumbPointerDown:a=>i.current=a};function n(a,b){return function(a,b,c,d="ltr"){let e=N(c),f=b||e/2,g=c.scrollbar.paddingStart+f,h=c.scrollbar.size-c.scrollbar.paddingEnd-(e-f),i=c.content-c.viewport;return P([g,h],"ltr"===d?[0,i]:[-1*i,0])(a)}(a,i.current,j,b)}return"horizontal"===e?(0,b.jsx)(A,{...m,ref:d,onThumbPositionChange:()=>{if(g.viewport&&h.current){let a=O(g.viewport.scrollLeft,j,g.dir);h.current.style.transform=`translate3d(${a}px, 0, 0)`}},onWheelScroll:a=>{g.viewport&&(g.viewport.scrollLeft=a)},onDragScroll:a=>{g.viewport&&(g.viewport.scrollLeft=n(a,g.dir))}}):"vertical"===e?(0,b.jsx)(B,{...m,ref:d,onThumbPositionChange:()=>{if(g.viewport&&h.current){let a=O(g.viewport.scrollTop,j);h.current.style.transform=`translate3d(0, ${a}px, 0)`}},onWheelScroll:a=>{g.viewport&&(g.viewport.scrollTop=a)},onDragScroll:a=>{g.viewport&&(g.viewport.scrollTop=n(a))}}):null}),A=c.forwardRef((a,d)=>{let{sizes:e,onSizesChange:f,...h}=a,i=q(u,a.__scopeScrollArea),[j,k]=c.useState(),l=c.useRef(null),m=(0,g.useComposedRefs)(d,l,i.onScrollbarXChange);return c.useEffect(()=>{l.current&&k(getComputedStyle(l.current))},[l]),(0,b.jsx)(E,{"data-orientation":"horizontal",...h,ref:m,sizes:e,style:{bottom:0,left:"rtl"===i.dir?"var(--radix-scroll-area-corner-width)":0,right:"ltr"===i.dir?"var(--radix-scroll-area-corner-width)":0,"--radix-scroll-area-thumb-width":N(e)+"px",...a.style},onThumbPointerDown:b=>a.onThumbPointerDown(b.x),onDragScroll:b=>a.onDragScroll(b.x),onWheelScroll:(b,c)=>{if(i.viewport){var d,e;let f=i.viewport.scrollLeft+b.deltaX;a.onWheelScroll(f),d=f,e=c,d>0&&d<e&&b.preventDefault()}},onResize:()=>{l.current&&i.viewport&&j&&f({content:i.viewport.scrollWidth,viewport:i.viewport.offsetWidth,scrollbar:{size:l.current.clientWidth,paddingStart:L(j.paddingLeft),paddingEnd:L(j.paddingRight)}})}})}),B=c.forwardRef((a,d)=>{let{sizes:e,onSizesChange:f,...h}=a,i=q(u,a.__scopeScrollArea),[j,k]=c.useState(),l=c.useRef(null),m=(0,g.useComposedRefs)(d,l,i.onScrollbarYChange);return c.useEffect(()=>{l.current&&k(getComputedStyle(l.current))},[l]),(0,b.jsx)(E,{"data-orientation":"vertical",...h,ref:m,sizes:e,style:{top:0,right:"ltr"===i.dir?0:void 0,left:"rtl"===i.dir?0:void 0,bottom:"var(--radix-scroll-area-corner-height)","--radix-scroll-area-thumb-height":N(e)+"px",...a.style},onThumbPointerDown:b=>a.onThumbPointerDown(b.y),onDragScroll:b=>a.onDragScroll(b.y),onWheelScroll:(b,c)=>{if(i.viewport){var d,e;let f=i.viewport.scrollTop+b.deltaY;a.onWheelScroll(f),d=f,e=c,d>0&&d<e&&b.preventDefault()}},onResize:()=>{l.current&&i.viewport&&j&&f({content:i.viewport.scrollHeight,viewport:i.viewport.offsetHeight,scrollbar:{size:l.current.clientHeight,paddingStart:L(j.paddingTop),paddingEnd:L(j.paddingBottom)}})}})}),[C,D]=n(u),E=c.forwardRef((a,e)=>{let{__scopeScrollArea:f,sizes:i,hasThumb:j,onThumbChange:k,onThumbPointerUp:m,onThumbPointerDown:n,onThumbPositionChange:o,onDragScroll:p,onWheelScroll:r,onResize:s,...t}=a,v=q(u,f),[w,x]=c.useState(null),y=(0,g.useComposedRefs)(e,a=>x(a)),z=c.useRef(null),A=c.useRef(""),B=v.viewport,D=i.content-i.viewport,E=(0,h.useCallbackRef)(r),F=(0,h.useCallbackRef)(o),G=R(s,10);function H(a){z.current&&p({x:a.clientX-z.current.left,y:a.clientY-z.current.top})}return c.useEffect(()=>{let a=a=>{let b=a.target;w?.contains(b)&&E(a,D)};return document.addEventListener("wheel",a,{passive:!1}),()=>document.removeEventListener("wheel",a,{passive:!1})},[B,w,D,E]),c.useEffect(F,[i,F]),S(w,G),S(v.content,G),(0,b.jsx)(C,{scope:f,scrollbar:w,hasThumb:j,onThumbChange:(0,h.useCallbackRef)(k),onThumbPointerUp:(0,h.useCallbackRef)(m),onThumbPositionChange:F,onThumbPointerDown:(0,h.useCallbackRef)(n),children:(0,b.jsx)(d.Primitive.div,{...t,ref:y,style:{position:"absolute",...t.style},onPointerDown:(0,l.composeEventHandlers)(a.onPointerDown,a=>{0===a.button&&(a.target.setPointerCapture(a.pointerId),z.current=w.getBoundingClientRect(),A.current=document.body.style.webkitUserSelect,document.body.style.webkitUserSelect="none",v.viewport&&(v.viewport.style.scrollBehavior="auto"),H(a))}),onPointerMove:(0,l.composeEventHandlers)(a.onPointerMove,H),onPointerUp:(0,l.composeEventHandlers)(a.onPointerUp,a=>{let b=a.target;b.hasPointerCapture(a.pointerId)&&b.releasePointerCapture(a.pointerId),document.body.style.webkitUserSelect=A.current,v.viewport&&(v.viewport.style.scrollBehavior=""),z.current=null})})})}),F="ScrollAreaThumb",G=c.forwardRef((a,c)=>{let{forceMount:d,...f}=a,g=D(F,a.__scopeScrollArea);return(0,b.jsx)(e.Presence,{present:d||g.hasThumb,children:(0,b.jsx)(H,{ref:c,...f})})}),H=c.forwardRef((a,e)=>{let{__scopeScrollArea:f,style:h,...i}=a,j=q(F,f),k=D(F,f),{onThumbPositionChange:m}=k,n=(0,g.useComposedRefs)(e,a=>k.onThumbChange(a)),o=c.useRef(void 0),p=R(()=>{o.current&&(o.current(),o.current=void 0)},100);return c.useEffect(()=>{let a=j.viewport;if(a){let b=()=>{p(),o.current||(o.current=Q(a,m),m())};return m(),a.addEventListener("scroll",b),()=>a.removeEventListener("scroll",b)}},[j.viewport,p,m]),(0,b.jsx)(d.Primitive.div,{"data-state":k.hasThumb?"visible":"hidden",...i,ref:n,style:{width:"var(--radix-scroll-area-thumb-width)",height:"var(--radix-scroll-area-thumb-height)",...h},onPointerDownCapture:(0,l.composeEventHandlers)(a.onPointerDownCapture,a=>{let b=a.target.getBoundingClientRect(),c=a.clientX-b.left,d=a.clientY-b.top;k.onThumbPointerDown({x:c,y:d})}),onPointerUp:(0,l.composeEventHandlers)(a.onPointerUp,k.onThumbPointerUp)})});G.displayName=F;var I="ScrollAreaCorner",J=c.forwardRef((a,c)=>{let d=q(I,a.__scopeScrollArea),e=!!(d.scrollbarX&&d.scrollbarY);return"scroll"!==d.type&&e?(0,b.jsx)(K,{...a,ref:c}):null});J.displayName=I;var K=c.forwardRef((a,e)=>{let{__scopeScrollArea:f,...g}=a,h=q(I,f),[i,j]=c.useState(0),[k,l]=c.useState(0),m=!!(i&&k);return S(h.scrollbarX,()=>{let a=h.scrollbarX?.offsetHeight||0;h.onCornerHeightChange(a),l(a)}),S(h.scrollbarY,()=>{let a=h.scrollbarY?.offsetWidth||0;h.onCornerWidthChange(a),j(a)}),m?(0,b.jsx)(d.Primitive.div,{...g,ref:e,style:{width:i,height:k,position:"absolute",right:"ltr"===h.dir?0:void 0,left:"rtl"===h.dir?0:void 0,bottom:0,...a.style}}):null});function L(a){return a?parseInt(a,10):0}function M(a,b){let c=a/b;return isNaN(c)?0:c}function N(a){let b=M(a.viewport,a.content),c=a.scrollbar.paddingStart+a.scrollbar.paddingEnd;return Math.max((a.scrollbar.size-c)*b,18)}function O(a,b,c="ltr"){let d=N(b),e=b.scrollbar.paddingStart+b.scrollbar.paddingEnd,f=b.scrollbar.size-e,g=b.content-b.viewport,h=(0,k.clamp)(a,"ltr"===c?[0,g]:[-1*g,0]);return P([0,g],[0,f-d])(h)}function P(a,b){return c=>{if(a[0]===a[1]||b[0]===b[1])return b[0];let d=(b[1]-b[0])/(a[1]-a[0]);return b[0]+d*(c-a[0])}}var Q=(a,b=()=>{})=>{let c={left:a.scrollLeft,top:a.scrollTop},d=0;return!function e(){let f={left:a.scrollLeft,top:a.scrollTop},g=c.left!==f.left,h=c.top!==f.top;(g||h)&&b(),c=f,d=window.requestAnimationFrame(e)}(),()=>window.cancelAnimationFrame(d)};function R(a,b){let d=(0,h.useCallbackRef)(a),e=c.useRef(0);return c.useEffect(()=>()=>window.clearTimeout(e.current),[]),c.useCallback(()=>{window.clearTimeout(e.current),e.current=window.setTimeout(d,b)},[d,b])}function S(a,b){let c=(0,h.useCallbackRef)(b);(0,j.useLayoutEffect)(()=>{let b=0;if(a){let d=new ResizeObserver(()=>{cancelAnimationFrame(b),b=window.requestAnimationFrame(c)});return d.observe(a),()=>{window.cancelAnimationFrame(b),d.unobserve(a)}}},[a,c])}var T=a.i(97895);let U=c.forwardRef(({className:a,children:c,...d},e)=>(0,b.jsxs)(r,{ref:e,className:(0,T.cn)("relative overflow-hidden",a),...d,children:[(0,b.jsx)(t,{className:"h-full w-full rounded-[inherit]",children:c}),(0,b.jsx)(V,{}),(0,b.jsx)(J,{})]}));U.displayName=r.displayName;let V=c.forwardRef(({className:a,orientation:c="vertical",...d},e)=>(0,b.jsx)(v,{ref:e,orientation:c,className:(0,T.cn)("flex touch-none select-none transition-colors","vertical"===c&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===c&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",a),...d,children:(0,b.jsx)(G,{className:"relative flex-1 rounded-full bg-border"})}));V.displayName=v.displayName,a.s(["ScrollArea",()=>U],46470)},29328,39290,90944,a=>{"use strict";var b=a.i(72131),c=a.i(77687),d=a.i(54917),e=a.i(25173);function f(){let{toast:a}=(0,c.useToast)(),{user:f}=(0,e.useAuthStore)(),[g,h]=(0,b.useState)([]),i=(0,b.useRef)(!1),[j,k]=(0,b.useState)(!1),[l,m]=(0,b.useState)(0),[n,o]=(0,b.useState)(null),[p,q]=(0,b.useState)(null),[r,s]=(0,b.useState)(!1),t=(0,b.useRef)(null),u=(0,b.useRef)([]),v=(0,b.useRef)(null),w=(0,b.useRef)(null),x=(0,b.useRef)(null),y=(0,b.useCallback)(async(b,c,d=0)=>{try{let a=new FormData;a.append("file",b),a.append("type",c);let d={};f?.id&&(d["x-user-id"]=f.id);let e=await fetch("/api/chat/upload",{method:"POST",credentials:"include",headers:d,body:a});if(!e.ok){let a=await e.json().catch(()=>({error:"خطا در آپلود فایل"}));throw Error(a.error||"خطا در آپلود فایل")}return(await e.json()).data.url}catch(e){if(d<3&&(e.message?.includes("fetch")||e.message?.includes("network")||e.message?.includes("timeout")||"NETWORK_ERROR"===e.code||"TypeError"===e.name)){let e=2e3*Math.pow(2,d);return 0===d&&a({title:"در حال تلاش مجدد...",description:"خطا در آپلود فایل. در حال تلاش مجدد...",duration:2e3}),await new Promise(a=>setTimeout(a,e)),y(b,c,d+1)}throw a({title:"خطا در آپلود فایل",description:e.message||"لطفاً دوباره تلاش کنید",variant:"destructive"}),e}},[a]),z=(0,b.useCallback)(async(a,b)=>{let c=a.target.files;if(c&&0!==c.length){for(let a of Array.from(c))try{let c=await y(a,b),d={id:Date.now().toString()+Math.random(),type:b,name:a.name,size:a.size,url:c};h(a=>[...a,d])}catch(a){}a.target.value=""}},[y]),A=(0,b.useCallback)(a=>{h(b=>b.filter(b=>b.id!==a))},[]),B=(0,b.useCallback)(()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(a=>{let b={id:`location-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"location",url:`https://www.google.com/maps?q=${a.coords.latitude},${a.coords.longitude}`,name:"موقعیت مکانی"};h(a=>[...a,b]),s(!1)},b=>{d.logger.error("Error getting location:",b),a({title:"خطا",description:"خطا در دریافت موقعیت مکانی",variant:"destructive"})}):a({title:"خطا",description:"مرورگر شما از موقعیت مکانی پشتیبانی نمی‌کند",variant:"destructive"})},[a]),C=(0,b.useCallback)(async()=>{try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(a=>a.stop()),!0}catch(a){return!1}},[]),D=(0,b.useCallback)(async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void a({title:"مرورگر شما پشتیبانی نمی‌کند",description:"مرورگر شما از ضبط صدا پشتیبانی نمی‌کند. لطفاً از مرورگر جدیدتری استفاده کنید.",variant:"destructive"});let b=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),c=new MediaRecorder(b,{mimeType:MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":MediaRecorder.isTypeSupported("audio/mp4")?"audio/mp4":"audio/webm"});t.current=c,u.current=[],c.ondataavailable=a=>{a.data.size>0&&u.current.push(a.data)},c.onstop=()=>{let a=new Blob(u.current,{type:c.mimeType||"audio/webm"});o(a);let d=URL.createObjectURL(a);q(d),b.getTracks().forEach(a=>a.stop())},c.onerror=b=>{d.logger.error("MediaRecorder error:",b),a({title:"خطا در ضبط صدا",description:"خطایی در هنگام ضبط صدا رخ داد. لطفاً دوباره تلاش کنید.",variant:"destructive"}),E()},c.start(),k(!0),m(0),s(!1),v.current=setInterval(()=>{m(a=>a+1)},1e3),a({title:"ضبط صدا شروع شد",description:"در حال ضبط پیام صوتی..."})}catch(d){let b="دسترسی به میکروفون مجاز نیست.",c="";"NotAllowedError"===d.name||"PermissionDeniedError"===d.name?(b="دسترسی به میکروفون رد شد",c="لطفاً در تنظیمات مرورگر خود، دسترسی میکروفون را فعال کنید."):"NotFoundError"===d.name||"DevicesNotFoundError"===d.name?(b="میکروفون یافت نشد",c="لطفاً مطمئن شوید که میکروفون به دستگاه شما متصل است."):"NotReadableError"===d.name||"TrackStartError"===d.name?(b="میکروفون در حال استفاده است",c="میکروفون توسط برنامه دیگری استفاده می‌شود. لطفاً آن را ببندید."):c="لطفاً دوباره تلاش کنید یا صفحه را رفرش کنید.",a({title:b,description:c,variant:"destructive",duration:5e3})}},[a]),E=(0,b.useCallback)(()=>{if(t.current&&"inactive"!==t.current.state)try{t.current.stop(),k(!1),v.current&&clearInterval(v.current),a({title:"ضبط صدا متوقف شد",description:"پیام صوتی شما آماده است. می‌توانید آن را ذخیره یا لغو کنید."})}catch(b){d.logger.error("Error stopping recording:",b),a({title:"خطا",description:"خطایی در توقف ضبط رخ داد.",variant:"destructive"})}},[a]),F=(0,b.useCallback)(()=>{E(),o(null),p&&(URL.revokeObjectURL(p),q(null)),m(0)},[p,E]),G=(0,b.useCallback)(a=>{let b=Math.floor(a/60);return`${b}:${(a%60).toString().padStart(2,"0")}`},[]),H=(0,b.useCallback)(async()=>{if(i.current)return d.logger.warn("saveRecording already in progress, skipping"),null;if(!n||!p)return null;i.current=!0;try{let a="webm",b=n.type||"audio/webm";b.includes("mp4")||b.includes("m4a")?a="m4a":b.includes("ogg")?a="ogg":b.includes("wav")&&(a="wav");let c=new File([n],`audio-${Date.now()}.${a}`,{type:b}),d=await y(c,"audio"),e={id:function(a=""){return"undefined"!=typeof crypto&&crypto.randomUUID?a?`${a}-${crypto.randomUUID()}`:crypto.randomUUID():`${a}-${Date.now()}-${Math.random().toString(36).substr(2,9)}-${performance.now()}`}("audio"),type:"audio",url:d,name:`پیام صوتی ${G(l)}`,size:n.size,duration:l};return o(null),p&&URL.revokeObjectURL(p),q(null),m(0),e}catch(a){return d.logger.error("Error saving recording:",a),null}finally{i.current=!1}},[n,p,l,y,G]);return{attachments:g,setAttachments:h,isRecording:j,recordingTime:l,audioBlob:n,audioUrl:p,showAttachmentOptions:r,setShowAttachmentOptions:s,uploadFile:y,handleFileSelect:z,handleRemoveAttachment:A,handleLocationShare:B,startRecording:D,stopRecording:E,cancelRecording:F,saveRecording:H,formatTime:G,formatFileSize:(0,b.useCallback)(a=>a<1024?a+" B":a<1048576?(a/1024).toFixed(1)+" KB":(a/1048576).toFixed(1)+" MB",[]),checkMicrophonePermission:C,imageInputRef:w,fileInputRef:x}}function g({chatId:a,sender:e,customerInfo:f,onMessageSent:g}){let{toast:h}=(0,c.useToast)(),[i,j]=(0,b.useState)(""),[k,l]=(0,b.useState)(!1),[m,n]=(0,b.useState)(!1),o=(0,b.useRef)(null),p=(0,b.useRef)(null),q=(0,b.useCallback)(async b=>{if(a)try{await fetch("/api/chat/typing",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:a,sender:e,isTyping:b})})}catch(a){d.logger.error("Error sending typing status:",a)}},[a,e]),r=(0,b.useCallback)(b=>{j(b.target.value),a&&(o.current&&clearTimeout(o.current),b.target.value.trim().length>0?(q(!0),o.current=setTimeout(()=>{q(!1)},2e3)):q(!1))},[a,q]),s=(0,b.useCallback)(async()=>{if(a)try{let b=await fetch(`/api/chat/typing?chatId=${a}&sender=${"user"===e?"support":"user"}`,{credentials:"include"});if(b.ok){let a=await b.json();a.success&&n(a.data.isTyping||!1)}}catch(a){d.logger.error("Error checking typing status:",a)}},[a,e]);(0,b.useEffect)(()=>{if(!a){n(!1),p.current&&(clearInterval(p.current),p.current=null);return}return s(),p.current=setInterval(()=>{s()},2e3),()=>{p.current&&(clearInterval(p.current),p.current=null),o.current&&(clearTimeout(o.current),o.current=null),q(!1)}},[a,s,q]);let t=(0,b.useCallback)(async(b,c=[])=>{if(!b.trim()&&0===c.length||!a)return null;let d=c.filter(a=>{let b=a.url;return b&&!b.startsWith("blob:")&&!b.startsWith("data:")&&(b.startsWith("http")||b.startsWith("/"))});if(!b.trim()&&0===d.length)return h({title:"خطا",description:"لطفاً یک پیام یا فایل معتبر اضافه کنید",variant:"destructive"}),null;let i={id:`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,text:b,sender:e,timestamp:new Date,attachments:d.length>0?d:void 0};try{l(!0),o.current&&clearTimeout(o.current),q(!1);let b={chatId:a,messages:[{id:i.id,text:i.text,sender:i.sender,timestamp:i.timestamp.toISOString(),attachments:i.attachments||[]}]};f&&(b.customerInfo=f);let c=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(b)});if(!c.ok){let a=await c.json().catch(()=>null),b=a?.error||(429===c.status?"درخواست‌های شما زیاد است. لطفاً کمی بعد دوباره تلاش کنید.":null)||"خطا در ارسال پیام";throw Error(b)}return g&&g(),i}catch(a){return h({title:"خطا",description:a instanceof Error?a.message:"خطا در ارسال پیام",variant:"destructive"}),null}finally{l(!1)}},[a,e,f,h,g,q]),u=(0,b.useCallback)(async(a=[],b)=>{let c=i;b&&(c=`در پاسخ به: ${b.text}

${i}`);let d=await t(c,a);return d?(j(""),d):null},[i,t]);return{message:i,setMessage:j,isSending:k,isTyping:m,handleMessageChange:r,sendMessage:t,handleSend:u}}a.s(["useChatUtils",()=>f],29328),a.s(["useChatMessaging",()=>g],39290);var h=a.i(87924),i=a.i(46271),j=a.i(20610),k=a.i(4720),l=a.i(24987),m=a.i(70106);let n=(0,m.default)("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]),o=(0,m.default)("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);var p=a.i(81560);let q=(0,m.default)("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);var r=a.i(40695),s=a.i(76504),t=a.i(23708);function u({message:a,index:b,totalMessages:c,onReply:d,onEdit:e,onDelete:f}){return(0,h.jsx)(i.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},transition:{duration:.2,ease:"easeOut"},className:`flex ${"user"===a.sender?"justify-end":"justify-start"} items-end gap-2 group mb-3`,children:(0,h.jsxs)("div",{className:`max-w-[85%] sm:max-w-[75%] md:max-w-[70%] rounded-lg px-2.5 sm:px-3 py-2 transition-all ${"user"===a.sender?"bg-primary text-primary-foreground":"bg-muted text-foreground border border-border/40"}`,children:[a.text&&(0,h.jsx)("p",{className:"text-xs sm:text-sm leading-relaxed whitespace-pre-wrap break-words mb-1.5",children:a.text}),a.attachments&&a.attachments.length>0&&(0,h.jsx)("div",{className:`space-y-2 ${a.text?"mt-2":""}`,children:a.attachments.map((a,b)=>(0,h.jsxs)("div",{className:"rounded overflow-hidden",children:["image"===a.type&&a.url&&(0,h.jsx)("img",{src:a.url,alt:a.name||"تصویر",className:"max-w-full max-h-[150px] sm:max-h-[180px] rounded cursor-pointer hover:opacity-90 transition-all",onClick:()=>window.open(a.url,"_blank")}),"file"===a.type&&(0,h.jsxs)("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",download:a.name,className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,h.jsx)(k.FileText,{className:"h-3.5 w-3.5"}),(0,h.jsx)("span",{className:"font-medium truncate",children:a.name||"فایل"})]}),"location"===a.type&&(0,h.jsxs)("a",{href:a.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,h.jsx)(l.MapPin,{className:"h-3.5 w-3.5"}),(0,h.jsx)("span",{className:"font-medium",children:a.name||"موقعیت"})]}),"audio"===a.type&&a.url&&(0,h.jsx)(t.AudioPlayer,{url:a.url,duration:a.duration})]},a.id||b))}),(0,h.jsxs)("div",{className:`flex items-center gap-1.5 mt-1.5 pt-1.5 border-t ${"user"===a.sender?"border-primary-foreground/20 justify-end":"border-border/30 justify-start"}`,children:[(0,h.jsx)("span",{className:`text-[10px] sm:text-xs ${"user"===a.sender?"text-primary-foreground/70":"text-muted-foreground"}`,children:new Date(a.timestamp).toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}),a.status&&"user"===a.sender&&(0,h.jsx)(j.CheckCheck,{className:`h-3 w-3 ${"read"===a.status?"text-primary-foreground/70":"text-primary-foreground/40"}`}),f&&("support"===a.sender||"user"===a.sender)&&(0,h.jsx)(r.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 hover:bg-destructive/10 text-destructive hover:text-destructive opacity-70 hover:opacity-100 transition-opacity",onClick:b=>{b.stopPropagation(),confirm("آیا مطمئن هستید که می‌خواهید این پیام را حذف کنید؟")&&f(a.id)},title:"حذف پیام",children:(0,h.jsx)(p.Trash2,{className:"h-3.5 w-3.5"})}),(d||e)&&(0,h.jsx)("div",{className:"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,h.jsxs)(s.DropdownMenu,{children:[(0,h.jsx)(s.DropdownMenuTrigger,{asChild:!0,children:(0,h.jsx)(r.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 hover:bg-background/20",onClick:a=>{a.stopPropagation()},title:"گزینه‌های بیشتر",children:(0,h.jsx)(q,{className:"h-3.5 w-3.5"})})}),(0,h.jsxs)(s.DropdownMenuContent,{align:"user"===a.sender?"end":"start",className:"min-w-[140px]",onClick:a=>a.stopPropagation(),children:[d&&(0,h.jsxs)(s.DropdownMenuItem,{onClick:b=>{b.stopPropagation(),d(a)},className:"cursor-pointer",children:[(0,h.jsx)(n,{className:"h-4 w-4 ml-2"}),(0,h.jsx)("span",{children:"پاسخ"})]}),e&&"user"===a.sender&&(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)(s.DropdownMenuSeparator,{}),(0,h.jsxs)(s.DropdownMenuItem,{onClick:b=>{b.stopPropagation(),e(a)},className:"cursor-pointer",children:[(0,h.jsx)(o,{className:"h-4 w-4 ml-2"}),(0,h.jsx)("span",{children:"ویرایش"})]})]})]})]})})]})]})},a.id)}a.s(["MessageBubble",()=>u],90944)},298,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(40695),e=a.i(5522),f=a.i(45222),g=a.i(87532),h=a.i(46842),i=a.i(63519),j=a.i(92258),k=a.i(33508),l=a.i(96221),m=a.i(56468),n=a.i(46271),o=a.i(77687),p=a.i(42964),q=a.i(62478),r=a.i(54161),s=a.i(29328),t=a.i(39290),u=a.i(90944),v=a.i(52119),w=a.i(54917),x=a.i(25173),y=a.i(65733),z=a.i(28094),A=a.i(46470),B=a.i(72228),C=a.i(80666);function D({isOpen:a,onOpenChange:D,initialCustomerPhone:E}){let{toast:F}=(0,o.useToast)(),{user:G}=(0,x.useAuthStore)(),{setOnline:H,isOnline:I}=(0,p.useAdminPresence)({enabled:!0,heartbeatInterval:15e3}),[J,K]=(0,c.useState)([]),[L,M]=(0,c.useState)(null),[N,O]=(0,c.useState)([]),[P,Q]=(0,c.useState)(!1),[R,S]=(0,c.useState)(!1),[T,U]=(0,c.useState)(""),[V,W]=(0,c.useState)(!1),[X,Y]=(0,c.useState)(null),[Z,$]=(0,c.useState)(null),[_,aa]=(0,c.useState)(!1),[ab,ac]=(0,c.useState)(!1),ad=(0,c.useRef)(null),ae=(0,c.useRef)(null),af=(0,c.useRef)(null),ag=(0,c.useRef)(null),[ah,ai]=(0,c.useState)(!1),aj=(0,c.useRef)(!1),ak=(0,s.useChatUtils)(),al=(0,t.useChatMessaging)({chatId:L?.id||null,sender:"support",customerInfo:L?{name:L.customerName,phone:L.customerPhone,email:L.customerEmail}:void 0,onMessageSent:()=>{setTimeout(()=>{am(!1)},2e3)}}),am=(0,c.useCallback)(async(a=!0)=>{try{a&&Q(!0),console.log("[AdminChat] Loading chats...");let b={"Content-Type":"application/json"};G?.id&&(b["x-user-id"]=G.id,console.log("[AdminChat] Adding x-user-id header:",G.id));let c=await fetch("/api/chat",{credentials:"include",headers:b});if(!c.ok){let a=await c.text();throw console.error("[AdminChat] Failed to load chats:",c.status,a),w.logger.error("Failed to load chats:",c.status,a),Error("خطا در بارگذاری چت‌ها")}let d=await c.json();if(console.log("[AdminChat] API Response:",{success:d.success,hasData:!!d.data,chatsCount:d.data?.chats?.length||0,chats:d.data?.chats?.slice(0,3)}),w.logger.info("Loaded chats:",d.success?d.data.chats?.length:0,"chats"),d.success&&d.data?.chats&&Array.isArray(d.data.chats)){console.log("[AdminChat] Processing",d.data.chats.length,"chats...");let a=await Promise.all(d.data.chats.map(async a=>{if(a.isRegisteredUser||a.isUserWithoutChat)return{...a,lastMessage:"هنوز پیامی ارسال نشده است",lastMessageTime:a.updatedAt||a.createdAt,unreadCount:void 0,isRegisteredUser:!0};try{let b=await fetch(`/api/chat?chatId=${a.id}`,{credentials:"include"});if(b.ok){let c=await b.json();if(c.success&&c.data.messages){let b=c.data.messages,d=b[b.length-1],e=a.unreadCount&&a.unreadCount>0?a.unreadCount:void 0;return{...a,lastMessage:d?.text||"",lastMessageTime:d?.createdAt||a.updatedAt,unreadCount:e}}}}catch(a){w.logger.error("Error loading last message:",a)}let b=a.unreadCount&&a.unreadCount>0?a.unreadCount:void 0;return{...a,unreadCount:b}}));console.log("[AdminChat] Setting chats:",a.length,"chats"),K(a)}else console.warn("[AdminChat] No chats in response or success=false:",d),K([])}catch(b){console.error("[AdminChat] Error loading chats:",b),w.logger.error("Error loading chats:",b),a&&F({title:"خطا",description:"خطا در بارگذاری چت‌ها",variant:"destructive"}),K([])}finally{a&&Q(!1)}},[F]),an=(0,c.useCallback)(async(a,b=!1)=>{try{b&&S(!0);let c=`/api/chat?chatId=${a}`;!b&&af.current&&(c+=`&lastMessageId=${af.current}`);let d=await fetch(c);if(!d.ok)throw Error("خطا در بارگذاری پیام‌ها");let e=await d.json();if(e.success&&e.data.messages){let a=e.data.messages.map(a=>{let b=[];if(a.attachments){if(Array.isArray(a.attachments))b=a.attachments;else if("string"==typeof a.attachments)try{let c=JSON.parse(a.attachments);b=Array.isArray(c)?c:[c]}catch(a){w.logger.error("Error parsing attachments:",a)}}return{id:a.id,text:a.text||"",sender:a.sender,timestamp:new Date(a.createdAt),attachments:b,status:a.status||("user"===a.sender?"sent":void 0)}});if(L)try{let a=await fetch(`/api/chat/unread-count?chatId=${L.id}`);if(a.ok){let b=await a.json();if(b.success&&b.data){let a=b.data.unreadCount&&b.data.unreadCount>0?b.data.unreadCount:void 0;K(b=>b.map(b=>b.id===L.id?{...b,unreadCount:a}:b))}}}catch(a){}b?(O(a),a.length>0&&(af.current=a[a.length-1].id)):O(b=>{if(0===a.length&&b.length>0)return b;let c=new Set(a.map(a=>a.id)),d=new Set(b.map(a=>a.id)),e=a.filter(a=>!d.has(a.id)),f=b.filter(a=>a.id.startsWith("temp-")||c.has(a.id)),g=f.map(b=>{let c=a.find(a=>a.id===b.id);return c&&"user"===b.sender&&c.status&&b.status!==c.status?{...b,status:c.status}:b});return e.length>0?(af.current=e[e.length-1].id,[...g,...e]):f.length!==b.length||g.some((a,c)=>{let d=b.find(b=>b.id===a.id);return!d||d.status!==a.status})?g:b})}else e.success&&L?.isRegisteredUser&&O([])}catch(a){w.logger.error("Error loading messages:",a),b&&F({title:"خطا",description:"خطا در بارگذاری پیام‌ها",variant:"destructive"})}finally{b&&S(!1)}},[L,F]),ao=(0,c.useCallback)(async a=>{try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:a,sender:"support",action:"delivered"})})}catch(a){}},[]),ap=(0,c.useCallback)(async a=>{try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:a,sender:"support",action:"read"})})}catch(a){}},[]),aq=(0,c.useCallback)(async a=>{O([]),af.current=null,M(a),(a.isRegisteredUser||a.isUserWithoutChat)&&a.userId?O([]):(ap(a.id).catch(()=>{}),ao(a.id),an(a.id,!0)),K(b=>b.map(b=>b.id===a.id?{...b,unreadCount:void 0}:b))},[an,ap,ao]),ar=(0,c.useCallback)(async()=>{if(L&&!L.isRegisteredUser&&!L.isUserWithoutChat)try{let a=await fetch(`/api/chat/typing?chatId=${L.id}&sender=user`,{credentials:"include"});if(a.ok){let b=await a.json();b.success&&W(b.data.isTyping||!1)}}catch(a){}},[L]),as=(0,c.useCallback)(a=>{Y(a),$(null)},[]),at=(0,c.useCallback)(a=>{$(a),Y(null),al.handleMessageChange({target:{value:a.text||""}})},[al]),au=(0,c.useCallback)(async a=>{if(!L)return void console.error("[AdminChat] handleDelete: No selected chat");console.log("[AdminChat] Deleting message:",a);try{let b,c=await fetch(`/api/chat/message/${a}`,{method:"DELETE",credentials:"include",headers:{"Content-Type":"application/json"}});console.log("[AdminChat] Delete response status:",c.status);try{b=await c.json()}catch(d){let a=await c.text();console.error("[AdminChat] Failed to parse response:",a),b={}}if(console.log("[AdminChat] Delete response data:",b),c.ok)O(b=>b.filter(b=>b.id!==a)),am(!1),L&&setTimeout(()=>{an(L.id,!1).catch(()=>{})},500),F({title:"موفق",description:b.message||"پیام با موفقیت حذف شد"});else{let a=b.error||b.message||`خطا در حذف پیام (${c.status})`;throw console.error("[AdminChat] Delete error:",a,b),w.logger.error("Error deleting message:",a,b),Error(a)}}catch(a){console.error("[AdminChat] Delete exception:",a),w.logger.error("Error deleting message:",a),F({title:"خطا",description:a instanceof Error?a.message:"خطا در حذف پیام",variant:"destructive"})}},[L,F,am,an]),av=(0,c.useCallback)(async()=>{if(L){ac(!0);try{let a=await fetch("/api/chat/block",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:L.id,customerPhone:L.customerPhone})});if(a.ok)F({title:"موفق",description:"کاربر با موفقیت مسدود شد"}),aa(!1),K(a=>a.filter(a=>a.id!==L.id)),M(null),O([]);else{let b=await a.json().catch(()=>({}));throw Error(b.error||"خطا در مسدود کردن کاربر")}}catch(a){w.logger.error("Error blocking user:",a),F({title:"خطا",description:a instanceof Error?a.message:"خطا در مسدود کردن کاربر",variant:"destructive"})}finally{ac(!1)}}},[L,F]),aw=(0,c.useCallback)(async()=>{if(!L)return;if(Z){try{(await fetch(`/api/chat/message/${Z.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:al.message,attachments:ak.attachments})})).ok&&(O(a=>a.map(a=>a.id===Z.id?{...a,text:al.message,attachments:ak.attachments}:a)),$(null),al.handleMessageChange({target:{value:""}}),ak.setAttachments([]),F({title:"موفق",description:"پیام ویرایش شد"}))}catch(a){w.logger.error("Error editing message:",a),F({title:"خطا",description:"خطا در ویرایش پیام",variant:"destructive"})}return}if((L.isRegisteredUser||L.isUserWithoutChat)&&L.userId){try{let a=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({customerInfo:{name:L.customerName,phone:L.customerPhone,email:L.customerEmail},messages:[{text:al.message,sender:"support",attachments:ak.attachments}]})});if(a.ok){let b=await a.json();if(b.success&&b.data.chat){let a=b.data.chat,c={...L,id:a.id,isRegisteredUser:!1,isUserWithoutChat:!1};if(M(c),b.success&&b.data.messages&&b.data.messages.length>0){let a=b.data.messages[0];O(b=>[...b,a])}am(!1).catch(()=>{}),an(a.id,!1).catch(()=>{}),setTimeout(()=>{ay(!1)},100),ak.setAttachments([]),ak.setShowAttachmentOptions(!1),Y(null),F({title:"موفق",description:"پیام ارسال شد"})}}}catch(a){w.logger.error("Error creating chat:",a),F({title:"خطا",description:"خطا در ارسال پیام",variant:"destructive"})}return}let a=await al.handleSend(ak.attachments,X);a&&(O(b=>b.some(b=>b.id===a.id)?b:[...b,a]),ak.setAttachments([]),ak.setShowAttachmentOptions(!1),Y(null),a.id&&!a.id.startsWith("temp-")&&(af.current=a.id),setTimeout(()=>{am(!1)},500),setTimeout(()=>{ay(!1),setTimeout(()=>{ax()},500)},100))},[L,al,ak,Z,X,F,am,an]),ax=(0,c.useCallback)(()=>{if(!ae.current||!L)return void ai(!1);let a=ae.current;ai(a.scrollHeight-a.scrollTop-a.clientHeight>150)},[L]),ay=(0,c.useCallback)((a=!1)=>{ad.current&&(ad.current.scrollIntoView({behavior:a?"auto":"smooth",block:"end"}),setTimeout(()=>{ai(!1)},300))},[]);(0,c.useEffect)(()=>{let a=ae.current;if(!a||!L)return void ai(!1);let b=()=>{ax()};return a.addEventListener("scroll",b,{passive:!0}),ax(),()=>{a.removeEventListener("scroll",b)}},[L,ax,N.length]);let az=(0,c.useRef)(!1);(0,c.useEffect)(()=>{if(L&&N.length>0&&!az.current){az.current=!0;let a=setTimeout(()=>{ay(!0),setTimeout(()=>{ax()},500)},200);return()=>clearTimeout(a)}L||(az.current=!1)},[L,N.length,ay,ax]),(0,c.useEffect)(()=>{if(!L||!a||L.isRegisteredUser||L.isUserWithoutChat){W(!1),ag.current&&(clearInterval(ag.current),ag.current=null);return}ao(L.id),ap(L.id).catch(()=>{}),ar(),ag.current=setInterval(()=>{ar()},3e3);let b=setInterval(()=>{an(L.id,!1).catch(()=>{}),ao(L.id),ap(L.id).catch(()=>{})},5e3);return()=>{clearInterval(b),ag.current&&(clearInterval(ag.current),ag.current=null)}},[L,a,ar,an,ao,ap]),(0,c.useEffect)(()=>{if(a){console.log("[AdminChat] Dialog opened, loading chats..."),am(!0),E||(M(null),O([])),H(!0);let a=setInterval(()=>{console.log("[AdminChat] Refreshing chats..."),am(!1)},15e3);return()=>{clearInterval(a)}}H(!1)},[a,H,am]),(0,c.useEffect)(()=>{if(E&&J.length>0&&!L){let a=J.find(a=>a.customerPhone===E);a&&(console.log("[AdminChat] Auto-selecting chat for phone:",E),M(a),an(a.id,!0))}},[E,J,L,an]);let aA=J.filter(a=>a.customerName.toLowerCase().includes(T.toLowerCase())||a.customerPhone.includes(T)||a.customerEmail?.toLowerCase().includes(T.toLowerCase()));return(0,b.jsxs)(y.Dialog,{open:a,onOpenChange:D,children:[(0,b.jsxs)(y.DialogContent,{className:"max-w-[95vw] w-full h-[90vh] p-0 flex flex-col gap-0 overflow-hidden",children:[(0,b.jsx)(z.Root,{children:(0,b.jsx)(y.DialogHeader,{children:(0,b.jsx)(y.DialogTitle,{children:"چت با کاربران"})})}),(0,b.jsxs)("div",{className:"flex h-full overflow-hidden",children:[(0,b.jsxs)("div",{className:"w-full md:w-1/3 lg:w-1/4 border-l border-border flex flex-col bg-background",children:[(0,b.jsx)("div",{className:"p-4 border-b border-border bg-muted/30",children:(0,b.jsxs)("div",{className:"flex items-center gap-2",children:[(0,b.jsxs)("div",{className:"relative flex-1",children:[(0,b.jsx)(g.Search,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,b.jsx)(e.Input,{type:"search",placeholder:"جستجوی کاربر...",value:T,onChange:a=>U(a.target.value),className:"pr-10"})]}),(0,b.jsx)(d.Button,{variant:"ghost",size:"icon",onClick:()=>D(!1),className:"h-10 w-10 flex-shrink-0",children:(0,b.jsx)(k.X,{className:"h-4 w-4"})})]})}),(0,b.jsx)(A.ScrollArea,{className:"flex-1",children:P?(0,b.jsx)("div",{className:"flex items-center justify-center h-full p-8",children:(0,b.jsx)(l.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):0===aA.length?(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center px-6 py-12",children:[(0,b.jsx)(f.MessageCircle,{className:"h-14 w-14 text-muted-foreground/50 mb-4"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:"چتی یافت نشد"}),J.length>0&&(0,b.jsxs)("p",{className:"text-xs text-muted-foreground mt-2",children:["(تعداد کل: ",J.length," - فیلتر شده: ",aA.length,")"]})]}):(0,b.jsx)("div",{className:"divide-y divide-border",children:aA.map(a=>(0,b.jsx)("button",{onClick:()=>aq(a),className:`w-full p-4 text-right hover:bg-muted/50 transition-all ${L?.id===a.id?"bg-primary/10 border-r-4 border-primary":""} ${a.unreadCount&&a.unreadCount>0?"font-semibold":""}`,children:(0,b.jsxs)("div",{className:"flex items-start gap-3",children:[(0,b.jsx)("div",{className:"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0",children:(0,b.jsx)(h.User,{className:"h-6 w-6 text-primary"})}),(0,b.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,b.jsx)("p",{className:"font-semibold text-sm truncate",children:a.customerName}),a.unreadCount&&a.unreadCount>0&&(0,b.jsx)(r.Badge,{variant:"destructive",className:"h-5 w-5 px-0 text-xs flex items-center justify-center",children:"!"})]}),(0,b.jsxs)("div",{className:"flex items-center gap-2 text-xs text-muted-foreground mb-1",children:[(0,b.jsx)(i.Phone,{className:"h-3 w-3"}),(0,b.jsx)("span",{children:a.customerPhone})]}),a.lastMessage&&(0,b.jsx)("p",{className:"text-xs text-muted-foreground truncate mt-1",children:a.lastMessage}),a.lastMessageTime&&(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:(0,B.format)(new Date(a.lastMessageTime),"HH:mm",{locale:C.faIR})})]})]})},a.id))})})]}),(0,b.jsx)("div",{className:"flex-1 flex flex-col bg-background",children:L?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{className:"p-4 border-b border-border bg-muted/30 flex items-center justify-between",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:(0,b.jsx)(h.User,{className:"h-5 w-5 text-primary"})}),(0,b.jsxs)("div",{children:[(0,b.jsx)("h3",{className:"font-semibold",children:L.customerName}),(0,b.jsxs)("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[(0,b.jsx)(i.Phone,{className:"h-3 w-3"}),(0,b.jsx)("span",{children:L.customerPhone}),L.customerEmail&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(j.Mail,{className:"h-3 w-3 mr-2"}),(0,b.jsx)("span",{children:L.customerEmail})]})]})]})]}),(0,b.jsxs)("div",{className:"flex items-center gap-4",children:[(0,b.jsxs)(d.Button,{variant:"outline",size:"sm",onClick:()=>aa(!0),className:"flex items-center gap-2 text-destructive hover:text-destructive",children:[(0,b.jsx)(m.Ban,{className:"h-4 w-4"}),(0,b.jsx)("span",{className:"hidden sm:inline",children:"مسدود کردن"})]}),(0,b.jsx)(d.Button,{variant:"ghost",size:"icon",onClick:()=>{M(null),O([]),af.current=null},className:"mr-4",children:(0,b.jsx)(k.X,{className:"h-4 w-4"})})]})]}),(0,b.jsxs)(A.ScrollArea,{ref:ae,className:"flex-1 p-4",children:[R?(0,b.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,b.jsx)(l.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):0===N.length?(0,b.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[(0,b.jsx)(f.MessageCircle,{className:"h-14 w-14 text-muted-foreground/50 mb-4"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:L.isRegisteredUser||L.isUserWithoutChat?"هنوز پیامی ارسال نشده است. می‌توانید اولین پیام را ارسال کنید.":"هنوز پیامی ارسال نشده است"})]}):(0,b.jsxs)("div",{className:"space-y-3",children:[N.map((a,c)=>(0,b.jsx)(u.MessageBubble,{message:a,index:c,totalMessages:N.length,onReply:as,onEdit:at,onDelete:au},a.id)),V&&(0,b.jsx)(n.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"flex justify-start items-end gap-2.5",children:(0,b.jsx)(q.TypingIndicator,{})})]}),(0,b.jsx)("div",{ref:ad})]}),(0,b.jsx)("div",{className:"p-4 border-t border-border bg-muted/30",children:(0,b.jsx)(v.ChatInput,{message:al.message,onMessageChange:al.handleMessageChange,onSend:aw,isSending:al.isSending,attachments:ak.attachments,onRemoveAttachment:ak.handleRemoveAttachment,showAttachmentOptions:ak.showAttachmentOptions,onToggleAttachmentOptions:()=>ak.setShowAttachmentOptions(!ak.showAttachmentOptions),isRecording:ak.isRecording,recordingTime:ak.recordingTime,audioUrl:ak.audioUrl,onStartRecording:ak.startRecording,onStopRecording:ak.stopRecording,onCancelRecording:ak.cancelRecording,onSaveRecording:async()=>{if(!aj.current){aj.current=!0;try{let a=await ak.saveRecording();a&&ak.setAttachments(b=>b.some(b=>b.id===a.id)?b:[...b,a])}finally{aj.current=!1}}},formatTime:ak.formatTime,imageInputRef:ak.imageInputRef,fileInputRef:ak.fileInputRef,onFileSelect:ak.handleFileSelect,onLocationShare:ak.handleLocationShare,onCheckMicrophonePermission:ak.checkMicrophonePermission,toast:F})})]}):(0,b.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,b.jsxs)("div",{className:"text-center",children:[(0,b.jsx)(f.MessageCircle,{className:"h-16 w-16 text-muted-foreground/50 mx-auto mb-4"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:"یک مخاطب را انتخاب کنید"})]})})})]})]}),(0,b.jsx)(y.Dialog,{open:_,onOpenChange:aa,children:(0,b.jsxs)(y.DialogContent,{children:[(0,b.jsxs)(y.DialogHeader,{children:[(0,b.jsx)(y.DialogTitle,{children:"مسدود کردن کاربر"}),(0,b.jsxs)(y.DialogDescription,{children:["آیا مطمئن هستید که می‌خواهید کاربر ",L?.customerName," (",L?.customerPhone,") را مسدود کنید؟",(0,b.jsx)("br",{}),(0,b.jsx)("span",{className:"text-destructive font-medium",children:"این عمل قابل بازگشت نیست."})]})]}),(0,b.jsxs)(y.DialogFooter,{children:[(0,b.jsx)(d.Button,{variant:"outline",onClick:()=>aa(!1),disabled:ab,children:"انصراف"}),(0,b.jsx)(d.Button,{variant:"destructive",onClick:av,disabled:ab,children:ab?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(l.Loader2,{className:"h-4 w-4 ml-2 animate-spin"}),"در حال مسدود کردن..."]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(m.Ban,{className:"h-4 w-4 ml-2"}),"مسدود کردن"]})})]})]})})]})}a.s(["AdminChat",()=>D])}];

//# sourceMappingURL=_e69746ef._.js.map