module.exports=[27630,e=>{"use strict";var t=e.i(74844),a=e.i(85151),i=e.i(55739),r=e.i(53041),n=e.i(57748),s=e.i(96996),o=e.i(88031),p=e.i(95403),c=e.i(16662),l=e.i(48680),d=e.i(40814),u=e.i(24457),g=e.i(48936),h=e.i(44518),E=e.i(74846),S=e.i(79164),R=e.i(93695);e.i(72483);var m=e.i(65619),f=e.i(12e3),A=e.i(17939),b=e.i(39142),C=e.i(2572),N=e.i(38339),w=e.i(40911);async function y(t){let a=await (0,N.rateLimit)(100,6e4)(t);if(a)return a;try{let a,{searchParams:i}=new URL(t.url),r=Math.max(1,parseInt(i.get("page")||"1",10)),n=Math.min(1e3,Math.max(1,parseInt(i.get("limit")||"50",10))),s=(r-1)*n,o="true"===i.get("all"),p=0,c=[];try{let{testConnection:t}=await e.A(41613);if(!await t())return w.logger.warn("⚠️ Database connection test failed - returning empty products"),(0,A.createSuccessResponse)([],200,{page:r,limit:n,total:0,totalPages:0})}catch(e){return w.logger.warn("⚠️ Database connection test error - returning empty products:",e),(0,A.createSuccessResponse)([],200,{page:r,limit:n,total:0,totalPages:0})}try{let e=C.cacheKeys.products(r,n,o?"all":"enabled"),t=C.cache.get(e);if(t)return(0,A.createSuccessResponse)(t.products,200,{page:r,limit:n,total:t.total,totalPages:Math.ceil(t.total/n)});a=await (0,f.getRows)(o?"SELECT COUNT(*) as count FROM products":"SELECT COUNT(*) as count FROM products WHERE enabled = TRUE"),p=a[0]?.count||0,c=await (0,f.getRows)(o?'SELECT * FROM products ORDER BY "createdAt" DESC LIMIT ? OFFSET ?':'SELECT * FROM products WHERE enabled = TRUE ORDER BY "createdAt" DESC LIMIT ? OFFSET ?',[n,s]),C.cache.set(e,{products:c,total:p},3e5)}catch(e){if(w.logger.error("Database error in GET /api/products:",{message:e?.message,code:e?.code,stack:e?.stack}),e?.code==="ECONNREFUSED"||e?.code==="ETIMEDOUT"||e?.code==="ENOTFOUND"||e?.message?.includes("connection")||e?.message?.includes("timeout"))throw new b.AppError("خطا در اتصال به دیتابیس. لطفاً مطمئن شوید که دیتابیس در حال اجرا است.",503,"DATABASE_CONNECTION_ERROR",void 0);throw new b.AppError(`خطا در دریافت محصولات: ${e?.message||"خطای نامشخص"}`,500,"DATABASE_ERROR",void 0)}let l=c.map(e=>({...e,images:Array.isArray(e.images)?e.images:"string"==typeof e.images?JSON.parse(e.images):[],tags:Array.isArray(e.tags)?e.tags:"string"==typeof e.tags?JSON.parse(e.tags):[],specifications:"object"==typeof e.specifications&&null!==e.specifications?e.specifications:"string"==typeof e.specifications?JSON.parse(e.specifications):{},price:Number(e.price),originalPrice:e.originalPrice?Number(e.originalPrice):void 0,stockCount:Number(e.stockCount),inStock:!!e.inStock,enabled:!!e.enabled,vinEnabled:!!e.vinEnabled,airShippingEnabled:!!e.airShippingEnabled,seaShippingEnabled:!!e.seaShippingEnabled,airShippingCost:null!==e.airShippingCost&&void 0!==e.airShippingCost?Number(e.airShippingCost):null,seaShippingCost:null!==e.seaShippingCost&&void 0!==e.seaShippingCost?Number(e.seaShippingCost):null,createdAt:e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt),updatedAt:e.updatedAt instanceof Date?e.updatedAt:new Date(e.updatedAt)})),d=Math.ceil(p/n);return(0,A.createSuccessResponse)(l,200,{page:r,limit:n,total:p,totalPages:d})}catch(e){return(0,A.createErrorResponse)(e)}}async function v(e){try{let t=await e.json().catch(()=>{throw new b.AppError("Invalid JSON in request body",400,"INVALID_JSON")});if(t.name&&void 0!==t.price&&!t.filters){let{name:e,description:a,price:i,originalPrice:r,brand:n,category:s,vin:o,vinEnabled:p,airShippingEnabled:c,seaShippingEnabled:l,airShippingCost:d,seaShippingCost:u,stockCount:g,inStock:h,enabled:E,images:S,tags:R,specifications:m}=t;if(!e||"string"!=typeof e||""===e.trim())throw new b.AppError("نام محصول الزامی است",400,"MISSING_NAME");if(!a||"string"!=typeof a||""===a.trim())throw new b.AppError("توضیحات محصول الزامی است",400,"MISSING_DESCRIPTION");if(void 0===i||"number"!=typeof i||i<0)throw new b.AppError("قیمت محصول الزامی است و باید مثبت باشد",400,"INVALID_PRICE");if(!n||"string"!=typeof n||""===n.trim())throw new b.AppError("برند محصول الزامی است",400,"MISSING_BRAND");if(!s||"string"!=typeof s||""===s.trim())throw new b.AppError("دسته‌بندی محصول الزامی است",400,"MISSING_CATEGORY");if(!S||!Array.isArray(S)||0===S.length)throw new b.AppError("حداقل یک تصویر الزامی است",400,"MISSING_IMAGES");let C=`product-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,N=new Date().toISOString(),y={id:C,name:e.trim(),description:a.trim(),price:Math.round(i),originalPrice:r?Math.round(r):null,brand:n.trim(),category:s.trim(),vin:o&&p?o.trim():null,vinEnabled:!!p,airShippingEnabled:"boolean"==typeof c?c:!0===c||"true"===c||1===c,seaShippingEnabled:"boolean"==typeof l?l:!0===l||"true"===l||1===l,airShippingCost:null!=d?Math.max(0,Math.round(d)):null,seaShippingCost:null!=u?Math.max(0,Math.round(u)):null,stockCount:Math.max(0,Math.round(g||0)),inStock:!1!==h,enabled:!1!==E,images:S,tags:R&&Array.isArray(R)?R:[],specifications:m&&"object"==typeof m?m:{},createdAt:N,updatedAt:N};try{let e=await (0,f.runQuery)(`INSERT INTO products (id, name, description, price, "originalPrice", brand, category, vin, "vinEnabled", "airShippingEnabled", "seaShippingEnabled", "airShippingCost", "seaShippingCost", "stockCount", "inStock", enabled, images, tags, specifications, "createdAt", "updatedAt")
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?::jsonb, ?::jsonb, ?::jsonb, ?, ?)`,[y.id,y.name,y.description,y.price,y.originalPrice,y.brand,y.category,y.vin,y.vinEnabled,y.airShippingEnabled,y.seaShippingEnabled,y.airShippingCost,y.seaShippingCost,y.stockCount,y.inStock,y.enabled,JSON.stringify(y.images),JSON.stringify(y.tags),JSON.stringify(y.specifications),y.createdAt,y.updatedAt]);w.logger.debug("Product inserted successfully:",{id:C,changes:e.changes})}catch(e){throw w.logger.error("Error inserting product:",e),new b.AppError(`خطا در ذخیره محصول: ${e?.message||"خطای نامشخص"}`,500,"INSERT_ERROR",void 0)}let v=await (0,f.getRow)("SELECT * FROM products WHERE id = ?",[C]);if(!v)throw w.logger.error("Product not found after insert:",C),new b.AppError("محصول ایجاد شد اما پیدا نشد",500,"PRODUCT_NOT_FOUND");let O={...v,images:Array.isArray(v.images)?v.images:"string"==typeof v.images?JSON.parse(v.images):[],tags:Array.isArray(v.tags)?v.tags:"string"==typeof v.tags?JSON.parse(v.tags):[],specifications:"object"==typeof v.specifications&&null!==v.specifications?v.specifications:"string"==typeof v.specifications?JSON.parse(v.specifications):{},price:Number(v.price),originalPrice:v.originalPrice?Number(v.originalPrice):void 0,stockCount:Number(v.stockCount),inStock:!!v.inStock,enabled:!!v.enabled,vinEnabled:!!v.vinEnabled,airShippingEnabled:!!v.airShippingEnabled,seaShippingEnabled:!!v.seaShippingEnabled,airShippingCost:null!==v.airShippingCost&&void 0!==v.airShippingCost?Number(v.airShippingCost):null,seaShippingCost:null!==v.seaShippingCost&&void 0!==v.seaShippingCost?Number(v.seaShippingCost):null,createdAt:v.createdAt instanceof Date?v.createdAt:new Date(v.createdAt),updatedAt:v.updatedAt instanceof Date?v.updatedAt:new Date(v.updatedAt)};return(0,A.createSuccessResponse)(O,201)}let a=t.filters||t||{},i=Math.max(1,parseInt(t.page||"1",10)),r=Math.min(100,Math.max(1,parseInt(t.limit||"50",10))),n=(i-1)*r,s="WHERE enabled = TRUE",o=[];if(a.vin)s+=" AND vinEnabled = TRUE AND UPPER(vin) = UPPER(?)",o.push(a.vin.trim());else if(a.search){let e=`%${a.search.trim()}%`;s+=" AND (UPPER(name) LIKE UPPER(?) OR UPPER(description) LIKE UPPER(?) OR UPPER(brand) LIKE UPPER(?) OR UPPER(category) LIKE UPPER(?) OR UPPER(vin) LIKE UPPER(?))",o.push(e,e,e,e,e)}void 0!==a.minPrice&&(s+=" AND price >= ?",o.push(a.minPrice)),void 0!==a.maxPrice&&(s+=" AND price <= ?",o.push(a.maxPrice)),a.brands&&a.brands.length>0&&(s+=` AND brand IN (${a.brands.map(()=>"?").join(",")})`,o.push(...a.brands)),a.categories&&a.categories.length>0&&(s+=` AND category IN (${a.categories.map(()=>"?").join(",")})`,o.push(...a.categories)),void 0!==a.inStock&&(s+=" AND inStock = ?",o.push(!!a.inStock));let p=`SELECT COUNT(*) as count FROM products ${s}`,c=await (0,f.getRows)(p,o),l=c[0]?.count||0,d=`SELECT * FROM products ${s} ORDER BY "createdAt" DESC LIMIT ? OFFSET ?`,u=(await (0,f.getRows)(d,[...o,r,n])).map(e=>({...e,images:Array.isArray(e.images)?e.images:"string"==typeof e.images?JSON.parse(e.images):[],tags:Array.isArray(e.tags)?e.tags:"string"==typeof e.tags?JSON.parse(e.tags):[],specifications:"object"==typeof e.specifications&&null!==e.specifications?e.specifications:"string"==typeof e.specifications?JSON.parse(e.specifications):{},price:Number(e.price),originalPrice:e.originalPrice?Number(e.originalPrice):void 0,stockCount:Number(e.stockCount),inStock:!!e.inStock,enabled:!!e.enabled,vinEnabled:!!e.vinEnabled,airShippingEnabled:!!e.airShippingEnabled,seaShippingEnabled:!!e.seaShippingEnabled,airShippingCost:null!==e.airShippingCost&&void 0!==e.airShippingCost?Number(e.airShippingCost):null,seaShippingCost:null!==e.seaShippingCost&&void 0!==e.seaShippingCost?Number(e.seaShippingCost):null,createdAt:e.createdAt instanceof Date?e.createdAt:new Date(e.createdAt),updatedAt:e.updatedAt instanceof Date?e.updatedAt:new Date(e.updatedAt)})),g=Math.ceil(l/r);return(0,A.createSuccessResponse)(u,200,{page:i,limit:r,total:l,totalPages:g})}catch(e){return(0,A.createErrorResponse)(e)}}e.s(["GET",()=>y,"POST",()=>v],55773);var O=e.i(55773);let P=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/products/route",pathname:"/api/products",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/products/route.ts",nextConfigOutput:"",userland:O}),{workAsyncStorage:T,workUnitAsyncStorage:I,serverHooks:D}=P;function M(){return(0,i.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:I})}async function U(e,t,i){P.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let f="/api/products/route";f=f.replace(/\/index$/,"")||"/";let A=await P.prepare(e,t,{srcPage:f,multiZoneDraftMode:!1});if(!A)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:b,params:C,nextConfig:N,parsedUrl:w,isDraftMode:y,prerenderManifest:v,routerServerContext:O,isOnDemandRevalidate:T,revalidateOnlyGenerated:I,resolvedPathname:D,clientReferenceManifest:M,serverActionsManifest:U}=A,x=(0,p.normalizeAppPath)(f),k=!!(v.dynamicRoutes[x]||v.routes[D]),_=async()=>((null==O?void 0:O.render404)?await O.render404(e,t,w,!1):t.end("This page could not be found"),null);if(k&&!y){let e=!!v.routes[D],t=v.dynamicRoutes[x];if(t&&!1===t.fallback&&!e){if(N.experimental.adapterPath)return await _();throw new R.NoFallbackError}}let L=null;!k||P.isDev||y||(L="/index"===(L=D)?"/":L);let F=!0===P.isDev||!k,H=k&&!F;U&&M&&(0,s.setReferenceManifestsSingleton)({page:f,clientReferenceManifest:M,serverActionsManifest:U,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:U})});let $=e.method||"GET",j=(0,n.getTracer)(),q=j.getActiveScopeSpan(),J={params:C,prerenderManifest:v,renderOpts:{experimental:{authInterrupts:!!N.experimental.authInterrupts},cacheComponents:!!N.cacheComponents,supportsDynamicResponse:F,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:N.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i)=>P.onRequestError(e,t,i,O)},sharedContext:{buildId:b}},K=new c.NodeNextRequest(e),G=new c.NodeNextResponse(t),B=l.NextRequestAdapter.fromNodeNextRequest(K,(0,l.signalFromNodeResponse)(t));try{let s=async e=>P.handle(B,J).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=j.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${$} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${$} ${f}`)}),o=!!(0,r.getRequestMeta)(e,"minimalMode"),p=async r=>{var n,p;let c=async({previousCacheEntry:a})=>{try{if(!o&&T&&I&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(r);e.fetchMetrics=J.renderOpts.fetchMetrics;let p=J.renderOpts.pendingWaitUntil;p&&i.waitUntil&&(i.waitUntil(p),p=void 0);let c=J.renderOpts.collectedTags;if(!k)return await (0,g.sendResponse)(K,G,n,J.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[S.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==J.renderOpts.collectedRevalidate&&!(J.renderOpts.collectedRevalidate>=S.INFINITE_CACHE)&&J.renderOpts.collectedRevalidate,i=void 0===J.renderOpts.collectedExpire||J.renderOpts.collectedExpire>=S.INFINITE_CACHE?void 0:J.renderOpts.collectedExpire;return{value:{kind:m.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==a?void 0:a.isStale)&&await P.onRequestError(e,t,{routerKind:"App Router",routePath:f,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})},O),t}},l=await P.handleResponse({req:e,nextConfig:N,cacheKey:L,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:v,isRoutePPREnabled:!1,isOnDemandRevalidate:T,revalidateOnlyGenerated:I,responseGenerator:c,waitUntil:i.waitUntil,isMinimalMode:o});if(!k)return null;if((null==l||null==(n=l.value)?void 0:n.kind)!==m.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(p=l.value)?void 0:p.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",T?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),y&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,h.fromNodeOutgoingHttpHeaders)(l.value.headers);return o&&k||d.delete(S.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,E.getCacheControlHeader)(l.cacheControl)),await (0,g.sendResponse)(K,G,new Response(l.value.body,{headers:d,status:l.value.status||200})),null};q?await p(q):await j.withPropagatedContext(e.headers,()=>j.trace(d.BaseServerSpan.handleRequest,{spanName:`${$} ${f}`,kind:n.SpanKind.SERVER,attributes:{"http.method":$,"http.target":e.url}},p))}catch(t){if(t instanceof R.NoFallbackError||await P.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,u.getRevalidateReason)({isStaticGeneration:H,isOnDemandRevalidate:T})}),k)throw t;return await (0,g.sendResponse)(K,G,new Response(null,{status:500})),null}}e.s(["handler",()=>U,"patchFetch",()=>M,"routeModule",()=>P,"serverHooks",()=>D,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>I],27630)}];

//# sourceMappingURL=5e9cd_next_dist_esm_build_templates_app-route_bac8051e.js.map