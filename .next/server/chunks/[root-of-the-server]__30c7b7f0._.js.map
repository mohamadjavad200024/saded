{"version":3,"sources":["../../../lib/auth/session.ts","../../../lib/db/index.ts","../../../lib/logger.ts","../../../lib/api-route-helpers.ts","../../../lib/api-error-handler.ts","../../../lib/cache.ts","../../../lib/rate-limit.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport crypto from \"crypto\";\r\nimport { getRow, getRows, runQuery } from \"@/lib/db/index\";\r\nimport { AppError } from \"@/lib/api-error-handler\";\r\n\r\nexport const SESSION_COOKIE_NAME = \"saded_session\";\r\n\r\nconst SESSION_DAYS = 30;\r\n\r\nfunction nowIso(): string {\r\n  // MySQL friendly datetime (YYYY-MM-DD HH:mm:ss)\r\n  return new Date().toISOString().slice(0, 19).replace(\"T\", \" \");\r\n}\r\n\r\nfunction addDays(date: Date, days: number): Date {\r\n  const d = new Date(date);\r\n  d.setDate(d.getDate() + days);\r\n  return d;\r\n}\r\n\r\nexport function sha256Hex(input: string): string {\r\n  return crypto.createHash(\"sha256\").update(input).digest(\"hex\");\r\n}\r\n\r\nexport function isHttpsRequest(request: NextRequest): boolean {\r\n  const proto = request.headers.get(\"x-forwarded-proto\") || request.nextUrl.protocol.replace(\":\", \"\");\r\n  return proto === \"https\";\r\n}\r\n\r\nexport function getSessionCookieOptions(request: NextRequest) {\r\n  // Important: if your site is served over http (Not secure), Secure cookies won't set.\r\n  const secure = process.env.NODE_ENV === \"production\" ? isHttpsRequest(request) : false;\r\n  return {\r\n    httpOnly: true,\r\n    secure,\r\n    sameSite: \"lax\" as const,\r\n    path: \"/\",\r\n    maxAge: SESSION_DAYS * 24 * 60 * 60,\r\n  };\r\n}\r\n\r\nexport async function ensureAuthTables(): Promise<void> {\r\n  // Users table\r\n  await runQuery(`\r\n    CREATE TABLE IF NOT EXISTS users (\r\n      id VARCHAR(255) PRIMARY KEY,\r\n      name VARCHAR(255) NOT NULL,\r\n      phone VARCHAR(32) NOT NULL,\r\n      password VARCHAR(255) NOT NULL,\r\n      role VARCHAR(50) NOT NULL DEFAULT 'user',\r\n      enabled BOOLEAN DEFAULT TRUE,\r\n      createdAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n      updatedAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\r\n      UNIQUE KEY uniq_users_phone (phone)\r\n    )\r\n  `);\r\n\r\n  // If table already existed with different schema/indexes, normalize it:\r\n  // - Only `phone` should be unique (besides PRIMARY id)\r\n  // - Remove other UNIQUE indexes that can block registration (e.g. old email unique)\r\n  // - Ensure phone is NOT NULL\r\n  try {\r\n    // Remove invalid rows (NULL/empty phone) to avoid ALTER failures\r\n    await runQuery(`DELETE FROM users WHERE phone IS NULL OR TRIM(phone) = ''`);\r\n\r\n    // Ensure phone column is NOT NULL (keep type small)\r\n    await runQuery(`ALTER TABLE users MODIFY phone VARCHAR(32) NOT NULL`);\r\n\r\n    // Read indexes\r\n    const indexRows = await getRows<any>(`SHOW INDEX FROM users`);\r\n    const uniqueIndexToColumns = new Map<string, string[]>();\r\n\r\n    for (const r of indexRows) {\r\n      const keyName = String(r.Key_name ?? r.key_name ?? r.KEY_NAME ?? \"\");\r\n      const nonUnique = Number(r.Non_unique ?? r.non_unique ?? r.NON_UNIQUE ?? 1);\r\n      const colName = String(r.Column_name ?? r.column_name ?? r.COLUMN_NAME ?? \"\");\r\n      if (!keyName || !colName) continue;\r\n      if (nonUnique !== 0) continue;\r\n      const cols = uniqueIndexToColumns.get(keyName) || [];\r\n      cols.push(colName);\r\n      uniqueIndexToColumns.set(keyName, cols);\r\n    }\r\n\r\n    // Find which unique index (if any) is exactly on phone\r\n    let phoneUniqueIndexName: string | null = null;\r\n    for (const [key, cols] of uniqueIndexToColumns.entries()) {\r\n      if (key === \"PRIMARY\") continue;\r\n      const normalizedCols = cols.map((c) => c.toLowerCase()).sort();\r\n      if (normalizedCols.length === 1 && normalizedCols[0] === \"phone\") {\r\n        phoneUniqueIndexName = key;\r\n        break;\r\n      }\r\n    }\r\n\r\n    // Ensure we have a unique index on phone with our preferred name\r\n    if (!phoneUniqueIndexName) {\r\n      await runQuery(`ALTER TABLE users ADD UNIQUE KEY uniq_users_phone (phone)`);\r\n      phoneUniqueIndexName = \"uniq_users_phone\";\r\n    }\r\n\r\n    // Drop any other UNIQUE indexes (only PRIMARY + phone unique should remain)\r\n    for (const key of uniqueIndexToColumns.keys()) {\r\n      if (key === \"PRIMARY\") continue;\r\n      if (key === phoneUniqueIndexName) continue;\r\n      // Drop (might fail if permissions; ignore)\r\n      try {\r\n        await runQuery(`ALTER TABLE users DROP INDEX \\`${key}\\``);\r\n      } catch {\r\n        // ignore\r\n      }\r\n    }\r\n  } catch {\r\n    // Best-effort; do not block auth if ALTER is not permitted\r\n  }\r\n\r\n  // Sessions table\r\n  await runQuery(`\r\n    CREATE TABLE IF NOT EXISTS sessions (\r\n      id VARCHAR(255) PRIMARY KEY,\r\n      userId VARCHAR(255) NOT NULL,\r\n      tokenHash CHAR(64) NOT NULL,\r\n      expiresAt TIMESTAMP NOT NULL,\r\n      createdAt TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n      lastSeenAt TIMESTAMP NULL DEFAULT NULL,\r\n      userAgent VARCHAR(255) NULL DEFAULT NULL,\r\n      ip VARCHAR(64) NULL DEFAULT NULL,\r\n      UNIQUE KEY uniq_sessions_tokenHash (tokenHash),\r\n      KEY idx_sessions_userId (userId),\r\n      KEY idx_sessions_expiresAt (expiresAt)\r\n    )\r\n  `);\r\n}\r\n\r\nexport type SessionUser = {\r\n  id: string;\r\n  name: string;\r\n  phone: string;\r\n  role: string;\r\n  enabled: boolean;\r\n  createdAt: string;\r\n};\r\n\r\nexport async function createSession(userId: string, request: NextRequest): Promise<string> {\r\n  await ensureAuthTables();\r\n\r\n  const token = crypto.randomBytes(32).toString(\"base64url\");\r\n  const tokenHash = sha256Hex(token);\r\n  const sessionId = `sess_${Date.now()}_${crypto.randomBytes(6).toString(\"hex\")}`;\r\n  const expiresAt = addDays(new Date(), SESSION_DAYS);\r\n\r\n  const ua = request.headers.get(\"user-agent\");\r\n  const ip = request.headers.get(\"x-forwarded-for\")?.split(\",\")[0]?.trim() || null;\r\n\r\n  await runQuery(\r\n    `INSERT INTO sessions (id, userId, tokenHash, expiresAt, createdAt, lastSeenAt, userAgent, ip)\r\n     VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,\r\n    [\r\n      sessionId,\r\n      userId,\r\n      tokenHash,\r\n      expiresAt.toISOString().slice(0, 19).replace(\"T\", \" \"),\r\n      nowIso(),\r\n      nowIso(),\r\n      ua || null,\r\n      ip,\r\n    ]\r\n  );\r\n\r\n  return token;\r\n}\r\n\r\nexport async function getSessionUserFromRequest(request: NextRequest): Promise<SessionUser | null> {\r\n  await ensureAuthTables();\r\n\r\n  const token = request.cookies.get(SESSION_COOKIE_NAME)?.value;\r\n  if (!token) return null;\r\n\r\n  const tokenHash = sha256Hex(token);\r\n  const row = await getRow<{\r\n    sessionId: string;\r\n    userId: string;\r\n    expiresAt: string;\r\n    enabled: any;\r\n    role: string;\r\n    name: string;\r\n    phone: string;\r\n    createdAt: string;\r\n  }>(\r\n    `SELECT s.id as sessionId, s.userId, s.expiresAt, u.enabled, u.role, u.name, u.phone, u.createdAt\r\n     FROM sessions s\r\n     JOIN users u ON u.id = s.userId\r\n     WHERE s.tokenHash = ?\r\n     LIMIT 1`,\r\n    [tokenHash]\r\n  );\r\n\r\n  if (!row) return null;\r\n\r\n  const expires = new Date(row.expiresAt);\r\n  if (Number.isNaN(expires.getTime()) || expires.getTime() < Date.now()) {\r\n    // Expired: delete it\r\n    await runQuery(`DELETE FROM sessions WHERE tokenHash = ?`, [tokenHash]);\r\n    return null;\r\n  }\r\n\r\n  // Touch session\r\n  await runQuery(`UPDATE sessions SET lastSeenAt = ? WHERE id = ?`, [nowIso(), row.sessionId]);\r\n\r\n  return {\r\n    id: row.userId,\r\n    name: row.name,\r\n    phone: row.phone,\r\n    role: row.role || \"user\",\r\n    enabled: Boolean(row.enabled),\r\n    createdAt: row.createdAt,\r\n  };\r\n}\r\n\r\nexport async function clearSession(request: NextRequest): Promise<void> {\r\n  const token = request.cookies.get(SESSION_COOKIE_NAME)?.value;\r\n  if (!token) return;\r\n  const tokenHash = sha256Hex(token);\r\n  await runQuery(`DELETE FROM sessions WHERE tokenHash = ?`, [tokenHash]);\r\n}\r\n\r\nexport function setSessionCookie(response: NextResponse, token: string, request: NextRequest) {\r\n  response.cookies.set(SESSION_COOKIE_NAME, token, getSessionCookieOptions(request));\r\n}\r\n\r\nexport function clearSessionCookie(response: NextResponse, request: NextRequest) {\r\n  response.cookies.set(SESSION_COOKIE_NAME, \"\", {\r\n    ...getSessionCookieOptions(request),\r\n    maxAge: 0,\r\n  });\r\n}\r\n\r\n\r\n","/**\n * Database Wrapper\n * \n * این فایل یک interface یکپارچه برای استفاده از MySQL فراهم می‌کند\n */\n\n/**\n * Get single row from database\n */\nexport async function getRow<T extends Record<string, any> = any>(\n  sql: string,\n  params: any[] = []\n): Promise<T | null> {\n  try {\n    const { queryOne } = await import(\"./mysql\");\n    // Convert double-quoted column names to backticks for MySQL\n    const mysqlSql = convertToMySQLSQL(sql);\n    return await queryOne<T>(mysqlSql, params);\n  } catch (error: any) {\n    console.error(\"Database error in getRow:\", {\n      sql,\n      params,\n      error: error?.message,\n      code: error?.code,\n    });\n    throw error;\n  }\n}\n\n/**\n * Get multiple rows from database\n */\nexport async function getRows<T extends Record<string, any> = any>(\n  sql: string,\n  params: any[] = []\n): Promise<T[]> {\n  try {\n    const { queryAll } = await import(\"./mysql\");\n    // Convert double-quoted column names to backticks for MySQL\n    const mysqlSql = convertToMySQLSQL(sql);\n    return await queryAll<T>(mysqlSql, params);\n  } catch (error: any) {\n    console.error(\"Database error in getRows:\", {\n      sql,\n      params,\n      error: error?.message,\n      code: error?.code,\n    });\n    throw error;\n  }\n}\n\n/**\n * Run a query (INSERT, UPDATE, DELETE)\n */\nexport async function runQuery(\n  sql: string,\n  params: any[] = []\n): Promise<{ changes: number; lastInsertRowid?: number }> {\n  const { query } = await import(\"./mysql\");\n  const mysqlSql = convertToMySQLSQL(sql);\n  const result = await query(mysqlSql, params);\n  return {\n    changes: result.affectedRows || result.rowCount || 0,\n    lastInsertRowid: result.insertId || undefined,\n  };\n}\n\n/**\n * Convert SQL to MySQL SQL\n * - Converts double-quoted column names to backticks\n * - Converts PostgreSQL $1, $2, etc. placeholders to MySQL ? placeholders\n * - Converts ON CONFLICT to ON DUPLICATE KEY UPDATE\n * - MySQL uses ? placeholders (already correct)\n */\nfunction convertToMySQLSQL(sql: string): string {\n  let mysqlSql = sql;\n\n  // Convert PostgreSQL $1, $2, etc. placeholders to MySQL ? placeholders\n  // First, extract all $N placeholders and their positions\n  const placeholderRegex = /\\$(\\d+)/g;\n  const placeholders: Array<{ index: number; position: number }> = [];\n  let match;\n  while ((match = placeholderRegex.exec(sql)) !== null) {\n    placeholders.push({\n      index: parseInt(match[1], 10),\n      position: match.index,\n    });\n  }\n\n  // Replace placeholders in reverse order to maintain positions\n  if (placeholders.length > 0) {\n    // Sort by position in reverse order\n    placeholders.sort((a, b) => b.position - a.position);\n    \n    // Replace each $N with ?\n    for (const placeholder of placeholders) {\n      mysqlSql = mysqlSql.substring(0, placeholder.position) + \n                 '?' + \n                 mysqlSql.substring(placeholder.position + `$${placeholder.index}`.length);\n    }\n  }\n\n  // Convert double-quoted column names to backticks for MySQL\n  // Match \"columnName\" and replace with `columnName`\n  mysqlSql = mysqlSql.replace(/\"([^\"]+)\"/g, '`$1`');\n\n  // Convert PostgreSQL ON CONFLICT to MySQL ON DUPLICATE KEY UPDATE\n  mysqlSql = mysqlSql.replace(\n    /ON CONFLICT\\s*\\(([^)]+)\\)\\s*DO UPDATE SET\\s*(.+)/gi,\n    (match, conflictColumns, updateClause) => {\n      // Convert EXCLUDED.columnName to VALUES(columnName)\n      const convertedUpdate = updateClause.replace(/EXCLUDED\\.(\\w+)/gi, 'VALUES($1)');\n      return `ON DUPLICATE KEY UPDATE ${convertedUpdate}`;\n    }\n  );\n\n  // Remove MySQL-incompatible syntax like ::jsonb (legacy PostgreSQL syntax)\n  mysqlSql = mysqlSql.replace(/::jsonb/g, '');\n  mysqlSql = mysqlSql.replace(/::json/g, '');\n\n  return mysqlSql;\n}\n\n/**\n * Initialize database\n */\nexport async function initializeDatabase(): Promise<void> {\n  const { ensureDatabase, initializeTables } = await import(\"./mysql\");\n  await ensureDatabase();\n  await initializeTables();\n}\n\n/**\n * Test database connection\n */\nexport async function testConnection(): Promise<boolean> {\n  try {\n    const { testConnection } = await import(\"./mysql\");\n    return await testConnection();\n  } catch (error) {\n    return false;\n  }\n}\n\n/**\n * Get database type\n */\nexport function getDatabaseType(): \"mysql\" | \"none\" {\n  return \"mysql\";\n}\n","/**\r\n * Centralized logging utility\r\n * Disables console.log in production for better performance\r\n */\r\n\r\ntype LogLevel = 'log' | 'error' | 'warn' | 'info' | 'debug';\r\n\r\nclass Logger {\r\n  private isDevelopment = process.env.NODE_ENV === 'development';\r\n  private isProduction = process.env.NODE_ENV === 'production';\r\n\r\n  private shouldLog(level: LogLevel): boolean {\r\n    // Always log errors and warnings\r\n    if (level === 'error' || level === 'warn') {\r\n      return true;\r\n    }\r\n    // Only log other levels in development\r\n    return this.isDevelopment;\r\n  }\r\n\r\n  log(...args: any[]): void {\r\n    if (this.shouldLog('log')) {\r\n      console.log(...args);\r\n    }\r\n  }\r\n\r\n  error(...args: any[]): void {\r\n    console.error(...args);\r\n  }\r\n\r\n  warn(...args: any[]): void {\r\n    console.warn(...args);\r\n  }\r\n\r\n  info(...args: any[]): void {\r\n    if (this.shouldLog('info')) {\r\n      console.info(...args);\r\n    }\r\n  }\r\n\r\n  debug(...args: any[]): void {\r\n    if (this.shouldLog('debug')) {\r\n      console.debug(...args);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Log database query (only in development)\r\n   */\r\n  dbQuery(query: string, params?: any[]): void {\r\n    if (this.isDevelopment) {\r\n      console.log('[DB Query]', query.substring(0, 100), params ? `[${params.length} params]` : '');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Log API request (only in development)\r\n   */\r\n  apiRequest(method: string, path: string, statusCode?: number): void {\r\n    if (this.isDevelopment) {\r\n      console.log(`[API] ${method} ${path}${statusCode ? ` ${statusCode}` : ''}`);\r\n    }\r\n  }\r\n}\r\n\r\nexport const logger = new Logger();\r\n\r\n","/**\r\n * API Route Helpers\r\n * Provides standardized error handling and response formatting for API routes\r\n */\r\n\r\nimport { NextResponse } from \"next/server\";\r\nimport { logError, AppError } from \"./api-error-handler\";\r\n\r\nexport interface ApiRouteError {\r\n  message: string;\r\n  status?: number;\r\n  code?: string;\r\n  details?: unknown;\r\n}\r\n\r\n/**\r\n * Create standardized error response\r\n */\r\nexport function createErrorResponse(\r\n  error: unknown,\r\n  defaultStatus: number = 500\r\n): NextResponse {\r\n  let message = \"خطای سرور\";\r\n  let status = defaultStatus;\r\n  let code: string | undefined;\r\n  let details: unknown;\r\n\r\n  // Handle AppError specifically (most common case)\r\n  if (error instanceof AppError) {\r\n    message = error.message;\r\n    status = error.status || defaultStatus;\r\n    code = error.code;\r\n    details = error.details;\r\n  } else if (error instanceof Error) {\r\n    message = error.message;\r\n    if (\"status\" in error && typeof error.status === \"number\") {\r\n      status = error.status;\r\n    }\r\n    if (\"code\" in error && typeof error.code === \"string\") {\r\n      code = error.code;\r\n    }\r\n    if (\"details\" in error) {\r\n      details = error.details;\r\n    }\r\n  } else if (typeof error === \"string\") {\r\n    message = error;\r\n  } else if (error && typeof error === \"object\" && \"message\" in error) {\r\n    message = String(error.message);\r\n    if (\"status\" in error && typeof error.status === \"number\") {\r\n      status = error.status;\r\n    }\r\n    if (\"code\" in error && typeof error.code === \"string\") {\r\n      code = error.code as string;\r\n    }\r\n  }\r\n\r\n  // Log error in development\r\n  logError(error, \"API Route\");\r\n\r\n  return NextResponse.json(\r\n    {\r\n      success: false,\r\n      error: message,\r\n      ...(code ? { code } : {}),\r\n      ...(process.env.NODE_ENV === \"development\" && details ? { details } : {}),\r\n    },\r\n    { status }\r\n  );\r\n}\r\n\r\n/**\r\n * Create standardized success response\r\n */\r\nexport function createSuccessResponse<T>(\r\n  data: T,\r\n  status: number = 200,\r\n  pagination?: {\r\n    page: number;\r\n    limit: number;\r\n    total: number;\r\n    totalPages: number;\r\n  }\r\n): NextResponse {\r\n  return NextResponse.json(\r\n    {\r\n      success: true,\r\n      data,\r\n      ...(pagination && { pagination }),\r\n    },\r\n    { status }\r\n  );\r\n}\r\n\r\n/**\r\n * Wrap route handler with error handling\r\n */\r\nexport function withErrorHandling(\r\n  handler: (request: Request, context?: any) => Promise<NextResponse>\r\n) {\r\n  return async (request: Request, context?: any): Promise<NextResponse> => {\r\n    try {\r\n      return await handler(request, context);\r\n    } catch (error) {\r\n      return createErrorResponse(error);\r\n    }\r\n  };\r\n}\r\n\r\n/**\r\n * Validate request body\r\n */\r\nexport function validateRequestBody<T>(\r\n  body: unknown,\r\n  validator?: (data: unknown) => data is T\r\n): T {\r\n  if (!body) {\r\n    throw new Error(\"Request body is required\");\r\n  }\r\n\r\n  if (validator && !validator(body)) {\r\n    throw new Error(\"Invalid request body\");\r\n  }\r\n\r\n  return body as T;\r\n}\r\n\r\n","/**\r\n * Centralized Error Handler\r\n * Provides consistent error handling and logging across the application\r\n */\r\n\r\nexport interface ApiError {\r\n  message: string;\r\n  status?: number;\r\n  code?: string;\r\n  details?: unknown;\r\n}\r\n\r\nexport class AppError extends Error {\r\n  status?: number;\r\n  code?: string;\r\n  details?: unknown;\r\n\r\n  constructor(message: string, status?: number, code?: string, details?: unknown) {\r\n    super(message);\r\n    this.name = \"AppError\";\r\n    this.status = status;\r\n    this.code = code;\r\n    this.details = details;\r\n    Object.setPrototypeOf(this, AppError.prototype);\r\n  }\r\n}\r\n\r\n/**\r\n * Network error types\r\n */\r\nexport enum NetworkErrorType {\r\n  TIMEOUT = \"TIMEOUT\",\r\n  NETWORK = \"NETWORK\",\r\n  ABORTED = \"ABORTED\",\r\n  UNKNOWN = \"UNKNOWN\",\r\n}\r\n\r\nexport class NetworkError extends Error {\r\n  type: NetworkErrorType;\r\n  originalError?: Error;\r\n\r\n  constructor(\r\n    message: string,\r\n    type: NetworkErrorType = NetworkErrorType.UNKNOWN,\r\n    originalError?: Error\r\n  ) {\r\n    super(message);\r\n    this.name = \"NetworkError\";\r\n    this.type = type;\r\n    this.originalError = originalError;\r\n    Object.setPrototypeOf(this, NetworkError.prototype);\r\n  }\r\n}\r\n\r\n/**\r\n * Import centralized logger\r\n */\r\nimport { logger } from \"@/lib/logger\";\r\n\r\n/**\r\n * Parse error from various sources\r\n */\r\nexport function parseError(error: unknown): ApiError {\r\n  if (error instanceof AppError) {\r\n    return {\r\n      message: error.message,\r\n      status: error.status,\r\n      code: error.code,\r\n      details: error.details,\r\n    };\r\n  }\r\n\r\n  if (error instanceof NetworkError) {\r\n    return {\r\n      message: error.message,\r\n      code: error.type,\r\n      details: error.originalError,\r\n    };\r\n  }\r\n\r\n  if (error instanceof Error) {\r\n    return {\r\n      message: error.message,\r\n    };\r\n  }\r\n\r\n  if (typeof error === \"string\") {\r\n    return {\r\n      message: error,\r\n    };\r\n  }\r\n\r\n  return {\r\n    message: \"خطای نامشخص رخ داد\",\r\n  };\r\n}\r\n\r\n/**\r\n * Get user-friendly error message\r\n */\r\nexport function getUserFriendlyMessage(error: unknown): string {\r\n  const parsed = parseError(error);\r\n\r\n  // Network errors\r\n  if (parsed.code === NetworkErrorType.TIMEOUT) {\r\n    return \"درخواست شما به دلیل طولانی شدن زمان پاسخ لغو شد. لطفاً دوباره تلاش کنید.\";\r\n  }\r\n\r\n  if (parsed.code === NetworkErrorType.NETWORK) {\r\n    return \"خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کنید.\";\r\n  }\r\n\r\n  if (parsed.code === NetworkErrorType.ABORTED) {\r\n    return \"درخواست لغو شد.\";\r\n  }\r\n\r\n  // HTTP status codes\r\n  if (parsed.status) {\r\n    switch (parsed.status) {\r\n      case 400:\r\n        return parsed.message || \"درخواست نامعتبر است.\";\r\n      case 401:\r\n        return \"لطفاً دوباره وارد شوید.\";\r\n      case 403:\r\n        return \"شما دسترسی به این منبع ندارید.\";\r\n      case 404:\r\n        return \"منبع مورد نظر یافت نشد.\";\r\n      case 429:\r\n        return \"تعداد درخواست‌های شما بیش از حد مجاز است. لطفاً کمی صبر کنید.\";\r\n      case 500:\r\n        return \"خطای سرور. لطفاً بعداً تلاش کنید.\";\r\n      case 502:\r\n      case 503:\r\n      case 504:\r\n        return \"سرور در دسترس نیست. لطفاً بعداً تلاش کنید.\";\r\n      default:\r\n        return parsed.message || \"خطایی رخ داد.\";\r\n    }\r\n  }\r\n\r\n  return parsed.message || \"خطای نامشخص رخ داد.\";\r\n}\r\n\r\n/**\r\n * Log error (only in development)\r\n */\r\nexport function logError(error: unknown, context?: string): void {\r\n  const parsed = parseError(error);\r\n  const contextMsg = context ? `[${context}] ` : \"\";\r\n  \r\n  logger.error(`${contextMsg}${parsed.message}`, {\r\n    status: parsed.status,\r\n    code: parsed.code,\r\n    details: parsed.details,\r\n  });\r\n}\r\n","/**\r\n * Simple in-memory cache for API responses\r\n * Used to reduce database queries and improve performance\r\n */\r\n\r\ninterface CacheEntry<T> {\r\n  data: T;\r\n  timestamp: number;\r\n  ttl: number; // Time to live in milliseconds\r\n}\r\n\r\nclass SimpleCache {\r\n  private cache = new Map<string, CacheEntry<any>>();\r\n  private maxSize = 1000; // Maximum number of entries\r\n\r\n  /**\r\n   * Get value from cache\r\n   */\r\n  get<T>(key: string): T | null {\r\n    const entry = this.cache.get(key);\r\n    \r\n    if (!entry) {\r\n      return null;\r\n    }\r\n\r\n    // Check if entry has expired\r\n    const now = Date.now();\r\n    if (now - entry.timestamp > entry.ttl) {\r\n      this.cache.delete(key);\r\n      return null;\r\n    }\r\n\r\n    return entry.data as T;\r\n  }\r\n\r\n  /**\r\n   * Set value in cache\r\n   */\r\n  set<T>(key: string, data: T, ttl: number = 60000): void {\r\n    // Remove oldest entries if cache is full\r\n    if (this.cache.size >= this.maxSize) {\r\n      const firstKey = this.cache.keys().next().value;\r\n      if (firstKey !== undefined) {\r\n        this.cache.delete(firstKey);\r\n      }\r\n    }\r\n\r\n    this.cache.set(key, {\r\n      data,\r\n      timestamp: Date.now(),\r\n      ttl,\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Delete value from cache\r\n   */\r\n  delete(key: string): void {\r\n    this.cache.delete(key);\r\n  }\r\n\r\n  /**\r\n   * Clear all cache entries\r\n   */\r\n  clear(): void {\r\n    this.cache.clear();\r\n  }\r\n\r\n  /**\r\n   * Clear expired entries\r\n   */\r\n  clearExpired(): void {\r\n    const now = Date.now();\r\n    for (const [key, entry] of this.cache.entries()) {\r\n      if (now - entry.timestamp > entry.ttl) {\r\n        this.cache.delete(key);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get cache size\r\n   */\r\n  size(): number {\r\n    return this.cache.size;\r\n  }\r\n}\r\n\r\n// Create singleton instance\r\nexport const cache = new SimpleCache();\r\n\r\n// Clean up expired entries every 5 minutes\r\nif (typeof setInterval !== 'undefined') {\r\n  setInterval(() => {\r\n    cache.clearExpired();\r\n  }, 5 * 60 * 1000);\r\n}\r\n\r\n/**\r\n * Cache key generators\r\n */\r\nexport const cacheKeys = {\r\n  chat: (chatId: string) => `chat:${chatId}`,\r\n  chatMessages: (chatId: string, page?: number, limit?: number) => \r\n    `chat:messages:${chatId}:${page || 1}:${limit || 50}`,\r\n  chatList: (page?: number, limit?: number) => \r\n    `chat:list:${page || 1}:${limit || 50}`,\r\n  products: (page?: number, limit?: number, filters?: string) => \r\n    `products:${page || 1}:${limit || 50}:${filters || ''}`,\r\n  product: (productId: string) => `product:${productId}`,\r\n  categories: () => `categories:all`,\r\n  category: (categoryId: string) => `category:${categoryId}`,\r\n  orders: (filters?: string) => `orders:${filters || ''}`,\r\n  order: (orderId: string) => `order:${orderId}`,\r\n};\r\n\r\n/**\r\n * Helper to wrap async function with cache\r\n */\r\nexport async function withCache<T>(\r\n  key: string,\r\n  fn: () => Promise<T>,\r\n  ttl: number = 60000 // Default 1 minute\r\n): Promise<T> {\r\n  // Try to get from cache first\r\n  const cached = cache.get<T>(key);\r\n  if (cached !== null) {\r\n    return cached;\r\n  }\r\n\r\n  // Execute function and cache result\r\n  const result = await fn();\r\n  cache.set(key, result, ttl);\r\n  return result;\r\n}\r\n\r\n","/**\r\n * Simple in-memory rate limiter\r\n * For production, consider using Redis-based rate limiting\r\n */\r\n\r\nimport { NextRequest } from 'next/server';\r\n\r\ninterface RateLimitEntry {\r\n  count: number;\r\n  resetTime: number;\r\n}\r\n\r\nclass RateLimiter {\r\n  private store = new Map<string, RateLimitEntry>();\r\n  private cleanupInterval: NodeJS.Timeout | null = null;\r\n\r\n  /**\r\n   * Check if request should be rate limited\r\n   * @param key - Unique identifier (e.g., IP address, user ID)\r\n   * @param maxRequests - Maximum number of requests\r\n   * @param windowMs - Time window in milliseconds\r\n   * @returns true if rate limited, false otherwise\r\n   */\r\n  isRateLimited(key: string, maxRequests: number, windowMs: number): boolean {\r\n    const now = Date.now();\r\n    const entry = this.store.get(key);\r\n\r\n    if (!entry || now > entry.resetTime) {\r\n      // Create new entry or reset expired entry\r\n      this.store.set(key, {\r\n        count: 1,\r\n        resetTime: now + windowMs,\r\n      });\r\n      return false;\r\n    }\r\n\r\n    if (entry.count >= maxRequests) {\r\n      return true; // Rate limited\r\n    }\r\n\r\n    // Increment count\r\n    entry.count++;\r\n    return false;\r\n  }\r\n\r\n  /**\r\n   * Get remaining requests for a key\r\n   */\r\n  getRemaining(key: string, maxRequests: number): number {\r\n    const entry = this.store.get(key);\r\n    if (!entry) {\r\n      return maxRequests;\r\n    }\r\n    return Math.max(0, maxRequests - entry.count);\r\n  }\r\n\r\n  /**\r\n   * Get reset time for a key\r\n   */\r\n  getResetTime(key: string): number | null {\r\n    const entry = this.store.get(key);\r\n    return entry ? entry.resetTime : null;\r\n  }\r\n\r\n  /**\r\n   * Clear expired entries\r\n   */\r\n  cleanup(): void {\r\n    const now = Date.now();\r\n    for (const [key, entry] of this.store.entries()) {\r\n      if (now > entry.resetTime) {\r\n        this.store.delete(key);\r\n      }\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Start automatic cleanup\r\n   */\r\n  startCleanup(intervalMs: number = 60000): void {\r\n    if (this.cleanupInterval) {\r\n      return;\r\n    }\r\n    this.cleanupInterval = setInterval(() => {\r\n      this.cleanup();\r\n    }, intervalMs);\r\n  }\r\n\r\n  /**\r\n   * Stop automatic cleanup\r\n   */\r\n  stopCleanup(): void {\r\n    if (this.cleanupInterval) {\r\n      clearInterval(this.cleanupInterval);\r\n      this.cleanupInterval = null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all entries\r\n   */\r\n  clear(): void {\r\n    this.store.clear();\r\n  }\r\n}\r\n\r\n// Create singleton instance\r\nexport const rateLimiter = new RateLimiter();\r\n\r\n// Start automatic cleanup every minute\r\nrateLimiter.startCleanup(60000);\r\n\r\n/**\r\n * Get client identifier from request\r\n */\r\nexport function getClientId(request: NextRequest): string {\r\n  // Try to get IP from various headers (for proxies/load balancers)\r\n  const forwarded = request.headers.get('x-forwarded-for');\r\n  const realIp = request.headers.get('x-real-ip');\r\n  const ip = forwarded?.split(',')[0] || realIp || 'unknown';\r\n  \r\n  return ip;\r\n}\r\n\r\n/**\r\n * Rate limit middleware\r\n */\r\nexport function rateLimit(\r\n  maxRequests: number = 100,\r\n  windowMs: number = 60000, // 1 minute default\r\n  keyGenerator?: (request: NextRequest) => string\r\n) {\r\n  return async (request: NextRequest): Promise<Response | null> => {\r\n    const key = keyGenerator ? keyGenerator(request) : getClientId(request);\r\n    const fullKey = `${request.nextUrl.pathname}:${key}`;\r\n\r\n    if (rateLimiter.isRateLimited(fullKey, maxRequests, windowMs)) {\r\n      const resetTime = rateLimiter.getResetTime(fullKey);\r\n      const remaining = rateLimiter.getRemaining(fullKey, maxRequests);\r\n      \r\n      return new Response(\r\n        JSON.stringify({\r\n          success: false,\r\n          error: {\r\n            message: 'Too many requests. Please try again later.',\r\n            code: 'RATE_LIMIT_EXCEEDED',\r\n          },\r\n        }),\r\n        {\r\n          status: 429,\r\n          headers: {\r\n            'Content-Type': 'application/json',\r\n            'X-RateLimit-Limit': maxRequests.toString(),\r\n            'X-RateLimit-Remaining': remaining.toString(),\r\n            'X-RateLimit-Reset': resetTime?.toString() || '',\r\n            'Retry-After': Math.ceil((resetTime ? resetTime - Date.now() : windowMs) / 1000).toString(),\r\n          },\r\n        }\r\n      );\r\n    }\r\n\r\n    return null; // Not rate limited\r\n  };\r\n}\r\n\r\n"],"names":[],"mappings":"uCACA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,MAGO,IAAM,EAAsB,gBAInC,SAAS,IAEP,OAAO,IAAI,OAAO,WAAW,GAAG,KAAK,CAAC,EAAG,IAAI,OAAO,CAAC,IAAK,IAC5D,CAQO,SAAS,EAAU,CAAa,EACrC,OAAO,EAAA,OAAM,CAAC,UAAU,CAAC,UAAU,MAAM,CAAC,GAAO,MAAM,CAAC,MAC1D,CAOO,SAAS,EAAwB,CAAoB,EAG1D,MAAO,CACL,UAAU,EACV,OARK,AAAU,WADH,AAMwD,EANhD,OAAO,CAAC,CAMmD,EANhD,CAAC,sBAAwB,EAAQ,OAAO,CAAC,QAAQ,CAAC,OAAO,CAAC,IAAK,GAAA,EAU9F,SAAU,MACV,KAAM,IACN,OAAQ,MACV,CACF,CAEO,OAJoB,KAAK,GAIV,EAJe,EAMnC,MAAM,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,CAAC;;;;;;;;;;;;EAYhB,CAAC,EAMD,GAAI,CAEF,MAAM,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,CAAC,yDAAyD,CAAC,EAG1E,MAAM,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,CAAC,mDAAmD,CAAC,EAGpE,IAAM,EAAY,MAAM,CAAA,EAAA,EAAA,OAAA,AAAO,EAAM,CAAC,qBAAqB,CAAC,EACtD,EAAuB,IAAI,IAEjC,IAAK,IAAM,KAAK,EAAW,CACzB,IAAM,EAAU,OAAO,EAAE,QAAQ,EAAI,EAAE,QAAQ,EAAI,EAAE,QAAQ,EAAI,IAC3D,EAAY,OAAO,EAAE,UAAU,EAAI,EAAE,UAAU,EAAI,EAAE,UAAU,EAAI,GACnE,EAAU,OAAO,EAAE,WAAW,EAAI,EAAE,WAAW,EAAI,EAAE,WAAW,EAAI,IAC1E,GAAI,CAAC,GAAW,CAAC,GACC,GAAG,CAAjB,EADsB,SAE1B,IAAM,EAAO,EAAqB,GAAG,CAAC,IAAY,EAAE,CACpD,EAAK,IAAI,CAAC,GACV,EAAqB,GAAG,CAAC,EAAS,EACpC,CAGA,IAAI,EAAsC,KAC1C,IAAK,GAAM,CAAC,EAAK,EAAK,GAAI,EAAqB,OAAO,GAAI,CACxD,GAAY,YAAR,EAAmB,SACvB,IAAM,EAAiB,EAAK,GAAG,CAAC,AAAC,GAAM,EAAE,WAAW,IAAI,IAAI,GAC5D,GAA8B,IAA1B,EAAe,MAAM,EAAgC,UAAtB,CAAc,CAAC,EAAE,CAAc,CAChE,EAAuB,EACvB,KACF,CACF,CASA,IAAK,IAAM,KANN,IACH,MAAM,CAAA,EAAA,EAAA,OADmB,CACnB,AAAQ,EAAC,CAAC,yDAAyD,CAAC,EAC1E,EAAuB,oBAIP,EAAqB,IAAI,GAAI,CAC7C,GAAY,WAAW,CAAnB,GACA,IAAQ,EAEZ,GAAI,CACF,MAAM,CAAA,EAAA,EAAA,KAH0B,GAG1B,AAAQ,EAAC,CAAC,+BAA+B,EAAE,EAAI,EAAE,CAAC,CAC1D,CAAE,KAAM,CAER,CAEJ,CAAE,KAAM,CAER,CAGA,MAAM,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,CAAC;;;;;;;;;;;;;;EAchB,CAAC,CACH,CAWO,eAAe,EAAc,CAAc,CAAE,CAAoB,OACtE,OAAM,IAEN,IAAM,EAAQ,EAAA,OAAM,CAAC,WAAW,CAAC,IAAI,QAAQ,CAAC,aACxC,EAAY,EAAU,GACtB,EAAY,CAAC,KAAK,EAAE,KAAK,GAAG,GAAG,CAAC,EAAE,EAAA,OAAM,CAAC,WAAW,CAAC,GAAG,QAAQ,CAAC,OAAA,CAAQ,CACzE,GApIN,CADM,EAAI,IAAI,EAqII,GArIC,AAqIO,IAAI,OApI5B,CAoIoC,MApI7B,CAAC,EAAE,OAAO,GATA,EASK,EACjB,GAqID,EAAK,EAAQ,OAAO,CAAC,GAAG,CAAC,cACzB,EAAK,EAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB,MAAM,IAAI,CAAC,EAAE,EAAE,QAAU,KAiB5E,OAfA,MAAM,CAAA,EAAA,EAAA,QAAA,AAAQ,EACZ,CAAC;oCAC+B,CAAC,CACjC,CACE,EACA,EACA,EACA,EAAU,WAAW,GAAG,KAAK,CAAC,EAAG,IAAI,OAAO,CAAC,IAAK,KAClD,IACA,IACA,GAAM,KACN,EACD,EAGI,CACT,CAEO,eAAe,EAA0B,CAAoB,EAClE,MAAM,IAEN,IAAM,EAAQ,EAAQ,OAAO,CAAC,GAAG,CAAC,IAAsB,MACxD,GAAI,CAAC,EAAO,OAAO,KAEnB,IAAM,EAAY,EAAU,GACtB,EAAM,MAAM,CAAA,EAAA,EAAA,MAAA,AAAM,EAUtB,CAAC;;;;YAIO,CAAC,CACT,CAAC,EAAU,EAGb,GAAI,CAAC,EAAK,OAAO,KAEjB,IAAM,EAAU,IAAI,KAAK,EAAI,SAAS,SACtC,AAAI,OAAO,KAAK,CAAC,EAAQ,OAAO,KAAO,EAAQ,OAAO,GAAK,KAAK,GAAG,IAAI,AAErE,MAAM,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,CAAC,wCAAwC,CAAC,CAAE,CAAC,EAAU,EAC/D,OAIT,MAAM,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,CAAC,+CAA+C,CAAC,CAAE,CAAC,IAAU,EAAI,SAAS,CAAC,EAEpF,CACL,GAAI,EAAI,MAAM,CACd,KAAM,EAAI,IAAI,CACd,MAAO,EAAI,KAAK,CAChB,KAAM,EAAI,IAAI,EAAI,OAClB,SAAS,CAAQ,EAAI,OAAO,CAC5B,UAAW,EAAI,SACjB,AAD0B,EAE5B,CAEO,eAAe,EAAa,CAAoB,EACrD,IAAM,EAAQ,EAAQ,OAAO,CAAC,GAAG,CAAC,IAAsB,MACxD,GAAI,CAAC,EAAO,OACZ,IAAM,EAAY,EAAU,EAC5B,OAAM,CAAA,EAAA,EAAA,QAAA,AAAQ,EAAC,CAAC,wCAAwC,CAAC,CAAE,CAAC,EAAU,CACxE,CAEO,SAAS,EAAiB,CAAsB,CAAE,CAAa,CAAE,CAAoB,EAC1F,EAAS,OAAO,CAAC,GAAG,CAAC,EAAqB,EAAO,EAAwB,GAC3E,CAEO,SAAS,EAAmB,CAAsB,CAAE,CAAoB,EAC7E,EAAS,OAAO,CAAC,GAAG,CAAC,EAAqB,GAAI,CAC5C,GAAG,EAAwB,EAAQ,CACnC,OAAQ,CACV,EACF,yLCjOO,eAAe,EACpB,CAAW,CACX,EAAgB,EAAE,EAElB,GAAI,CACF,GAAM,UAAE,CAAQ,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,MAEf,EAAW,EAAkB,GACnC,OAAO,MAAM,EAAY,EAAU,EACrC,CAAE,MAAO,EAAY,CAOnB,MANA,QAAQ,KAAK,CAAC,4BAA6B,KACzC,SACA,EACA,MAAO,GAAO,QACd,KAAM,GAAO,IACf,GACM,CACR,CACF,CAKO,eAAe,EACpB,CAAW,CACX,EAAgB,EAAE,EAElB,GAAI,CACF,GAAM,CAAE,UAAQ,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,MAEf,EAAW,EAAkB,GACnC,OAAO,MAAM,EAAY,EAAU,EACrC,CAAE,MAAO,EAAY,CAOnB,MANA,QAAQ,KAAK,CAAC,6BAA8B,KAC1C,SACA,EACA,MAAO,GAAO,QACd,KAAM,GAAO,IACf,GACM,CACR,CACF,CAKO,eAAe,EACpB,CAAW,CACX,EAAgB,EAAE,EAElB,GAAM,CAAE,OAAK,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,MACZ,EAAW,EAAkB,GAC7B,EAAS,MAAM,EAAM,EAAU,GACrC,MAAO,CACL,QAAS,EAAO,YAAY,EAAI,EAAO,QAAQ,EAAI,EACnD,gBAAiB,EAAO,QAAQ,OAAI,CACtC,CACF,CASA,SAAS,EAAkB,CAAW,EACpC,IAMI,EANA,EAAW,EAIT,EAAmB,WACnB,EAA2D,EAAE,CAEnE,KAAO,AAAyC,KAAM,GAA9C,EAAQ,EAAiB,IAAI,CAAC,EAAA,CAAI,EACxC,EAAa,IAAI,CAAC,CAChB,MAAO,SAAS,CAAK,CAAC,EAAE,CAAE,IAC1B,SAAU,EAAM,KAAK,AACvB,GAIF,GAAI,EAAa,MAAM,CAAG,EAKxB,CAL2B,GAKtB,IAAM,KAHX,EAAa,IAAI,CAAC,CAAC,EAAG,IAAM,EAAE,QAAQ,CAAG,EAAE,QAAQ,EAGzB,GACxB,EAAW,EAAS,MADkB,GACT,CAAC,EAAG,EAAY,QAAQ,EAC1C,IACA,EAAS,SAAS,CAAC,EAAY,QAAQ,CAAG,CAAC,CAAC,EAAE,EAAY,KAAK,CAAA,CAAE,CAAC,MAAM,EAsBvF,MAFW,CADX,AAGO,EAHI,CAVX,EAAW,CAHX,EAAW,EAAS,OAAO,CAAC,aAAc,OAAA,EAGtB,OAAO,CACzB,qDACA,CAAC,EAAO,EAAiB,KAEvB,IAAM,EAAkB,EAAa,OAAO,CAAC,oBAAqB,cAClE,MAAO,CAAC,wBAAwB,EAAE,EAAA,CAAiB,AACrD,EAAA,EAIkB,OAAO,CAAC,WAAY,GAAA,EACpB,OAAO,CAAC,UAAW,GAGzC,CAKO,eAAe,IACpB,GAAM,gBAAE,CAAc,kBAAE,CAAgB,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,KAC7C,OAAM,IACN,MAAM,GACR,CAKO,eAAe,IACpB,GAAI,CACF,GAAM,gBAAE,CAAc,CAAE,CAAG,MAAA,EAAA,CAAA,CAAA,MAC3B,OAAO,MAAM,GACf,CAAE,MAAO,EAAO,CACd,MAAO,EACT,CACF,CAKO,SAAS,IACd,MAAO,OACT,smCCrFO,IAAM,EAAS,IAAI,AA1D1B,MAAM,AACI,eAAgB,CAAuC,CACvD,cAAe,CAAsC,CAErD,UAAU,CAAe,CAAW,OAE1C,AAAc,UAAV,GAA+B,CALY,OAKJ,CAAlB,GAIlB,IAAI,CARmC,AAQlC,aAAa,AAC3B,CAEA,IAAI,GAAG,CAAW,CAAQ,CACpB,IAAI,CAAC,SAAS,CAAC,QACjB,AADyB,QACjB,GAAG,IAAI,EAEnB,CAEA,MAAM,GAAG,CAAW,CAAQ,CAC1B,QAAQ,KAAK,IAAI,EACnB,CAEA,KAAK,GAAG,CAAW,CAAQ,CACzB,QAAQ,IAAI,IAAI,EAClB,CAEA,KAAK,GAAG,CAAW,CAAQ,CACrB,IAAI,CAAC,SAAS,CAAC,SAAS,AAC1B,QAAQ,IAAI,IAAI,EAEpB,CAEA,MAAM,GAAG,CAAW,CAAQ,CACtB,IAAI,CAAC,SAAS,CAAC,UAAU,AAC3B,QAAQ,KAAK,IAAI,EAErB,CAKA,QAAQ,CAAa,CAAE,CAAc,CAAQ,CACvC,IAAI,CAAC,aAAa,EAAE,AACtB,QAAQ,GAAG,CAAC,aAAc,EAAM,SAAS,CAAC,EAAG,KAAM,EAAS,CAAC,CAAC,EAAE,EAAO,MAAM,CAAC,QAAQ,CAAC,CAAG,GAE9F,CAKA,WAAW,CAAc,CAAE,CAAY,CAAE,CAAmB,CAAQ,CAC9D,IAAI,CAAC,aAAa,EAAE,AACtB,QAAQ,GAAG,CAAC,CAAC,MAAM,EAAE,EAAO,CAAC,EAAE,EAAA,EAAO,EAAa,CAAC,CAAC,EAAE,EAAA,CAAY,CAAG,GAAA,CAAI,CAE9E,CACF,oDC1DA,ICyBY,EDzBZ,EAAA,EAAA,CAAA,CAAA,OCoDA,EAAA,EAAA,CAAA,CAAA,MA7CO,OAAM,UAAiB,MAC5B,MAAgB,CAChB,IAAc,CACd,OAAkB,AAElB,aAAY,CAAe,CAAE,CAAe,CAAE,CAAa,CAAE,CAAiB,CAAE,CAC9E,KAAK,CAAC,GACN,IAAI,CAAC,IAAI,CAAG,WACZ,IAAI,CAAC,MAAM,CAAG,EACd,IAAI,CAAC,IAAI,CAAG,EACZ,IAAI,CAAC,OAAO,CAAG,EACf,OAAO,cAAc,CAAC,IAAI,CAAE,EAAS,SAAS,CAChD,CACF,qFAYO,OAAM,UAAqB,MAChC,IAAuB,AACvB,cAEA,AAFsB,aAGpB,CAAe,CACf,EAAA,SAAiD,CACjD,CAAqB,CACrB,CACA,KAAK,CAAC,GACN,IAAI,CAAC,IAAI,CAAG,eACZ,IAAI,CAAC,IAAI,CAAG,EACZ,IAAI,CAAC,aAAa,CAAG,EACrB,OAAO,cAAc,CAAC,IAAI,CAAE,EAAa,SAAS,CACpD,CACF,CA8FO,SAAS,EAAS,CAAc,CAAE,CAAgB,EACvD,IAAM,EApFN,AAAI,OAoFW,MApFM,EACZ,CACL,OAF2B,CAElB,EAAM,OAAO,CACtB,OAAQ,EAAM,MAAM,CACpB,KAAM,EAAM,IAAI,CAChB,QAAS,EAAM,OAAO,AACxB,EA8EwB,AA3EtB,aAAiB,EACZ,CACL,QAAS,EAAM,CAFgB,MAET,CACtB,KAAM,EAAM,IAAI,CAChB,QAAS,EAAM,aACjB,AAD8B,EAI5B,aAAiB,MACZ,CADmB,AAExB,QAAS,EAAM,OAAO,AACxB,EAGmB,UAAU,AAA3B,OAAO,EACF,CACL,SAAS,AACX,EAGK,CACL,QAAS,oBACX,EAsDM,EAAa,EAAU,CAAC,CAAC,EAAE,EAAQ,EAAE,CAAC,CAAG,GAE/C,EAAA,MAAM,CAAC,KAAK,CAAC,CAAA,EAAG,EAAA,EAAa,EAAO,OAAO,CAAA,CAAE,CAAE,CAC7C,OAAQ,EAAO,MAAM,CACrB,KAAM,EAAO,IAAI,CACjB,QAAS,EAAO,OAAO,AACzB,EACF,CDzIO,SAAS,EACd,CAAc,CACd,EAAwB,GAAG,EAE3B,IAEI,EAFA,EAAU,YACV,EAAS,EAoCb,OA/BI,aAAiB,GACnB,EAAU,EAAM,GADa,IACN,CACvB,EAAS,EAAM,MAAM,EAAI,EACzB,EAAO,EAAM,IAAI,CACP,EAAM,OAAO,EACd,aAAiB,OAAO,AACjC,EAAU,EAAM,OAAO,CACnB,WAAY,GAAiC,UAAxB,AAAkC,OAA3B,EAAM,MAAM,GAC1C,EAAS,EAAM,MAAM,AAAN,EAEb,SAAU,GAA+B,UAAtB,AAAgC,OAAzB,EAAM,IAAI,GACtC,EAAO,EAAM,IAAA,AAAI,EAEf,YAAa,GACL,EAAM,EADM,KACC,EAEhB,AAAiB,UAAU,OAApB,EAChB,EAAU,EACD,GAA0B,UAAjB,OAAO,GAAsB,YAAa,IAC5D,EAAU,CADyD,MAClD,EAAM,OAAO,EAC1B,WAAY,GAAiC,AAAxB,UAAkC,OAA3B,EAAM,MAAM,GAC1C,EAAS,EAAM,MAAA,AAAM,EAEnB,SAAU,GAAS,AAAsB,UAAU,OAAzB,EAAM,IAAI,GACtC,EAAO,EAAM,IAAA,AAAI,GAKrB,EAAS,EAAO,aAET,EAAA,YAAY,CAAC,IAAI,CACtB,CACE,SAAS,EACT,MAAO,EACP,GAAI,EAAO,MAAE,CAAK,EAAI,CAAC,CAAC,AAE1B,EACA,QAAE,CAAO,EAEb,CAKO,SAAS,EACd,CAAO,CACP,EAAiB,GAAG,CACpB,CAKC,EAED,OAAO,EAAA,YAAY,CAAC,IAAI,CACtB,CACE,SAAS,OACT,EACA,GAAI,GAAc,YAAE,CAAW,CAAC,AAClC,EACA,QAAE,CAAO,EAEb,kNEhFA,OAAM,EACI,MAAQ,IAAI,GAA+B,CAC3C,QAAU,GAAK,CAKvB,IAAO,CAAW,CAAY,CAC5B,IAAM,EAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,UAE7B,AAAK,EAKO,AACR,EANA,GAKa,AALL,GAKQ,GACV,EAAM,SAAS,CAAG,EAAM,GAAG,EAAE,AACrC,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,GACX,MAGF,EAAM,IAAI,CAVR,IAWX,CAKA,IAAO,CAAW,CAAE,CAAO,CAAE,EAAc,GAAK,CAAQ,CAEtD,GAAI,IAAI,CAAC,KAAK,CAAC,IAAI,EAAI,IAAI,CAAC,OAAO,CAAE,CACnC,IAAM,EAAW,IAAI,CAAC,KAAK,CAAC,IAAI,GAAG,IAAI,GAAG,KAAK,MAC9B,IAAb,GACF,IAD0B,AACtB,CAAC,KAAK,CAAC,MAAM,CAAC,EAEtB,CAEA,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,EAAK,MAClB,EACA,UAAW,KAAK,GAAG,OACnB,CACF,EACF,CAKA,OAAO,CAAW,CAAQ,CACxB,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EACpB,CAKA,OAAc,CACZ,IAAI,CAAC,KAAK,CAAC,KAAK,EAClB,CAKA,cAAqB,CACnB,IAAM,EAAM,KAAK,GAAG,GACpB,IAAK,GAAM,CAAC,EAAK,EAAM,GAAI,IAAI,CAAC,KAAK,CAAC,OAAO,GAAI,AAC3C,EAAM,EAAM,SAAS,CAAG,EAAM,GAAG,EACnC,AADqC,IACjC,CAAC,KAAK,CAAC,MAAM,CAAC,EAGxB,CAKA,MAAe,CACb,OAAO,IAAI,CAAC,KAAK,CAAC,IAAI,AACxB,CACF,CAGO,IAAM,EAAQ,IAAI,CAGE,aAAa,CAApC,OAAO,aACT,YAAY,KACV,EAAM,YAAY,EACpB,EAAG,IAAI,KAAK,2BAMW,CACvB,KAAM,AAAC,GAAmB,CAAC,KAAK,EAAE,EAAA,CAAQ,CAC1C,aAAc,CAAC,EAAgB,EAAe,IAC5C,CAAC,cAAc,EAAE,EAAO,CAAC,EAAE,GAAQ,EAAE,CAAC,EAAE,GAAS,GAAA,CAAI,CACvD,SAAU,CAAC,EAAe,IACxB,CAAC,UAAU,EAAE,GAAQ,EAAE,CAAC,EAAE,GAAS,GAAA,CAAI,CACzC,SAAU,CAAC,EAAe,EAAgB,IACxC,CAAC,SAAS,EAAE,GAAQ,EAAE,CAAC,EAAE,GAAS,GAAG,CAAC,EAAE,GAAW,GAAA,CAAI,CACzD,QAAS,AAAC,GAAsB,CAAC,QAAQ,EAAE,EAAA,CAAW,CACtD,WAAY,IAAM,CAAC,cAAc,CAAC,CAClC,SAAU,AAAC,GAAuB,CAAC,SAAS,EAAE,EAAA,CAAY,CAC1D,OAAQ,AAAC,GAAqB,CAAC,OAAO,EAAE,GAAW,GAAA,CAAI,CACvD,MAAO,AAAC,GAAoB,CAAC,MAAM,EAAE,EAAA,CAAS,AAChD,QCtGA,OAAM,EACI,MAAQ,IAAI,GAA8B,CAC1C,gBAAyC,IAAK,CAStD,cAAc,CAAW,CAAE,CAAmB,CAAE,CAAgB,CAAW,CACzE,IAAM,EAAM,KAAK,GAAG,GACd,EAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,SAEzB,AAAJ,CAAK,GAAS,EAAM,EAAM,SAAS,EAAE,AAEnC,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,EAAK,CAClB,MAAO,EACP,UAAW,EAAM,CACnB,GACO,IAGL,EAAM,KAAK,EAAI,IAKnB,EAAM,KAAK,EALqB,EAMzB,EACT,CAKA,aAAa,CAAW,CAAE,CAAmB,CAAU,CACrD,IAAM,EAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,UAC7B,AAAK,EAGE,EAHH,GAGQ,AAHA,GAGG,CAAC,EAAG,EAAc,EAAM,KAAK,EAFnC,CAGX,CAKA,aAAa,CAAW,CAAiB,CACvC,IAAM,EAAQ,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,GAC7B,OAAO,EAAQ,EAAM,SAAS,CAAG,IACnC,CAKA,SAAgB,CACd,IAAM,EAAM,KAAK,GAAG,GACpB,IAAK,GAAM,CAAC,EAAK,EAAM,GAAI,IAAI,CAAC,KAAK,CAAC,OAAO,GAAI,AAC3C,EAAM,EAAM,SAAS,EAAE,AACzB,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,EAGxB,CAKA,aAAa,EAAqB,GAAK,CAAQ,CACzC,IAAI,CAAC,eAAe,EAAE,CAG1B,IAAI,CAAC,eAAe,CAAG,YAAY,KACjC,IAAI,CAAC,OAAO,EACd,EAAG,EAAA,CACL,CAKA,aAAoB,CACd,IAAI,CAAC,eAAe,EAAE,CACxB,cAAc,IAAI,CAAC,eAAe,EAClC,IAAI,CAAC,eAAe,CAAG,KAE3B,CAKA,OAAc,CACZ,IAAI,CAAC,KAAK,CAAC,KAAK,EAClB,CACF,CAGO,IAAM,EAAc,IAAI,EAoBxB,SAAS,EACd,EAAsB,GAAG,CACzB,EAAmB,GAAK,CACxB,CAA+C,EAE/C,OAAO,MAAO,QAfR,IAgBE,EAAM,EAAe,EAAa,MAhBxB,EAAQ,GAgB2B,IAhBpB,CAAC,GAAG,CAAC,mBAChC,EAAS,AAekD,EAf1C,OAAO,CAAC,GAAG,CAAC,aACxB,GAAW,MAAM,IAAI,CAAC,EAAE,EAAI,GAAU,WAezC,EAAU,CAAA,EAAG,EAAQ,OAAO,CAAC,QAAQ,CAAC,CAAC,EAAE,EAAA,CAAK,CAEpD,GAAI,EAAY,aAAa,CAAC,EAAS,EAAa,GAAW,CAC7D,IAAM,EAAY,EAAY,YAAY,CAAC,GACrC,EAAY,EAAY,YAAY,CAAC,EAAS,GAEpD,OAAO,IAAI,SACT,KAAK,SAAS,CAAC,CACb,SAAS,EACT,MAAO,CACL,QAAS,6CACT,KAAM,qBACR,CACF,GACA,CACE,OAAQ,IACR,QAAS,CACP,eAAgB,mBAChB,oBAAqB,EAAY,QAAQ,GACzC,wBAAyB,EAAU,QAAQ,GAC3C,oBAAqB,GAAW,YAAc,GAC9C,cAAe,KAAK,IAAI,CAAC,CAAC,EAAY,EAAY,KAAK,GAAG,GAAK,CAAA,CAAQ,CAAI,KAAM,QAAQ,EAC3F,CACF,EAEJ,CAEA,OAAO,IACT,CACF,CArDA,AAmDiB,EAnDL,YAAY,CAAC,IAmDW"}