(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,71876,e=>{"use strict";var t=e.i(43476),s=e.i(71645),a=e.i(18566),r=e.i(70065),i=e.i(67881),n=e.i(23750),l=e.i(10708),o=e.i(60366),d=e.i(36361),c=e.i(55436),m=e.i(88844),u=e.i(46897),h=e.i(43432),p=e.i(63488),g=e.i(87316),x=e.i(15788),f=e.i(95468),j=e.i(3116),b=e.i(73884),y=e.i(1928),v=e.i(72664),N=e.i(69638),w=e.i(94983),k=e.i(78917),C=e.i(48106),S=e.i(94179);e.i(74080);var I=e.i(91918),T=["a","button","div","form","h2","h3","img","input","label","li","nav","ol","p","select","span","svg","ul"].reduce((e,a)=>{let r=(0,I.createSlot)(`Primitive.${a}`),i=s.forwardRef((e,s)=>{let{asChild:i,...n}=e;return"undefined"!=typeof window&&(window[Symbol.for("radix-ui")]=!0),(0,t.jsx)(i?r:a,{...n,ref:s})});return i.displayName=`Primitive.${a}`,{...e,[a]:i}},{}),R="Progress",[$,E]=function(e,a=[]){let r=[],i=()=>{let t=r.map(e=>s.createContext(e));return function(a){let r=a?.[e]||t;return s.useMemo(()=>({[`__scope${e}`]:{...a,[e]:r}}),[a,r])}};return i.scopeName=e,[function(a,i){let n=s.createContext(i);n.displayName=a+"Context";let l=r.length;r=[...r,i];let o=a=>{let{scope:r,children:i,...o}=a,d=r?.[e]?.[l]||n,c=s.useMemo(()=>o,Object.values(o));return(0,t.jsx)(d.Provider,{value:c,children:i})};return o.displayName=a+"Provider",[o,function(t,r){let o=r?.[e]?.[l]||n,d=s.useContext(o);if(d)return d;if(void 0!==i)return i;throw Error(`\`${t}\` must be used within \`${a}\``)}]},function(...e){let t=e[0];if(1===e.length)return t;let a=()=>{let a=e.map(e=>({useScope:e(),scopeName:e.scopeName}));return function(e){let r=a.reduce((t,{useScope:s,scopeName:a})=>{let r=s(e)[`__scope${a}`];return{...t,...r}},{});return s.useMemo(()=>({[`__scope${t.scopeName}`]:r}),[r])}};return a.scopeName=t.scopeName,a}(i,...a)]}(R),[A,O]=$(R),L=s.forwardRef((e,s)=>{var a,r;let{__scopeProgress:i,value:n=null,max:l,getValueLabel:o=D,...d}=e;(l||0===l)&&!U(l)&&console.error((a=`${l}`,`Invalid prop \`max\` of value \`${a}\` supplied to \`Progress\`. Only numbers greater than 0 are valid max values. Defaulting to \`100\`.`));let c=U(l)?l:100;null===n||_(n,c)||console.error((r=`${n}`,`Invalid prop \`value\` of value \`${r}\` supplied to \`Progress\`. The \`value\` prop must be:
  - a positive number
  - less than the value passed to \`max\` (or 100 if no \`max\` prop is set)
  - \`null\` or \`undefined\` if the progress is indeterminate.

Defaulting to \`null\`.`));let m=_(n,c)?n:null,u=W(m)?o(m,c):void 0;return(0,t.jsx)(A,{scope:i,value:m,max:c,children:(0,t.jsx)(T.div,{"aria-valuemax":c,"aria-valuemin":0,"aria-valuenow":W(m)?m:void 0,"aria-valuetext":u,role:"progressbar","data-state":M(m,c),"data-value":m??void 0,"data-max":c,...d,ref:s})})});L.displayName=R;var P="ProgressIndicator",B=s.forwardRef((e,s)=>{let{__scopeProgress:a,...r}=e,i=O(P,a);return(0,t.jsx)(T.div,{"data-state":M(i.value,i.max),"data-value":i.value??void 0,"data-max":i.max,...r,ref:s})});function D(e,t){return`${Math.round(e/t*100)}%`}function M(e,t){return null==e?"indeterminate":e===t?"complete":"loading"}function W(e){return"number"==typeof e}function U(e){return W(e)&&!isNaN(e)&&e>0}function _(e,t){return W(e)&&!isNaN(e)&&e<=t&&e>=0}B.displayName=P;var q=e.i(47163);let z=s.forwardRef(({className:e,value:s,...a},r)=>(0,t.jsx)(L,{ref:r,className:(0,q.cn)("relative h-4 w-full overflow-hidden rounded-full bg-secondary",e),...a,children:(0,t.jsx)(B,{className:"h-full w-full flex-1 bg-primary transition-all",style:{transform:`translateX(-${100-(s||0)}%)`}})}));z.displayName=L.displayName,e.i(47167);var H=e.i(52917),F=e.i(20682),J=e.i(16637),V=e.i(27651),X=e.i(44073),G=e.i(73493),K=e.i(46932),Q=e.i(31278),Y=e.i(43531),Z=e.i(94771),ee=e.i(27612),et=e.i(37727),es=e.i(78583),ea=e.i(26428),er=e.i(14050);function ei({messages:e,messagesContainerRef:s,messagesEndRef:a,isSupportTyping:r,onDelete:n}){return(0,t.jsx)("div",{ref:s,className:"flex-1 min-h-0 overflow-y-auto p-5 sm:p-6 md:p-8 bg-gradient-to-b from-background via-background/95 to-muted/5 scroll-smooth",children:(0,t.jsxs)("div",{className:"space-y-3",children:[0===e.length&&(0,t.jsxs)(K.motion.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex flex-col items-center justify-center h-full min-h-[200px] text-center px-4",children:[(0,t.jsx)("div",{className:"w-20 h-20 rounded-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center mb-4 shadow-lg",children:(0,t.jsxs)("svg",{className:"h-10 w-10 text-primary/60",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,t.jsx)("path",{d:"M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),(0,t.jsx)("path",{d:"M8 10h.01M12 10h.01M16 10h.01",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]})}),(0,t.jsx)("p",{className:"text-muted-foreground text-base font-medium leading-relaxed",children:"Ù‡Ù†ÙˆØ² Ù¾ÛŒØ§Ù…ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª"}),(0,t.jsx)("p",{className:"text-muted-foreground/70 text-sm mt-2 leading-relaxed",children:"Ù¾ÛŒØ§Ù… Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."})]}),e.map((e,s)=>(0,t.jsx)(K.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},transition:{duration:.2,ease:"easeOut"},className:`flex ${"user"===e.sender?"justify-end":"justify-start"} items-end gap-2 group`,children:(0,t.jsxs)("div",{className:`max-w-[85%] sm:max-w-[75%] md:max-w-[70%] rounded-lg px-2.5 sm:px-3 py-2 transition-all ${"user"===e.sender?"bg-primary text-primary-foreground":"bg-muted text-foreground border border-border/40"}`,children:[e.text&&(0,t.jsx)("p",{className:"text-xs sm:text-sm leading-relaxed whitespace-pre-wrap break-words mb-1.5",children:e.text}),e.attachments&&e.attachments.length>0&&(0,t.jsx)("div",{className:`space-y-2 ${e.text?"mt-2":""}`,children:e.attachments.map((e,a)=>(0,t.jsxs)(K.motion.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:.1*a},className:"rounded-xl overflow-hidden",children:["image"===e.type&&e.url&&(0,t.jsx)("img",{src:e.url,alt:e.name||"ØªØµÙˆÛŒØ±",className:"max-w-full max-h-[150px] sm:max-h-[180px] rounded cursor-pointer hover:opacity-90 transition-all",onClick:()=>window.open(e.url,"_blank"),onError:t=>{G.logger.error("Image load error:",e.url),t.target.style.display="none"}}),"file"===e.type&&(0,t.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",download:e.name,className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,t.jsx)(es.FileText,{className:"h-3.5 w-3.5"}),(0,t.jsx)("span",{className:"font-medium truncate",children:e.name||"ÙØ§ÛŒÙ„"})]}),"location"===e.type&&(0,t.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,t.jsx)(u.MapPin,{className:"h-3.5 w-3.5"}),(0,t.jsx)("span",{className:"font-medium",children:e.name||"Ù…ÙˆÙ‚Ø¹ÛŒØª"})]}),"audio"===e.type&&e.url&&(0,t.jsx)(er.AudioPlayer,{url:e.url,duration:e.duration})]},e.id||`att-${s}-${a}`))}),(0,t.jsxs)("div",{className:`flex items-center gap-1.5 mt-1.5 pt-1.5 border-t ${"user"===e.sender?"border-primary-foreground/20 justify-end":"border-border/30 justify-start"}`,children:[(0,t.jsx)("span",{className:`text-[10px] sm:text-xs ${"user"===e.sender?"text-primary-foreground/70":"text-muted-foreground"}`,children:new Date(e.timestamp).toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}),"user"===e.sender&&(0,t.jsxs)(t.Fragment,{children:["sending"===e.status&&(0,t.jsx)(Q.Loader2,{className:"h-3 w-3 text-primary-foreground/50 animate-spin"}),"sent"===e.status&&(0,t.jsx)(Y.Check,{className:"h-3 w-3 text-primary-foreground/40"}),"delivered"===e.status&&(0,t.jsx)(Z.CheckCheck,{className:"h-3 w-3 text-primary-foreground/40"}),"read"===e.status&&(0,t.jsx)(Z.CheckCheck,{className:"h-3 w-3 text-primary-foreground/70"}),"failed"===e.status&&(0,t.jsx)(et.X,{className:"h-3 w-3 text-destructive"}),!e.status&&(0,t.jsx)(Y.Check,{className:"h-3 w-3 text-primary-foreground/40"})]}),"user"===e.sender&&n&&(0,t.jsx)(i.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 hover:bg-destructive/10 text-destructive hover:text-destructive opacity-70 hover:opacity-100 transition-opacity",onClick:t=>{t.stopPropagation(),confirm("Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø§ÛŒÙ† Ù¾ÛŒØ§Ù… Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯ØŸ")&&n(e.id)},title:"Ø­Ø°Ù Ù¾ÛŒØ§Ù…",children:(0,t.jsx)(ee.Trash2,{className:"h-3.5 w-3.5"})})]})]})},e.id)),r&&(0,t.jsx)(K.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"flex justify-start items-end gap-2.5",children:(0,t.jsx)(ea.TypingIndicator,{})}),(0,t.jsx)("div",{ref:a})]})})}var en=e.i(22085),el=e.i(73042);function eo({step:e,isOnline:s,lastSeen:a,customerInfo:r,onEditInfo:n}){return(0,t.jsx)(H.SheetHeader,{className:"px-4 sm:px-6 py-2 border-b border-border/40",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:"flex-1 min-w-0",children:(0,t.jsxs)(H.SheetTitle,{className:"text-base font-semibold text-foreground flex items-center gap-2",children:["Ø®Ø±ÛŒØ¯ Ø³Ø±ÛŒØ¹","chat"===e&&(0,t.jsx)(el.OnlineStatusBadge,{isOnline:s,lastSeen:a instanceof Date?a.toISOString():"string"==typeof a?a:null,showText:!1})]})}),"chat"===e&&r.name&&r.phone&&(0,t.jsx)(i.Button,{variant:"ghost",size:"icon",onClick:n,className:"h-8 w-8 rounded-lg hover:bg-primary/10 transition-colors",title:"ØªØºÛŒÛŒØ± Ø§Ø·Ù„Ø§Ø¹Ø§Øª",children:(0,t.jsxs)("svg",{className:"h-4 w-4",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,t.jsx)("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),(0,t.jsx)("circle",{cx:"12",cy:"7",r:"4",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]})})]})})}let ed=e=>{let t=Math.floor(e/60);return`${t}:${(e%60).toString().padStart(2,"0")}`};var ec=e.i(93226);function em({isOpen:e,onOpenChange:r,trigger:i}){let n=(0,a.useRouter)(),{toast:l}=(0,F.useToast)(),{showNotification:o,requestPermission:d}=(0,J.useNotifications)(),{showMessageNotification:c}=(0,X.usePersistentNotifications)(),{isOnline:m,lastSeen:u,checkStatus:h}=(0,V.useAdminPresence)({enabled:!0,heartbeatInterval:2e4}),{user:p,isAuthenticated:g}=(0,ec.useAuthStore)(),[x,f]=(0,s.useState)([{id:"1",text:"Ø³Ù„Ø§Ù…! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ø¨Ø±Ø§ÛŒ Ø®Ø±ÛŒØ¯ Ø³Ø±ÛŒØ¹ Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:",sender:"support",timestamp:new Date}]),[j,b]=(0,s.useState)(""),[y,v]=(0,s.useState)(null),[N,w]=(0,s.useState)(null),k=(0,s.useCallback)(()=>{if(g&&p)return{name:p.name||"",phone:p.phone||"",email:""};{let e=localStorage.getItem("quickBuyChat_customerInfo"),t=localStorage.getItem("quickBuyChat_customerInfo_timestamp");if(e)try{let s=JSON.parse(e);if(t){let e=parseInt(t,10);if((Date.now()-e)/864e5>30)return localStorage.removeItem("quickBuyChat_customerInfo"),localStorage.removeItem("quickBuyChat_customerInfo_timestamp"),localStorage.removeItem("quickBuyChat_chatId"),{name:"",phone:"",email:""}}return s}catch{localStorage.removeItem("quickBuyChat_customerInfo"),localStorage.removeItem("quickBuyChat_customerInfo_timestamp")}}return{name:"",phone:"",email:""}},[g,p]),[C,S]=(0,s.useState)(k);(0,s.useEffect)(()=>{S(k())},[g,p,k]);let I="chat",[T,R]=(0,s.useState)([]),[$,E]=(0,s.useState)(!1),[A,O]=(0,s.useState)(!1),[L,P]=(0,s.useState)(localStorage.getItem("quickBuyChat_chatId")),[B,D]=(0,s.useState)(!1),[M,W]=(0,s.useState)(!1),[U,_]=(0,s.useState)(null),q=(0,s.useRef)(null),z=(0,s.useRef)(null),K=(0,s.useRef)(null);(0,s.useRef)({});let Q=(0,s.useRef)(null);(0,s.useRef)(new Set),(0,s.useRef)(new Map),(0,s.useRef)(new Map);let Y=(0,s.useRef)(!1),Z=(0,s.useRef)(null),ee=(0,s.useRef)(null),et=(0,s.useRef)(null),es=(0,s.useRef)(null),ea=(0,s.useRef)(!1),er=(0,s.useRef)(null),[el,em]=(0,s.useState)(!1),eu=(0,s.useCallback)(()=>{if(!et.current)return void em(!1);let e=et.current;em(e.scrollHeight-e.scrollTop-e.clientHeight>150)},[I]),eh=(0,s.useCallback)((e=!1)=>{ee.current&&(ee.current.scrollIntoView({behavior:e?"auto":"smooth",block:"end"}),setTimeout(()=>{em(!1)},300))},[]);(0,s.useEffect)(()=>{let e=et.current;if(!e)return void em(!1);let t=()=>{eu()};return e.addEventListener("scroll",t,{passive:!0}),eu(),setTimeout(()=>{eu()},100),()=>{e.removeEventListener("scroll",t)}},[I,eu,x.length]),(0,s.useEffect)(()=>{if(x.length>0&&!ea.current){ea.current=!0;let e=setTimeout(()=>{eh(!0),setTimeout(()=>{eu()},500)},200);return()=>clearTimeout(e)}},[I,eh,eu]),(0,s.useEffect)(()=>{},[I]),(0,s.useEffect)(()=>{if(x.length>0){let e=x[x.length-1];if(e.id===er.current&&"user"===e.sender){let e=setTimeout(()=>{eh(!1),setTimeout(()=>{eu()},500)},150);return()=>clearTimeout(e)}{let e=setTimeout(()=>{eu()},200);return()=>clearTimeout(e)}}},[x,I,eh,eu]),(0,s.useEffect)(()=>{C.name&&C.phone&&(localStorage.setItem("quickBuyChat_customerInfo",JSON.stringify(C)),localStorage.setItem("quickBuyChat_customerInfo_timestamp",Date.now().toString()))},[C]),(0,s.useEffect)(()=>{L&&localStorage.setItem("quickBuyChat_chatId",L)},[L]),(0,s.useEffect)(()=>{if(e){let e=k(),t=localStorage.getItem("quickBuyChat_chatId");e.name&&e.phone?(S(e),ep(e,t)):window.location.href="/auth"}else b(""),R([]),E(!1),_(null),K.current&&(clearInterval(K.current),K.current=null),D(!1)},[e]);let ep=async(e,t)=>{try{let s="/api/chat?";if(t)s+=`chatId=${t}`;else{try{let e=await fetch("/api/chat/my",{credentials:"include"}),a=await e.json().catch(()=>null);e.ok&&a?.success&&a?.data?.chatId&&(t=String(a.data.chatId),s=`/api/chat?chatId=${t}`)}catch{}s+=`customerPhone=${encodeURIComponent(e.phone)}`,e.name&&(s+=`&customerName=${encodeURIComponent(e.name)}`)}let a=await fetch(s,{credentials:"include"});if(!a.ok)throw Error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ú†Øª");let r=await a.json();if(r.success&&r.data){let{chat:t,messages:s}=r.data;if(t&&s&&s.length>0){P(t.id),localStorage.setItem("quickBuyChat_chatId",t.id);let e=s.map(e=>{let t=[];if(e.attachments){if(Array.isArray(e.attachments))t=e.attachments.map(e=>{let t=e.url||e.fileUrl||e.filePath,s=e.type;return!s&&t&&(t.includes("/image-")||t.includes("image-")?s="image":(t.includes("/audio-")||t.includes("audio-"))&&(s="audio")),{id:e.id||`att-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:s||e.type||"file",url:t,name:e.name||e.fileName,size:e.size||e.fileSize,duration:e.duration}});else if("string"==typeof e.attachments)try{let s=JSON.parse(e.attachments);Array.isArray(s)&&(t=s.map(e=>{let t=e.url||e.fileUrl||e.filePath,s=e.type;return!s&&t&&(t.includes("/image-")||t.includes("image-")?s="image":(t.includes("/audio-")||t.includes("audio-"))&&(s="audio")),{id:e.id||`att-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:s||e.type||"file",url:t,name:e.name||e.fileName,size:e.size||e.fileSize,duration:e.duration}}))}catch(e){G.logger.error("Error parsing attachments JSON:",e)}}let s=t.filter(e=>{let t=e.url;return t&&!t.startsWith("blob:")&&!t.startsWith("data:")&&(t.startsWith("http")||t.startsWith("/"))});return t.length>0&&G.logger.debug(`Loaded message ${e.id} has ${s.length} valid attachment(s) out of ${t.length} total:`,s.map(e=>({id:e.id,type:e.type,url:e.url,name:e.name,hasUrl:!!e.url}))),{id:e.id,text:e.text||"",sender:e.sender,timestamp:new Date(e.createdAt),attachments:s.length>0?s:void 0,status:"user"===e.sender?e.status||"sent":void 0}}),a=e.map(e=>"user"!==e.sender||e.status?e:{...e,status:"sent"});if(f(a),e.length>0){let t=e[e.length-1].id;Q.current=t,localStorage.setItem("quickBuyChat_lastMessageId",t),a.some(e=>"support"===e.sender&&"1"!==e.id)?Y.current=!0:Y.current=!1}else Y.current=!1}else f([{id:"1",text:`Ø³Ù„Ø§Ù… ${e.name}! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø°Ú©Ø± Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù¾Ø±Ø³ÛŒØ¯.`,sender:"support",timestamp:new Date}]),Y.current=!1}else f([{id:"1",text:`Ø³Ù„Ø§Ù… ${e.name}! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø°Ú©Ø± Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù¾Ø±Ø³ÛŒØ¯.`,sender:"support",timestamp:new Date}]),Y.current=!1}catch(t){G.logger.error("Error loading chat history:",t),f([{id:"1",text:`Ø³Ù„Ø§Ù… ${e.name}! Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ù…Ø­ØµÙˆÙ„ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø°Ú©Ø± Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø³ÙˆØ§Ù„ Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù¾Ø±Ø³ÛŒØ¯.`,sender:"support",timestamp:new Date}]),Y.current=!1}},eg=async()=>{if(L)try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:L,sender:"user",action:"delivered"})})}catch(e){G.logger.error("Error marking messages as delivered:",e)}},ex=async()=>{if(L)try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:L,sender:"user",action:"read"})})}catch(e){G.logger.error("Error marking messages as read:",e)}},ef=async()=>{if(L&&e&&1)try{D(!0);let e=Q.current,t=`/api/chat?chatId=${L}`;e&&"1"!==e&&(t+=`&lastMessageId=${e}`);let s=await fetch(t,{credentials:"include"});if(!s.ok)throw Error("Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯");let a=await s.json();if(a.success&&a.data?.messages&&Array.isArray(a.data.messages)){let e=a.data.messages;e.length>0&&(eg(),setTimeout(()=>{ex()},1e3));let t=e.map(e=>{let t=[];e.attachments&&Array.isArray(e.attachments)&&(t=e.attachments.map(e=>{let t=e.url||e.fileUrl||e.filePath,s=e.type;return!s&&t&&(t.includes("/image-")||t.includes("image-")?s="image":(t.includes("/audio-")||t.includes("audio-"))&&(s="audio")),{id:e.id||`att-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:s||e.type||"file",url:t,name:e.name||e.fileName,size:e.size||e.fileSize,duration:e.duration}}));let s=t.filter(e=>{let t=e.url;return t&&!t.startsWith("blob:")&&!t.startsWith("data:")&&(t.startsWith("http")||t.startsWith("/"))});return{id:e.id,text:e.text||"",sender:e.sender,timestamp:new Date(e.createdAt),attachments:s.length>0?s:void 0,status:"user"===e.sender?e.status||"sent":void 0}});f(e=>{let s=new Set(e.map(e=>e.id)),a=t.filter(e=>!s.has(e.id)),r=e.filter(e=>!e.id.startsWith("system-")).map(e=>{let s=t.find(t=>t.id===e.id);return s&&"user"===e.sender&&s.status&&e.status!==s.status?{...e,status:s.status}:e});if(a.length>0){let e=a.some(e=>"support"===e.sender),t=r;e&&Z.current&&(t=r.filter(e=>e.id!==Z.current),Z.current=null,Y.current=!0);let s=[...t,...a],i=s[s.length-1];return i&&(Q.current=i.id,localStorage.setItem("quickBuyChat_lastMessageId",i.id)),s}return r})}}catch(e){G.logger.error("Error polling for new messages:",e)}finally{D(!1)}},ej=async()=>{if(L)try{let e=await fetch(`/api/chat/typing?chatId=${L}&sender=support`,{credentials:"include"});if(e.ok){let t=await e.json();t.success&&W(t.data.isTyping||!1)}}catch(e){G.logger.error("Error checking typing status:",e)}},eb=async e=>{if(L)try{await fetch("/api/chat/typing",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:L,sender:"user",isTyping:e})})}catch(e){G.logger.error("Error sending typing status:",e)}};(0,s.useEffect)(()=>{d()},[]),(0,s.useEffect)(()=>{let t=t=>{let{chatId:s,isAdmin:a}=t.detail;(!1===a||void 0===a)&&(e||r(!0),s&&1&&localStorage.getItem("quickBuyChat_chatId")!==s&&(localStorage.setItem("quickBuyChat_chatId",s),setTimeout(()=>{e&&ef()},500)))};return window.addEventListener("openChat",t),()=>{window.removeEventListener("openChat",t)}},[e,r,L,I,ef]),(0,s.useEffect)(()=>{if(e&&L){eg();let e=setTimeout(()=>{ex()},2e3);return ej(),z.current=setInterval(()=>{ej()},3e3),K.current=setInterval(()=>{ef(),eg()},5e3),ef(),h(),()=>{K.current&&(clearInterval(K.current),K.current=null),z.current&&(clearInterval(z.current),z.current=null),q.current&&(clearTimeout(q.current),q.current=null),clearTimeout(e),eb(!1)}}},[e,I,L,h]);let ey=async e=>{try{if((await fetch(`/api/chat/message/${e}`,{method:"DELETE",credentials:"include"})).ok)f(t=>t.filter(t=>t.id!==e)),l({title:"Ù…ÙˆÙÙ‚",description:"Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯"});else throw Error("Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù¾ÛŒØ§Ù…")}catch(e){G.logger.error("Error deleting message:",e),l({title:"Ø®Ø·Ø§",description:"Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù¾ÛŒØ§Ù…",variant:"destructive"})}},ev=async()=>{if(!g||!p){l({title:"Ø®Ø·Ø§",description:"Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù… Ø¨Ø§ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´ÙˆÛŒØ¯",variant:"destructive"}),r(!1),n.push("/auth?redirect="+encodeURIComponent(window.location.pathname));return}let t=es.current?.value??j;if(!t.trim()&&0===T.length)return;if(N){try{(await fetch(`/api/chat/message/${N.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({text:t,attachments:T})})).ok&&(f(e=>e.map(e=>e.id===N.id?{...e,text:t,attachments:T}:e)),w(null),b(""),R([]),l({title:"Ù…ÙˆÙÙ‚",description:"Ù¾ÛŒØ§Ù… ÙˆÛŒØ±Ø§ÛŒØ´ Ø´Ø¯"}))}catch(e){G.logger.error("Error editing message:",e),l({title:"Ø®Ø·Ø§",description:"Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…",variant:"destructive"})}return}let s=T.filter(e=>{let t=e.url;return t&&!t.startsWith("blob:")&&!t.startsWith("data:")&&(t.startsWith("http")||t.startsWith("/"))});if(!t.trim()&&0===s.length)return void l({title:"Ø®Ø·Ø§",description:"Ù„Ø·ÙØ§Ù‹ ÛŒÚ© Ù¾ÛŒØ§Ù… ÛŒØ§ ÙØ§ÛŒÙ„ Ù…Ø¹ØªØ¨Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯",variant:"destructive"});let a=t;y&&(a=`Ø¯Ø± Ù¾Ø§Ø³Ø® Ø¨Ù‡: ${y.text}

${t}`);let i={id:`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,text:a,sender:"user",timestamp:new Date,attachments:s.length>0?s:void 0,status:"sending"};f(e=>{let t=[...e,i];return Q.current=i.id,er.current=i.id,localStorage.setItem("quickBuyChat_lastMessageId",i.id),t}),setTimeout(()=>{eh(!1)},150);let o=[...T];b(""),R([]),E(!1),v(null);try{O(!0);let t={id:i.id,text:i.text,sender:i.sender,timestamp:i.timestamp.toISOString(),status:"sent",attachments:(o||[]).filter(e=>{let t=e.url;return t&&!t.startsWith("blob:")&&!t.startsWith("data:")&&(t.startsWith("http")||t.startsWith("/"))})};i.attachments&&i.attachments.length>0&&G.logger.debug(`ğŸ“¤ Sending new message with ${i.attachments.length} attachment(s):`,i.attachments.map(e=>({id:e.id,type:e.type,url:e.url,name:e.name})));let s=g&&p?{name:p.name||C.name||"",phone:p.phone||C.phone||"",email:C.email||""}:C;if(!s.name||!s.phone){l({title:"Ø®Ø·Ø§",description:"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ Ú©Ø§Ù…Ù„ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯",variant:"destructive"}),r(!1),n.push("/auth?redirect="+encodeURIComponent(window.location.pathname));return}let a=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:L||void 0,customerInfo:s,messages:[t]})});if(!a.ok){let e=await a.json().catch(()=>({})),s=e.error||e.message||`Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù… (Ú©Ø¯: ${a.status})`;if(401===a.status){let{checkAuth:e}=ec.useAuthStore.getState();await e();let{isAuthenticated:s,user:a}=ec.useAuthStore.getState();if(s&&a){let e={name:a.name||C.name||"",phone:a.phone||C.phone||"",email:C.email||""},s=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:L||void 0,customerInfo:e,messages:[t]})});if(s.ok){let e=await s.json();e.data?.chatId&&(P(e.data.chatId),localStorage.setItem("quickBuyChat_chatId",e.data.chatId));let t=e.data?.messages?.find(e=>e.id===i.id),a=t?.status||"sent";f(e=>e.map(e=>e.id===i.id?{...e,status:a}:e));return}}l({title:"Ø®Ø·Ø§",description:"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´ÙˆÛŒØ¯",variant:"destructive"}),r(!1),n.push("/auth?redirect="+encodeURIComponent(window.location.pathname));return}throw G.logger.error("âŒ Message send failed:",{status:a.status,error:s,errorData:e}),Error(s)}let d=await a.json();d.data?.chatId&&(P(d.data.chatId),localStorage.setItem("quickBuyChat_chatId",d.data.chatId));let m=d.data?.messages?.find(e=>e.id===i.id),u=m?.status||"sent";f(e=>e.map(e=>e.id===i.id?{...e,status:u}:e));try{let t=await fetch("/api/admin/presence");if(t.ok){let s=await t.json();s.success&&s.data?.admins&&(Array.isArray(s.data.admins)&&s.data.admins.length>0||c("Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ","Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø¢Ù†Ù„Ø§ÛŒÙ† Ù†ÛŒØ³Øª. Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯Ù‡ Ùˆ Ø¯Ø± Ø§Ø³Ø±Ø¹ ÙˆÙ‚Øª Ù¾Ø§Ø³Ø® Ø¯Ø§Ø¯Ù‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.",{onOpen:()=>{e||r(!0)},chatId:L||void 0,metadata:{isAdminOffline:!0,isAdmin:!1}}))}}catch(e){G.logger.error("Error checking admin status:",e)}}catch(e){G.logger.error("âŒ Error saving message:",{error:e.message,errorStack:e.stack,messageId:i.id,chatId:L||void 0,messageText:i.text?.substring(0,50)+"..."}),f(e=>e.map(e=>e.id===i.id?{...e,status:"failed"}:e)),b(a),R(o),l({title:"Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…",description:e.message||"Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡ Ù¾ÛŒØ§Ù…. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.",variant:"destructive",duration:5e3})}finally{O(!1)}Y.current||setTimeout(async()=>{let e=`system-${Date.now()}`;Z.current=e,Y.current=!0;let t={id:e,text:"Ù…ØªØ´Ú©Ø±Ù…! Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯. Ù‡Ù…Ú©Ø§Ø±Ø§Ù† Ù…Ø§ Ø¯Ø± Ø§Ø³Ø±Ø¹ ÙˆÙ‚Øª Ø¨Ø§ Ø´Ù…Ø§ ØªÙ…Ø§Ø³ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ú¯Ø±ÙØª.",sender:"support",timestamp:new Date};f(e=>[...e,t])},1e3)},eN=async(e,t,s=0)=>{try{let s=new FormData;s.append("file",e),s.append("type",t);let a=await fetch("/api/chat/upload",{method:"POST",body:s,credentials:"include"});if(!a.ok){let e=await a.json().catch(()=>({error:"Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„"}));throw Error(e.error||"Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„")}return(await a.json()).data.url}catch(a){if(G.logger.error("Error uploading file:",a),s<3&&(a.message?.includes("fetch")||a.message?.includes("network")||a.message?.includes("timeout")||"NETWORK_ERROR"===a.code||"TypeError"===a.name)){let a=2e3*Math.pow(2,s);return G.logger.debug(`Retrying file upload in ${a}ms (attempt ${s+1}/3)`),0===s&&l({title:"Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯...",description:"Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„. Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯...",duration:2e3}),await new Promise(e=>setTimeout(e,a)),eN(e,t,s+1)}throw l({title:"Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„",description:a.message||"Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯",variant:"destructive"}),a}},ew=function(e,t,a){let{toast:r}=(0,F.useToast)(),[i,n]=(0,s.useState)(!1),[l,o]=(0,s.useState)(0),[d,c]=(0,s.useState)(null),[m,u]=(0,s.useState)(null),[h,p]=(0,s.useState)(null),[g,x]=(0,s.useState)(!1),f=(0,s.useRef)(null),j=(0,s.useRef)([]),b=(0,s.useRef)(null),y=async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void r({title:"Ø®Ø·Ø§",description:"Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ø¶Ø¨Ø· ØµØ¯Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯",variant:"destructive"});let e=await navigator.mediaDevices.getUserMedia({audio:!0});p(!0),x(!1);let t=new MediaRecorder(e);f.current=t,j.current=[],t.ondataavailable=e=>{e.data.size>0&&j.current.push(e.data)},t.onstop=()=>{let s=new Blob(j.current,{type:t.mimeType||"audio/webm"});c(s);let a=URL.createObjectURL(s);u(a),e.getTracks().forEach(e=>e.stop())},t.onerror=e=>{G.logger.error("MediaRecorder error:",e),r({title:"Ø®Ø·Ø§ Ø¯Ø± Ø¶Ø¨Ø· ØµØ¯Ø§",description:"Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø¶Ø¨Ø· ØµØ¯Ø§ Ø±Ø® Ø¯Ø§Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.",variant:"destructive"}),v()},t.start(),n(!0),o(0),b.current=setInterval(()=>{o(e=>e+1)},1e3),r({title:"Ø¶Ø¨Ø· ØµØ¯Ø§ Ø´Ø±ÙˆØ¹ Ø´Ø¯",description:"Ø¯Ø± Ø­Ø§Ù„ Ø¶Ø¨Ø· Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ..."})}catch(s){G.logger.error("Error starting recording:",s),p(!1);let e="Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª.",t="";"NotAllowedError"===s.name||"PermissionDeniedError"===s.name?(e="Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø¯ Ø´Ø¯",t="Ù„Ø·ÙØ§Ù‹ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±ÙˆØ±Ú¯Ø± Ø®ÙˆØ¯ØŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯."):"NotFoundError"===s.name||"DevicesNotFoundError"===s.name?(e="Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† ÛŒØ§ÙØª Ù†Ø´Ø¯",t="Ù„Ø·ÙØ§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ú©Ù‡ Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¨Ù‡ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø´Ù…Ø§ Ù…ØªØµÙ„ Ø§Ø³Øª."):"NotReadableError"===s.name||"TrackStartError"===s.name?(e="Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª",t="Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† ØªÙˆØ³Ø· Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ø¢Ù† Ø±Ø§ Ø¨Ø¨Ù†Ø¯ÛŒØ¯."):"OverconstrainedError"===s.name||"ConstraintNotSatisfiedError"===s.name?(e="ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯",t="Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ù…ÛŒÚ©Ø±ÙˆÙÙˆÙ† Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯."):t="Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ ÛŒØ§ ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯.",r({title:e,description:t,variant:"destructive",duration:5e3}),("NotAllowedError"===s.name||"PermissionDeniedError"===s.name)&&x(!0)}},v=()=>{if(f.current&&"inactive"!==f.current.state)try{f.current.stop(),n(!1),b.current&&clearInterval(b.current),r({title:"Ø¶Ø¨Ø· ØµØ¯Ø§ Ù…ØªÙˆÙ‚Ù Ø´Ø¯",description:"Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ Ø´Ù…Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¢Ù† Ø±Ø§ Ø°Ø®ÛŒØ±Ù‡ ÛŒØ§ Ù„ØºÙˆ Ú©Ù†ÛŒØ¯."})}catch(e){G.logger.error("Error stopping recording:",e),r({title:"Ø®Ø·Ø§",description:"Ø®Ø·Ø§ÛŒÛŒ Ø¯Ø± ØªÙˆÙ‚Ù Ø¶Ø¨Ø· Ø±Ø® Ø¯Ø§Ø¯.",variant:"destructive"})}},N=async()=>{if(G.logger.info("saveRecording called",{hasAudioBlob:!!d,hasAudioUrl:!!m}),console.log("[Voice Widget] saveRecording called",{hasAudioBlob:!!d,hasAudioUrl:!!m,audioBlobSize:d?.size,audioUrl:m}),!d||!m){G.logger.warn("No audio blob or URL available"),console.log("[Voice Widget] No audio blob or URL available, returning"),alert("Ù‡ÛŒÚ† Ø¶Ø¨Ø· ØµÙˆØªÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª");return}try{console.log("[Voice Widget] Starting upload...");let s="webm",r=d.type||"audio/webm";r.includes("mp4")||r.includes("m4a")?s="m4a":r.includes("ogg")?s="ogg":r.includes("wav")?s="wav":r.includes("webm")&&(s="webm");let i=new File([d],`audio-${Date.now()}.${s}`,{type:r});console.log("[Voice Widget] Uploading audio file...");let n=await e(i,"audio");console.log("[Voice Widget] Upload successful, URL:",n);let h={id:"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`audio-${Date.now()}-${Math.random().toString(36).substr(2,9)}-${performance.now()}`,type:"audio",url:n,name:`Ù¾ÛŒØ§Ù… ØµÙˆØªÛŒ ${ed(l)}`,size:d.size,duration:l};console.log("[Voice Widget] Adding attachment:",h),t(e=>{let t=[...e,h];return console.log("[Voice Widget] New attachments:",t),t}),c(null),m&&URL.revokeObjectURL(m),u(null),o(0),console.log("[Voice Widget] Auto-sending message..."),setTimeout(()=>{a()},100)}catch(e){}};return{isRecording:i,recordingTime:l,audioUrl:m,showPermissionGuide:g,setShowPermissionGuide:x,checkMicrophonePermission:async()=>{try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),!0}catch(e){return!1}},startRecording:y,stopRecording:v,cancelRecording:()=>{v(),c(null),m&&(URL.revokeObjectURL(m),u(null)),o(0)},saveRecording:N}}(eN,R,ev),ek=function(e,t,a,r){let{toast:i}=(0,F.useToast)(),n=(0,s.useRef)(null),l=(0,s.useRef)(null);return{imageInputRef:n,fileInputRef:l,handleFileSelect:async(s,a)=>{let r=s.target.files;if(r&&0!==r.length){for(let s of Array.from(r))try{let r=await e(s,a),i={id:`${a}-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:a,name:s.name,size:s.size,url:r};t(e=>[...e,i])}catch(e){}s.target.value=""}},handleRemoveAttachment:e=>{t(t=>{let s=t.find(t=>t.id===e);return s?.url&&URL.revokeObjectURL(s.url),t.filter(t=>t.id!==e)})},handleLocationShare:()=>{if(G.logger.info("handleLocationShare called"),console.log("[Location Widget] handleLocationShare called"),!navigator.geolocation){G.logger.warn("Geolocation not supported"),console.log("[Location Widget] Geolocation not supported"),i({title:"Ø®Ø·Ø§",description:"Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯",variant:"destructive"});return}let e="https:"===window.location.protocol||"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname;if(console.log("[Location Widget] Protocol:",window.location.protocol,"Hostname:",window.location.hostname,"IsSecure:",e),!e){G.logger.warn("Not on secure origin"),console.log("[Location Widget] Not on secure origin"),i({title:"Ø®Ø·Ø§",description:"Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ÙˆÙ‚Ø¹ÛŒØªâ€ŒÛŒØ§Ø¨ÛŒ Ø¨Ø§ÛŒØ¯ Ø§Ø² HTTPS Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ø¢Ø¯Ø±Ø³ Ø§Ù…Ù† Ø³Ø§ÛŒØª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.",variant:"destructive"});return}i({title:"Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª...",description:"Ù„Ø·ÙØ§Ù‹ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø§ Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø¨Ø¯Ù‡ÛŒØ¯",duration:3e3}),G.logger.info("Requesting geolocation permission..."),console.log("[Location Widget] Requesting geolocation permission..."),navigator.geolocation.getCurrentPosition(e=>{G.logger.info("Location received:",e.coords),console.log("[Location Widget] Position received:",e.coords);let s={id:`location-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"location",url:`https://www.google.com/maps?q=${e.coords.latitude},${e.coords.longitude}`,name:"Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ"};console.log("[Location Widget] Adding attachment:",s),t(e=>{let t=[...e,s];return console.log("[Location Widget] New attachments:",t),t}),a(!1),console.log("[Location Widget] Auto-sending message..."),setTimeout(()=>{r()},100)},e=>{G.logger.error("Error getting location:",e);let t="Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ù…Ú©Ø§Ù†ÛŒ";1===e.code?t="Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø±ÙˆØ±Ú¯Ø± Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø±Ø§ ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯.":2===e.code?t="Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ Ú©Ù‡ GPS ÙØ¹Ø§Ù„ Ø§Ø³Øª.":3===e.code&&(t="Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª Ø²Ù…Ø§Ù†â€ŒØ¨Ø± Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯."),i({title:"Ø®Ø·Ø§",description:t,variant:"destructive"})},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})}}}(eN,R,E,ev),{isRecording:eC,recordingTime:eS,audioUrl:eI,showPermissionGuide:eT,setShowPermissionGuide:eR,checkMicrophonePermission:e$,startRecording:eE,stopRecording:eA,cancelRecording:eO,saveRecording:eL}=ew,{imageInputRef:eP,fileInputRef:eB,handleFileSelect:eD,handleRemoveAttachment:eM,handleLocationShare:eW}=ek;return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{"data-chat-open":e&&1?"true":"false",style:{display:"none"}}),(0,t.jsxs)(H.Sheet,{open:e,onOpenChange:r,children:[i&&(0,t.jsx)(H.SheetTrigger,{asChild:!0,children:i}),(0,t.jsxs)(H.SheetContent,{side:"left",className:"w-full sm:w-[420px] md:w-[480px] p-0 flex flex-col border-l-2 border-border/40 bg-background shadow-2xl",children:[(0,t.jsx)(eo,{step:I,isOnline:m,lastSeen:u,customerInfo:C,onEditInfo:()=>{window.location.href="/auth"}}),(0,t.jsx)(ei,{messages:x,messagesContainerRef:et,messagesEndRef:ee,isSupportTyping:M,onReply:e=>{v(e),w(null)},onEdit:e=>{w(e),v(null),b(e.text||"")},onDelete:ey}),(0,t.jsx)(en.ChatInput,{message:j,setMessage:b,attachments:T,setAttachments:R,showAttachmentOptions:$,setShowAttachmentOptions:E,isRecording:eC,recordingTime:eS,audioUrl:eI,isSaving:A,showScrollToBottom:el,showPermissionGuide:eT,setShowPermissionGuide:eR,textareaRef:es,imageInputRef:eP,fileInputRef:eB,typingTimeoutRef:q,handleSendMessage:ev,handleFileSelect:eD,handleRemoveAttachment:eM,handleLocationShare:eW,startRecording:eE,stopRecording:eA,saveRecording:eL,cancelRecording:eO,sendTypingStatus:eb,scrollToBottom:eh,formatTime:ed,toast:l})]})]})]})}let eu={pending:{label:"Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±",color:"bg-yellow-100 text-yellow-800",icon:j.Clock},processing:{label:"Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´",color:"bg-blue-100 text-blue-800",icon:m.Package},shipped:{label:"Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡",color:"bg-purple-100 text-purple-800",icon:x.Truck},delivered:{label:"ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡",color:"bg-green-100 text-green-800",icon:f.CheckCircle2},cancelled:{label:"Ù„ØºÙˆ Ø´Ø¯Ù‡",color:"bg-red-100 text-red-800",icon:b.XCircle}},eh={pending:{label:"Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª",color:"bg-yellow-100 text-yellow-800"},paid:{label:"Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡",color:"bg-green-100 text-green-800"},failed:{label:"Ù¾Ø±Ø¯Ø§Ø®Øª Ù†Ø§Ù…ÙˆÙÙ‚",color:"bg-red-100 text-red-800"},refunded:{label:"Ø¨Ø§Ø²Ú¯Ø´Øª ÙˆØ¬Ù‡",color:"bg-gray-100 text-gray-800"}};function ep(){let e,I,T,R,$,E,A,O,L,P,B=(0,a.useSearchParams)().get("orderNumber")||"",[D,M]=(0,s.useState)(B),[W,U]=(0,s.useState)(null),[_,q]=(0,s.useState)(!1),[H,F]=(0,s.useState)(!1),[J,V]=(0,s.useState)(!1),{orders:X,updateOrder:G}=(0,o.useOrderStore)(),{getProduct:K,loadProductsFromDB:Q}=(0,d.useProductStore)(),Y=()=>{(q(!1),U(null),F(!0),D.trim())?Z(D):F(!1)},Z=async e=>{try{let t=X.find(t=>t.orderNumber.toLowerCase()===e.toLowerCase().trim()||t.id===e.trim());if(t){U(t),q(!1);return}console.log("[Track Order] Fetching order from API:",e);let s=await fetch(`/api/orders?orderNumber=${encodeURIComponent(e)}`,{credentials:"include"});if(console.log("[Track Order] API response status:",s.status),s.ok){let e=await s.json();if(console.log("[Track Order] API result:",{success:e.success,dataLength:e.data?.length||0,hasData:!!e.data}),e.success&&e.data&&e.data.length>0){let t=e.data[0];console.log("[Track Order] Order found:",t.orderNumber),U(t),q(!1),G(t.id,t)}else console.log("[Track Order] Order not found in API response"),q(!0)}else{let e=await s.text().catch(()=>"Unknown error");console.error("[Track Order] API error:",s.status,e),q(!0)}}catch(e){console.error("Error fetching order:",e),q(!0)}};return(0,s.useEffect)(()=>{Q(!0).catch(e=>{console.error("Error loading products for order tracking:",e)})},[Q]),(0,s.useEffect)(()=>{B&&B.trim()&&(F(!0),Z(B))},[B]),(0,s.useEffect)(()=>{if(!W?.id)return;let e=setInterval(async()=>{try{let e=await fetch(`/api/orders/${W.id}`);if(e.ok){let t=await e.json();t.success&&t.data&&(U(t.data),G(t.data.id,t.data))}}catch(e){console.error("Error polling order status:",e)}},1e4);return()=>clearInterval(e)},[W?.id,G]),W&&eu[W.status]?.icon||j.Clock,(0,t.jsxs)("div",{className:"container mx-auto px-4 py-6 sm:py-8 md:py-12",children:[(0,t.jsxs)("div",{className:"max-w-4xl mx-auto",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-6 sm:mb-8",children:[(0,t.jsx)("h1",{className:"text-2xl sm:text-3xl font-bold",children:"Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´"}),(0,t.jsxs)(i.Button,{onClick:()=>V(!0),variant:"outline",size:"sm",className:"flex items-center gap-2",children:[(0,t.jsx)(w.MessageCircle,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"Ú†Øª Ø¨Ø§ Ø§Ø¯Ù…ÛŒÙ†"}),(0,t.jsx)("span",{className:"sm:hidden",children:"Ú†Øª"})]})]}),(0,t.jsxs)(r.Card,{className:"mb-4 sm:mb-6",children:[(0,t.jsx)(r.CardHeader,{className:"pb-3 sm:pb-6",children:(0,t.jsx)(r.CardTitle,{className:"text-base sm:text-lg",children:"Ø¬Ø³ØªØ¬ÙˆÛŒ Ø³ÙØ§Ø±Ø´"})}),(0,t.jsx)(r.CardContent,{className:"pt-0 sm:pt-6",children:(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row gap-2 sm:gap-3",children:[(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)(l.Label,{htmlFor:"orderNumber",className:"text-sm sm:text-base",children:"Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´"}),(0,t.jsx)(n.Input,{id:"orderNumber",placeholder:"ORD-1234567890-001",value:D,onChange:e=>M(e.target.value),onKeyDown:e=>{"Enter"===e.key&&Y()},className:"mt-1 text-sm sm:text-base"})]}),(0,t.jsx)("div",{className:"flex items-end",children:(0,t.jsxs)(i.Button,{onClick:Y,size:"lg",className:"w-full sm:w-auto",children:[(0,t.jsx)(c.Search,{className:"ml-2 h-4 w-4"}),"Ø¬Ø³ØªØ¬Ùˆ"]})})]})})]}),_&&H&&(0,t.jsx)(r.Card,{children:(0,t.jsx)(r.CardContent,{className:"pt-6",children:(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center py-12",children:[(0,t.jsx)(b.XCircle,{className:"h-16 w-16 text-muted-foreground mb-4"}),(0,t.jsx)("h2",{className:"text-xl font-bold mb-2",children:"Ø³ÙØ§Ø±Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯"}),(0,t.jsx)("p",{className:"text-muted-foreground text-center mb-6",children:"Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯."})]})})}),W&&(0,t.jsxs)("div",{className:"space-y-4 sm:space-y-6",children:["cancelled"===W.status&&(0,t.jsx)(r.Card,{className:"border-2 border-red-500 bg-red-50 dark:bg-red-950/30",children:(0,t.jsxs)(r.CardContent,{className:"pt-4 sm:pt-6",children:[(0,t.jsxs)("div",{className:"flex sm:hidden items-center gap-2",children:[(0,t.jsx)(b.XCircle,{className:"h-5 w-5 text-red-700 dark:text-red-400 flex-shrink-0"}),(0,t.jsx)(S.Badge,{variant:"destructive",className:"bg-red-600 text-white text-xs",children:eu.cancelled.label}),(0,t.jsx)("span",{className:"text-sm font-semibold text-red-900 dark:text-red-50 flex-1",children:"Ø³ÙØ§Ø±Ø´ Ù„ØºÙˆ Ø´Ø¯Ù‡"})]}),(0,t.jsxs)("div",{className:"hidden sm:flex items-center gap-3",children:[(0,t.jsx)(b.XCircle,{className:"h-6 w-6 text-red-700 dark:text-red-400 flex-shrink-0"}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("h3",{className:"font-semibold text-lg text-red-900 dark:text-red-50 mb-1",children:"Ø³ÙØ§Ø±Ø´ Ù„ØºÙˆ Ø´Ø¯Ù‡ Ø§Ø³Øª"}),(0,t.jsxs)("p",{className:"text-sm text-red-800 dark:text-red-100",children:["Ø§ÛŒÙ† Ø³ÙØ§Ø±Ø´ ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ±ÛŒØª Ù„ØºÙˆ Ø´Ø¯Ù‡ Ø§Ø³Øª.",W.updatedAt&&(0,t.jsxs)("span",{className:"block mt-1 text-red-900 dark:text-red-50",children:["ØªØ§Ø±ÛŒØ® Ù„ØºÙˆ: ",new Date(W.updatedAt).toLocaleDateString("fa-IR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]}),(0,t.jsx)(S.Badge,{variant:"destructive",className:"bg-red-600 text-white",children:eu.cancelled.label})]})]})}),(0,t.jsxs)(r.Card,{className:"border-2",children:[(0,t.jsx)(r.CardHeader,{className:"bg-gradient-to-r from-primary/5 to-transparent border-b",children:(0,t.jsxs)(r.CardTitle,{className:"flex items-center gap-2 text-base sm:text-lg",children:[(0,t.jsx)(m.Package,{className:"h-4 w-4 sm:h-5 sm:w-5 text-primary"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"Ù¾ÛŒÚ¯ÛŒØ±ÛŒ Ø³ÙØ§Ø±Ø´"}),(0,t.jsx)("span",{className:"sm:hidden",children:"ÙˆØ¶Ø¹ÛŒØª Ø³ÙØ§Ø±Ø´"})]})}),(0,t.jsxs)(r.CardContent,{className:"pt-4 sm:pt-6",children:[(0,t.jsxs)("div",{className:"sm:hidden space-y-3",children:[[{status:"pending",label:"Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±",icon:y.ShoppingCart},{status:"processing",label:"Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´",icon:v.Box},{status:"shipped",label:"Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡",icon:x.Truck},{status:"delivered",label:"ØªØ­ÙˆÛŒÙ„ Ø´Ø¯Ù‡",icon:f.CheckCircle2}].map(e=>{let s=["pending","processing","shipped","delivered"],a=s.indexOf(W.status),r=s.indexOf(e.status),i=a>=r&&"cancelled"!==W.status,n=a===r&&"cancelled"!==W.status,l=e.icon;return(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)("div",{className:`w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${i?"bg-primary text-primary-foreground":n?"bg-primary/20 text-primary border border-primary":"bg-muted text-muted-foreground"}`,children:i?(0,t.jsx)(N.CheckCircle,{className:"h-4 w-4"}):(0,t.jsx)(l,{className:"h-4 w-4"})}),(0,t.jsx)("span",{className:`text-sm flex-1 ${i||n?"font-semibold":"text-muted-foreground"}`,children:e.label}),n&&(0,t.jsx)(S.Badge,{variant:"default",className:"text-xs animate-pulse",children:"ÙØ¹Ù„ÛŒ"})]},e.status)}),(0,t.jsxs)("div",{className:"mt-4 pt-4 border-t",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-1.5",children:[(0,t.jsx)("span",{className:"text-xs text-muted-foreground",children:"Ù¾ÛŒØ´Ø±ÙØª"}),(0,t.jsx)("span",{className:"text-xs font-medium",children:-1===(I=(e=["pending","processing","shipped","delivered"]).indexOf(W.status))?"0%":`${Math.round((I+1)/e.length*100)}%`})]}),(0,t.jsx)(z,{value:-1===(R=(T=["pending","processing","shipped","delivered"]).indexOf(W.status))?0:(R+1)/T.length*100,className:"h-2"})]})]}),(0,t.jsxs)("div",{className:"hidden sm:block",children:[(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)("div",{className:"absolute right-8 top-0 bottom-0 w-0.5 bg-border",children:(0,t.jsx)("div",{className:"absolute top-0 right-0 w-full bg-primary transition-all duration-500 ease-in-out",style:{height:`${-1===(E=($=["pending","processing","shipped","delivered"]).indexOf(W.status))?0:(E+1)/$.length*100}%`}})}),(0,t.jsx)("div",{className:"space-y-8 relative z-10",children:[{status:"pending",label:"Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±",icon:y.ShoppingCart,description:"Ø³ÙØ§Ø±Ø´ Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯"},{status:"processing",label:"Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´",icon:v.Box,description:"Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ"},{status:"shipped",label:"Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡",icon:x.Truck,description:"Ø¯Ø± Ù…Ø³ÛŒØ± ØªØ­ÙˆÛŒÙ„"},{status:"delivered",label:"ØªØ­ÙˆÛŒÙ„ Ø´Ø¯Ù‡",icon:f.CheckCircle2,description:"ØªØ­ÙˆÛŒÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯"}].map((e,s)=>{let a=["pending","processing","shipped","delivered"],r=a.indexOf(W.status),i=a.indexOf(e.status),n=r>=i&&"cancelled"!==W.status,l=r===i&&"cancelled"!==W.status,o=e.icon;return(0,t.jsxs)("div",{className:"flex items-start gap-4",children:[(0,t.jsx)("div",{className:"relative z-10",children:(0,t.jsx)("div",{className:`w-16 h-16 rounded-full flex items-center justify-center transition-all duration-300 ${n?"bg-primary text-primary-foreground shadow-lg shadow-primary/50":l?"bg-primary/20 text-primary border-2 border-primary":"bg-muted text-muted-foreground"}`,children:n?(0,t.jsx)(N.CheckCircle,{className:"h-8 w-8"}):(0,t.jsx)(o,{className:"h-8 w-8"})})}),(0,t.jsxs)("div",{className:"flex-1 pt-2",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,t.jsx)("h3",{className:`font-semibold text-lg ${n||l?"text-foreground":"text-muted-foreground"}`,children:e.label}),l&&(0,t.jsx)(S.Badge,{variant:"default",className:"animate-pulse",children:"Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…"}),n&&!l&&(0,t.jsxs)(S.Badge,{variant:"success",className:"gap-1",children:[(0,t.jsx)(N.CheckCircle,{className:"h-3 w-3"}),"ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯"]})]}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:e.description}),l&&W.updatedAt&&(0,t.jsxs)("p",{className:"text-xs text-muted-foreground mt-2",children:["Ø¢Ø®Ø±ÛŒÙ† Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ:"," ",new Date(W.updatedAt).toLocaleDateString("fa-IR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})]})]})]},e.status)})})]}),(0,t.jsxs)("div",{className:"mt-8 pt-6 border-t",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsx)("span",{className:"text-sm font-medium",children:"Ù¾ÛŒØ´Ø±ÙØª Ú©Ù„ÛŒ"}),(0,t.jsx)("span",{className:"text-sm text-muted-foreground",children:-1===(O=(A=["pending","processing","shipped","delivered"]).indexOf(W.status))?"0%":`${Math.round((O+1)/A.length*100)}%`})]}),(0,t.jsx)(z,{value:-1===(P=(L=["pending","processing","shipped","delivered"]).indexOf(W.status))?0:(P+1)/L.length*100,className:"h-3"})]}),(0,t.jsxs)("div",{className:"mt-6 pt-6 border-t grid grid-cols-1 sm:grid-cols-2 gap-4",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"p-2 bg-muted rounded-lg",children:(0,t.jsx)(m.Package,{className:"h-5 w-5"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´"}),(0,t.jsx)("p",{className:"font-semibold font-mono",children:W.orderNumber})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"p-2 bg-muted rounded-lg",children:(0,t.jsx)(g.Calendar,{className:"h-5 w-5"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"text-sm text-muted-foreground",children:"ØªØ§Ø±ÛŒØ® Ø«Ø¨Øª"}),(0,t.jsx)("p",{className:"font-semibold",children:new Date(W.createdAt).toLocaleDateString("fa-IR",{year:"numeric",month:"long",day:"numeric"})})]})]})]})]})]})]}),(0,t.jsxs)(r.Card,{children:[(0,t.jsx)(r.CardHeader,{className:"pb-3 sm:pb-6",children:(0,t.jsx)(r.CardTitle,{className:"text-base sm:text-lg",children:"Ù…Ø­ØµÙˆÙ„Ø§Øª Ø³ÙØ§Ø±Ø´"})}),(0,t.jsx)(r.CardContent,{className:"pt-0 sm:pt-6",children:(0,t.jsx)("div",{className:"space-y-3 sm:space-y-4",children:Array.isArray(W.items)?W.items.map(e=>{let s=K(e.productId||e.id),a=e.image&&""!==e.image.trim()?e.image:"";!a&&s&&s.images&&s.images.length>0&&(a=s.images[0]);let r=a&&(e=>{if(!e||"string"!=typeof e||""===e.trim())return!1;if(e.startsWith("blob:")||e.startsWith("data:"))return!0;try{return new URL(e),!0}catch{return!1}})(a);return(0,t.jsxs)("div",{className:"flex gap-2 sm:gap-4 pb-3 sm:pb-4 border-b last:border-0",children:[(0,t.jsx)("div",{className:"relative w-16 h-16 sm:w-20 sm:h-20 bg-muted rounded-lg overflow-hidden flex-shrink-0 border",children:(0,t.jsx)(C.SafeImage,{src:r?a:null,alt:e.name||"Product image",fill:!0,className:"w-full h-full"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("h3",{className:"font-semibold mb-1 text-sm sm:text-base truncate",children:e.name}),(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row sm:justify-between gap-1 sm:gap-0",children:[(0,t.jsxs)("span",{className:"text-xs sm:text-sm text-muted-foreground",children:["ØªØ¹Ø¯Ø§Ø¯: ",e.quantity]}),(0,t.jsxs)("span",{className:"font-semibold text-sm sm:text-base text-foreground",children:[(e.price*e.quantity).toLocaleString("fa-IR")," ØªÙˆÙ…Ø§Ù†"]})]})]})]},e.id)}):(0,t.jsxs)("div",{className:"text-center py-6 sm:py-8 text-muted-foreground",children:[(0,t.jsx)(m.Package,{className:"h-10 w-10 sm:h-12 sm:w-12 mx-auto mb-3 sm:mb-4 opacity-50"}),(0,t.jsx)("p",{className:"text-sm sm:text-base",children:"Ù…Ø­ØµÙˆÙ„Ø§Øª Ø³ÙØ§Ø±Ø´ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª"})]})})})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6",children:[(0,t.jsxs)(r.Card,{children:[(0,t.jsx)(r.CardHeader,{className:"pb-3 sm:pb-6",children:(0,t.jsx)(r.CardTitle,{className:"text-base sm:text-lg",children:"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§"})}),(0,t.jsxs)(r.CardContent,{className:"space-y-2 sm:space-y-3 pt-0 sm:pt-6",children:[(0,t.jsxs)("div",{className:"flex items-start gap-2 sm:gap-3",children:[(0,t.jsx)("div",{className:"p-1.5 sm:p-2 bg-muted rounded-lg flex-shrink-0",children:(0,t.jsx)(m.Package,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4"})}),(0,t.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,t.jsx)("p",{className:"text-xs sm:text-sm text-muted-foreground",children:"Ù†Ø§Ù…"}),(0,t.jsx)("p",{className:"font-semibold text-sm sm:text-base truncate",children:W.customerName})]})]}),(0,t.jsxs)("div",{className:"flex items-start gap-2 sm:gap-3",children:[(0,t.jsx)("div",{className:"p-1.5 sm:p-2 bg-muted rounded-lg flex-shrink-0",children:(0,t.jsx)(h.Phone,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4"})}),(0,t.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,t.jsx)("p",{className:"text-xs sm:text-sm text-muted-foreground",children:"Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³"}),(0,t.jsx)("p",{className:"font-semibold text-sm sm:text-base",children:W.customerPhone})]})]}),W.customerEmail&&(0,t.jsxs)("div",{className:"flex items-start gap-2 sm:gap-3",children:[(0,t.jsx)("div",{className:"p-1.5 sm:p-2 bg-muted rounded-lg flex-shrink-0",children:(0,t.jsx)(p.Mail,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4"})}),(0,t.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,t.jsx)("p",{className:"text-xs sm:text-sm text-muted-foreground",children:"Ø§ÛŒÙ…ÛŒÙ„"}),(0,t.jsx)("p",{className:"font-semibold text-sm sm:text-base truncate",children:W.customerEmail})]})]})]})]}),(0,t.jsxs)(r.Card,{children:[(0,t.jsx)(r.CardHeader,{className:"pb-3 sm:pb-6",children:(0,t.jsx)(r.CardTitle,{className:"text-base sm:text-lg",children:"Ø¢Ø¯Ø±Ø³ Ø§Ø±Ø³Ø§Ù„"})}),(0,t.jsxs)(r.CardContent,{className:"space-y-2 sm:space-y-3 pt-0 sm:pt-6",children:[(0,t.jsxs)("div",{className:"flex items-start gap-2 sm:gap-3",children:[(0,t.jsx)("div",{className:"p-1.5 sm:p-2 bg-muted rounded-lg flex-shrink-0",children:(0,t.jsx)(u.MapPin,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4"})}),(0,t.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,t.jsx)("p",{className:"text-xs sm:text-sm text-muted-foreground",children:"Ø¢Ø¯Ø±Ø³"}),(()=>{let e=W.shippingAddress.location,s=e&&e.includes(",")&&/^-?\d+\.?\d*,-?\d+\.?\d*$/.test(e.trim());if(("location"===W.shippingAddress.addressType||s)&&e){let[s,a]=e.split(",").map(e=>e.trim()),r=`https://www.google.com/maps?q=${s},${a}`;return(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("p",{className:"font-semibold text-sm sm:text-base break-words font-mono",children:[s,", ",a]}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground",children:"Ù…Ø®ØªØµØ§Øª Ø¯Ù‚ÛŒÙ‚ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ø´Ù…Ø§"}),(0,t.jsxs)(i.Button,{type:"button",variant:"outline",size:"sm",className:"text-xs h-7",onClick:()=>window.open(r,"_blank"),children:[(0,t.jsx)(u.MapPin,{className:"h-3 w-3 ml-1"}),"Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Ù†Ù‚Ø´Ù‡",(0,t.jsx)(k.ExternalLink,{className:"h-3 w-3 mr-1"})]})]})}return"postalCode"===W.shippingAddress.addressType&&W.shippingAddress.postalCode?(0,t.jsxs)("p",{className:"font-semibold text-sm sm:text-base break-words",children:["Ú©Ø¯ Ù¾Ø³ØªÛŒ: ",W.shippingAddress.postalCode]}):(0,t.jsxs)(t.Fragment,{children:[W.shippingAddress.city&&(0,t.jsxs)("p",{className:"font-semibold text-sm sm:text-base break-words",children:[W.shippingAddress.city,W.shippingAddress.address?`ØŒ ${W.shippingAddress.address}`:""]}),W.shippingAddress.postalCode&&(0,t.jsxs)("p",{className:"text-xs sm:text-sm text-muted-foreground mt-1",children:["Ú©Ø¯ Ù¾Ø³ØªÛŒ: ",W.shippingAddress.postalCode]})]})})()]})]}),(0,t.jsxs)("div",{className:"flex items-start gap-2 sm:gap-3",children:[(0,t.jsx)("div",{className:"p-1.5 sm:p-2 bg-muted rounded-lg flex-shrink-0",children:(0,t.jsx)(x.Truck,{className:"h-3.5 w-3.5 sm:h-4 sm:w-4"})}),(0,t.jsxs)("div",{className:"min-w-0 flex-1",children:[(0,t.jsx)("p",{className:"text-xs sm:text-sm text-muted-foreground",children:"Ø±ÙˆØ´ Ø§Ø±Ø³Ø§Ù„"}),(0,t.jsx)("p",{className:"font-semibold text-sm sm:text-base",children:"air"===W.shippingMethod?"Ù‡ÙˆØ§ÛŒÛŒ":"Ø¯Ø±ÛŒØ§ÛŒÛŒ"})]})]})]})]})]}),(0,t.jsxs)(r.Card,{children:[(0,t.jsx)(r.CardHeader,{className:"pb-3 sm:pb-6",children:(0,t.jsx)(r.CardTitle,{className:"text-base sm:text-lg",children:"Ø®Ù„Ø§ØµÙ‡ Ø³ÙØ§Ø±Ø´"})}),(0,t.jsx)(r.CardContent,{className:"pt-0 sm:pt-6",children:(0,t.jsxs)("div",{className:"space-y-2.5 sm:space-y-3",children:[(0,t.jsxs)("div",{className:"flex justify-between text-sm sm:text-base",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Ø¬Ù…Ø¹ Ú©Ù„:"}),(0,t.jsxs)("span",{className:"font-semibold",children:[W.total.toLocaleString("fa-IR")," ØªÙˆÙ…Ø§Ù†"]})]}),(0,t.jsxs)("div",{className:"flex justify-between text-sm sm:text-base",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„:"}),(0,t.jsx)("span",{className:"font-semibold",children:0===W.shippingCost?(0,t.jsx)("span",{className:"text-green-600",children:"Ø±Ø§ÛŒÚ¯Ø§Ù†"}):`${W.shippingCost.toLocaleString("fa-IR")} ØªÙˆÙ…Ø§Ù†`})]}),(0,t.jsxs)("div",{className:"flex justify-between pt-2.5 sm:pt-3 border-t text-base sm:text-lg",children:[(0,t.jsx)("span",{className:"font-bold",children:"Ù…Ø¨Ù„Øº Ù†Ù‡Ø§ÛŒÛŒ:"}),(0,t.jsxs)("span",{className:"font-bold text-primary",children:[(W.total+W.shippingCost).toLocaleString("fa-IR")," ØªÙˆÙ…Ø§Ù†"]})]}),(0,t.jsxs)("div",{className:"flex justify-between items-center pt-2.5 sm:pt-3 border-t text-sm sm:text-base",children:[(0,t.jsx)("span",{className:"text-muted-foreground",children:"ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª:"}),(0,t.jsx)(S.Badge,{className:`text-xs sm:text-sm ${eh[W.paymentStatus]?.color}`,children:eh[W.paymentStatus]?.label})]})]})})]})]})]}),(0,t.jsx)(em,{isOpen:J,onOpenChange:V})]})}function eg(){return(0,t.jsx)(s.Suspense,{fallback:(0,t.jsx)("div",{className:"container mx-auto px-4 py-6",children:"Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ..."}),children:(0,t.jsx)(ep,{})})}e.s(["default",()=>eg],71876)}]);