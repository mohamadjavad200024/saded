(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,22085,e=>{"use strict";var t=e.i(43476),a=e.i(46932),r=e.i(88653),s=e.i(67881),i=e.i(84762),n=e.i(14764),l=e.i(82735),o=e.i(46897),c=e.i(78583),d=e.i(37727),u=e.i(87951),m=e.i(52044),h=e.i(95242),p=e.i(31278),g=e.i(64659),x=e.i(73708);function f({message:e,setMessage:f,onMessageChange:y,attachments:v,setAttachments:w,onRemoveAttachment:b,showAttachmentOptions:j,setShowAttachmentOptions:k,onToggleAttachmentOptions:N,isRecording:C,recordingTime:S,audioUrl:T,isSaving:M,isSending:E,showScrollToBottom:I,showPermissionGuide:R,setShowPermissionGuide:O,textareaRef:A,imageInputRef:P,fileInputRef:D,typingTimeoutRef:$,handleSendMessage:z,onSend:F,handleFileSelect:L,onFileSelect:B,handleRemoveAttachment:_,onLocationShare:U,handleLocationShare:H,startRecording:q,onStartRecording:V,stopRecording:W,onStopRecording:J,saveRecording:K,onSaveRecording:X,cancelRecording:G,onCancelRecording:Z,sendTypingStatus:Q,scrollToBottom:Y,formatTime:ee,toast:et}){let ea=f||(e=>{y&&y({target:{value:e}})}),er=z||F||(()=>{}),es=L||B,ei=_||b,en=H||U,el=q||V,eo=W||J,ec=K||X,ed=k||(()=>{N&&N()});return(0,t.jsxs)("div",{className:"border-t border-border/40 bg-background p-2 sm:p-3 space-y-2 relative flex-shrink-0",children:[(0,t.jsx)(r.AnimatePresence,{children:I&&(0,t.jsx)(a.motion.div,{initial:{opacity:0,y:10,scale:.9},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.9},className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 z-10",children:(0,t.jsx)(s.Button,{onClick:()=>{Y&&Y(!1)},size:"icon",className:"h-9 w-9 rounded-full shadow-lg hover:shadow-xl bg-primary text-primary-foreground hover:bg-primary/90 transition-all",title:"برو به آخرین پیام",children:(0,t.jsx)(g.ChevronDown,{className:"h-4 w-4"})})})}),R&&(0,t.jsx)(a.motion.div,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},exit:{opacity:0,y:5},className:"p-3 bg-destructive/5 border-2 border-destructive/20 rounded-xl shadow-sm",children:(0,t.jsxs)("div",{className:"flex items-start gap-2",children:[(0,t.jsx)(u.Mic,{className:"h-3.5 w-3.5 text-destructive mt-0.5 flex-shrink-0"}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsx)("p",{className:"text-sm font-semibold text-destructive mb-1.5 leading-tight",children:"دسترسی میکروفون نیاز است"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground leading-relaxed",children:"لطفاً در تنظیمات مرورگر دسترسی میکروفون را فعال کنید"})]}),(0,t.jsx)("button",{onClick:()=>{O&&O(!1)},className:"p-0.5 rounded hover:bg-destructive/10 transition-colors flex-shrink-0",children:(0,t.jsx)(d.X,{className:"h-3 w-3 text-destructive"})})]})}),(C||T)&&(0,t.jsx)(a.motion.div,{initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},className:"flex items-center gap-2 p-2 bg-destructive/10 border border-destructive/30 rounded-lg",children:C?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(a.motion.div,{animate:{scale:[1,1.1,1]},transition:{repeat:1/0,duration:1},className:"p-1.5 rounded-full bg-destructive/20",children:(0,t.jsx)(u.Mic,{className:"h-3.5 w-3.5 text-destructive"})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-xs font-medium text-destructive leading-tight",children:"در حال ضبط"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground font-mono",children:ee(S)})]}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:eo,className:"h-7 w-7 text-destructive hover:bg-destructive/10 rounded-lg",children:(0,t.jsx)(m.Square,{className:"h-3 w-3 fill-current"})})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"p-1.5 rounded-full bg-primary/20",children:(0,t.jsx)(u.Mic,{className:"h-3.5 w-3.5 text-primary"})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-xs font-medium leading-tight",children:"پیام صوتی آماده است"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground font-mono",children:ee(S)})]}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:G||Z,className:"h-7 w-7 text-muted-foreground hover:text-destructive rounded-lg",children:(0,t.jsx)(d.X,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{onClick:async e=>{e.preventDefault(),e.stopPropagation(),console.log("[Voice Widget] Save button clicked!"),ec&&await ec()},size:"sm",className:"h-7 px-3 text-xs rounded-lg",title:"ذخیره و ارسال پیام صوتی",children:"ذخیره"})]})}),j&&(0,t.jsxs)(a.motion.div,{initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},className:"flex gap-2 p-2 bg-card rounded-lg border border-border/50 shadow-lg",onClick:e=>{console.log("[Attachment Options Widget] Container clicked!",e.target)},children:[(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:()=>{P?.current?.click(),N?N():ed(!1)},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",children:(0,t.jsx)(x.Image,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:()=>{D?.current?.click(),N?N():ed(!1)},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",children:(0,t.jsx)(c.FileText,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:e=>{e.preventDefault(),e.stopPropagation(),console.log("[Location Widget] Button clicked!"),en&&en(),N?N():ed(!1)},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",title:"اشتراک‌گذاری موقعیت مکانی",children:(0,t.jsx)(o.MapPin,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:async e=>{if(e.preventDefault(),e.stopPropagation(),console.log("[Voice Widget] Button clicked!"),N?N():ed(!1),C)eo&&eo();else{et({title:"در حال درخواست دسترسی...",description:"لطفاً اجازه دسترسی به میکروفون را در مرورگر بدهید",duration:3e3});try{el&&await el()}catch(e){console.error("[Voice Widget] Error starting recording:",e)}}},title:"ضبط پیام صوتی",className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",disabled:C,children:C?(0,t.jsx)(h.Pause,{className:"h-3.5 w-3.5 text-destructive"}):(0,t.jsx)(u.Mic,{className:"h-3.5 w-3.5"})})]}),(0,t.jsx)("input",{ref:P,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:e=>{es&&es(e,"image")}}),(0,t.jsx)("input",{ref:D,type:"file",multiple:!0,className:"hidden",onChange:e=>{es&&es(e,"file")}}),(0,t.jsx)("div",{className:"flex items-end gap-2",children:(0,t.jsxs)("div",{className:"flex-1 relative",children:[v.length>0&&(0,t.jsx)("div",{className:"absolute top-2 right-2 left-2 z-10 pointer-events-none overflow-hidden",children:(0,t.jsx)("div",{className:"overflow-x-auto overflow-y-hidden scroll-smooth w-full [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]",children:(0,t.jsx)("div",{className:"flex items-center gap-1.5 flex-nowrap",children:v.map(e=>(0,t.jsxs)("div",{className:"relative group pointer-events-auto flex-shrink-0 w-auto",children:[(0,t.jsxs)("div",{className:"bg-card/95 backdrop-blur-sm rounded-md p-1 border border-border/40 shadow-sm",children:["image"===e.type&&e.url&&(0,t.jsx)("img",{src:e.url,alt:e.name||"تصویر",className:"w-10 h-10 object-cover rounded"}),"file"===e.type&&(0,t.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,t.jsx)(c.FileText,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,t.jsx)("p",{className:"text-[10px] truncate max-w-[50px] font-medium leading-tight",children:e.name})]}),"location"===e.type&&(0,t.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,t.jsx)(o.MapPin,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,t.jsx)("span",{className:"text-[10px] font-medium whitespace-nowrap leading-tight",children:"موقعیت"})]}),"audio"===e.type&&(0,t.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,t.jsx)(u.Mic,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,t.jsx)("span",{className:"text-[10px] font-medium whitespace-nowrap leading-tight",children:e.duration?ee(e.duration):"صدا"})]})]}),(0,t.jsx)("button",{onClick:()=>{ei&&ei(e.id)},className:"absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm z-20 hover:scale-110",children:(0,t.jsx)(d.X,{className:"h-2.5 w-2.5"})})]},e.id))})})}),(0,t.jsx)(i.Textarea,{ref:A,value:e,onChange:e=>{y?y(e):ea(e.target.value),$?.current&&clearTimeout($.current),Q&&e.target.value.trim().length>0?(Q(!0),$&&($.current=setTimeout(()=>{Q(!1)},2e3))):Q&&Q(!1)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),$?.current&&clearTimeout($.current),Q&&Q(!1),er())},placeholder:"پیام خود را بنویسید...",className:`min-h-[44px] max-h-[100px] resize-none text-sm leading-relaxed rounded-lg border pr-20 pl-3 py-2 ${v.length>0?"pt-12":""}`}),(0,t.jsxs)("div",{className:"absolute bottom-2 right-2 flex items-center gap-1",children:[(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:e=>{e.preventDefault(),e.stopPropagation(),console.log("[Paperclip Widget] Button clicked! showAttachmentOptions:",!j),N?N():ed(!j)},className:`h-7 w-7 rounded-lg transition-all ${j?"bg-primary/10 text-primary":"hover:bg-muted/60 text-muted-foreground hover:text-foreground"}`,children:(0,t.jsx)(l.Paperclip,{className:"h-4 w-4"})}),!C&&(0,t.jsx)(t.Fragment,{children:M??E?(0,t.jsx)(p.Loader2,{className:"h-4 w-4 text-primary animate-spin"}):(0,t.jsx)(s.Button,{onClick:er,size:"icon",className:"h-7 w-7 rounded-lg transition-all",children:(0,t.jsx)(n.Send,{className:"h-3.5 w-3.5"})})})]})]})})]})}e.s(["ChatInput",()=>f])},15788,e=>{"use strict";let t=(0,e.i(75254).default)("Truck",[["path",{d:"M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2",key:"wrbu53"}],["path",{d:"M15 18H9",key:"1lyqi6"}],["path",{d:"M19 18h2a1 1 0 0 0 1-1v-3.65a1 1 0 0 0-.22-.624l-3.48-4.35A1 1 0 0 0 17.52 8H14",key:"lysw3i"}],["circle",{cx:"17",cy:"18",r:"2",key:"332jqn"}],["circle",{cx:"7",cy:"18",r:"2",key:"19iecd"}]]);e.s(["Truck",()=>t],15788)},73708,e=>{"use strict";let t=(0,e.i(75254).default)("Image",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]]);e.s(["Image",()=>t],73708)},84762,e=>{"use strict";var t=e.i(43476),a=e.i(71645),r=e.i(47163);let s=a.forwardRef(({className:e,...a},s)=>(0,t.jsx)("textarea",{className:(0,r.cn)("flex min-h-[80px] w-full rounded-md border-[0.25px] border-input/30 bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",e),ref:s,...a}));s.displayName="Textarea",e.s(["Textarea",()=>s])},20682,e=>{"use strict";var t=e.i(71645);let a=0,r=new Map,s=e=>{if(r.has(e))return;let t=setTimeout(()=>{r.delete(e),l({type:"REMOVE_TOAST",toastId:e})},1e6);r.set(e,t)},i=[],n={toasts:[]};function l(e){n=((e,t)=>{switch(t.type){case"ADD_TOAST":return{...e,toasts:[t.toast,...e.toasts].slice(0,1)};case"UPDATE_TOAST":return{...e,toasts:e.toasts.map(e=>e.id===t.toast.id?{...e,...t.toast}:e)};case"DISMISS_TOAST":{let{toastId:a}=t;return a?s(a):e.toasts.forEach(e=>{s(e.id)}),{...e,toasts:e.toasts.map(e=>e.id===a||void 0===a?{...e,open:!1}:e)}}case"REMOVE_TOAST":if(void 0===t.toastId)return{...e,toasts:[]};return{...e,toasts:e.toasts.filter(e=>e.id!==t.toastId)}}})(n,e),i.forEach(e=>{e(n)})}function o({...e}){let t=(a=(a+1)%Number.MAX_SAFE_INTEGER).toString(),r=()=>l({type:"DISMISS_TOAST",toastId:t});return l({type:"ADD_TOAST",toast:{...e,id:t,open:!0,onOpenChange:e=>{e||r()}}}),{id:t,dismiss:r,update:e=>l({type:"UPDATE_TOAST",toast:{...e,id:t}})}}function c(){let[e,a]=t.useState(n);return t.useEffect(()=>(i.push(a),()=>{let e=i.indexOf(a);e>-1&&i.splice(e,1)}),[e]),{...e,toast:o,dismiss:e=>l({type:"DISMISS_TOAST",toastId:e})}}e.s(["useToast",()=>c])},31278,e=>{"use strict";let t=(0,e.i(75254).default)("LoaderCircle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]]);e.s(["Loader2",()=>t],31278)},78583,e=>{"use strict";let t=(0,e.i(75254).default)("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]]);e.s(["FileText",()=>t],78583)},14764,e=>{"use strict";let t=(0,e.i(75254).default)("Send",[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]]);e.s(["Send",()=>t],14764)},46897,e=>{"use strict";let t=(0,e.i(75254).default)("MapPin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]]);e.s(["MapPin",()=>t],46897)},27651,e=>{"use strict";var t=e.i(71645),a=e.i(73493);function r({adminId:e="admin-1",enabled:s=!0,heartbeatInterval:i=15e3}={}){let[n,l]=(0,t.useState)(!1),[o,c]=(0,t.useState)(null),d=(0,t.useRef)(null),u=(0,t.useRef)(!0),m=(0,t.useCallback)(async()=>{if(s&&u.current)try{let t=await fetch(`/api/admin/presence?adminId=${e}`);if(!t.ok){let r=`Failed to check admin status (${t.status})`;try{let e=await t.json();e.error&&(r=`Failed to check admin status: ${e.error}`)}catch{}a.logger.error(r,{status:t.status,adminId:e});return}let r=await t.json();r.success&&r.data?(l(r.data.isOnline||!1),c(r.data.lastSeen||null)):r.success||a.logger.error("Failed to check admin status:",r.error||"Unknown error",{adminId:e})}catch(t){a.logger.error("Error checking admin status:",t,{adminId:e})}},[e,s]),h=(0,t.useCallback)(async t=>{if(s&&u.current)try{let r=await fetch("/api/admin/presence",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({adminId:e,isOnline:t})});if(!r.ok){let t=`Failed to update admin status (${r.status})`;try{let e=await r.json();e.error&&(t=`Failed to update admin status: ${e.error}`)}catch{}a.logger.error(t,{status:r.status,adminId:e});return}let s=await r.json();s.success&&s.data?(l(s.data.isOnline||!1),c(s.data.lastSeen||null)):s.success||a.logger.error("Failed to update admin status:",s.error||"Unknown error",{adminId:e})}catch(t){a.logger.error("Error updating admin status:",t,{adminId:e})}},[e,s]);return(0,t.useEffect)(()=>{s&&m()},[s,m]),(0,t.useEffect)(()=>{if(!s||!n){d.current&&(clearInterval(d.current),d.current=null);return}return h(!0),d.current=setInterval(()=>{u.current&&h(!0)},i),()=>{d.current&&(clearInterval(d.current),d.current=null)}},[s,n,i,h]),(0,t.useEffect)(()=>()=>{u.current=!1,d.current&&(clearInterval(d.current),d.current=null),s&&h(!1).catch(e=>a.logger.error("Error setting offline status:",e))},[s,h]),{isOnline:n,lastSeen:o,checkStatus:m,setOnline:h}}e.s(["useAdminPresence",()=>r])},73042,e=>{"use strict";var t=e.i(43476),a=e.i(46932),r=e.i(14683),s=e.i(47163);function i({isOnline:e,lastSeen:i,className:n,showText:l=!1}){return(0,t.jsxs)(a.motion.span,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},className:(0,s.cn)("inline-flex items-center gap-2",n),children:[(0,t.jsxs)("span",{className:"relative inline-flex items-center",children:[(0,t.jsx)(r.Circle,{className:(0,s.cn)("h-3 w-3",e?"fill-green-500 text-green-500":"fill-gray-400 text-gray-400")}),e&&(0,t.jsx)(a.motion.span,{className:"absolute inset-0 rounded-full bg-green-500 pointer-events-none",animate:{scale:[1,1.5,1],opacity:[1,0,1]},transition:{duration:2,repeat:1/0}})]}),l&&(0,t.jsx)("span",{className:(0,s.cn)("text-sm font-semibold leading-tight",e?"text-green-600 dark:text-green-400":"text-gray-500"),children:e?"آنلاین":i?`آخرین بازدید: ${(e=>{if(!e)return"هرگز";let t=new Date(e),a=new Date().getTime()-t.getTime(),r=Math.floor(a/6e4),s=Math.floor(a/36e5),i=Math.floor(a/864e5);return r<1?"همین الان":r<60?`${r} دقیقه پیش`:s<24?`${s} ساعت پیش`:i<7?`${i} روز پیش`:t.toLocaleDateString("fa-IR")})(i)}`:"آفلاین"})]})}e.s(["OnlineStatusBadge",()=>i])},26428,e=>{"use strict";var t=e.i(43476),a=e.i(46932);function r({className:e}){return(0,t.jsxs)(a.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:`flex items-center gap-2 px-5 py-3 bg-muted/60 rounded-2xl shadow-sm border border-border/30 ${e||""}`,children:[(0,t.jsx)(a.motion.div,{className:"w-2.5 h-2.5 bg-muted-foreground/70 rounded-full",animate:{y:[0,-6,0]},transition:{duration:.6,repeat:1/0,delay:0}}),(0,t.jsx)(a.motion.div,{className:"w-2.5 h-2.5 bg-muted-foreground/70 rounded-full",animate:{y:[0,-6,0]},transition:{duration:.6,repeat:1/0,delay:.2}}),(0,t.jsx)(a.motion.div,{className:"w-2.5 h-2.5 bg-muted-foreground/70 rounded-full",animate:{y:[0,-6,0]},transition:{duration:.6,repeat:1/0,delay:.4}})]})}e.s(["TypingIndicator",()=>r])},94771,e=>{"use strict";let t=(0,e.i(75254).default)("CheckCheck",[["path",{d:"M18 6 7 17l-5-5",key:"116fxf"}],["path",{d:"m22 10-7.5 7.5L13 16",key:"ke71qq"}]]);e.s(["CheckCheck",()=>t],94771)},87951,e=>{"use strict";let t=(0,e.i(75254).default)("Mic",[["path",{d:"M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z",key:"131961"}],["path",{d:"M19 10v2a7 7 0 0 1-14 0v-2",key:"1vc78b"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);e.s(["Mic",()=>t],87951)},29006,92930,23585,e=>{"use strict";var t=e.i(75254);let a=(0,t.default)("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]);e.s(["Reply",()=>a],29006);let r=(0,t.default)("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);e.s(["Edit2",()=>r],92930);let s=(0,t.default)("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);e.s(["MoreVertical",()=>s],23585)},82735,e=>{"use strict";let t=(0,e.i(75254).default)("Paperclip",[["path",{d:"M13.234 20.252 21 12.3",key:"1cbrk9"}],["path",{d:"m16 6-8.414 8.586a2 2 0 0 0 0 2.828 2 2 0 0 0 2.828 0l8.414-8.586a4 4 0 0 0 0-5.656 4 4 0 0 0-5.656 0l-8.415 8.585a6 6 0 1 0 8.486 8.486",key:"1pkts6"}]]);e.s(["Paperclip",()=>t],82735)},52044,95242,e=>{"use strict";var t=e.i(75254);let a=(0,t.default)("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);e.s(["Square",()=>a],52044);let r=(0,t.default)("Pause",[["rect",{x:"14",y:"4",width:"4",height:"16",rx:"1",key:"zuxfzm"}],["rect",{x:"6",y:"4",width:"4",height:"16",rx:"1",key:"1okwgv"}]]);e.s(["Pause",()=>r],95242)},82429,e=>{"use strict";var t=e.i(43476),a=e.i(71645),r=e.i(52917),s=e.i(67881),i=e.i(23750),n=e.i(94983),l=e.i(55436),o=e.i(84614),c=e.i(43432),d=e.i(37727),u=e.i(31278),m=e.i(64659),h=e.i(46932),p=e.i(88653),g=e.i(20682),x=e.i(27651),f=e.i(73042),y=e.i(26428),v=e.i(94179),w=e.i(73493);e.i(47167);var b=e.i(94771),j=e.i(78583),k=e.i(46897),N=e.i(87951),C=e.i(29006),S=e.i(92930),T=e.i(27612),M=e.i(23585),E=e.i(63415);function I({message:e,index:a,totalMessages:r,onReply:i,onEdit:n,onDelete:l}){return(0,t.jsx)(h.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},transition:{duration:.2,ease:"easeOut"},className:`flex ${"user"===e.sender?"justify-end":"justify-start"} items-end gap-2 group`,children:(0,t.jsxs)("div",{className:`max-w-[85%] sm:max-w-[75%] md:max-w-[70%] rounded-lg px-2.5 sm:px-3 py-2 transition-all ${"user"===e.sender?"bg-primary text-primary-foreground":"bg-muted text-foreground border border-border/40"}`,children:[e.text&&(0,t.jsx)("p",{className:"text-xs sm:text-sm leading-relaxed whitespace-pre-wrap break-words mb-1.5",children:e.text}),e.attachments&&e.attachments.length>0&&(0,t.jsx)("div",{className:`space-y-2 ${e.text?"mt-2":""}`,children:e.attachments.map((e,a)=>(0,t.jsxs)("div",{className:"rounded overflow-hidden",children:["image"===e.type&&e.url&&(0,t.jsx)("img",{src:e.url,alt:e.name||"تصویر",className:"max-w-full max-h-[150px] sm:max-h-[180px] rounded cursor-pointer hover:opacity-90 transition-all",onClick:()=>window.open(e.url,"_blank")}),"file"===e.type&&(0,t.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",download:e.name,className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,t.jsx)(j.FileText,{className:"h-3.5 w-3.5"}),(0,t.jsx)("span",{className:"font-medium truncate",children:e.name||"فایل"})]}),"location"===e.type&&(0,t.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,t.jsx)(k.MapPin,{className:"h-3.5 w-3.5"}),(0,t.jsx)("span",{className:"font-medium",children:e.name||"موقعیت"})]}),"audio"===e.type&&e.url&&(0,t.jsxs)("div",{className:"flex items-center gap-2 p-2 bg-background/50 rounded",children:[(0,t.jsx)(N.Mic,{className:"h-3.5 w-3.5"}),(0,t.jsx)("audio",{controls:!0,className:"flex-1 h-7 text-xs",children:(0,t.jsx)("source",{src:e.url})})]})]},e.id||a))}),(0,t.jsxs)("div",{className:`flex items-center gap-1.5 mt-1.5 pt-1.5 border-t ${"user"===e.sender?"border-primary-foreground/20 justify-end":"border-border/30 justify-start"}`,children:[(0,t.jsx)("span",{className:`text-[10px] sm:text-xs ${"user"===e.sender?"text-primary-foreground/70":"text-muted-foreground"}`,children:new Date(e.timestamp).toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}),e.status&&"user"===e.sender&&(0,t.jsx)(b.CheckCheck,{className:`h-3 w-3 ${"read"===e.status?"text-primary-foreground/70":"text-primary-foreground/40"}`}),(0,t.jsx)("div",{className:"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity",children:(i||n||l)&&(0,t.jsxs)(E.DropdownMenu,{children:[(0,t.jsx)(E.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 hover:bg-background/20",onClick:e=>{e.stopPropagation()},title:"گزینه‌های بیشتر",children:(0,t.jsx)(M.MoreVertical,{className:"h-3.5 w-3.5"})})}),(0,t.jsxs)(E.DropdownMenuContent,{align:"user"===e.sender?"end":"start",className:"min-w-[140px]",onClick:e=>e.stopPropagation(),children:[i&&(0,t.jsxs)(E.DropdownMenuItem,{onClick:t=>{t.stopPropagation(),i(e)},className:"cursor-pointer",children:[(0,t.jsx)(C.Reply,{className:"h-4 w-4 ml-2"}),(0,t.jsx)("span",{children:"پاسخ"})]}),n&&"user"===e.sender&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(E.DropdownMenuSeparator,{}),(0,t.jsxs)(E.DropdownMenuItem,{onClick:t=>{t.stopPropagation(),n(e)},className:"cursor-pointer",children:[(0,t.jsx)(S.Edit2,{className:"h-4 w-4 ml-2"}),(0,t.jsx)("span",{children:"ویرایش"})]})]}),l&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(E.DropdownMenuSeparator,{}),(0,t.jsxs)(E.DropdownMenuItem,{onClick:t=>{t.stopPropagation(),confirm("آیا مطمئن هستید که می‌خواهید این پیام را حذف کنید؟")&&l(e.id)},className:"cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10",children:[(0,t.jsx)(T.Trash2,{className:"h-4 w-4 ml-2"}),(0,t.jsx)("span",{children:"حذف"})]})]})]})]})})]})]})},e.id)}var R=e.i(22085);function O({isOpen:e,onOpenChange:b}){let{toast:j}=(0,g.useToast)(),{setOnline:k,isOnline:N}=(0,x.useAdminPresence)({enabled:!0,heartbeatInterval:15e3}),[C,S]=(0,a.useState)([]),[T,M]=(0,a.useState)(null),[E,O]=(0,a.useState)([]),[A,P]=(0,a.useState)(!1),[D,$]=(0,a.useState)(""),[z,F]=(0,a.useState)(!1),[L,B]=(0,a.useState)(null),[_,U]=(0,a.useState)(null),H=(0,a.useRef)(null),q=(0,a.useRef)(null),V=(0,a.useRef)(null),W=(0,a.useRef)(null),[J,K]=(0,a.useState)(!1),X=function(){let{toast:e}=(0,g.useToast)(),[t,r]=(0,a.useState)([]),[s,i]=(0,a.useState)(!1),[n,l]=(0,a.useState)(0),[o,c]=(0,a.useState)(null),[d,u]=(0,a.useState)(null),[m,h]=(0,a.useState)(!1),p=(0,a.useRef)(null),x=(0,a.useRef)([]),f=(0,a.useRef)(null),y=(0,a.useRef)(null),v=(0,a.useRef)(null),b=(0,a.useCallback)(async(t,a,r=0)=>{try{let e=new FormData;e.append("file",t),e.append("type",a);let r=await fetch("/api/chat/upload",{method:"POST",body:e});if(!r.ok){let e=await r.json().catch(()=>({error:"خطا در آپلود فایل"}));throw Error(e.error||"خطا در آپلود فایل")}return(await r.json()).data.url}catch(s){if(r<3&&(s.message?.includes("fetch")||s.message?.includes("network")||s.message?.includes("timeout")||"NETWORK_ERROR"===s.code||"TypeError"===s.name)){let s=2e3*Math.pow(2,r);return 0===r&&e({title:"در حال تلاش مجدد...",description:"خطا در آپلود فایل. در حال تلاش مجدد...",duration:2e3}),await new Promise(e=>setTimeout(e,s)),b(t,a,r+1)}throw e({title:"خطا در آپلود فایل",description:s.message||"لطفاً دوباره تلاش کنید",variant:"destructive"}),s}},[e]),j=(0,a.useCallback)(async(e,t)=>{let a=e.target.files;if(a&&0!==a.length){for(let e of Array.from(a))try{let a=await b(e,t),s={id:Date.now().toString()+Math.random(),type:t,name:e.name,size:e.size,url:a};r(e=>[...e,s])}catch(e){}e.target.value=""}},[b]),k=(0,a.useCallback)(e=>{r(t=>t.filter(t=>t.id!==e))},[]),N=(0,a.useCallback)(()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{let t={id:Date.now().toString(),type:"location",url:`https://www.google.com/maps?q=${e.coords.latitude},${e.coords.longitude}`,name:"موقعیت مکانی"};r(e=>[...e,t]),h(!1)},t=>{w.logger.error("Error getting location:",t),e({title:"خطا",description:"خطا در دریافت موقعیت مکانی",variant:"destructive"})}):e({title:"خطا",description:"مرورگر شما از موقعیت مکانی پشتیبانی نمی‌کند",variant:"destructive"})},[e]),C=(0,a.useCallback)(async()=>{try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),!0}catch(e){return!1}},[]),S=(0,a.useCallback)(async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void e({title:"مرورگر شما پشتیبانی نمی‌کند",description:"مرورگر شما از ضبط صدا پشتیبانی نمی‌کند. لطفاً از مرورگر جدیدتری استفاده کنید.",variant:"destructive"});let t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),a=new MediaRecorder(t,{mimeType:MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":MediaRecorder.isTypeSupported("audio/mp4")?"audio/mp4":"audio/webm"});p.current=a,x.current=[],a.ondataavailable=e=>{e.data.size>0&&x.current.push(e.data)},a.onstop=()=>{let e=new Blob(x.current,{type:a.mimeType||"audio/webm"});c(e);let r=URL.createObjectURL(e);u(r),t.getTracks().forEach(e=>e.stop())},a.onerror=t=>{w.logger.error("MediaRecorder error:",t),e({title:"خطا در ضبط صدا",description:"خطایی در هنگام ضبط صدا رخ داد. لطفاً دوباره تلاش کنید.",variant:"destructive"}),T()},a.start(),i(!0),l(0),h(!1),f.current=setInterval(()=>{l(e=>e+1)},1e3),e({title:"ضبط صدا شروع شد",description:"در حال ضبط پیام صوتی..."})}catch(r){let t="دسترسی به میکروفون مجاز نیست.",a="";"NotAllowedError"===r.name||"PermissionDeniedError"===r.name?(t="دسترسی به میکروفون رد شد",a="لطفاً در تنظیمات مرورگر خود، دسترسی میکروفون را فعال کنید."):"NotFoundError"===r.name||"DevicesNotFoundError"===r.name?(t="میکروفون یافت نشد",a="لطفاً مطمئن شوید که میکروفون به دستگاه شما متصل است."):"NotReadableError"===r.name||"TrackStartError"===r.name?(t="میکروفون در حال استفاده است",a="میکروفون توسط برنامه دیگری استفاده می‌شود. لطفاً آن را ببندید."):a="لطفاً دوباره تلاش کنید یا صفحه را رفرش کنید.",e({title:t,description:a,variant:"destructive",duration:5e3})}},[e]),T=(0,a.useCallback)(()=>{if(p.current&&"inactive"!==p.current.state)try{p.current.stop(),i(!1),f.current&&clearInterval(f.current),e({title:"ضبط صدا متوقف شد",description:"پیام صوتی شما آماده است. می‌توانید آن را ذخیره یا لغو کنید."})}catch(t){w.logger.error("Error stopping recording:",t),e({title:"خطا",description:"خطایی در توقف ضبط رخ داد.",variant:"destructive"})}},[e]),M=(0,a.useCallback)(()=>{T(),c(null),d&&(URL.revokeObjectURL(d),u(null)),l(0)},[d,T]),E=(0,a.useCallback)(async()=>{if(o&&d)try{let e="webm",t=o.type||"audio/webm";t.includes("mp4")||t.includes("m4a")?e="m4a":t.includes("ogg")?e="ogg":t.includes("wav")&&(e="wav");let a=new File([o],`audio-${Date.now()}.${e}`,{type:t}),s=await b(a,"audio"),i={id:Date.now().toString(),type:"audio",url:s,name:`پیام صوتی ${I(n)}`,size:o.size,duration:n};return r(e=>[...e,i]),c(null),d&&URL.revokeObjectURL(d),u(null),l(0),i}catch(e){}return null},[o,d,n,b]),I=(0,a.useCallback)(e=>{let t=Math.floor(e/60);return`${t}:${(e%60).toString().padStart(2,"0")}`},[]);return{attachments:t,setAttachments:r,isRecording:s,recordingTime:n,audioBlob:o,audioUrl:d,showAttachmentOptions:m,setShowAttachmentOptions:h,uploadFile:b,handleFileSelect:j,handleRemoveAttachment:k,handleLocationShare:N,startRecording:S,stopRecording:T,cancelRecording:M,saveRecording:E,formatTime:I,formatFileSize:(0,a.useCallback)(e=>e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB",[]),checkMicrophonePermission:C,imageInputRef:y,fileInputRef:v}}(),G=function({chatId:e,sender:t,customerInfo:r,onMessageSent:s}){let{toast:i}=(0,g.useToast)(),[n,l]=(0,a.useState)(""),[o,c]=(0,a.useState)(!1),[d,u]=(0,a.useState)(!1),m=(0,a.useRef)(null),h=(0,a.useRef)(null),p=(0,a.useCallback)(async a=>{if(e)try{await fetch("/api/chat/typing",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:e,sender:t,isTyping:a})})}catch(e){w.logger.error("Error sending typing status:",e)}},[e,t]),x=(0,a.useCallback)(t=>{l(t.target.value),e&&(m.current&&clearTimeout(m.current),t.target.value.trim().length>0?(p(!0),m.current=setTimeout(()=>{p(!1)},2e3)):p(!1))},[e,p]),f=(0,a.useCallback)(async()=>{if(e)try{let a=await fetch(`/api/chat/typing?chatId=${e}&sender=${"user"===t?"support":"user"}`,{credentials:"include"});if(a.ok){let e=await a.json();e.success&&u(e.data.isTyping||!1)}}catch(e){w.logger.error("Error checking typing status:",e)}},[e,t]);(0,a.useEffect)(()=>{if(!e){u(!1),h.current&&(clearInterval(h.current),h.current=null);return}return f(),h.current=setInterval(()=>{f()},2e3),()=>{h.current&&(clearInterval(h.current),h.current=null),m.current&&(clearTimeout(m.current),m.current=null),p(!1)}},[e,f,p]);let y=(0,a.useCallback)(async(a,n=[])=>{if(!a.trim()&&0===n.length||!e)return null;let l=n.filter(e=>{let t=e.url;return t&&!t.startsWith("blob:")&&!t.startsWith("data:")&&(t.startsWith("http")||t.startsWith("/"))});if(!a.trim()&&0===l.length)return i({title:"خطا",description:"لطفاً یک پیام یا فایل معتبر اضافه کنید",variant:"destructive"}),null;let o={id:`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,text:a,sender:t,timestamp:new Date,attachments:l.length>0?l:void 0};try{c(!0),m.current&&clearTimeout(m.current),p(!1);let t={chatId:e,messages:[{id:o.id,text:o.text,sender:o.sender,timestamp:o.timestamp.toISOString(),attachments:o.attachments||[]}]};r&&(t.customerInfo=r);let a=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)});if(!a.ok){let e=await a.json().catch(()=>null),t=e?.error||(429===a.status?"درخواست‌های شما زیاد است. لطفاً کمی بعد دوباره تلاش کنید.":null)||"خطا در ارسال پیام";throw Error(t)}return s&&s(),o}catch(e){return i({title:"خطا",description:e instanceof Error?e.message:"خطا در ارسال پیام",variant:"destructive"}),null}finally{c(!1)}},[e,t,r,i,s,p]),v=(0,a.useCallback)(async(e=[],t)=>{let a=n;t&&(a=`در پاسخ به: ${t.text}

${n}`);let r=await y(a,e);return r?(l(""),r):null},[n,y]);return{message:n,setMessage:l,isSending:o,isTyping:d,handleMessageChange:x,sendMessage:y,handleSend:v}}({chatId:T?.id||null,sender:"support",customerInfo:T?{name:T.customerName,phone:T.customerPhone,email:T.customerEmail}:void 0,onMessageSent:()=>{Z(),T&&Y(T.id,!1)}}),Z=(0,a.useCallback)(async(e=!0)=>{try{e&&P(!0);let t=await fetch("/api/chat",{credentials:"include"});if(!t.ok){let e=await t.text();throw w.logger.error("Failed to load chats:",t.status,e),Error("خطا در بارگذاری چت‌ها")}let a=await t.json();if(w.logger.info("Loaded chats:",a.success?a.data.chats?.length:0,"chats"),a.success&&a.data.chats){let e=await Promise.all(a.data.chats.map(async e=>{try{let t=await fetch(`/api/chat?chatId=${e.id}`,{credentials:"include"});if(t.ok){let a=await t.json();if(a.success&&a.data.messages){let t=a.data.messages,r=t[t.length-1];return{...e,lastMessage:r?.text||"",lastMessageTime:r?.createdAt||e.updatedAt,unreadCount:e.unreadCount||0}}}}catch(e){w.logger.error("Error loading last message:",e)}return{...e,unreadCount:e.unreadCount||0}}));S(e)}}catch(t){w.logger.error("Error loading chats:",t),e&&j({title:"خطا",description:"خطا در بارگذاری چت‌ها",variant:"destructive"})}finally{e&&P(!1)}},[j]),Q=(0,a.useCallback)(async()=>{try{let e=await fetch("/api/chat",{credentials:"include"});if(!e.ok)return;let t=await e.json();if(t.success&&t.data.chats){let e=t.data.chats.map(async e=>{try{let t=await fetch(`/api/chat?chatId=${e.id}`,{credentials:"include"});if(t.ok){let a=await t.json();if(a.success&&a.data.messages){let t=a.data.messages,r=t[t.length-1];return{...e,lastMessage:r?.text||"",lastMessageTime:r?.createdAt||e.updatedAt,unreadCount:e.unreadCount||0}}}}catch(e){}return{...e,unreadCount:e.unreadCount||0}}),a=(await Promise.allSettled(e)).filter(e=>"fulfilled"===e.status).map(e=>e.value);S(e=>{let t=new Map(a.map(e=>[e.id,e])),r=new Set(e.map(e=>e.id)),s=e.map(e=>{let a=t.get(e.id);return a&&(a.unreadCount!==e.unreadCount||a.lastMessage!==e.lastMessage||a.lastMessageTime!==e.lastMessageTime)?{...e,...a}:e});return a.forEach(e=>{r.has(e.id)||s.push(e)}),s})}}catch(e){}},[]),Y=(0,a.useCallback)(async(e,t=!1)=>{try{t&&P(!0);let a=`/api/chat?chatId=${e}`;!t&&V.current&&(a+=`&lastMessageId=${V.current}`);let r=await fetch(a);if(!r.ok)throw Error("خطا در بارگذاری پیام‌ها");let s=await r.json();if(s.success&&s.data.messages){let e=s.data.messages.map(e=>{let t=[];if(e.attachments){if(Array.isArray(e.attachments))t=e.attachments;else if("string"==typeof e.attachments)try{let a=JSON.parse(e.attachments);t=Array.isArray(a)?a:[a]}catch(e){w.logger.error("Error parsing attachments:",e)}}return{id:e.id,text:e.text||"",sender:e.sender,timestamp:new Date(e.createdAt),attachments:t,status:e.status||("user"===e.sender?"sent":void 0)}});if(T)try{let e=await fetch(`/api/chat/unread-count?chatId=${T.id}`);if(e.ok){let t=await e.json();if(t.success&&t.data){let e=t.data.unreadCount||0;S(t=>t.map(t=>t.id===T.id?{...t,unreadCount:e}:t))}}}catch(e){}t?(O(e),e.length>0&&(V.current=e[e.length-1].id)):O(t=>{let a=new Set(t.map(e=>e.id)),r=e.filter(e=>!a.has(e.id));return r.length>0?(V.current=r[r.length-1].id,[...t,...r]):t})}}catch(e){w.logger.error("Error loading messages:",e),t&&j({title:"خطا",description:"خطا در بارگذاری پیام‌ها",variant:"destructive"})}finally{t&&P(!1)}},[T,j]),ee=(0,a.useCallback)(async e=>{try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:e,sender:"support",action:"delivered"})})}catch(e){}},[]),et=(0,a.useCallback)(async e=>{try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:e,sender:"support",action:"read"})})}catch(e){}},[]),ea=(0,a.useCallback)(async e=>{M(e),V.current=null,localStorage.setItem("admin_selected_chat_id",e.id),window.dispatchEvent(new CustomEvent("chatOpened",{detail:{chatId:e.id}})),et(e.id).catch(()=>{}),ee(e.id),Y(e.id,!0),S(t=>t.map(t=>t.id===e.id?{...t,unreadCount:0}:t))},[Y,et,ee]),er=(0,a.useCallback)(async()=>{if(T)try{let e=await fetch(`/api/chat/typing?chatId=${T.id}&sender=user`,{credentials:"include"});if(e.ok){let t=await e.json();t.success&&F(t.data.isTyping||!1)}}catch(e){}},[T]),es=(0,a.useCallback)(e=>{B(e),U(null)},[]),ei=(0,a.useCallback)(e=>{U(e),B(null),G.handleMessageChange({target:{value:e.text||""}})},[G]),en=(0,a.useCallback)(async e=>{if(T)try{if((await fetch(`/api/chat/message/${e}`,{method:"DELETE"})).ok)O(t=>t.filter(t=>t.id!==e)),j({title:"موفق",description:"پیام با موفقیت حذف شد"});else throw Error("خطا در حذف پیام")}catch(e){w.logger.error("Error deleting message:",e),j({title:"خطا",description:"خطا در حذف پیام",variant:"destructive"})}},[T,j]),el=(0,a.useCallback)(async()=>{if(!T)return;if(_){try{(await fetch(`/api/chat/message/${_.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:G.message,attachments:X.attachments})})).ok&&(O(e=>e.map(e=>e.id===_.id?{...e,text:G.message,attachments:X.attachments}:e)),U(null),G.handleMessageChange({target:{value:""}}),X.setAttachments([]),j({title:"موفق",description:"پیام ویرایش شد"}))}catch(e){w.logger.error("Error editing message:",e),j({title:"خطا",description:"خطا در ویرایش پیام",variant:"destructive"})}return}let e=await G.handleSend(X.attachments,L);e&&(O(t=>[...t,e]),X.setAttachments([]),X.setShowAttachmentOptions(!1),B(null),setTimeout(()=>{ec(!1),setTimeout(()=>{eo()},500)},150),X.audioBlob&&X.audioUrl&&await X.saveRecording())},[T,G,X,_,L,j]),eo=(0,a.useCallback)(()=>{if(!q.current||!T)return void K(!1);let e=q.current;K(e.scrollHeight-e.scrollTop-e.clientHeight>150)},[T]),ec=(0,a.useCallback)((e=!1)=>{H.current&&(H.current.scrollIntoView({behavior:e?"auto":"smooth",block:"end"}),setTimeout(()=>{K(!1)},300))},[]);(0,a.useEffect)(()=>{let e=q.current;if(!e||!T)return void K(!1);let t=()=>{eo()};return e.addEventListener("scroll",t,{passive:!0}),eo(),setTimeout(()=>{eo()},100),()=>{e.removeEventListener("scroll",t)}},[T,eo,E.length]);let ed=(0,a.useRef)(!1);(0,a.useEffect)(()=>{if(T&&E.length>0&&!ed.current){ed.current=!0;let e=setTimeout(()=>{ec(!0),setTimeout(()=>{eo()},500)},200);return()=>clearTimeout(e)}T||(ed.current=!1)},[T,E.length,ec,eo]),(0,a.useEffect)(()=>{if(E.length>0&&T){let e=setTimeout(()=>{eo()},200);return()=>clearTimeout(e)}},[E.length,eo,T]),(0,a.useEffect)(()=>{if(!T||!e){F(!1),W.current&&(clearInterval(W.current),W.current=null);return}ee(T.id),et(T.id).catch(()=>{}),er(),W.current=setInterval(()=>{er()},3e3);let t=setInterval(()=>{Y(T.id,!1),ee(T.id),et(T.id).catch(()=>{})},5e3);return()=>{clearInterval(t),W.current&&(clearInterval(W.current),W.current=null)}},[T,e,er,Y,ee,et]),(0,a.useEffect)(()=>{if(e){Z(!0),M(null),O([]),localStorage.removeItem("admin_selected_chat_id"),window.dispatchEvent(new CustomEvent("chatClosed")),k(!0);let e=setInterval(()=>{Q()},15e3);return()=>{clearInterval(e)}}k(!1),localStorage.removeItem("admin_selected_chat_id"),window.dispatchEvent(new CustomEvent("chatClosed"))},[e,k,Q,Z]),(0,a.useEffect)(()=>{let t=async t=>{let{chatId:a}=t.detail;a&&(e||b(!0),setTimeout(async()=>{0===C.length&&await Z();let e=C.find(e=>e.id===a);if(e)ea(e);else try{let e=await fetch(`/api/chat?chatId=${a}`,{credentials:"include"});if(e.ok){let t=await e.json();if(t.success&&t.data){let e={id:t.data.id,customerName:t.data.customerName||"کاربر",customerPhone:t.data.customerPhone||"",status:t.data.status||"active",createdAt:t.data.createdAt||new Date().toISOString(),updatedAt:t.data.updatedAt||new Date().toISOString(),lastMessage:t.data.lastMessage||"",lastMessageTime:t.data.lastMessageTime};ea(e)}}}catch(e){w.logger.error("Error loading chat:",e)}},300))};return window.addEventListener("openChat",t),()=>{window.removeEventListener("openChat",t)}},[e,C,b,Z,ea]),(0,a.useEffect)(()=>{"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission()},[]);let eu=C.filter(e=>e.customerName.toLowerCase().includes(D.toLowerCase())||e.customerPhone.includes(D));return(0,t.jsx)(r.Sheet,{open:e,onOpenChange:b,"data-admin-chat-open":e?"true":"false","data-selected-chat-id":T?.id||"",children:(0,t.jsx)(r.SheetContent,{side:"left",className:"w-full sm:w-[500px] md:w-[600px] p-0 flex flex-col shadow-2xl !h-screen !max-h-screen overflow-hidden",children:T?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.SheetHeader,{className:"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b border-border/40 px-4 sm:px-6 py-2",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:async()=>{M(null),O([]),V.current=null,localStorage.removeItem("admin_selected_chat_id"),window.dispatchEvent(new CustomEvent("chatClosed")),await Z()},className:"h-8 w-8 rounded-lg hover:bg-muted/60 transition-all",children:(0,t.jsx)(d.X,{className:"h-4 w-4"})}),(0,t.jsx)("div",{className:"flex-1 min-w-0",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(r.SheetTitle,{className:"text-base font-semibold truncate",children:T.customerName}),(0,t.jsx)(f.OnlineStatusBadge,{isOnline:N,showText:!1})]})})]})}),(0,t.jsxs)("div",{ref:q,className:"flex-1 min-h-0 overflow-y-auto p-4 sm:p-5 md:p-6 space-y-4 sm:space-y-5 bg-gradient-to-b from-background via-background to-muted/5",children:[A?(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsx)(u.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):0===E.length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center px-6",children:[(0,t.jsx)(n.MessageCircle,{className:"h-14 w-14 text-muted-foreground/50 mb-5"}),(0,t.jsx)("p",{className:"text-muted-foreground text-base font-medium leading-relaxed",children:"هنوز پیامی ارسال نشده است"})]}):(0,t.jsxs)(t.Fragment,{children:[E.map((e,a)=>(0,t.jsx)(I,{message:e,index:a,totalMessages:E.length,onReply:es,onEdit:ei,onDelete:en},e.id)),z&&(0,t.jsx)(h.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"flex justify-start items-end gap-2.5",children:(0,t.jsx)(y.TypingIndicator,{})})]}),(0,t.jsx)("div",{ref:H})]}),(0,t.jsxs)("div",{className:"sticky bottom-0 z-10 bg-background/95 backdrop-blur-sm border-t border-border/40 flex-shrink-0 relative pb-safe",style:{paddingBottom:"max(0.5rem, env(safe-area-inset-bottom))"},children:[(0,t.jsx)(p.AnimatePresence,{children:J&&(0,t.jsx)(h.motion.div,{initial:{opacity:0,y:10,scale:.9},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.9},className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 z-10",children:(0,t.jsx)(s.Button,{onClick:()=>ec(!1),size:"icon",className:"h-9 w-9 rounded-full shadow-lg hover:shadow-xl bg-primary text-primary-foreground hover:bg-primary/90 transition-all",title:"برو به آخرین پیام",children:(0,t.jsx)(m.ChevronDown,{className:"h-4 w-4"})})})}),(0,t.jsx)(R.ChatInput,{message:G.message,onMessageChange:G.handleMessageChange,onSend:el,isSending:G.isSending,attachments:X.attachments,onRemoveAttachment:X.handleRemoveAttachment,showAttachmentOptions:X.showAttachmentOptions,onToggleAttachmentOptions:()=>X.setShowAttachmentOptions(!X.showAttachmentOptions),isRecording:X.isRecording,recordingTime:X.recordingTime,audioUrl:X.audioUrl,onStartRecording:X.startRecording,onStopRecording:X.stopRecording,onCancelRecording:X.cancelRecording,onSaveRecording:async()=>{let e=await X.saveRecording();e&&X.setAttachments(t=>[...t,e])},formatTime:X.formatTime,imageInputRef:X.imageInputRef,fileInputRef:X.fileInputRef,onFileSelect:X.handleFileSelect,onLocationShare:X.handleLocationShare,onCheckMicrophonePermission:X.checkMicrophonePermission,toast:j})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(r.SheetHeader,{className:"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b border-border/40 px-4 sm:px-6 py-2",children:[(0,t.jsxs)(r.SheetTitle,{className:"flex items-center gap-2 text-base font-semibold",children:[(0,t.jsx)(n.MessageCircle,{className:"h-5 w-5"}),"چت‌های کاربران"]}),(0,t.jsx)("div",{className:"mt-2",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(l.Search,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,t.jsx)(i.Input,{type:"search",placeholder:"جستجوی کاربر...",value:D,onChange:e=>$(e.target.value),className:"pr-10 h-9 text-sm border rounded-lg"})]})})]}),(0,t.jsx)("div",{className:"flex-1 min-h-0 overflow-y-auto bg-gradient-to-b from-background to-muted/5",children:A?(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsx)(u.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):0===eu.length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center px-6",children:[(0,t.jsx)(n.MessageCircle,{className:"h-14 w-14 text-muted-foreground/50 mb-5"}),(0,t.jsx)("p",{className:"text-muted-foreground text-base font-medium leading-relaxed",children:"چتی یافت نشد"})]}):(0,t.jsx)("div",{className:"divide-y divide-border/50",children:eu.map(e=>(0,t.jsx)(h.motion.button,{onClick:()=>ea(e),className:`w-full p-5 text-right hover:bg-muted/50 transition-all duration-200 rounded-lg ${e.unreadCount&&e.unreadCount>0?"bg-primary/5 border-r-4 border-primary shadow-md":"hover:shadow-sm"}`,whileHover:{backgroundColor:e.unreadCount&&e.unreadCount>0?"rgba(var(--primary), 0.1)":"rgba(0,0,0,0.05)"},initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.2},children:(0,t.jsxs)("div",{className:"flex items-start gap-4",children:[(0,t.jsx)("div",{className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0 shadow-md border-2 border-primary/30",children:(0,t.jsx)(o.User,{className:"h-5 w-5 sm:h-6 sm:w-6 text-primary"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2.5 flex-1 min-w-0",children:[(0,t.jsx)("p",{className:`font-semibold text-sm sm:text-base truncate leading-tight ${e.unreadCount&&e.unreadCount>0?"font-bold":""}`,children:e.customerName}),e.unreadCount&&e.unreadCount>0&&(0,t.jsx)(h.motion.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:15},children:(0,t.jsx)(v.Badge,{variant:"destructive",className:"h-6 w-6 px-0 text-xs font-bold flex-shrink-0 shadow-lg animate-pulse flex items-center justify-center",children:"!"})})]}),e.lastMessageTime&&(0,t.jsx)("span",{className:"text-xs text-muted-foreground flex-shrink-0 mr-2 font-medium",children:new Date(e.lastMessageTime).toLocaleDateString("fa-IR",{month:"short",day:"numeric"})})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2.5 text-sm text-muted-foreground mb-1.5",children:[(0,t.jsx)(c.Phone,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:"font-medium",children:e.customerPhone})]}),e.lastMessage&&(0,t.jsx)("p",{className:"text-sm text-muted-foreground mt-2 truncate leading-relaxed",children:e.lastMessage})]})]})},e.id))})})]})})})}e.s(["AdminChat",()=>O],82429)}]);