(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,41222,e=>{"use strict";var t=e.i(43476),a=e.i(71645),r=e.i(18566),s=e.i(67881),i=e.i(84762),n=e.i(23750),o=e.i(14764),l=e.i(94983),c=e.i(43432),d=e.i(63488),u=e.i(73708),m=e.i(82735),h=e.i(46897),p=e.i(78583),g=e.i(37727),x=e.i(87951),f=e.i(52044),y=e.i(95242),v=e.i(31278),b=e.i(43531),w=e.i(94771),j=e.i(27612),N=e.i(64659),k=e.i(72520),C=e.i(46932),S=e.i(88653),T=e.i(20682),E=e.i(14050),I=e.i(16637),P=e.i(73042),R=e.i(27651),A=e.i(26428),L=e.i(73493),$=e.i(93226),B=e.i(37496);function D(){let e=(0,r.useRouter)(),{toast:B}=(0,T.useToast)(),{showNotification:D,requestPermission:z}=(0,I.useNotifications)(),{isOnline:U,lastSeen:M,checkStatus:O}=(0,R.useAdminPresence)({enabled:!0,heartbeatInterval:2e4}),{user:F,isAuthenticated:V}=(0,$.useAuthStore)(),[H,W]=(0,a.useState)([{id:"1",text:"سلام! خوش آمدید. برای خرید سریع لطفاً اطلاعات زیر را وارد کنید:",sender:"support",timestamp:new Date}]),[q,J]=(0,a.useState)(""),[G,K]=(0,a.useState)(null),[_,X]=(0,a.useState)(null),[Q,Y]=(0,a.useState)("chat"),Z=(0,a.useCallback)(()=>F?{name:F.name||"",phone:F.phone||"",email:""}:{name:"",phone:"",email:""},[F]),[ee,et]=(0,a.useState)(Z);(0,a.useEffect)(()=>{et(Z())},[F,Z]);let[ea,er]=(0,a.useState)([]),[es,ei]=(0,a.useState)(!1),[en,eo]=(0,a.useState)(!1),[el,ec]=(0,a.useState)(0),[ed,eu]=(0,a.useState)(null),[em,eh]=(0,a.useState)(null),[ep,eg]=(0,a.useState)(!1),[ex,ef]=(0,a.useState)(!1),[ey,ev]=(0,a.useState)(!1),[eb,ew]=(0,a.useState)(!1),[ej,eN]=(0,a.useState)(null),ek=(0,a.useRef)(null),eC=(0,a.useRef)(null),eS=(0,a.useRef)(null),eT=(0,a.useRef)(null),eE=(0,a.useRef)(null),eI=(0,a.useRef)(null),eP=(0,a.useRef)(null),eR=(0,a.useRef)(null);(0,a.useRef)(!1);let eA=(0,a.useRef)(!1),eL=(0,a.useCallback)(async t=>{try{await new Promise(e=>setTimeout(e,200));let a=null,r=null;for(let s=0;s<3;s++)try{$.useAuthStore.getState().user;let r={"Cache-Control":"no-cache","Content-Type":"application/json"};if((a=await fetch("/api/chat/my",{method:"GET",credentials:"include",cache:"no-store",headers:r})).ok)break;if(401===a.status){let a=await fetch("/api/auth/me",{credentials:"include",cache:"no-store"}),r=await a.json().catch(()=>null);if(!a.ok||!r?.success||!r?.data?.authenticated)return t?.silent||e.push("/auth?redirect="+encodeURIComponent(window.location.pathname)),null;if(s<2){await new Promise(e=>setTimeout(e,500));continue}}break}catch(e){r=e instanceof Error?e:Error(String(e)),s<2&&await new Promise(e=>setTimeout(e,500))}if(!a)throw r||Error("Failed to fetch chat");let s=await a.json().catch(()=>null);if(!a.ok||!s?.success||!s?.data?.chatId){let e=s?.error||s?.message||"خطا در دریافت چت";throw Error(e)}let i=String(s.data.chatId);return eN(i),Y("chat"),i}catch(e){return t?.silent||B({title:"خطا",description:e instanceof Error?e.message:"خطا در دریافت چت",variant:"destructive"}),null}},[B]),e$=(0,a.useCallback)(async t=>{let a=t||ej;if(a)try{let t=await fetch(`/api/chat?chatId=${a}`,{credentials:"include"});if(!t.ok){if(401===t.status)return void e.push("/auth?redirect="+encodeURIComponent(window.location.pathname));return}let r=await t.json();if(r.success&&r.data?.messages){let e=r.data.messages.map(e=>({id:e.id,text:e.text||"",sender:e.sender,timestamp:new Date(e.createdAt),attachments:e.attachments?Array.isArray(e.attachments)?e.attachments:JSON.parse(e.attachments):[],status:e.status||("user"===e.sender?"sent":void 0)}));W(t=>{let a=new Set(e.map(e=>e.id)),r=new Set(t.map(e=>e.id)),s=e.filter(e=>!r.has(e.id)),i=t.filter(e=>e.id.startsWith("temp-")||a.has(e.id)).map(t=>{let a=e.find(e=>e.id===t.id);return a&&"user"===t.sender&&a.status&&t.status!==a.status?{...t,status:a.status}:t});return s.length>0?[...i,...s]:i})}}catch(e){L.logger.error("Error polling messages:",e)}},[ej]);(0,a.useEffect)(()=>{if(!F||ej)return;let e=setTimeout(()=>{eL({silent:!0}).catch(()=>null)},500);return()=>clearTimeout(e)},[F,ej,eL]),(0,a.useEffect)(()=>{if(!ej||!F)return;e$(ej);let e=setInterval(()=>e$(ej),3e3);return()=>clearInterval(e)},[ej,e$,F]),(0,a.useCallback)(async(e,t)=>{let a=e.name?.trim(),r=e.phone?.trim(),s=e.email?.trim();if(!a||!r)return t?.silent||B({title:"خطا",description:"لطفاً نام و شماره تماس را وارد کنید",variant:"destructive"}),null;try{let e=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({customerInfo:{name:a,phone:r,email:s||void 0},messages:[]})}),t=await e.json().catch(()=>null);if(!e.ok||!t?.success){let a=t?.error||(429===e.status?"درخواست‌های شما زیاد است. لطفاً کمی بعد دوباره تلاش کنید.":null)||"خطا در ایجاد چت";throw Error(a)}let i=t.data?.id;if(!i)throw Error("خطا در ایجاد چت");return eN(i),Y("chat"),e$(i),i}catch(e){return L.logger.error("Error creating chat:",e),t?.silent||B({title:"خطا",description:e instanceof Error?e.message:"خطا در ایجاد چت. لطفاً دوباره تلاش کنید.",variant:"destructive"}),null}},[B,e$]);let eB=(0,a.useCallback)(async()=>{await eL({silent:!1})},[eL]),eD=(0,a.useCallback)(e=>{let t=Math.floor(e/60);return`${t.toString().padStart(2,"0")}:${(e%60).toString().padStart(2,"0")}`},[]),ez=(0,a.useCallback)(async()=>{try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),!0}catch(e){return ew(!0),!1}},[]),eU=(0,a.useCallback)(async()=>{try{if(!await ez())return;let e=await navigator.mediaDevices.getUserMedia({audio:!0}),t=new MediaRecorder(e);eR.current=t;let a=[];t.ondataavailable=e=>{e.data.size>0&&a.push(e.data)},t.onstop=()=>{let t=new Blob(a,{type:"audio/webm"});eh(t);let r=URL.createObjectURL(t);eu(r),e.getTracks().forEach(e=>e.stop())},t.start(),eo(!0),ec(0),eP.current=setInterval(()=>{ec(e=>e+1)},1e3)}catch(e){L.logger.error("Error starting recording:",e),B({title:"خطا",description:"خطا در شروع ضبط صدا",variant:"destructive"})}},[ez,B]),eM=(0,a.useCallback)(()=>{eR.current&&en&&(eR.current.stop(),eo(!1),eP.current&&(clearInterval(eP.current),eP.current=null))},[en]),eO=(0,a.useCallback)(()=>{eM(),eu(null),eh(null),ec(0)},[eM]),eF=(0,a.useCallback)(async()=>{if(L.logger.info("saveRecording called",{hasAudioBlob:!!em,hasAudioUrl:!!ed}),console.log("[Voice] saveRecording called",{hasAudioBlob:!!em,hasAudioUrl:!!ed,audioBlobSize:em?.size,audioUrl:ed}),!em||!ed){L.logger.warn("No audio blob or URL available"),console.log("[Voice] No audio blob or URL available, returning"),B({title:"خطا",description:"هیچ ضبط صوتی موجود نیست",variant:"destructive"});return}try{eg(!0),console.log("[Voice] Starting upload...");let e=new FormData;e.append("file",em,"recording.webm"),e.append("type","audio");let t=await fetch("/api/chat/upload",{method:"POST",credentials:"include",body:e});if(!t.ok)throw Error("خطا در آپلود فایل");let a=await t.json();if(console.log("[Voice] Upload response:",a),a.success&&a.data?.url){let e={id:"undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`audio-${Date.now()}-${Math.random().toString(36).substr(2,9)}-${performance.now()}`,type:"audio",url:a.data.url,name:"پیام صوتی",duration:el};console.log("[Voice] Adding attachment:",e),er(t=>{if(t.some(t=>t.id===e.id))return console.log("[Voice] Attachment already exists, skipping"),t;let a=[...t,e];return console.log("[Voice] New attachments:",a),a}),eu(null),eh(null),ec(0),eA.current=!0,console.log("[Voice] shouldAutoSendRef set to true")}else console.error("[Voice] Upload failed:",a)}catch(e){L.logger.error("Error saving recording:",e),B({title:"خطا",description:"خطا در ذخیره پیام صوتی",variant:"destructive"})}finally{eg(!1)}},[em,ed,el,B]),eV=(0,a.useCallback)(async(e,t)=>{let a=e.target.files;if(a&&0!==a.length){try{for(let e=0;e<a.length;e++){let r=a[e],s=new FormData;s.append("file",r),s.append("type",t);let i={};F?.id&&(i["x-user-id"]=F.id);let n=await fetch("/api/chat/upload",{method:"POST",credentials:"include",headers:i,body:s});if(!n.ok){let e=await n.json().catch(()=>null),t=e?.error||e?.message||"خطا در آپلود فایل";throw Error(t)}let o=await n.json();if(o.success&&o.data?.url){let a={id:`${t}-${Date.now()}-${e}-${Math.random().toString(36).substr(2,9)}`,type:t,url:o.data.url,name:r.name,size:r.size};er(e=>[...e,a])}}}catch(e){L.logger.error("Error uploading file:",e),B({title:"خطا",description:"خطا در آپلود فایل",variant:"destructive"})}e.target&&(e.target.value="")}},[B,e]),eH=(0,a.useCallback)(()=>{if(L.logger.info("handleLocationShare called"),console.log("[Location] handleLocationShare called"),!navigator.geolocation){L.logger.warn("Geolocation not supported"),console.log("[Location] Geolocation not supported"),B({title:"خطا",description:"مرورگر شما از موقعیت‌یابی پشتیبانی نمی‌کند",variant:"destructive"});return}let e="https:"===window.location.protocol||"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname;if(console.log("[Location] Protocol:",window.location.protocol,"Hostname:",window.location.hostname,"IsSecure:",e),!e){L.logger.warn("Not on secure origin"),console.log("[Location] Not on secure origin"),B({title:"خطا",description:"برای استفاده از موقعیت‌یابی باید از HTTPS استفاده کنید. لطفاً از آدرس امن سایت استفاده کنید.",variant:"destructive"});return}B({title:"در حال دریافت موقعیت...",description:"لطفاً اجازه دسترسی به موقعیت را در مرورگر بدهید",duration:3e3}),L.logger.info("Requesting geolocation permission..."),console.log("[Location] Requesting geolocation permission..."),navigator.geolocation.getCurrentPosition(e=>{L.logger.info("Location received:",e.coords),console.log("[Location] Position received:",e.coords);let{latitude:t,longitude:a}=e.coords,r=`https://www.google.com/maps?q=${t},${a}`,s={id:`location-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"location",url:r,name:"موقعیت من"};console.log("[Location] Adding attachment:",s),er(e=>{let t=[...e,s];return console.log("[Location] New attachments:",t),t}),ei(!1),eA.current=!0,console.log("[Location] shouldAutoSendRef set to true")},e=>{L.logger.error("Error getting location:",e);let t="خطا در دریافت موقعیت";1===e.code?t="دسترسی به موقعیت رد شد. لطفاً در تنظیمات مرورگر اجازه دسترسی به موقعیت را فعال کنید.":2===e.code?t="موقعیت در دسترس نیست. لطفاً مطمئن شوید که GPS فعال است.":3===e.code&&(t="دریافت موقعیت زمان‌بر شد. لطفاً دوباره تلاش کنید."),B({title:"خطا",description:t,variant:"destructive"})},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})},[B]),eW=(0,a.useCallback)(e=>{er(t=>t.filter(t=>t.id!==e))},[]),eq=(0,a.useCallback)(async e=>{if(ej)try{await fetch("/api/chat/typing",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:ej,sender:"user",isTyping:e})})}catch(e){}},[ej]);(0,a.useEffect)(()=>{F&&et({name:F.name||"",phone:F.phone||"",email:""})},[F]);let eJ=(0,a.useCallback)(async()=>{if(ej)try{let e=await fetch(`/api/chat/typing?chatId=${ej}&sender=support`,{credentials:"include"});if(e.ok){let t=await e.json();t.success&&ef(t.data?.isTyping||!1)}}catch(e){}},[ej]),eG=(0,a.useCallback)(async()=>{if(!F){B({title:"خطا",description:"برای ارسال پیام باید وارد حساب کاربری خود شوید",variant:"destructive"}),e.push("/auth?redirect="+encodeURIComponent(window.location.pathname));return}let t=ej;if(!t){let e=await eL({silent:!0});if(!e)return void B({title:"خطا",description:"چت آماده نیست. لطفاً دوباره تلاش کنید",variant:"destructive"});t=e}let a=eS.current?.value??q;if(!a.trim()&&0===ea.length)return;if(!F||!F.name||!F.phone){B({title:"خطا",description:"اطلاعات کاربری کامل نیست. لطفاً دوباره وارد شوید",variant:"destructive"}),e.push("/auth?redirect="+encodeURIComponent(window.location.pathname));return}if(_){try{(await fetch(`/api/chat/message/${_.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({text:a,attachments:ea})})).ok&&(W(e=>e.map(e=>e.id===_.id?{...e,text:a,attachments:ea}:e)),X(null),J(""),er([]))}catch(e){L.logger.error("Error editing message:",e)}return}let r=`temp-${Date.now()}`,s={id:r,text:q,sender:"user",timestamp:new Date,attachments:ea,status:"sending"};W(e=>[...e,s]),J(""),er([]),K(null),eI.current&&(clearTimeout(eI.current),eI.current=null),eq(!1);try{let i={id:r,text:a,sender:"user",timestamp:s.timestamp.toISOString(),attachments:ea.filter(e=>{let t=e.url;return t&&!t.startsWith("blob:")&&!t.startsWith("data:")&&(t.startsWith("http")||t.startsWith("/"))}),status:"sent"},n={name:F.name||"",phone:F.phone||"",email:ee.email||""},o=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:t,customerInfo:n,messages:[i]})});if(!o.ok){let t=await o.json().catch(()=>({}));if(401===o.status){B({title:"خطا",description:"جلسه شما منقضی شده است. لطفاً دوباره وارد شوید",variant:"destructive"}),e.push("/auth?redirect="+encodeURIComponent(window.location.pathname));return}let a="string"==typeof t?.error&&t.error||"string"==typeof t?.error?.message&&t.error.message||"string"==typeof t?.message&&t.message||(429===o.status?"درخواست‌های شما زیاد است. لطفاً کمی بعد دوباره تلاش کنید.":null)||`خطا در ارسال پیام (HTTP ${o.status})`;throw Error(a)}let l=await o.json();if(l.success&&l.data?.messages&&l.data.messages.length>0){let e=l.data.messages[0];requestAnimationFrame(()=>{W(t=>t.map(t=>t.id===r?{...t,id:e.id,text:e.text||t.text,status:e.status||"sent",attachments:e.attachments||t.attachments}:t))}),l.data.chatId&&l.data.chatId!==t&&eN(l.data.chatId)}setTimeout(()=>{e$(t)},1e3)}catch(e){L.logger.error("Error sending message:",e),W(e=>e.filter(e=>e.id!==r)),B({title:"خطا",description:e instanceof Error?e.message:"خطا در ارسال پیام",variant:"destructive"})}setTimeout(()=>{e_(!1)},100)},[ej,ea,G,_,eq,B,Y,eL,e$,V,F,e]);(0,a.useEffect)(()=>{if(eA.current&&ea.length>0){eA.current=!1;let e=setTimeout(()=>{eG()},200);return()=>clearTimeout(e)}},[ea,eG]),(0,a.useCallback)(e=>{K(e),X(null)},[]),(0,a.useCallback)(e=>{X(e),K(null),J(e.text||"")},[]);let eK=(0,a.useCallback)(async e=>{try{let t=await fetch(`/api/chat/message/${e}`,{method:"DELETE",credentials:"include",headers:{"Content-Type":"application/json"}}),a=await t.json().catch(()=>({}));if(t.ok)W(t=>t.filter(t=>t.id!==e)),setTimeout(()=>{e$()},500),B({title:"موفق",description:"پیام با موفقیت حذف شد"});else{let e=a.error||a.message||`خطا در حذف پیام (${t.status})`;B({title:"خطا",description:e,variant:"destructive"})}}catch(e){L.logger.error("Error deleting message:",e),B({title:"خطا",description:"خطا در حذف پیام",variant:"destructive"})}},[B]),e_=(0,a.useCallback)((e=!1)=>{ek.current&&ek.current.scrollIntoView({behavior:e?"auto":"smooth",block:"end"})},[]),eX=(0,a.useCallback)(()=>{if(!eC.current)return void ev(!1);let e=eC.current;ev(e.scrollHeight-e.scrollTop-e.clientHeight>150)},[]);return(0,a.useEffect)(()=>{if(!ej||"chat"!==Q)return;e$();let e=setInterval(()=>{e$(),eJ()},3e3);return()=>clearInterval(e)},[ej,Q,e$,eJ]),(0,a.useEffect)(()=>{H.length>0&&"chat"===Q&&setTimeout(()=>{e_(!0),eX()},100)},[H.length,Q,e_,eX]),(0,a.useEffect)(()=>{let e=eC.current;if(!e)return;let t=()=>{eX()};return e.addEventListener("scroll",t,{passive:!0}),()=>e.removeEventListener("scroll",t)},[eX]),(0,a.useEffect)(()=>{z()},[z]),(0,a.useEffect)(()=>{let e=document.body.style.overflow,t=document.documentElement.style.overflow;return document.body.style.overflow="hidden",document.documentElement.style.overflow="hidden",()=>{document.body.style.overflow=e,document.documentElement.style.overflow=t}},[]),(0,t.jsx)("div",{className:"flex flex-col overflow-hidden",style:{height:"100dvh"},children:(0,t.jsx)("div",{className:"flex-1 flex justify-center w-full min-h-0",children:(0,t.jsxs)("main",{className:"flex-1 flex flex-col min-h-0 overflow-hidden w-full md:max-w-2xl lg:max-w-3xl h-full",children:[(0,t.jsx)("div",{className:"flex-shrink-0 border-b border-border/40 px-4 sm:px-6 py-3 bg-background/95 backdrop-blur-sm",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:()=>e.back(),className:"h-8 w-8 rounded-lg",children:(0,t.jsx)(k.ArrowRight,{className:"h-4 w-4"})}),(0,t.jsx)("div",{className:"flex-1 min-w-0",children:(0,t.jsxs)("h1",{className:"text-base font-semibold text-foreground flex items-center gap-2",children:["پشتیبانی و خرید سریع","chat"===Q&&(0,t.jsx)(P.OnlineStatusBadge,{isOnline:U,lastSeen:M,showText:!1})]})})]})}),(0,t.jsx)("div",{className:"flex-1 flex flex-col min-h-0 overflow-hidden",children:"info"===Q?(0,t.jsxs)("div",{className:"flex-1 overflow-y-auto p-6 sm:p-8 space-y-6 bg-gradient-to-b from-background via-background to-muted/10",children:[(0,t.jsxs)(C.motion.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"text-center pb-2",children:[(0,t.jsx)("div",{className:"inline-flex items-center justify-center w-16 h-16 rounded-full bg-gradient-to-br from-primary/20 to-accent/20 mb-3 shadow-lg",children:(0,t.jsx)(l.MessageCircle,{className:"h-8 w-8 text-primary"})}),(0,t.jsx)("p",{className:"text-sm text-muted-foreground leading-relaxed",children:"لطفاً اطلاعات زیر را برای شروع خرید سریع وارد کنید"})]}),(0,t.jsxs)(C.motion.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"space-y-5",children:[(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("label",{className:"text-sm font-semibold text-foreground flex items-center gap-2",children:[(0,t.jsxs)("svg",{className:"h-4 w-4 text-primary",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:[(0,t.jsx)("path",{d:"M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"}),(0,t.jsx)("circle",{cx:"12",cy:"7",r:"4",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"})]}),"نام و نام خانوادگی",(0,t.jsx)("span",{className:"text-destructive text-xs",children:"*"})]}),(0,t.jsx)(n.Input,{type:"text",placeholder:"مثال: علی احمدی",value:ee.name,onChange:e=>et({...ee,name:e.target.value}),className:"h-12 text-base border-2 border-border/40 focus:border-primary/60 focus:ring-2 focus:ring-primary/20 rounded-xl transition-all bg-background/50 hover:bg-background"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("label",{className:"text-sm font-semibold text-foreground flex items-center gap-2",children:[(0,t.jsx)(c.Phone,{className:"h-4 w-4 text-primary"}),"شماره تماس",(0,t.jsx)("span",{className:"text-destructive text-xs",children:"*"})]}),(0,t.jsx)(n.Input,{type:"tel",placeholder:"09123456789",value:ee.phone,onChange:e=>et({...ee,phone:e.target.value}),className:"h-12 text-base border-2 border-border/40 focus:border-primary/60 focus:ring-2 focus:ring-primary/20 rounded-xl transition-all bg-background/50 hover:bg-background"})]}),(0,t.jsxs)("div",{className:"space-y-2",children:[(0,t.jsxs)("label",{className:"text-sm font-semibold text-foreground flex items-center gap-2",children:[(0,t.jsx)(d.Mail,{className:"h-4 w-4 text-primary"}),"ایمیل",(0,t.jsx)("span",{className:"text-xs text-muted-foreground font-normal",children:"(اختیاری)"})]}),(0,t.jsx)(n.Input,{type:"email",placeholder:"example@email.com",value:ee.email,onChange:e=>et({...ee,email:e.target.value}),className:"h-12 text-base border-2 border-border/40 focus:border-primary/60 focus:ring-2 focus:ring-primary/20 rounded-xl transition-all bg-background/50 hover:bg-background"})]})]}),(0,t.jsxs)(C.motion.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.15},className:"pt-2",children:[(0,t.jsx)(s.Button,{onClick:eB,disabled:!ee.name||!ee.phone,className:"w-full h-13 text-base font-semibold bg-gradient-to-r from-primary via-primary to-primary/90 hover:from-primary/90 hover:via-primary/80 hover:to-primary/70 shadow-lg shadow-primary/30 hover:shadow-xl hover:shadow-primary/40 transition-all duration-300 disabled:opacity-50 disabled:shadow-none disabled:cursor-not-allowed rounded-xl",children:(0,t.jsxs)("span",{className:"flex items-center justify-center gap-2",children:["ادامه",(0,t.jsx)(C.motion.div,{animate:{x:[0,4,0]},transition:{repeat:1/0,duration:1.5,delay:.5},children:"→"})]})}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground text-center mt-3",children:"با ادامه، شما شرایط و قوانین ما را می‌پذیرید"})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{ref:eC,className:"flex-1 min-h-0 overflow-y-auto p-5 sm:p-6 md:p-8 space-y-5 sm:space-y-6 bg-gradient-to-b from-background via-background/95 to-muted/5 scroll-smooth",children:[0===H.length&&(0,t.jsxs)(C.motion.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"flex flex-col items-center justify-center h-full min-h-[200px] text-center px-4",children:[(0,t.jsx)("div",{className:"w-20 h-20 rounded-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center mb-4 shadow-lg",children:(0,t.jsx)(l.MessageCircle,{className:"h-10 w-10 text-primary/60"})}),(0,t.jsx)("p",{className:"text-muted-foreground text-base font-medium leading-relaxed",children:"هنوز پیامی ارسال نشده است"}),(0,t.jsx)("p",{className:"text-muted-foreground/70 text-sm mt-2 leading-relaxed",children:"پیام خود را بنویسید..."})]}),(0,t.jsxs)("div",{className:"space-y-3",children:[H.map(e=>(0,t.jsx)(C.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:`flex ${"user"===e.sender?"justify-end":"justify-start"} items-end gap-2 group`,children:(0,t.jsxs)("div",{className:`max-w-[85%] sm:max-w-[75%] md:max-w-[70%] rounded-lg px-2.5 sm:px-3 py-2 transition-all ${"user"===e.sender?"bg-primary text-primary-foreground":"bg-muted text-foreground border border-border/40"}`,children:[e.text&&(0,t.jsx)("p",{className:"text-xs sm:text-sm leading-relaxed whitespace-pre-wrap break-words mb-1.5",children:e.text}),e.attachments&&e.attachments.length>0&&(0,t.jsx)("div",{className:`space-y-2 ${e.text?"mt-2":""}`,children:e.attachments.map(e=>(0,t.jsxs)("div",{className:"rounded-xl overflow-hidden",children:["image"===e.type&&e.url&&(0,t.jsx)("img",{src:e.url,alt:e.name||"تصویر",className:"max-w-full max-h-[150px] sm:max-h-[180px] rounded cursor-pointer hover:opacity-90 transition-all",onClick:()=>window.open(e.url,"_blank")}),"file"===e.type&&(0,t.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",download:e.name,className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,t.jsx)(p.FileText,{className:"h-3.5 w-3.5"}),(0,t.jsx)("span",{className:"font-medium truncate",children:e.name||"فایل"})]}),"location"===e.type&&(0,t.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,t.jsx)(h.MapPin,{className:"h-3.5 w-3.5"}),(0,t.jsx)("span",{className:"font-medium",children:e.name||"موقعیت"})]}),"audio"===e.type&&e.url&&(0,t.jsx)(E.AudioPlayer,{url:e.url,duration:e.duration})]},e.id))}),(0,t.jsxs)("div",{className:`flex items-center gap-1.5 mt-1.5 pt-1.5 border-t ${"user"===e.sender?"border-primary-foreground/20 justify-end":"border-border/30 justify-start"}`,children:[(0,t.jsx)("span",{className:`text-[10px] sm:text-xs ${"user"===e.sender?"text-primary-foreground/70":"text-muted-foreground"}`,children:new Date(e.timestamp).toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}),"user"===e.sender&&(0,t.jsxs)(t.Fragment,{children:["sending"===e.status&&(0,t.jsx)(v.Loader2,{className:"h-3 w-3 text-primary-foreground/50 animate-spin"}),"sent"===e.status&&(0,t.jsx)(b.Check,{className:"h-3 w-3 text-primary-foreground/40"}),"delivered"===e.status&&(0,t.jsx)(w.CheckCheck,{className:"h-3 w-3 text-primary-foreground/40"}),"read"===e.status&&(0,t.jsx)(w.CheckCheck,{className:"h-3 w-3 text-primary-foreground/70"}),!e.status&&(0,t.jsx)(b.Check,{className:"h-3 w-3 text-primary-foreground/40"})]}),"user"===e.sender&&(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 hover:bg-destructive/10 text-destructive hover:text-destructive opacity-70 hover:opacity-100 transition-opacity",onClick:t=>{t.stopPropagation(),confirm("آیا مطمئن هستید که می‌خواهید این پیام را حذف کنید؟")&&eK(e.id)},title:"حذف پیام",children:(0,t.jsx)(j.Trash2,{className:"h-3.5 w-3.5"})})]})]})},e.id)),ex&&(0,t.jsx)(C.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex justify-start items-end gap-2.5",children:(0,t.jsx)(A.TypingIndicator,{})}),(0,t.jsx)("div",{ref:ek})]})]}),(0,t.jsxs)("div",{className:"flex-shrink-0 border-t border-border/40 bg-background/95 backdrop-blur-sm p-2 sm:p-3 space-y-2 relative",children:[(0,t.jsx)(S.AnimatePresence,{children:ey&&(0,t.jsx)(C.motion.div,{initial:{opacity:0,y:10,scale:.9},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.9},className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 z-10",children:(0,t.jsx)(s.Button,{onClick:()=>e_(!1),size:"icon",className:"h-9 w-9 rounded-full shadow-lg hover:shadow-xl bg-primary text-primary-foreground hover:bg-primary/90 transition-all",title:"برو به آخرین پیام",children:(0,t.jsx)(N.ChevronDown,{className:"h-4 w-4"})})})}),(en||ed)&&(0,t.jsx)(C.motion.div,{initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},className:"flex items-center gap-2 p-2 bg-destructive/10 border border-destructive/30 rounded-lg",children:en?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(C.motion.div,{animate:{scale:[1,1.1,1]},transition:{repeat:1/0,duration:1},className:"p-1.5 rounded-full bg-destructive/20",children:(0,t.jsx)(x.Mic,{className:"h-3.5 w-3.5 text-destructive"})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-xs font-medium text-destructive leading-tight",children:"در حال ضبط"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground font-mono",children:eD(el)})]}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:eM,className:"h-7 w-7 text-destructive hover:bg-destructive/10 rounded-lg",children:(0,t.jsx)(f.Square,{className:"h-3 w-3 fill-current"})})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"p-1.5 rounded-full bg-primary/20",children:(0,t.jsx)(x.Mic,{className:"h-3.5 w-3.5 text-primary"})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-xs font-medium leading-tight",children:"پیام صوتی آماده است"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground font-mono",children:eD(el)})]}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:eO,className:"h-7 w-7 text-muted-foreground hover:text-destructive rounded-lg",children:(0,t.jsx)(g.X,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{onClick:e=>{e.preventDefault(),e.stopPropagation(),console.log("[Voice] Save button clicked!"),eF()},size:"sm",className:"h-7 px-3 text-xs rounded-lg",title:"ذخیره و ارسال پیام صوتی",children:"ذخیره"})]})}),es&&(0,t.jsxs)(C.motion.div,{initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},className:"flex gap-2 p-2 bg-card rounded-lg border border-border/50 shadow-lg",onClick:e=>{console.log("[Attachment Options] Container clicked!",e.target)},children:[(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:()=>{eT.current?.click(),ei(!1)},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",children:(0,t.jsx)(u.Image,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:()=>{eE.current?.click(),ei(!1)},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",children:(0,t.jsx)(p.FileText,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:e=>{e.preventDefault(),e.stopPropagation(),console.log("[Location] Button clicked!"),eH(),ei(!1)},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",title:"اشتراک‌گذاری موقعیت مکانی",children:(0,t.jsx)(h.MapPin,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:async e=>{if(e.preventDefault(),e.stopPropagation(),console.log("[Voice] Button clicked!"),ei(!1),en)eM();else{if(B({title:"در حال درخواست دسترسی...",description:"لطفاً اجازه دسترسی به میکروفون را در مرورگر بدهید",duration:3e3}),!await ez())return void B({title:"نیاز به دسترسی میکروفون",description:"برای ضبط صدا، لطفاً دسترسی میکروفون را در تنظیمات مرورگر فعال کنید.",variant:"destructive",duration:5e3});eU()}},title:"ضبط پیام صوتی",className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",disabled:en,children:en?(0,t.jsx)(y.Pause,{className:"h-3.5 w-3.5 text-destructive"}):(0,t.jsx)(x.Mic,{className:"h-3.5 w-3.5"})})]}),(0,t.jsx)("input",{ref:eT,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:e=>eV(e,"image")}),(0,t.jsx)("input",{ref:eE,type:"file",multiple:!0,className:"hidden",onChange:e=>eV(e,"file")}),(0,t.jsx)("div",{className:"flex items-end gap-2",children:(0,t.jsxs)("div",{className:"flex-1 relative",children:[ea.length>0&&(0,t.jsx)("div",{className:"absolute top-2 right-2 left-2 z-10 pointer-events-none overflow-hidden",children:(0,t.jsx)("div",{className:"overflow-x-auto overflow-y-hidden scroll-smooth w-full [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]",children:(0,t.jsx)("div",{className:"flex items-center gap-1.5 flex-nowrap",children:ea.map(e=>(0,t.jsxs)("div",{className:"relative group pointer-events-auto flex-shrink-0 w-auto",children:[(0,t.jsxs)("div",{className:"bg-card/95 backdrop-blur-sm rounded-md p-1 border border-border/40 shadow-sm",children:["image"===e.type&&e.url&&(0,t.jsx)("img",{src:e.url,alt:e.name||"تصویر",className:"w-10 h-10 object-cover rounded"}),"file"===e.type&&(0,t.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,t.jsx)(p.FileText,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,t.jsx)("p",{className:"text-[10px] truncate max-w-[50px] font-medium leading-tight",children:e.name})]}),"location"===e.type&&(0,t.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,t.jsx)(h.MapPin,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,t.jsx)("span",{className:"text-[10px] font-medium whitespace-nowrap leading-tight",children:"موقعیت"})]}),"audio"===e.type&&(0,t.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,t.jsx)(x.Mic,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,t.jsx)("span",{className:"text-[10px] font-medium whitespace-nowrap leading-tight",children:e.duration?eD(e.duration):"صدا"})]})]}),(0,t.jsx)("button",{onClick:()=>eW(e.id),className:"absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm z-20 hover:scale-110",children:(0,t.jsx)(g.X,{className:"h-2.5 w-2.5"})})]},e.id))})})}),(0,t.jsx)(i.Textarea,{ref:eS,value:q,onChange:e=>{J(e.target.value),eI.current&&clearTimeout(eI.current),e.target.value.trim().length>0?(eq(!0),eI.current=setTimeout(()=>{eq(!1)},2e3)):eq(!1)},onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),eI.current&&clearTimeout(eI.current),eq(!1),eG())},placeholder:"پیام خود را بنویسید...",className:`min-h-[44px] max-h-[100px] resize-none text-sm leading-relaxed rounded-lg border pr-20 pl-3 py-2 ${ea.length>0?"pt-12":""}`}),(0,t.jsxs)("div",{className:"absolute bottom-2 right-2 flex items-center gap-1",children:[(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:e=>{e.preventDefault(),e.stopPropagation(),console.log("[Paperclip] Button clicked! showAttachmentOptions:",!es),ei(!es)},className:`h-7 w-7 rounded-lg transition-all ${es?"bg-primary/10 text-primary":"hover:bg-muted/60 text-muted-foreground hover:text-foreground"}`,children:(0,t.jsx)(m.Paperclip,{className:"h-4 w-4"})}),!en&&(0,t.jsx)(t.Fragment,{children:ep?(0,t.jsx)(v.Loader2,{className:"h-4 w-4 text-primary animate-spin"}):(0,t.jsx)(s.Button,{onClick:eG,size:"icon",className:"h-7 w-7 rounded-lg transition-all",children:(0,t.jsx)(o.Send,{className:"h-3.5 w-3.5"})})})]})]})})]})]})})]})})})}function z(){return(0,t.jsx)(B.ProtectedRoute,{requireAuth:!0,children:(0,t.jsx)(D,{})})}e.s(["default",()=>z])}]);