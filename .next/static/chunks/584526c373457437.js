(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,82429,e=>{"use strict";var t=e.i(43476),a=e.i(71645),r=e.i(52917),s=e.i(67881),i=e.i(23750),n=e.i(94983),l=e.i(55436),o=e.i(84614),c=e.i(43432),d=e.i(37727),u=e.i(31278),m=e.i(64659),h=e.i(46932),p=e.i(88653),g=e.i(20682),x=e.i(27651),f=e.i(73042),v=e.i(26428),w=e.i(94179),y=e.i(73493),b=e.i(94771),j=e.i(78583),N=e.i(46897),C=e.i(87951),k=e.i(29006),S=e.i(92930),T=e.i(27612),M=e.i(23585),E=e.i(63415);function R({message:e,index:a,totalMessages:r,onReply:i,onEdit:n,onDelete:l}){return(0,t.jsx)(h.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},transition:{duration:.2,ease:"easeOut"},className:`flex ${"user"===e.sender?"justify-end":"justify-start"} items-end gap-2 group`,children:(0,t.jsxs)("div",{className:`max-w-[85%] sm:max-w-[75%] md:max-w-[70%] rounded-lg px-2.5 sm:px-3 py-2 transition-all ${"user"===e.sender?"bg-primary text-primary-foreground":"bg-muted text-foreground border border-border/40"}`,children:[e.text&&(0,t.jsx)("p",{className:"text-xs sm:text-sm leading-relaxed whitespace-pre-wrap break-words mb-1.5",children:e.text}),e.attachments&&e.attachments.length>0&&(0,t.jsx)("div",{className:`space-y-2 ${e.text?"mt-2":""}`,children:e.attachments.map((e,a)=>(0,t.jsxs)("div",{className:"rounded overflow-hidden",children:["image"===e.type&&e.url&&(0,t.jsx)("img",{src:e.url,alt:e.name||"تصویر",className:"max-w-full max-h-[150px] sm:max-h-[180px] rounded cursor-pointer hover:opacity-90 transition-all",onClick:()=>window.open(e.url,"_blank")}),"file"===e.type&&(0,t.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",download:e.name,className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,t.jsx)(j.FileText,{className:"h-3.5 w-3.5"}),(0,t.jsx)("span",{className:"font-medium truncate",children:e.name||"فایل"})]}),"location"===e.type&&(0,t.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,t.jsx)(N.MapPin,{className:"h-3.5 w-3.5"}),(0,t.jsx)("span",{className:"font-medium",children:e.name||"موقعیت"})]}),"audio"===e.type&&e.url&&(0,t.jsxs)("div",{className:"flex items-center gap-2 p-2 bg-background/50 rounded",children:[(0,t.jsx)(C.Mic,{className:"h-3.5 w-3.5"}),(0,t.jsx)("audio",{controls:!0,className:"flex-1 h-7 text-xs",children:(0,t.jsx)("source",{src:e.url})})]})]},e.id||a))}),(0,t.jsxs)("div",{className:`flex items-center gap-1.5 mt-1.5 pt-1.5 border-t ${"user"===e.sender?"border-primary-foreground/20 justify-end":"border-border/30 justify-start"}`,children:[(0,t.jsx)("span",{className:`text-[10px] sm:text-xs ${"user"===e.sender?"text-primary-foreground/70":"text-muted-foreground"}`,children:new Date(e.timestamp).toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}),e.status&&"user"===e.sender&&(0,t.jsx)(b.CheckCheck,{className:`h-3 w-3 ${"read"===e.status?"text-primary-foreground/70":"text-primary-foreground/40"}`}),(0,t.jsx)("div",{className:"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity",children:(i||n||l)&&(0,t.jsxs)(E.DropdownMenu,{children:[(0,t.jsx)(E.DropdownMenuTrigger,{asChild:!0,children:(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 hover:bg-background/20",onClick:e=>{e.stopPropagation()},title:"گزینه‌های بیشتر",children:(0,t.jsx)(M.MoreVertical,{className:"h-3.5 w-3.5"})})}),(0,t.jsxs)(E.DropdownMenuContent,{align:"user"===e.sender?"end":"start",className:"min-w-[140px]",onClick:e=>e.stopPropagation(),children:[i&&(0,t.jsxs)(E.DropdownMenuItem,{onClick:t=>{t.stopPropagation(),i(e)},className:"cursor-pointer",children:[(0,t.jsx)(k.Reply,{className:"h-4 w-4 ml-2"}),(0,t.jsx)("span",{children:"پاسخ"})]}),n&&"user"===e.sender&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(E.DropdownMenuSeparator,{}),(0,t.jsxs)(E.DropdownMenuItem,{onClick:t=>{t.stopPropagation(),n(e)},className:"cursor-pointer",children:[(0,t.jsx)(S.Edit2,{className:"h-4 w-4 ml-2"}),(0,t.jsx)("span",{children:"ویرایش"})]})]}),l&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(E.DropdownMenuSeparator,{}),(0,t.jsxs)(E.DropdownMenuItem,{onClick:t=>{t.stopPropagation(),confirm("آیا مطمئن هستید که می‌خواهید این پیام را حذف کنید؟")&&l(e.id)},className:"cursor-pointer text-destructive focus:text-destructive focus:bg-destructive/10",children:[(0,t.jsx)(T.Trash2,{className:"h-4 w-4 ml-2"}),(0,t.jsx)("span",{children:"حذف"})]})]})]})]})})]})]})},e.id)}var I=e.i(84762),P=e.i(14764),A=e.i(73708),D=e.i(82735),O=e.i(52044);function $({message:e,onMessageChange:a,onSend:r,isSending:i,attachments:n,onRemoveAttachment:l,showAttachmentOptions:o,onToggleAttachmentOptions:c,isRecording:m,recordingTime:g,audioUrl:x,onStartRecording:f,onStopRecording:v,onCancelRecording:w,onSaveRecording:y,formatTime:b,imageInputRef:k,fileInputRef:S,onFileSelect:T,onLocationShare:M,onCheckMicrophonePermission:E,toast:R}){return(0,t.jsxs)("div",{className:"border-t border-border/40 p-2 sm:p-3 bg-background",children:[(m||x)&&(0,t.jsx)(h.motion.div,{initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},className:"flex items-center gap-2 p-2 mb-2 bg-destructive/10 border border-destructive/30 rounded-lg",children:m?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(h.motion.div,{animate:{scale:[1,1.1,1]},transition:{repeat:1/0,duration:1},className:"p-1.5 rounded-full bg-destructive/20",children:(0,t.jsx)(C.Mic,{className:"h-3.5 w-3.5 text-destructive"})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-xs font-medium text-destructive leading-tight",children:"در حال ضبط"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground font-mono",children:b(g)})]}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:v,className:"h-7 w-7 text-destructive hover:bg-destructive/10 rounded-lg",children:(0,t.jsx)(O.Square,{className:"h-3 w-3 fill-current"})})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("div",{className:"p-1.5 rounded-full bg-primary/20",children:(0,t.jsx)(C.Mic,{className:"h-3.5 w-3.5 text-primary"})}),(0,t.jsxs)("div",{className:"flex-1",children:[(0,t.jsx)("p",{className:"text-xs font-medium leading-tight",children:"پیام صوتی آماده است"}),(0,t.jsx)("p",{className:"text-xs text-muted-foreground font-mono",children:b(g)})]}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:w,className:"h-7 w-7 text-muted-foreground hover:text-destructive rounded-lg",children:(0,t.jsx)(d.X,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{onClick:y,size:"sm",className:"h-7 px-3 text-xs rounded-lg",children:"ذخیره"})]})}),(0,t.jsx)("div",{className:"flex items-end gap-2",children:(0,t.jsxs)("div",{className:"flex-1 relative",children:[n.length>0&&(0,t.jsx)("div",{className:"absolute top-2 right-2 left-2 z-10 pointer-events-none overflow-hidden",children:(0,t.jsx)("div",{className:"overflow-x-auto overflow-y-hidden scroll-smooth w-full [&::-webkit-scrollbar]:hidden [-ms-overflow-style:none] [scrollbar-width:none]",children:(0,t.jsx)("div",{className:"flex items-center gap-1.5 flex-nowrap",children:n.map(e=>(0,t.jsxs)("div",{className:"relative group pointer-events-auto flex-shrink-0 w-auto",children:[(0,t.jsxs)("div",{className:"bg-card/95 backdrop-blur-sm rounded-md p-1 border border-border/40 shadow-sm",children:["image"===e.type&&e.url&&(0,t.jsx)("img",{src:e.url,alt:e.name||"تصویر",className:"w-10 h-10 object-cover rounded"}),"file"===e.type&&(0,t.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,t.jsx)(j.FileText,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,t.jsx)("p",{className:"text-[10px] truncate max-w-[50px] font-medium leading-tight",children:e.name})]}),"location"===e.type&&(0,t.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,t.jsx)(N.MapPin,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,t.jsx)("span",{className:"text-[10px] font-medium whitespace-nowrap leading-tight",children:"موقعیت"})]}),"audio"===e.type&&(0,t.jsxs)("div",{className:"flex items-center gap-1 px-1.5 py-1",children:[(0,t.jsx)(C.Mic,{className:"h-3 w-3 flex-shrink-0 text-primary"}),(0,t.jsx)("span",{className:"text-[10px] font-medium whitespace-nowrap leading-tight",children:e.duration?b(e.duration):"صدا"})]})]}),(0,t.jsx)("button",{onClick:()=>l(e.id),className:"absolute -top-1 -right-1 bg-destructive text-destructive-foreground rounded-full p-0.5 opacity-0 group-hover:opacity-100 transition-opacity shadow-sm z-20 hover:scale-110",children:(0,t.jsx)(d.X,{className:"h-2.5 w-2.5"})})]},e.id))})})}),(0,t.jsx)(I.Textarea,{value:e,onChange:a,onKeyDown:t=>{"Enter"===t.key&&!t.shiftKey&&(t.preventDefault(),(e.trim()||n.length>0)&&r())},placeholder:"پیام خود را بنویسید...",className:`min-h-[44px] max-h-[100px] resize-none text-sm leading-relaxed rounded-lg border pr-20 pl-3 py-2 ${n.length>0?"pt-12":""}`}),(0,t.jsx)(p.AnimatePresence,{children:o&&(0,t.jsxs)(h.motion.div,{initial:{opacity:0,y:10,scale:.95},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.95},className:"absolute bottom-full right-0 mb-2 flex gap-2 p-2 bg-card rounded-lg border border-border/50 shadow-lg z-10",children:[(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:()=>{k.current?.click(),c()},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",disabled:m,children:(0,t.jsx)(A.Image,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:()=>{S.current?.click(),c()},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",disabled:m,children:(0,t.jsx)(j.FileText,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:M,className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",disabled:m,children:(0,t.jsx)(N.MapPin,{className:"h-3.5 w-3.5"})}),(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:async()=>{c(),m?v():(await E()||R({title:"نیاز به دسترسی میکروفون",description:"برای ضبط صدا، لطفاً دسترسی میکروفون را در تنظیمات مرورگر فعال کنید.",variant:"destructive",duration:5e3}),f())},className:"h-8 w-8 hover:bg-primary/10 hover:text-primary transition-all rounded-lg",disabled:m,children:m?(0,t.jsx)(C.Mic,{className:"h-3.5 w-3.5 text-destructive"}):(0,t.jsx)(C.Mic,{className:"h-3.5 w-3.5"})})]})}),(0,t.jsx)("input",{ref:k,type:"file",accept:"image/*",multiple:!0,className:"hidden",onChange:e=>T(e,"image")}),(0,t.jsx)("input",{ref:S,type:"file",multiple:!0,className:"hidden",onChange:e=>T(e,"file")}),(0,t.jsxs)("div",{className:"absolute bottom-2 right-2 flex items-center gap-1",children:[(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:c,className:`h-7 w-7 rounded-lg transition-all ${o?"bg-primary/10 text-primary":"hover:bg-muted/60 text-muted-foreground hover:text-foreground"}`,children:(0,t.jsx)(D.Paperclip,{className:"h-4 w-4"})}),(e.trim()||n.length>0)&&!m&&(0,t.jsx)(t.Fragment,{children:i?(0,t.jsx)(u.Loader2,{className:"h-4 w-4 text-primary animate-spin"}):(0,t.jsx)(s.Button,{onClick:r,size:"icon",className:"h-7 w-7 rounded-lg transition-all",children:(0,t.jsx)(P.Send,{className:"h-3.5 w-3.5"})})})]})]})})]})}function z({isOpen:e,onOpenChange:b}){let{toast:j}=(0,g.useToast)(),{setOnline:N,isOnline:C}=(0,x.useAdminPresence)({enabled:!0,heartbeatInterval:15e3}),[k,S]=(0,a.useState)([]),[T,M]=(0,a.useState)(null),[E,I]=(0,a.useState)([]),[P,A]=(0,a.useState)(!1),[D,O]=(0,a.useState)(""),[z,B]=(0,a.useState)(!1),[F,L]=(0,a.useState)(null),[_,U]=(0,a.useState)(null),H=(0,a.useRef)(null),J=(0,a.useRef)(null),K=(0,a.useRef)(null),W=(0,a.useRef)(null),[q,X]=(0,a.useState)(!1),V=function(){let{toast:e}=(0,g.useToast)(),[t,r]=(0,a.useState)([]),[s,i]=(0,a.useState)(!1),[n,l]=(0,a.useState)(0),[o,c]=(0,a.useState)(null),[d,u]=(0,a.useState)(null),[m,h]=(0,a.useState)(!1),p=(0,a.useRef)(null),x=(0,a.useRef)([]),f=(0,a.useRef)(null),v=(0,a.useRef)(null),w=(0,a.useRef)(null),b=(0,a.useCallback)(async(t,a,r=0)=>{try{let e=new FormData;e.append("file",t),e.append("type",a);let r=await fetch("/api/chat/upload",{method:"POST",body:e});if(!r.ok){let e=await r.json().catch(()=>({error:"خطا در آپلود فایل"}));throw Error(e.error||"خطا در آپلود فایل")}return(await r.json()).data.url}catch(s){if(r<3&&(s.message?.includes("fetch")||s.message?.includes("network")||s.message?.includes("timeout")||"NETWORK_ERROR"===s.code||"TypeError"===s.name)){let s=2e3*Math.pow(2,r);return 0===r&&e({title:"در حال تلاش مجدد...",description:"خطا در آپلود فایل. در حال تلاش مجدد...",duration:2e3}),await new Promise(e=>setTimeout(e,s)),b(t,a,r+1)}throw e({title:"خطا در آپلود فایل",description:s.message||"لطفاً دوباره تلاش کنید",variant:"destructive"}),s}},[e]),j=(0,a.useCallback)(async(e,t)=>{let a=e.target.files;if(a&&0!==a.length){for(let e of Array.from(a))try{let a=await b(e,t),s={id:Date.now().toString()+Math.random(),type:t,name:e.name,size:e.size,url:a};r(e=>[...e,s])}catch(e){}e.target.value=""}},[b]),N=(0,a.useCallback)(e=>{r(t=>t.filter(t=>t.id!==e))},[]),C=(0,a.useCallback)(()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{let t={id:Date.now().toString(),type:"location",url:`https://www.google.com/maps?q=${e.coords.latitude},${e.coords.longitude}`,name:"موقعیت مکانی"};r(e=>[...e,t]),h(!1)},t=>{y.logger.error("Error getting location:",t),e({title:"خطا",description:"خطا در دریافت موقعیت مکانی",variant:"destructive"})}):e({title:"خطا",description:"مرورگر شما از موقعیت مکانی پشتیبانی نمی‌کند",variant:"destructive"})},[e]),k=(0,a.useCallback)(async()=>{try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),!0}catch(e){return!1}},[]),S=(0,a.useCallback)(async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void e({title:"مرورگر شما پشتیبانی نمی‌کند",description:"مرورگر شما از ضبط صدا پشتیبانی نمی‌کند. لطفاً از مرورگر جدیدتری استفاده کنید.",variant:"destructive"});let t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),a=new MediaRecorder(t,{mimeType:MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":MediaRecorder.isTypeSupported("audio/mp4")?"audio/mp4":"audio/webm"});p.current=a,x.current=[],a.ondataavailable=e=>{e.data.size>0&&x.current.push(e.data)},a.onstop=()=>{let e=new Blob(x.current,{type:a.mimeType||"audio/webm"});c(e);let r=URL.createObjectURL(e);u(r),t.getTracks().forEach(e=>e.stop())},a.onerror=t=>{y.logger.error("MediaRecorder error:",t),e({title:"خطا در ضبط صدا",description:"خطایی در هنگام ضبط صدا رخ داد. لطفاً دوباره تلاش کنید.",variant:"destructive"}),T()},a.start(),i(!0),l(0),h(!1),f.current=setInterval(()=>{l(e=>e+1)},1e3),e({title:"ضبط صدا شروع شد",description:"در حال ضبط پیام صوتی..."})}catch(r){let t="دسترسی به میکروفون مجاز نیست.",a="";"NotAllowedError"===r.name||"PermissionDeniedError"===r.name?(t="دسترسی به میکروفون رد شد",a="لطفاً در تنظیمات مرورگر خود، دسترسی میکروفون را فعال کنید."):"NotFoundError"===r.name||"DevicesNotFoundError"===r.name?(t="میکروفون یافت نشد",a="لطفاً مطمئن شوید که میکروفون به دستگاه شما متصل است."):"NotReadableError"===r.name||"TrackStartError"===r.name?(t="میکروفون در حال استفاده است",a="میکروفون توسط برنامه دیگری استفاده می‌شود. لطفاً آن را ببندید."):a="لطفاً دوباره تلاش کنید یا صفحه را رفرش کنید.",e({title:t,description:a,variant:"destructive",duration:5e3})}},[e]),T=(0,a.useCallback)(()=>{if(p.current&&"inactive"!==p.current.state)try{p.current.stop(),i(!1),f.current&&clearInterval(f.current),e({title:"ضبط صدا متوقف شد",description:"پیام صوتی شما آماده است. می‌توانید آن را ذخیره یا لغو کنید."})}catch(t){y.logger.error("Error stopping recording:",t),e({title:"خطا",description:"خطایی در توقف ضبط رخ داد.",variant:"destructive"})}},[e]),M=(0,a.useCallback)(()=>{T(),c(null),d&&(URL.revokeObjectURL(d),u(null)),l(0)},[d,T]),E=(0,a.useCallback)(async()=>{if(o&&d)try{let e="webm",t=o.type||"audio/webm";t.includes("mp4")||t.includes("m4a")?e="m4a":t.includes("ogg")?e="ogg":t.includes("wav")&&(e="wav");let a=new File([o],`audio-${Date.now()}.${e}`,{type:t}),s=await b(a,"audio"),i={id:Date.now().toString(),type:"audio",url:s,name:`پیام صوتی ${R(n)}`,size:o.size,duration:n};return r(e=>[...e,i]),c(null),d&&URL.revokeObjectURL(d),u(null),l(0),i}catch(e){}return null},[o,d,n,b]),R=(0,a.useCallback)(e=>{let t=Math.floor(e/60);return`${t}:${(e%60).toString().padStart(2,"0")}`},[]);return{attachments:t,setAttachments:r,isRecording:s,recordingTime:n,audioBlob:o,audioUrl:d,showAttachmentOptions:m,setShowAttachmentOptions:h,uploadFile:b,handleFileSelect:j,handleRemoveAttachment:N,handleLocationShare:C,startRecording:S,stopRecording:T,cancelRecording:M,saveRecording:E,formatTime:R,formatFileSize:(0,a.useCallback)(e=>e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB",[]),checkMicrophonePermission:k,imageInputRef:v,fileInputRef:w}}(),G=function({chatId:e,sender:t,customerInfo:r,onMessageSent:s}){let{toast:i}=(0,g.useToast)(),[n,l]=(0,a.useState)(""),[o,c]=(0,a.useState)(!1),[d,u]=(0,a.useState)(!1),m=(0,a.useRef)(null),h=(0,a.useRef)(null),p=(0,a.useCallback)(async a=>{if(e)try{await fetch("/api/chat/typing",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:e,sender:t,isTyping:a})})}catch(e){y.logger.error("Error sending typing status:",e)}},[e,t]),x=(0,a.useCallback)(t=>{l(t.target.value),e&&(m.current&&clearTimeout(m.current),t.target.value.trim().length>0?(p(!0),m.current=setTimeout(()=>{p(!1)},2e3)):p(!1))},[e,p]),f=(0,a.useCallback)(async()=>{if(e)try{let a=await fetch(`/api/chat/typing?chatId=${e}&sender=${"user"===t?"support":"user"}`);if(a.ok){let e=await a.json();e.success&&u(e.data.isTyping||!1)}}catch(e){y.logger.error("Error checking typing status:",e)}},[e,t]);(0,a.useEffect)(()=>{if(!e){u(!1),h.current&&(clearInterval(h.current),h.current=null);return}return f(),h.current=setInterval(()=>{f()},2e3),()=>{h.current&&(clearInterval(h.current),h.current=null),m.current&&(clearTimeout(m.current),m.current=null),p(!1)}},[e,f,p]);let v=(0,a.useCallback)(async(a,n=[])=>{if(!a.trim()&&0===n.length||!e)return null;let l=n.filter(e=>{let t=e.url;return t&&!t.startsWith("blob:")&&!t.startsWith("data:")&&(t.startsWith("http")||t.startsWith("/"))});if(!a.trim()&&0===l.length)return i({title:"خطا",description:"لطفاً یک پیام یا فایل معتبر اضافه کنید",variant:"destructive"}),null;let o={id:`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,text:a,sender:t,timestamp:new Date,attachments:l.length>0?l:void 0};try{c(!0),m.current&&clearTimeout(m.current),p(!1);let t={chatId:e,messages:[{id:o.id,text:o.text,sender:o.sender,timestamp:o.timestamp.toISOString(),attachments:o.attachments||[]}]};if(r&&(t.customerInfo=r),!(await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)})).ok)throw Error("خطا در ارسال پیام");return s&&s(),o}catch(e){return y.logger.error("Error sending message:",e),i({title:"خطا",description:"خطا در ارسال پیام",variant:"destructive"}),null}finally{c(!1)}},[e,t,r,i,s,p]),w=(0,a.useCallback)(async(e=[],t)=>{let a=n;t&&(a=`در پاسخ به: ${t.text}

${n}`);let r=await v(a,e);return r?(l(""),r):null},[n,v]);return{message:n,setMessage:l,isSending:o,isTyping:d,handleMessageChange:x,sendMessage:v,handleSend:w}}({chatId:T?.id||null,sender:"support",customerInfo:T?{name:T.customerName,phone:T.customerPhone,email:T.customerEmail}:void 0,onMessageSent:()=>{Q(),T&&Z(T.id,!1)}}),Q=(0,a.useCallback)(async(e=!0)=>{try{e&&A(!0);let t=await fetch("/api/chat");if(!t.ok)throw Error("خطا در بارگذاری چت‌ها");let a=await t.json();if(a.success&&a.data.chats){let e=await Promise.all(a.data.chats.map(async e=>{try{let t=await fetch(`/api/chat?chatId=${e.id}`);if(t.ok){let a=await t.json();if(a.success&&a.data.messages){let t=a.data.messages,r=t[t.length-1];return{...e,lastMessage:r?.text||"",lastMessageTime:r?.createdAt||e.updatedAt,unreadCount:e.unreadCount||0}}}}catch(e){y.logger.error("Error loading last message:",e)}return{...e,unreadCount:e.unreadCount||0}}));S(e)}}catch(t){y.logger.error("Error loading chats:",t),e&&j({title:"خطا",description:"خطا در بارگذاری چت‌ها",variant:"destructive"})}finally{e&&A(!1)}},[j]),Y=(0,a.useCallback)(async()=>{try{let e=await fetch("/api/chat");if(!e.ok)return;let t=await e.json();if(t.success&&t.data.chats){let e=t.data.chats.map(async e=>{try{let t=await fetch(`/api/chat?chatId=${e.id}`);if(t.ok){let a=await t.json();if(a.success&&a.data.messages){let t=a.data.messages,r=t[t.length-1];return{...e,lastMessage:r?.text||"",lastMessageTime:r?.createdAt||e.updatedAt,unreadCount:e.unreadCount||0}}}}catch(e){}return{...e,unreadCount:e.unreadCount||0}}),a=(await Promise.allSettled(e)).filter(e=>"fulfilled"===e.status).map(e=>e.value);S(e=>{let t=new Map(a.map(e=>[e.id,e])),r=new Set(e.map(e=>e.id)),s=e.map(e=>{let a=t.get(e.id);return a&&(a.unreadCount!==e.unreadCount||a.lastMessage!==e.lastMessage||a.lastMessageTime!==e.lastMessageTime)?{...e,...a}:e});return a.forEach(e=>{r.has(e.id)||s.push(e)}),s})}}catch(e){}},[]),Z=(0,a.useCallback)(async(e,t=!1)=>{try{t&&A(!0);let a=`/api/chat?chatId=${e}`;!t&&K.current&&(a+=`&lastMessageId=${K.current}`);let r=await fetch(a);if(!r.ok)throw Error("خطا در بارگذاری پیام‌ها");let s=await r.json();if(s.success&&s.data.messages){let e=s.data.messages.map(e=>{let t=[];if(e.attachments){if(Array.isArray(e.attachments))t=e.attachments;else if("string"==typeof e.attachments)try{let a=JSON.parse(e.attachments);t=Array.isArray(a)?a:[a]}catch(e){y.logger.error("Error parsing attachments:",e)}}return{id:e.id,text:e.text||"",sender:e.sender,timestamp:new Date(e.createdAt),attachments:t,status:e.status||("user"===e.sender?"sent":void 0)}});if(T)try{let e=await fetch(`/api/chat/unread-count?chatId=${T.id}`);if(e.ok){let t=await e.json();if(t.success&&t.data){let e=t.data.unreadCount||0;S(t=>t.map(t=>t.id===T.id?{...t,unreadCount:e}:t))}}}catch(e){}t?(I(e),e.length>0&&(K.current=e[e.length-1].id)):I(t=>{let a=new Set(t.map(e=>e.id)),r=e.filter(e=>!a.has(e.id));return r.length>0?(K.current=r[r.length-1].id,[...t,...r]):t})}}catch(e){y.logger.error("Error loading messages:",e),t&&j({title:"خطا",description:"خطا در بارگذاری پیام‌ها",variant:"destructive"})}finally{t&&A(!1)}},[T,j]),ee=(0,a.useCallback)(async e=>{try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:e,sender:"support",action:"delivered"})})}catch(e){}},[]),et=(0,a.useCallback)(async e=>{try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:e,sender:"support",action:"read"})})}catch(e){}},[]),ea=(0,a.useCallback)(async e=>{M(e),K.current=null,localStorage.setItem("admin_selected_chat_id",e.id),window.dispatchEvent(new CustomEvent("chatOpened",{detail:{chatId:e.id}})),et(e.id).catch(()=>{}),ee(e.id),Z(e.id,!0),S(t=>t.map(t=>t.id===e.id?{...t,unreadCount:0}:t))},[Z,et,ee]),er=(0,a.useCallback)(async()=>{if(T)try{let e=await fetch(`/api/chat/typing?chatId=${T.id}&sender=user`);if(e.ok){let t=await e.json();t.success&&B(t.data.isTyping||!1)}}catch(e){}},[T]),es=(0,a.useCallback)(e=>{L(e),U(null)},[]),ei=(0,a.useCallback)(e=>{U(e),L(null),G.handleMessageChange({target:{value:e.text||""}})},[G]),en=(0,a.useCallback)(async e=>{if(T)try{if((await fetch(`/api/chat/message/${e}`,{method:"DELETE"})).ok)I(t=>t.filter(t=>t.id!==e)),j({title:"موفق",description:"پیام با موفقیت حذف شد"});else throw Error("خطا در حذف پیام")}catch(e){y.logger.error("Error deleting message:",e),j({title:"خطا",description:"خطا در حذف پیام",variant:"destructive"})}},[T,j]),el=(0,a.useCallback)(async()=>{if(!T)return;if(_){try{(await fetch(`/api/chat/message/${_.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:G.message,attachments:V.attachments})})).ok&&(I(e=>e.map(e=>e.id===_.id?{...e,text:G.message,attachments:V.attachments}:e)),U(null),G.handleMessageChange({target:{value:""}}),V.setAttachments([]),j({title:"موفق",description:"پیام ویرایش شد"}))}catch(e){y.logger.error("Error editing message:",e),j({title:"خطا",description:"خطا در ویرایش پیام",variant:"destructive"})}return}let e=await G.handleSend(V.attachments,F);e&&(I(t=>[...t,e]),V.setAttachments([]),V.setShowAttachmentOptions(!1),L(null),setTimeout(()=>{ec(!1),setTimeout(()=>{eo()},500)},150),V.audioBlob&&V.audioUrl&&await V.saveRecording())},[T,G,V,_,F,j]),eo=(0,a.useCallback)(()=>{if(!J.current||!T)return void X(!1);let e=J.current;X(e.scrollHeight-e.scrollTop-e.clientHeight>150)},[T]),ec=(0,a.useCallback)((e=!1)=>{H.current&&(H.current.scrollIntoView({behavior:e?"auto":"smooth",block:"end"}),setTimeout(()=>{X(!1)},300))},[]);(0,a.useEffect)(()=>{let e=J.current;if(!e||!T)return void X(!1);let t=()=>{eo()};return e.addEventListener("scroll",t,{passive:!0}),eo(),setTimeout(()=>{eo()},100),()=>{e.removeEventListener("scroll",t)}},[T,eo,E.length]);let ed=(0,a.useRef)(!1);(0,a.useEffect)(()=>{if(T&&E.length>0&&!ed.current){ed.current=!0;let e=setTimeout(()=>{ec(!0),setTimeout(()=>{eo()},500)},200);return()=>clearTimeout(e)}T||(ed.current=!1)},[T,E.length,ec,eo]),(0,a.useEffect)(()=>{if(E.length>0&&T){let e=setTimeout(()=>{eo()},200);return()=>clearTimeout(e)}},[E.length,eo,T]),(0,a.useEffect)(()=>{if(!T||!e){B(!1),W.current&&(clearInterval(W.current),W.current=null);return}ee(T.id),et(T.id).catch(()=>{}),er(),W.current=setInterval(()=>{er()},3e3);let t=setInterval(()=>{Z(T.id,!1),ee(T.id),et(T.id).catch(()=>{})},5e3);return()=>{clearInterval(t),W.current&&(clearInterval(W.current),W.current=null)}},[T,e,er,Z,ee,et]),(0,a.useEffect)(()=>{if(e){Q(!0),M(null),I([]),localStorage.removeItem("admin_selected_chat_id"),window.dispatchEvent(new CustomEvent("chatClosed")),N(!0);let e=setInterval(()=>{Y()},15e3);return()=>{clearInterval(e)}}N(!1),localStorage.removeItem("admin_selected_chat_id"),window.dispatchEvent(new CustomEvent("chatClosed"))},[e,N,Y,Q]),(0,a.useEffect)(()=>{let t=async t=>{let{chatId:a}=t.detail;a&&(e||b(!0),setTimeout(async()=>{0===k.length&&await Q();let e=k.find(e=>e.id===a);if(e)ea(e);else try{let e=await fetch(`/api/chat?chatId=${a}`);if(e.ok){let t=await e.json();if(t.success&&t.data){let e={id:t.data.id,customerName:t.data.customerName||"کاربر",customerPhone:t.data.customerPhone||"",status:t.data.status||"active",createdAt:t.data.createdAt||new Date().toISOString(),updatedAt:t.data.updatedAt||new Date().toISOString(),lastMessage:t.data.lastMessage||"",lastMessageTime:t.data.lastMessageTime};ea(e)}}}catch(e){y.logger.error("Error loading chat:",e)}},300))};return window.addEventListener("openChat",t),()=>{window.removeEventListener("openChat",t)}},[e,k,b,Q,ea]),(0,a.useEffect)(()=>{"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission()},[]);let eu=k.filter(e=>e.customerName.toLowerCase().includes(D.toLowerCase())||e.customerPhone.includes(D));return(0,t.jsx)(r.Sheet,{open:e,onOpenChange:b,"data-admin-chat-open":e?"true":"false","data-selected-chat-id":T?.id||"",children:(0,t.jsx)(r.SheetContent,{side:"left",className:"w-full sm:w-[500px] md:w-[600px] p-0 flex flex-col shadow-2xl !h-screen !max-h-screen overflow-hidden",children:T?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(r.SheetHeader,{className:"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b border-border/40 px-4 sm:px-6 py-2",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(s.Button,{variant:"ghost",size:"icon",onClick:async()=>{M(null),I([]),K.current=null,localStorage.removeItem("admin_selected_chat_id"),window.dispatchEvent(new CustomEvent("chatClosed")),await Q()},className:"h-8 w-8 rounded-lg hover:bg-muted/60 transition-all",children:(0,t.jsx)(d.X,{className:"h-4 w-4"})}),(0,t.jsx)("div",{className:"flex-1 min-w-0",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsx)(r.SheetTitle,{className:"text-base font-semibold truncate",children:T.customerName}),(0,t.jsx)(f.OnlineStatusBadge,{isOnline:C,showText:!1})]})})]})}),(0,t.jsxs)("div",{ref:J,className:"flex-1 min-h-0 overflow-y-auto p-4 sm:p-5 md:p-6 space-y-4 sm:space-y-5 bg-gradient-to-b from-background via-background to-muted/5",children:[P?(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsx)(u.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):0===E.length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center px-6",children:[(0,t.jsx)(n.MessageCircle,{className:"h-14 w-14 text-muted-foreground/50 mb-5"}),(0,t.jsx)("p",{className:"text-muted-foreground text-base font-medium leading-relaxed",children:"هنوز پیامی ارسال نشده است"})]}):(0,t.jsxs)(t.Fragment,{children:[E.map((e,a)=>(0,t.jsx)(R,{message:e,index:a,totalMessages:E.length,onReply:es,onEdit:ei,onDelete:en},e.id)),z&&(0,t.jsx)(h.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"flex justify-start items-end gap-2.5",children:(0,t.jsx)(v.TypingIndicator,{})})]}),(0,t.jsx)("div",{ref:H})]}),(0,t.jsxs)("div",{className:"sticky bottom-0 z-10 bg-background/95 backdrop-blur-sm border-t border-border/40 flex-shrink-0 relative",children:[(0,t.jsx)(p.AnimatePresence,{children:q&&(0,t.jsx)(h.motion.div,{initial:{opacity:0,y:10,scale:.9},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:10,scale:.9},className:"absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 z-10",children:(0,t.jsx)(s.Button,{onClick:()=>ec(!1),size:"icon",className:"h-9 w-9 rounded-full shadow-lg hover:shadow-xl bg-primary text-primary-foreground hover:bg-primary/90 transition-all",title:"برو به آخرین پیام",children:(0,t.jsx)(m.ChevronDown,{className:"h-4 w-4"})})})}),(0,t.jsx)($,{message:G.message,onMessageChange:G.handleMessageChange,onSend:el,isSending:G.isSending,attachments:V.attachments,onRemoveAttachment:V.handleRemoveAttachment,showAttachmentOptions:V.showAttachmentOptions,onToggleAttachmentOptions:()=>V.setShowAttachmentOptions(!V.showAttachmentOptions),isRecording:V.isRecording,recordingTime:V.recordingTime,audioUrl:V.audioUrl,onStartRecording:V.startRecording,onStopRecording:V.stopRecording,onCancelRecording:V.cancelRecording,onSaveRecording:async()=>{let e=await V.saveRecording();e&&V.setAttachments(t=>[...t,e])},formatTime:V.formatTime,imageInputRef:V.imageInputRef,fileInputRef:V.fileInputRef,onFileSelect:V.handleFileSelect,onLocationShare:V.handleLocationShare,onCheckMicrophonePermission:V.checkMicrophonePermission,toast:j})]})]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)(r.SheetHeader,{className:"sticky top-0 z-10 bg-background/95 backdrop-blur-sm border-b border-border/40 px-4 sm:px-6 py-2",children:[(0,t.jsxs)(r.SheetTitle,{className:"flex items-center gap-2 text-base font-semibold",children:[(0,t.jsx)(n.MessageCircle,{className:"h-5 w-5"}),"چت‌های کاربران"]}),(0,t.jsx)("div",{className:"mt-2",children:(0,t.jsxs)("div",{className:"relative",children:[(0,t.jsx)(l.Search,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,t.jsx)(i.Input,{type:"search",placeholder:"جستجوی کاربر...",value:D,onChange:e=>O(e.target.value),className:"pr-10 h-9 text-sm border rounded-lg"})]})})]}),(0,t.jsx)("div",{className:"flex-1 min-h-0 overflow-y-auto bg-gradient-to-b from-background to-muted/5",children:P?(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsx)(u.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):0===eu.length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center px-6",children:[(0,t.jsx)(n.MessageCircle,{className:"h-14 w-14 text-muted-foreground/50 mb-5"}),(0,t.jsx)("p",{className:"text-muted-foreground text-base font-medium leading-relaxed",children:"چتی یافت نشد"})]}):(0,t.jsx)("div",{className:"divide-y divide-border/50",children:eu.map(e=>(0,t.jsx)(h.motion.button,{onClick:()=>ea(e),className:`w-full p-5 text-right hover:bg-muted/50 transition-all duration-200 rounded-lg ${e.unreadCount&&e.unreadCount>0?"bg-primary/5 border-r-4 border-primary shadow-md":"hover:shadow-sm"}`,whileHover:{backgroundColor:e.unreadCount&&e.unreadCount>0?"rgba(var(--primary), 0.1)":"rgba(0,0,0,0.05)"},initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.2},children:(0,t.jsxs)("div",{className:"flex items-start gap-4",children:[(0,t.jsx)("div",{className:"w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0 shadow-md border-2 border-primary/30",children:(0,t.jsx)(o.User,{className:"h-5 w-5 sm:h-6 sm:w-6 text-primary"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,t.jsxs)("div",{className:"flex items-center gap-2.5 flex-1 min-w-0",children:[(0,t.jsx)("p",{className:`font-semibold text-sm sm:text-base truncate leading-tight ${e.unreadCount&&e.unreadCount>0?"font-bold":""}`,children:e.customerName}),e.unreadCount&&e.unreadCount>0&&(0,t.jsx)(h.motion.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:15},children:(0,t.jsx)(w.Badge,{variant:"destructive",className:"h-6 w-6 px-0 text-xs font-bold flex-shrink-0 shadow-lg animate-pulse flex items-center justify-center",children:"!"})})]}),e.lastMessageTime&&(0,t.jsx)("span",{className:"text-xs text-muted-foreground flex-shrink-0 mr-2 font-medium",children:new Date(e.lastMessageTime).toLocaleDateString("fa-IR",{month:"short",day:"numeric"})})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2.5 text-sm text-muted-foreground mb-1.5",children:[(0,t.jsx)(c.Phone,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:"font-medium",children:e.customerPhone})]}),e.lastMessage&&(0,t.jsx)("p",{className:"text-sm text-muted-foreground mt-2 truncate leading-relaxed",children:e.lastMessage})]})]})},e.id))})})]})})})}e.s(["AdminChat",()=>z],82429)}]);