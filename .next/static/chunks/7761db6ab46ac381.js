(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,71435,e=>{"use strict";var t=e.i(43476),r=e.i(71645),a=e.i(48425),s=e.i(96626),n=e.i(30030),i=e.i(20783),o=e.i(30207),l=e.i(86318),c=e.i(34620),d=e.i(70152),u=e.i(81140),h="ScrollArea",[m,p]=(0,n.createContextScope)(h),[g,f]=m(h),x=r.forwardRef((e,s)=>{let{__scopeScrollArea:n,type:o="hover",dir:c,scrollHideDelay:d=600,...u}=e,[h,m]=r.useState(null),[p,f]=r.useState(null),[x,v]=r.useState(null),[w,y]=r.useState(null),[b,j]=r.useState(null),[C,S]=r.useState(0),[N,R]=r.useState(0),[E,T]=r.useState(!1),[k,P]=r.useState(!1),A=(0,i.useComposedRefs)(s,e=>m(e)),D=(0,l.useDirection)(c);return(0,t.jsx)(g,{scope:n,type:o,dir:D,scrollHideDelay:d,scrollArea:h,viewport:p,onViewportChange:f,content:x,onContentChange:v,scrollbarX:w,onScrollbarXChange:y,scrollbarXEnabled:E,onScrollbarXEnabledChange:T,scrollbarY:b,onScrollbarYChange:j,scrollbarYEnabled:k,onScrollbarYEnabledChange:P,onCornerWidthChange:S,onCornerHeightChange:R,children:(0,t.jsx)(a.Primitive.div,{dir:D,...u,ref:A,style:{position:"relative","--radix-scroll-area-corner-width":C+"px","--radix-scroll-area-corner-height":N+"px",...e.style}})})});x.displayName=h;var v="ScrollAreaViewport",w=r.forwardRef((e,s)=>{let{__scopeScrollArea:n,children:o,nonce:l,...c}=e,d=f(v,n),u=r.useRef(null),h=(0,i.useComposedRefs)(s,u,d.onViewportChange);return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)("style",{dangerouslySetInnerHTML:{__html:"[data-radix-scroll-area-viewport]{scrollbar-width:none;-ms-overflow-style:none;-webkit-overflow-scrolling:touch;}[data-radix-scroll-area-viewport]::-webkit-scrollbar{display:none}"},nonce:l}),(0,t.jsx)(a.Primitive.div,{"data-radix-scroll-area-viewport":"",...c,ref:h,style:{overflowX:d.scrollbarXEnabled?"scroll":"hidden",overflowY:d.scrollbarYEnabled?"scroll":"hidden",...e.style},children:(0,t.jsx)("div",{ref:d.onContentChange,style:{minWidth:"100%",display:"table"},children:o})})]})});w.displayName=v;var y="ScrollAreaScrollbar",b=r.forwardRef((e,a)=>{let{forceMount:s,...n}=e,i=f(y,e.__scopeScrollArea),{onScrollbarXEnabledChange:o,onScrollbarYEnabledChange:l}=i,c="horizontal"===e.orientation;return r.useEffect(()=>(c?o(!0):l(!0),()=>{c?o(!1):l(!1)}),[c,o,l]),"hover"===i.type?(0,t.jsx)(j,{...n,ref:a,forceMount:s}):"scroll"===i.type?(0,t.jsx)(C,{...n,ref:a,forceMount:s}):"auto"===i.type?(0,t.jsx)(S,{...n,ref:a,forceMount:s}):"always"===i.type?(0,t.jsx)(N,{...n,ref:a}):null});b.displayName=y;var j=r.forwardRef((e,a)=>{let{forceMount:n,...i}=e,o=f(y,e.__scopeScrollArea),[l,c]=r.useState(!1);return r.useEffect(()=>{let e=o.scrollArea,t=0;if(e){let r=()=>{window.clearTimeout(t),c(!0)},a=()=>{t=window.setTimeout(()=>c(!1),o.scrollHideDelay)};return e.addEventListener("pointerenter",r),e.addEventListener("pointerleave",a),()=>{window.clearTimeout(t),e.removeEventListener("pointerenter",r),e.removeEventListener("pointerleave",a)}}},[o.scrollArea,o.scrollHideDelay]),(0,t.jsx)(s.Presence,{present:n||l,children:(0,t.jsx)(S,{"data-state":l?"visible":"hidden",...i,ref:a})})}),C=r.forwardRef((e,a)=>{var n;let{forceMount:i,...o}=e,l=f(y,e.__scopeScrollArea),c="horizontal"===e.orientation,d=F(()=>m("SCROLL_END"),100),[h,m]=(n={hidden:{SCROLL:"scrolling"},scrolling:{SCROLL_END:"idle",POINTER_ENTER:"interacting"},interacting:{SCROLL:"interacting",POINTER_LEAVE:"idle"},idle:{HIDE:"hidden",SCROLL:"scrolling",POINTER_ENTER:"interacting"}},r.useReducer((e,t)=>n[e][t]??e,"hidden"));return r.useEffect(()=>{if("idle"===h){let e=window.setTimeout(()=>m("HIDE"),l.scrollHideDelay);return()=>window.clearTimeout(e)}},[h,l.scrollHideDelay,m]),r.useEffect(()=>{let e=l.viewport,t=c?"scrollLeft":"scrollTop";if(e){let r=e[t],a=()=>{let a=e[t];r!==a&&(m("SCROLL"),d()),r=a};return e.addEventListener("scroll",a),()=>e.removeEventListener("scroll",a)}},[l.viewport,c,m,d]),(0,t.jsx)(s.Presence,{present:i||"hidden"!==h,children:(0,t.jsx)(N,{"data-state":"hidden"===h?"hidden":"visible",...o,ref:a,onPointerEnter:(0,u.composeEventHandlers)(e.onPointerEnter,()=>m("POINTER_ENTER")),onPointerLeave:(0,u.composeEventHandlers)(e.onPointerLeave,()=>m("POINTER_LEAVE"))})})}),S=r.forwardRef((e,a)=>{let n=f(y,e.__scopeScrollArea),{forceMount:i,...o}=e,[l,c]=r.useState(!1),d="horizontal"===e.orientation,u=F(()=>{if(n.viewport){let e=n.viewport.offsetWidth<n.viewport.scrollWidth,t=n.viewport.offsetHeight<n.viewport.scrollHeight;c(d?e:t)}},10);return B(n.viewport,u),B(n.content,u),(0,t.jsx)(s.Presence,{present:i||l,children:(0,t.jsx)(N,{"data-state":l?"visible":"hidden",...o,ref:a})})}),N=r.forwardRef((e,a)=>{let{orientation:s="vertical",...n}=e,i=f(y,e.__scopeScrollArea),o=r.useRef(null),l=r.useRef(0),[c,d]=r.useState({content:0,viewport:0,scrollbar:{size:0,paddingStart:0,paddingEnd:0}}),u=_(c.viewport,c.content),h={...n,sizes:c,onSizesChange:d,hasThumb:!!(u>0&&u<1),onThumbChange:e=>o.current=e,onThumbPointerUp:()=>l.current=0,onThumbPointerDown:e=>l.current=e};function m(e,t){return function(e,t,r,a="ltr"){let s=$(r),n=t||s/2,i=r.scrollbar.paddingStart+n,o=r.scrollbar.size-r.scrollbar.paddingEnd-(s-n),l=r.content-r.viewport;return W([i,o],"ltr"===a?[0,l]:[-1*l,0])(e)}(e,l.current,c,t)}return"horizontal"===s?(0,t.jsx)(R,{...h,ref:a,onThumbPositionChange:()=>{if(i.viewport&&o.current){let e=H(i.viewport.scrollLeft,c,i.dir);o.current.style.transform=`translate3d(${e}px, 0, 0)`}},onWheelScroll:e=>{i.viewport&&(i.viewport.scrollLeft=e)},onDragScroll:e=>{i.viewport&&(i.viewport.scrollLeft=m(e,i.dir))}}):"vertical"===s?(0,t.jsx)(E,{...h,ref:a,onThumbPositionChange:()=>{if(i.viewport&&o.current){let e=H(i.viewport.scrollTop,c);o.current.style.transform=`translate3d(0, ${e}px, 0)`}},onWheelScroll:e=>{i.viewport&&(i.viewport.scrollTop=e)},onDragScroll:e=>{i.viewport&&(i.viewport.scrollTop=m(e))}}):null}),R=r.forwardRef((e,a)=>{let{sizes:s,onSizesChange:n,...o}=e,l=f(y,e.__scopeScrollArea),[c,d]=r.useState(),u=r.useRef(null),h=(0,i.useComposedRefs)(a,u,l.onScrollbarXChange);return r.useEffect(()=>{u.current&&d(getComputedStyle(u.current))},[u]),(0,t.jsx)(P,{"data-orientation":"horizontal",...o,ref:h,sizes:s,style:{bottom:0,left:"rtl"===l.dir?"var(--radix-scroll-area-corner-width)":0,right:"ltr"===l.dir?"var(--radix-scroll-area-corner-width)":0,"--radix-scroll-area-thumb-width":$(s)+"px",...e.style},onThumbPointerDown:t=>e.onThumbPointerDown(t.x),onDragScroll:t=>e.onDragScroll(t.x),onWheelScroll:(t,r)=>{if(l.viewport){var a,s;let n=l.viewport.scrollLeft+t.deltaX;e.onWheelScroll(n),a=n,s=r,a>0&&a<s&&t.preventDefault()}},onResize:()=>{u.current&&l.viewport&&c&&n({content:l.viewport.scrollWidth,viewport:l.viewport.offsetWidth,scrollbar:{size:u.current.clientWidth,paddingStart:O(c.paddingLeft),paddingEnd:O(c.paddingRight)}})}})}),E=r.forwardRef((e,a)=>{let{sizes:s,onSizesChange:n,...o}=e,l=f(y,e.__scopeScrollArea),[c,d]=r.useState(),u=r.useRef(null),h=(0,i.useComposedRefs)(a,u,l.onScrollbarYChange);return r.useEffect(()=>{u.current&&d(getComputedStyle(u.current))},[u]),(0,t.jsx)(P,{"data-orientation":"vertical",...o,ref:h,sizes:s,style:{top:0,right:"ltr"===l.dir?0:void 0,left:"rtl"===l.dir?0:void 0,bottom:"var(--radix-scroll-area-corner-height)","--radix-scroll-area-thumb-height":$(s)+"px",...e.style},onThumbPointerDown:t=>e.onThumbPointerDown(t.y),onDragScroll:t=>e.onDragScroll(t.y),onWheelScroll:(t,r)=>{if(l.viewport){var a,s;let n=l.viewport.scrollTop+t.deltaY;e.onWheelScroll(n),a=n,s=r,a>0&&a<s&&t.preventDefault()}},onResize:()=>{u.current&&l.viewport&&c&&n({content:l.viewport.scrollHeight,viewport:l.viewport.offsetHeight,scrollbar:{size:u.current.clientHeight,paddingStart:O(c.paddingTop),paddingEnd:O(c.paddingBottom)}})}})}),[T,k]=m(y),P=r.forwardRef((e,s)=>{let{__scopeScrollArea:n,sizes:l,hasThumb:c,onThumbChange:d,onThumbPointerUp:h,onThumbPointerDown:m,onThumbPositionChange:p,onDragScroll:g,onWheelScroll:x,onResize:v,...w}=e,b=f(y,n),[j,C]=r.useState(null),S=(0,i.useComposedRefs)(s,e=>C(e)),N=r.useRef(null),R=r.useRef(""),E=b.viewport,k=l.content-l.viewport,P=(0,o.useCallbackRef)(x),A=(0,o.useCallbackRef)(p),D=F(v,10);function I(e){N.current&&g({x:e.clientX-N.current.left,y:e.clientY-N.current.top})}return r.useEffect(()=>{let e=e=>{let t=e.target;j?.contains(t)&&P(e,k)};return document.addEventListener("wheel",e,{passive:!1}),()=>document.removeEventListener("wheel",e,{passive:!1})},[E,j,k,P]),r.useEffect(A,[l,A]),B(j,D),B(b.content,D),(0,t.jsx)(T,{scope:n,scrollbar:j,hasThumb:c,onThumbChange:(0,o.useCallbackRef)(d),onThumbPointerUp:(0,o.useCallbackRef)(h),onThumbPositionChange:A,onThumbPointerDown:(0,o.useCallbackRef)(m),children:(0,t.jsx)(a.Primitive.div,{...w,ref:S,style:{position:"absolute",...w.style},onPointerDown:(0,u.composeEventHandlers)(e.onPointerDown,e=>{0===e.button&&(e.target.setPointerCapture(e.pointerId),N.current=j.getBoundingClientRect(),R.current=document.body.style.webkitUserSelect,document.body.style.webkitUserSelect="none",b.viewport&&(b.viewport.style.scrollBehavior="auto"),I(e))}),onPointerMove:(0,u.composeEventHandlers)(e.onPointerMove,I),onPointerUp:(0,u.composeEventHandlers)(e.onPointerUp,e=>{let t=e.target;t.hasPointerCapture(e.pointerId)&&t.releasePointerCapture(e.pointerId),document.body.style.webkitUserSelect=R.current,b.viewport&&(b.viewport.style.scrollBehavior=""),N.current=null})})})}),A="ScrollAreaThumb",D=r.forwardRef((e,r)=>{let{forceMount:a,...n}=e,i=k(A,e.__scopeScrollArea);return(0,t.jsx)(s.Presence,{present:a||i.hasThumb,children:(0,t.jsx)(I,{ref:r,...n})})}),I=r.forwardRef((e,s)=>{let{__scopeScrollArea:n,style:o,...l}=e,c=f(A,n),d=k(A,n),{onThumbPositionChange:h}=d,m=(0,i.useComposedRefs)(s,e=>d.onThumbChange(e)),p=r.useRef(void 0),g=F(()=>{p.current&&(p.current(),p.current=void 0)},100);return r.useEffect(()=>{let e=c.viewport;if(e){let t=()=>{g(),p.current||(p.current=z(e,h),h())};return h(),e.addEventListener("scroll",t),()=>e.removeEventListener("scroll",t)}},[c.viewport,g,h]),(0,t.jsx)(a.Primitive.div,{"data-state":d.hasThumb?"visible":"hidden",...l,ref:m,style:{width:"var(--radix-scroll-area-thumb-width)",height:"var(--radix-scroll-area-thumb-height)",...o},onPointerDownCapture:(0,u.composeEventHandlers)(e.onPointerDownCapture,e=>{let t=e.target.getBoundingClientRect(),r=e.clientX-t.left,a=e.clientY-t.top;d.onThumbPointerDown({x:r,y:a})}),onPointerUp:(0,u.composeEventHandlers)(e.onPointerUp,d.onThumbPointerUp)})});D.displayName=A;var L="ScrollAreaCorner",M=r.forwardRef((e,r)=>{let a=f(L,e.__scopeScrollArea),s=!!(a.scrollbarX&&a.scrollbarY);return"scroll"!==a.type&&s?(0,t.jsx)(U,{...e,ref:r}):null});M.displayName=L;var U=r.forwardRef((e,s)=>{let{__scopeScrollArea:n,...i}=e,o=f(L,n),[l,c]=r.useState(0),[d,u]=r.useState(0),h=!!(l&&d);return B(o.scrollbarX,()=>{let e=o.scrollbarX?.offsetHeight||0;o.onCornerHeightChange(e),u(e)}),B(o.scrollbarY,()=>{let e=o.scrollbarY?.offsetWidth||0;o.onCornerWidthChange(e),c(e)}),h?(0,t.jsx)(a.Primitive.div,{...i,ref:s,style:{width:l,height:d,position:"absolute",right:"ltr"===o.dir?0:void 0,left:"rtl"===o.dir?0:void 0,bottom:0,...e.style}}):null});function O(e){return e?parseInt(e,10):0}function _(e,t){let r=e/t;return isNaN(r)?0:r}function $(e){let t=_(e.viewport,e.content),r=e.scrollbar.paddingStart+e.scrollbar.paddingEnd;return Math.max((e.scrollbar.size-r)*t,18)}function H(e,t,r="ltr"){let a=$(t),s=t.scrollbar.paddingStart+t.scrollbar.paddingEnd,n=t.scrollbar.size-s,i=t.content-t.viewport,o=(0,d.clamp)(e,"ltr"===r?[0,i]:[-1*i,0]);return W([0,i],[0,n-a])(o)}function W(e,t){return r=>{if(e[0]===e[1]||t[0]===t[1])return t[0];let a=(t[1]-t[0])/(e[1]-e[0]);return t[0]+a*(r-e[0])}}var z=(e,t=()=>{})=>{let r={left:e.scrollLeft,top:e.scrollTop},a=0;return!function s(){let n={left:e.scrollLeft,top:e.scrollTop},i=r.left!==n.left,o=r.top!==n.top;(i||o)&&t(),r=n,a=window.requestAnimationFrame(s)}(),()=>window.cancelAnimationFrame(a)};function F(e,t){let a=(0,o.useCallbackRef)(e),s=r.useRef(0);return r.useEffect(()=>()=>window.clearTimeout(s.current),[]),r.useCallback(()=>{window.clearTimeout(s.current),s.current=window.setTimeout(a,t)},[a,t])}function B(e,t){let r=(0,o.useCallbackRef)(t);(0,c.useLayoutEffect)(()=>{let t=0;if(e){let a=new ResizeObserver(()=>{cancelAnimationFrame(t),t=window.requestAnimationFrame(r)});return a.observe(e),()=>{window.cancelAnimationFrame(t),a.unobserve(e)}}},[e,r])}var X=e.i(47163);let Y=r.forwardRef(({className:e,children:r,...a},s)=>(0,t.jsxs)(x,{ref:s,className:(0,X.cn)("relative overflow-hidden",e),...a,children:[(0,t.jsx)(w,{className:"h-full w-full rounded-[inherit]",children:r}),(0,t.jsx)(J,{}),(0,t.jsx)(M,{})]}));Y.displayName=x.displayName;let J=r.forwardRef(({className:e,orientation:r="vertical",...a},s)=>(0,t.jsx)(b,{ref:s,orientation:r,className:(0,X.cn)("flex touch-none select-none transition-colors","vertical"===r&&"h-full w-2.5 border-l border-l-transparent p-[1px]","horizontal"===r&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",e),...a,children:(0,t.jsx)(D,{className:"relative flex-1 rounded-full bg-border"})}));J.displayName=b.displayName,e.s(["ScrollArea",()=>Y],71435)},53504,36065,94149,e=>{"use strict";var t=e.i(71645),r=e.i(20682),a=e.i(73493),s=e.i(93226);function n(){let{toast:e}=(0,r.useToast)(),{user:n}=(0,s.useAuthStore)(),[i,o]=(0,t.useState)([]),l=(0,t.useRef)(!1),[c,d]=(0,t.useState)(!1),[u,h]=(0,t.useState)(0),[m,p]=(0,t.useState)(null),[g,f]=(0,t.useState)(null),[x,v]=(0,t.useState)(!1),w=(0,t.useRef)(null),y=(0,t.useRef)([]),b=(0,t.useRef)(null),j=(0,t.useRef)(null),C=(0,t.useRef)(null),S=(0,t.useCallback)(async(t,r,a=0)=>{try{let e=new FormData;e.append("file",t),e.append("type",r);let a={};n?.id&&(a["x-user-id"]=n.id);let s=await fetch("/api/chat/upload",{method:"POST",credentials:"include",headers:a,body:e});if(!s.ok){let e=await s.json().catch(()=>({error:"خطا در آپلود فایل"}));throw Error(e.error||"خطا در آپلود فایل")}return(await s.json()).data.url}catch(s){if(a<3&&(s.message?.includes("fetch")||s.message?.includes("network")||s.message?.includes("timeout")||"NETWORK_ERROR"===s.code||"TypeError"===s.name)){let s=2e3*Math.pow(2,a);return 0===a&&e({title:"در حال تلاش مجدد...",description:"خطا در آپلود فایل. در حال تلاش مجدد...",duration:2e3}),await new Promise(e=>setTimeout(e,s)),S(t,r,a+1)}throw e({title:"خطا در آپلود فایل",description:s.message||"لطفاً دوباره تلاش کنید",variant:"destructive"}),s}},[e]),N=(0,t.useCallback)(async(e,t)=>{let r=e.target.files;if(r&&0!==r.length){for(let e of Array.from(r))try{let r=await S(e,t),a={id:Date.now().toString()+Math.random(),type:t,name:e.name,size:e.size,url:r};o(e=>[...e,a])}catch(e){}e.target.value=""}},[S]),R=(0,t.useCallback)(e=>{o(t=>t.filter(t=>t.id!==e))},[]),E=(0,t.useCallback)(()=>{navigator.geolocation?navigator.geolocation.getCurrentPosition(e=>{let t={id:`location-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:"location",url:`https://www.google.com/maps?q=${e.coords.latitude},${e.coords.longitude}`,name:"موقعیت مکانی"};o(e=>[...e,t]),v(!1)},t=>{a.logger.error("Error getting location:",t),e({title:"خطا",description:"خطا در دریافت موقعیت مکانی",variant:"destructive"})}):e({title:"خطا",description:"مرورگر شما از موقعیت مکانی پشتیبانی نمی‌کند",variant:"destructive"})},[e]),T=(0,t.useCallback)(async()=>{try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(e=>e.stop()),!0}catch(e){return!1}},[]),k=(0,t.useCallback)(async()=>{try{if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return void e({title:"مرورگر شما پشتیبانی نمی‌کند",description:"مرورگر شما از ضبط صدا پشتیبانی نمی‌کند. لطفاً از مرورگر جدیدتری استفاده کنید.",variant:"destructive"});let t=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0}}),r=new MediaRecorder(t,{mimeType:MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":MediaRecorder.isTypeSupported("audio/mp4")?"audio/mp4":"audio/webm"});w.current=r,y.current=[],r.ondataavailable=e=>{e.data.size>0&&y.current.push(e.data)},r.onstop=()=>{let e=new Blob(y.current,{type:r.mimeType||"audio/webm"});p(e);let a=URL.createObjectURL(e);f(a),t.getTracks().forEach(e=>e.stop())},r.onerror=t=>{a.logger.error("MediaRecorder error:",t),e({title:"خطا در ضبط صدا",description:"خطایی در هنگام ضبط صدا رخ داد. لطفاً دوباره تلاش کنید.",variant:"destructive"}),P()},r.start(),d(!0),h(0),v(!1),b.current=setInterval(()=>{h(e=>e+1)},1e3),e({title:"ضبط صدا شروع شد",description:"در حال ضبط پیام صوتی..."})}catch(a){let t="دسترسی به میکروفون مجاز نیست.",r="";"NotAllowedError"===a.name||"PermissionDeniedError"===a.name?(t="دسترسی به میکروفون رد شد",r="لطفاً در تنظیمات مرورگر خود، دسترسی میکروفون را فعال کنید."):"NotFoundError"===a.name||"DevicesNotFoundError"===a.name?(t="میکروفون یافت نشد",r="لطفاً مطمئن شوید که میکروفون به دستگاه شما متصل است."):"NotReadableError"===a.name||"TrackStartError"===a.name?(t="میکروفون در حال استفاده است",r="میکروفون توسط برنامه دیگری استفاده می‌شود. لطفاً آن را ببندید."):r="لطفاً دوباره تلاش کنید یا صفحه را رفرش کنید.",e({title:t,description:r,variant:"destructive",duration:5e3})}},[e]),P=(0,t.useCallback)(()=>{if(w.current&&"inactive"!==w.current.state)try{w.current.stop(),d(!1),b.current&&clearInterval(b.current),e({title:"ضبط صدا متوقف شد",description:"پیام صوتی شما آماده است. می‌توانید آن را ذخیره یا لغو کنید."})}catch(t){a.logger.error("Error stopping recording:",t),e({title:"خطا",description:"خطایی در توقف ضبط رخ داد.",variant:"destructive"})}},[e]),A=(0,t.useCallback)(()=>{P(),p(null),g&&(URL.revokeObjectURL(g),f(null)),h(0)},[g,P]),D=(0,t.useCallback)(e=>{let t=Math.floor(e/60);return`${t}:${(e%60).toString().padStart(2,"0")}`},[]),I=(0,t.useCallback)(async()=>{if(l.current)return a.logger.warn("saveRecording already in progress, skipping"),null;if(!m||!g)return null;l.current=!0;try{let e="webm",t=m.type||"audio/webm";t.includes("mp4")||t.includes("m4a")?e="m4a":t.includes("ogg")?e="ogg":t.includes("wav")&&(e="wav");let r=new File([m],`audio-${Date.now()}.${e}`,{type:t}),a=await S(r,"audio"),s={id:function(e=""){return"undefined"!=typeof crypto&&crypto.randomUUID?e?`${e}-${crypto.randomUUID()}`:crypto.randomUUID():`${e}-${Date.now()}-${Math.random().toString(36).substr(2,9)}-${performance.now()}`}("audio"),type:"audio",url:a,name:`پیام صوتی ${D(u)}`,size:m.size,duration:u};return p(null),g&&URL.revokeObjectURL(g),f(null),h(0),s}catch(e){return a.logger.error("Error saving recording:",e),null}finally{l.current=!1}},[m,g,u,S,D]);return{attachments:i,setAttachments:o,isRecording:c,recordingTime:u,audioBlob:m,audioUrl:g,showAttachmentOptions:x,setShowAttachmentOptions:v,uploadFile:S,handleFileSelect:N,handleRemoveAttachment:R,handleLocationShare:E,startRecording:k,stopRecording:P,cancelRecording:A,saveRecording:I,formatTime:D,formatFileSize:(0,t.useCallback)(e=>e<1024?e+" B":e<1048576?(e/1024).toFixed(1)+" KB":(e/1048576).toFixed(1)+" MB",[]),checkMicrophonePermission:T,imageInputRef:j,fileInputRef:C}}function i({chatId:e,sender:s,customerInfo:n,onMessageSent:i}){let{toast:o}=(0,r.useToast)(),[l,c]=(0,t.useState)(""),[d,u]=(0,t.useState)(!1),[h,m]=(0,t.useState)(!1),p=(0,t.useRef)(null),g=(0,t.useRef)(null),f=(0,t.useCallback)(async t=>{if(e)try{await fetch("/api/chat/typing",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:e,sender:s,isTyping:t})})}catch(e){a.logger.error("Error sending typing status:",e)}},[e,s]),x=(0,t.useCallback)(t=>{c(t.target.value),e&&(p.current&&clearTimeout(p.current),t.target.value.trim().length>0?(f(!0),p.current=setTimeout(()=>{f(!1)},2e3)):f(!1))},[e,f]),v=(0,t.useCallback)(async()=>{if(e)try{let t=await fetch(`/api/chat/typing?chatId=${e}&sender=${"user"===s?"support":"user"}`,{credentials:"include"});if(t.ok){let e=await t.json();e.success&&m(e.data.isTyping||!1)}}catch(e){a.logger.error("Error checking typing status:",e)}},[e,s]);(0,t.useEffect)(()=>{if(!e){m(!1),g.current&&(clearInterval(g.current),g.current=null);return}return v(),g.current=setInterval(()=>{v()},2e3),()=>{g.current&&(clearInterval(g.current),g.current=null),p.current&&(clearTimeout(p.current),p.current=null),f(!1)}},[e,v,f]);let w=(0,t.useCallback)(async(t,r=[])=>{if(!t.trim()&&0===r.length||!e)return null;let a=r.filter(e=>{let t=e.url;return t&&!t.startsWith("blob:")&&!t.startsWith("data:")&&(t.startsWith("http")||t.startsWith("/"))});if(!t.trim()&&0===a.length)return o({title:"خطا",description:"لطفاً یک پیام یا فایل معتبر اضافه کنید",variant:"destructive"}),null;let l={id:`msg-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,text:t,sender:s,timestamp:new Date,attachments:a.length>0?a:void 0};try{u(!0),p.current&&clearTimeout(p.current),f(!1);let t={chatId:e,messages:[{id:l.id,text:l.text,sender:l.sender,timestamp:l.timestamp.toISOString(),attachments:l.attachments||[]}]};n&&(t.customerInfo=n);let r=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(t)});if(!r.ok){let e=await r.json().catch(()=>null),t=e?.error||(429===r.status?"درخواست‌های شما زیاد است. لطفاً کمی بعد دوباره تلاش کنید.":null)||"خطا در ارسال پیام";throw Error(t)}return i&&i(),l}catch(e){return o({title:"خطا",description:e instanceof Error?e.message:"خطا در ارسال پیام",variant:"destructive"}),null}finally{u(!1)}},[e,s,n,o,i,f]),y=(0,t.useCallback)(async(e=[],t)=>{let r=l;t&&(r=`در پاسخ به: ${t.text}

${l}`);let a=await w(r,e);return a?(c(""),a):null},[l,w]);return{message:l,setMessage:c,isSending:d,isTyping:h,handleMessageChange:x,sendMessage:w,handleSend:y}}e.s(["useChatUtils",()=>n],53504),e.i(47167),e.s(["useChatMessaging",()=>i],36065);var o=e.i(43476),l=e.i(46932),c=e.i(94771),d=e.i(78583),u=e.i(46897),h=e.i(75254);let m=(0,h.default)("Reply",[["polyline",{points:"9 17 4 12 9 7",key:"hvgpf2"}],["path",{d:"M20 18v-2a4 4 0 0 0-4-4H4",key:"5vmcpk"}]]),p=(0,h.default)("Pen",[["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]]);var g=e.i(27612);let f=(0,h.default)("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);var x=e.i(67881),v=e.i(63415),w=e.i(14050);function y({message:e,index:t,totalMessages:r,onReply:a,onEdit:s,onDelete:n}){return(0,o.jsx)(l.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},transition:{duration:.2,ease:"easeOut"},className:`flex ${"user"===e.sender?"justify-end":"justify-start"} items-end gap-2 group mb-3`,children:(0,o.jsxs)("div",{className:`max-w-[85%] sm:max-w-[75%] md:max-w-[70%] rounded-lg px-2.5 sm:px-3 py-2 transition-all ${"user"===e.sender?"bg-primary text-primary-foreground":"bg-muted text-foreground border border-border/40"}`,children:[e.text&&(0,o.jsx)("p",{className:"text-xs sm:text-sm leading-relaxed whitespace-pre-wrap break-words mb-1.5",children:e.text}),e.attachments&&e.attachments.length>0&&(0,o.jsx)("div",{className:`space-y-2 ${e.text?"mt-2":""}`,children:e.attachments.map((e,t)=>(0,o.jsxs)("div",{className:"rounded overflow-hidden",children:["image"===e.type&&e.url&&(0,o.jsx)("img",{src:e.url,alt:e.name||"تصویر",className:"max-w-full max-h-[150px] sm:max-h-[180px] rounded cursor-pointer hover:opacity-90 transition-all",onClick:()=>window.open(e.url,"_blank")}),"file"===e.type&&(0,o.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",download:e.name,className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,o.jsx)(d.FileText,{className:"h-3.5 w-3.5"}),(0,o.jsx)("span",{className:"font-medium truncate",children:e.name||"فایل"})]}),"location"===e.type&&(0,o.jsxs)("a",{href:e.url,target:"_blank",rel:"noopener noreferrer",className:"flex items-center gap-2 p-2 bg-background/50 rounded hover:bg-background/70 transition-all text-xs",children:[(0,o.jsx)(u.MapPin,{className:"h-3.5 w-3.5"}),(0,o.jsx)("span",{className:"font-medium",children:e.name||"موقعیت"})]}),"audio"===e.type&&e.url&&(0,o.jsx)(w.AudioPlayer,{url:e.url,duration:e.duration})]},e.id||t))}),(0,o.jsxs)("div",{className:`flex items-center gap-1.5 mt-1.5 pt-1.5 border-t ${"user"===e.sender?"border-primary-foreground/20 justify-end":"border-border/30 justify-start"}`,children:[(0,o.jsx)("span",{className:`text-[10px] sm:text-xs ${"user"===e.sender?"text-primary-foreground/70":"text-muted-foreground"}`,children:new Date(e.timestamp).toLocaleTimeString("fa-IR",{hour:"2-digit",minute:"2-digit"})}),e.status&&"user"===e.sender&&(0,o.jsx)(c.CheckCheck,{className:`h-3 w-3 ${"read"===e.status?"text-primary-foreground/70":"text-primary-foreground/40"}`}),n&&("support"===e.sender||"user"===e.sender)&&(0,o.jsx)(x.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 hover:bg-destructive/10 text-destructive hover:text-destructive opacity-70 hover:opacity-100 transition-opacity",onClick:t=>{t.stopPropagation(),confirm("آیا مطمئن هستید که می‌خواهید این پیام را حذف کنید؟")&&n(e.id)},title:"حذف پیام",children:(0,o.jsx)(g.Trash2,{className:"h-3.5 w-3.5"})}),(a||s)&&(0,o.jsx)("div",{className:"flex items-center gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity",children:(0,o.jsxs)(v.DropdownMenu,{children:[(0,o.jsx)(v.DropdownMenuTrigger,{asChild:!0,children:(0,o.jsx)(x.Button,{variant:"ghost",size:"icon",className:"h-6 w-6 hover:bg-background/20",onClick:e=>{e.stopPropagation()},title:"گزینه‌های بیشتر",children:(0,o.jsx)(f,{className:"h-3.5 w-3.5"})})}),(0,o.jsxs)(v.DropdownMenuContent,{align:"user"===e.sender?"end":"start",className:"min-w-[140px]",onClick:e=>e.stopPropagation(),children:[a&&(0,o.jsxs)(v.DropdownMenuItem,{onClick:t=>{t.stopPropagation(),a(e)},className:"cursor-pointer",children:[(0,o.jsx)(m,{className:"h-4 w-4 ml-2"}),(0,o.jsx)("span",{children:"پاسخ"})]}),s&&"user"===e.sender&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(v.DropdownMenuSeparator,{}),(0,o.jsxs)(v.DropdownMenuItem,{onClick:t=>{t.stopPropagation(),s(e)},className:"cursor-pointer",children:[(0,o.jsx)(p,{className:"h-4 w-4 ml-2"}),(0,o.jsx)("span",{children:"ویرایش"})]})]})]})]})})]})]})},e.id)}e.s(["MessageBubble",()=>y],94149)},82429,e=>{"use strict";var t=e.i(43476),r=e.i(71645),a=e.i(67881),s=e.i(23750),n=e.i(94983),i=e.i(55436),o=e.i(84614),l=e.i(43432),c=e.i(63488),d=e.i(37727),u=e.i(31278),h=e.i(23622),m=e.i(46932),p=e.i(20682),g=e.i(27651),f=e.i(26428),x=e.i(94179),v=e.i(53504),w=e.i(36065),y=e.i(94149),b=e.i(22085),j=e.i(73493),C=e.i(93226),S=e.i(30374),N=e.i(59411),R=e.i(71435),E=e.i(45919),T=e.i(29865);function k({isOpen:e,onOpenChange:k,initialCustomerPhone:P}){let{toast:A}=(0,p.useToast)(),{user:D}=(0,C.useAuthStore)(),{setOnline:I,isOnline:L}=(0,g.useAdminPresence)({enabled:!0,heartbeatInterval:15e3}),[M,U]=(0,r.useState)([]),[O,_]=(0,r.useState)(null),[$,H]=(0,r.useState)([]),[W,z]=(0,r.useState)(!1),[F,B]=(0,r.useState)(!1),[X,Y]=(0,r.useState)(""),[J,V]=(0,r.useState)(!1),[K,q]=(0,r.useState)(null),[G,Q]=(0,r.useState)(null),[Z,ee]=(0,r.useState)(!1),[et,er]=(0,r.useState)(!1),ea=(0,r.useRef)(null),es=(0,r.useRef)(null),en=(0,r.useRef)(null),ei=(0,r.useRef)(null),[eo,el]=(0,r.useState)(!1),ec=(0,r.useRef)(!1),ed=(0,v.useChatUtils)(),eu=(0,w.useChatMessaging)({chatId:O?.id||null,sender:"support",customerInfo:O?{name:O.customerName,phone:O.customerPhone,email:O.customerEmail}:void 0,onMessageSent:()=>{setTimeout(()=>{eh(!1)},2e3)}}),eh=(0,r.useCallback)(async(e=!0)=>{try{e&&z(!0),console.log("[AdminChat] Loading chats...");let t={"Content-Type":"application/json"};D?.id&&(t["x-user-id"]=D.id,console.log("[AdminChat] Adding x-user-id header:",D.id));let r=await fetch("/api/chat",{credentials:"include",headers:t});if(!r.ok){let e=await r.text();throw console.error("[AdminChat] Failed to load chats:",r.status,e),j.logger.error("Failed to load chats:",r.status,e),Error("خطا در بارگذاری چت‌ها")}let a=await r.json();if(console.log("[AdminChat] API Response:",{success:a.success,hasData:!!a.data,chatsCount:a.data?.chats?.length||0,chats:a.data?.chats?.slice(0,3)}),j.logger.info("Loaded chats:",a.success?a.data.chats?.length:0,"chats"),a.success&&a.data?.chats&&Array.isArray(a.data.chats)){console.log("[AdminChat] Processing",a.data.chats.length,"chats...");let e=await Promise.all(a.data.chats.map(async e=>{if(e.isRegisteredUser||e.isUserWithoutChat)return{...e,lastMessage:"هنوز پیامی ارسال نشده است",lastMessageTime:e.updatedAt||e.createdAt,unreadCount:void 0,isRegisteredUser:!0};try{let t=await fetch(`/api/chat?chatId=${e.id}`,{credentials:"include"});if(t.ok){let r=await t.json();if(r.success&&r.data.messages){let t=r.data.messages,a=t[t.length-1],s=e.unreadCount&&e.unreadCount>0?e.unreadCount:void 0;return{...e,lastMessage:a?.text||"",lastMessageTime:a?.createdAt||e.updatedAt,unreadCount:s}}}}catch(e){j.logger.error("Error loading last message:",e)}let t=e.unreadCount&&e.unreadCount>0?e.unreadCount:void 0;return{...e,unreadCount:t}}));console.log("[AdminChat] Setting chats:",e.length,"chats"),U(e)}else console.warn("[AdminChat] No chats in response or success=false:",a),U([])}catch(t){console.error("[AdminChat] Error loading chats:",t),j.logger.error("Error loading chats:",t),e&&A({title:"خطا",description:"خطا در بارگذاری چت‌ها",variant:"destructive"}),U([])}finally{e&&z(!1)}},[A]),em=(0,r.useCallback)(async(e,t=!1)=>{try{t&&B(!0);let r=`/api/chat?chatId=${e}`;!t&&en.current&&(r+=`&lastMessageId=${en.current}`);let a=await fetch(r);if(!a.ok)throw Error("خطا در بارگذاری پیام‌ها");let s=await a.json();if(s.success&&s.data.messages){let e=s.data.messages.map(e=>{let t=[];if(e.attachments){if(Array.isArray(e.attachments))t=e.attachments;else if("string"==typeof e.attachments)try{let r=JSON.parse(e.attachments);t=Array.isArray(r)?r:[r]}catch(e){j.logger.error("Error parsing attachments:",e)}}return{id:e.id,text:e.text||"",sender:e.sender,timestamp:new Date(e.createdAt),attachments:t,status:e.status||("user"===e.sender?"sent":void 0)}});if(O)try{let e=await fetch(`/api/chat/unread-count?chatId=${O.id}`);if(e.ok){let t=await e.json();if(t.success&&t.data){let e=t.data.unreadCount&&t.data.unreadCount>0?t.data.unreadCount:void 0;U(t=>t.map(t=>t.id===O.id?{...t,unreadCount:e}:t))}}}catch(e){}t?(H(e),e.length>0&&(en.current=e[e.length-1].id)):H(t=>{if(0===e.length&&t.length>0)return t;let r=new Set(e.map(e=>e.id)),a=new Set(t.map(e=>e.id)),s=e.filter(e=>!a.has(e.id)),n=t.filter(e=>e.id.startsWith("temp-")||r.has(e.id)),i=n.map(t=>{let r=e.find(e=>e.id===t.id);return r&&"user"===t.sender&&r.status&&t.status!==r.status?{...t,status:r.status}:t});return s.length>0?(en.current=s[s.length-1].id,[...i,...s]):n.length!==t.length||i.some((e,r)=>{let a=t.find(t=>t.id===e.id);return!a||a.status!==e.status})?i:t})}else s.success&&O?.isRegisteredUser&&H([])}catch(e){j.logger.error("Error loading messages:",e),t&&A({title:"خطا",description:"خطا در بارگذاری پیام‌ها",variant:"destructive"})}finally{t&&B(!1)}},[O,A]),ep=(0,r.useCallback)(async e=>{try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:e,sender:"support",action:"delivered"})})}catch(e){}},[]),eg=(0,r.useCallback)(async e=>{try{await fetch("/api/chat/status",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({chatId:e,sender:"support",action:"read"})})}catch(e){}},[]),ef=(0,r.useCallback)(async e=>{H([]),en.current=null,_(e),localStorage.setItem("admin_selected_chat_id",e.id),window.dispatchEvent(new CustomEvent("chatOpened",{detail:{chatId:e.id}})),(e.isRegisteredUser||e.isUserWithoutChat)&&e.userId?H([]):(eg(e.id).catch(()=>{}),ep(e.id),em(e.id,!0)),U(t=>t.map(t=>t.id===e.id?{...t,unreadCount:void 0}:t))},[em,eg,ep]),ex=(0,r.useCallback)(async()=>{if(O&&!O.isRegisteredUser&&!O.isUserWithoutChat)try{let e=await fetch(`/api/chat/typing?chatId=${O.id}&sender=user`,{credentials:"include"});if(e.ok){let t=await e.json();t.success&&V(t.data.isTyping||!1)}}catch(e){}},[O]),ev=(0,r.useCallback)(e=>{q(e),Q(null)},[]),ew=(0,r.useCallback)(e=>{Q(e),q(null),eu.handleMessageChange({target:{value:e.text||""}})},[eu]),ey=(0,r.useCallback)(async e=>{if(!O)return void console.error("[AdminChat] handleDelete: No selected chat");console.log("[AdminChat] Deleting message:",e);try{let t,r=await fetch(`/api/chat/message/${e}`,{method:"DELETE",credentials:"include",headers:{"Content-Type":"application/json"}});console.log("[AdminChat] Delete response status:",r.status);try{t=await r.json()}catch(a){let e=await r.text();console.error("[AdminChat] Failed to parse response:",e),t={}}if(console.log("[AdminChat] Delete response data:",t),r.ok)H(t=>t.filter(t=>t.id!==e)),eh(!1),O&&setTimeout(()=>{em(O.id,!1).catch(()=>{})},500),A({title:"موفق",description:t.message||"پیام با موفقیت حذف شد"});else{let e=t.error||t.message||`خطا در حذف پیام (${r.status})`;throw console.error("[AdminChat] Delete error:",e,t),j.logger.error("Error deleting message:",e,t),Error(e)}}catch(e){console.error("[AdminChat] Delete exception:",e),j.logger.error("Error deleting message:",e),A({title:"خطا",description:e instanceof Error?e.message:"خطا در حذف پیام",variant:"destructive"})}},[O,A,eh,em]),eb=(0,r.useCallback)(async()=>{if(O){er(!0);try{let e=await fetch("/api/chat/block",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatId:O.id,customerPhone:O.customerPhone})});if(e.ok)A({title:"موفق",description:"کاربر با موفقیت مسدود شد"}),ee(!1),U(e=>e.filter(e=>e.id!==O.id)),_(null),H([]);else{let t=await e.json().catch(()=>({}));throw Error(t.error||"خطا در مسدود کردن کاربر")}}catch(e){j.logger.error("Error blocking user:",e),A({title:"خطا",description:e instanceof Error?e.message:"خطا در مسدود کردن کاربر",variant:"destructive"})}finally{er(!1)}}},[O,A]),ej=(0,r.useCallback)(async()=>{if(!O)return;if(G){try{(await fetch(`/api/chat/message/${G.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:eu.message,attachments:ed.attachments})})).ok&&(H(e=>e.map(e=>e.id===G.id?{...e,text:eu.message,attachments:ed.attachments}:e)),Q(null),eu.handleMessageChange({target:{value:""}}),ed.setAttachments([]),A({title:"موفق",description:"پیام ویرایش شد"}))}catch(e){j.logger.error("Error editing message:",e),A({title:"خطا",description:"خطا در ویرایش پیام",variant:"destructive"})}return}if((O.isRegisteredUser||O.isUserWithoutChat)&&O.userId){try{let e=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({customerInfo:{name:O.customerName,phone:O.customerPhone,email:O.customerEmail},messages:[{text:eu.message,sender:"support",attachments:ed.attachments}]})});if(e.ok){let t=await e.json();if(t.success&&t.data.chat){let e=t.data.chat,r={...O,id:e.id,isRegisteredUser:!1,isUserWithoutChat:!1};if(_(r),t.success&&t.data.messages&&t.data.messages.length>0){let e=t.data.messages[0];H(t=>[...t,e])}eh(!1).catch(()=>{}),em(e.id,!1).catch(()=>{}),setTimeout(()=>{eS(!1)},100),ed.setAttachments([]),ed.setShowAttachmentOptions(!1),q(null),A({title:"موفق",description:"پیام ارسال شد"})}}}catch(e){j.logger.error("Error creating chat:",e),A({title:"خطا",description:"خطا در ارسال پیام",variant:"destructive"})}return}let e=await eu.handleSend(ed.attachments,K);e&&(H(t=>t.some(t=>t.id===e.id)?t:[...t,e]),ed.setAttachments([]),ed.setShowAttachmentOptions(!1),q(null),e.id&&!e.id.startsWith("temp-")&&(en.current=e.id),setTimeout(()=>{eh(!1)},500),setTimeout(()=>{eS(!1),setTimeout(()=>{eC()},500)},100))},[O,eu,ed,G,K,A,eh,em]),eC=(0,r.useCallback)(()=>{if(!es.current||!O)return void el(!1);let e=es.current;el(e.scrollHeight-e.scrollTop-e.clientHeight>150)},[O]),eS=(0,r.useCallback)((e=!1)=>{ea.current&&(ea.current.scrollIntoView({behavior:e?"auto":"smooth",block:"end"}),setTimeout(()=>{el(!1)},300))},[]);(0,r.useEffect)(()=>{let e=es.current;if(!e||!O)return void el(!1);let t=()=>{eC()};return e.addEventListener("scroll",t,{passive:!0}),eC(),()=>{e.removeEventListener("scroll",t)}},[O,eC,$.length]);let eN=(0,r.useRef)(!1);(0,r.useEffect)(()=>{if(O&&$.length>0&&!eN.current){eN.current=!0;let e=setTimeout(()=>{eS(!0),setTimeout(()=>{eC()},500)},200);return()=>clearTimeout(e)}O||(eN.current=!1)},[O,$.length,eS,eC]),(0,r.useEffect)(()=>{if(!O||!e||O.isRegisteredUser||O.isUserWithoutChat){V(!1),ei.current&&(clearInterval(ei.current),ei.current=null);return}ep(O.id),eg(O.id).catch(()=>{}),ex(),ei.current=setInterval(()=>{ex()},3e3);let t=setInterval(()=>{em(O.id,!1).catch(()=>{}),ep(O.id),eg(O.id).catch(()=>{})},5e3);return()=>{clearInterval(t),ei.current&&(clearInterval(ei.current),ei.current=null)}},[O,e,ex,em,ep,eg]),(0,r.useEffect)(()=>{if(e){console.log("[AdminChat] Dialog opened, loading chats..."),eh(!0),P||(_(null),H([])),localStorage.removeItem("admin_selected_chat_id"),window.dispatchEvent(new CustomEvent("chatClosed")),I(!0);let e=setInterval(()=>{console.log("[AdminChat] Refreshing chats..."),eh(!1)},15e3);return()=>{clearInterval(e)}}I(!1),localStorage.removeItem("admin_selected_chat_id"),window.dispatchEvent(new CustomEvent("chatClosed"))},[e,I,eh]),(0,r.useEffect)(()=>{if(P&&M.length>0&&!O){let e=M.find(e=>e.customerPhone===P);e&&(console.log("[AdminChat] Auto-selecting chat for phone:",P),_(e),em(e.id,!0))}},[P,M,O,em]);let eR=M.filter(e=>e.customerName.toLowerCase().includes(X.toLowerCase())||e.customerPhone.includes(X)||e.customerEmail?.toLowerCase().includes(X.toLowerCase()));return(0,t.jsxs)(S.Dialog,{open:e,onOpenChange:k,children:[(0,t.jsxs)(S.DialogContent,{className:"max-w-[95vw] w-full h-[90vh] p-0 flex flex-col gap-0 overflow-hidden",children:[(0,t.jsx)(N.Root,{children:(0,t.jsx)(S.DialogHeader,{children:(0,t.jsx)(S.DialogTitle,{children:"چت با کاربران"})})}),(0,t.jsxs)("div",{className:"flex h-full overflow-hidden",children:[(0,t.jsxs)("div",{className:"w-full md:w-1/3 lg:w-1/4 border-l border-border flex flex-col bg-background",children:[(0,t.jsx)("div",{className:"p-4 border-b border-border bg-muted/30",children:(0,t.jsxs)("div",{className:"flex items-center gap-2",children:[(0,t.jsxs)("div",{className:"relative flex-1",children:[(0,t.jsx)(i.Search,{className:"absolute right-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,t.jsx)(s.Input,{type:"search",placeholder:"جستجوی کاربر...",value:X,onChange:e=>Y(e.target.value),className:"pr-10"})]}),(0,t.jsx)(a.Button,{variant:"ghost",size:"icon",onClick:()=>k(!1),className:"h-10 w-10 flex-shrink-0",children:(0,t.jsx)(d.X,{className:"h-4 w-4"})})]})}),(0,t.jsx)(R.ScrollArea,{className:"flex-1",children:W?(0,t.jsx)("div",{className:"flex items-center justify-center h-full p-8",children:(0,t.jsx)(u.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):0===eR.length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center px-6 py-12",children:[(0,t.jsx)(n.MessageCircle,{className:"h-14 w-14 text-muted-foreground/50 mb-4"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"چتی یافت نشد"}),M.length>0&&(0,t.jsxs)("p",{className:"text-xs text-muted-foreground mt-2",children:["(تعداد کل: ",M.length," - فیلتر شده: ",eR.length,")"]})]}):(0,t.jsx)("div",{className:"divide-y divide-border",children:eR.map(e=>(0,t.jsx)("button",{onClick:()=>ef(e),className:`w-full p-4 text-right hover:bg-muted/50 transition-all ${O?.id===e.id?"bg-primary/10 border-r-4 border-primary":""} ${e.unreadCount&&e.unreadCount>0?"font-semibold":""}`,children:(0,t.jsxs)("div",{className:"flex items-start gap-3",children:[(0,t.jsx)("div",{className:"w-12 h-12 rounded-full bg-primary/10 flex items-center justify-center flex-shrink-0",children:(0,t.jsx)(o.User,{className:"h-6 w-6 text-primary"})}),(0,t.jsxs)("div",{className:"flex-1 min-w-0",children:[(0,t.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,t.jsx)("p",{className:"font-semibold text-sm truncate",children:e.customerName}),e.unreadCount&&e.unreadCount>0&&(0,t.jsx)(x.Badge,{variant:"destructive",className:"h-5 w-5 px-0 text-xs flex items-center justify-center",children:"!"})]}),(0,t.jsxs)("div",{className:"flex items-center gap-2 text-xs text-muted-foreground mb-1",children:[(0,t.jsx)(l.Phone,{className:"h-3 w-3"}),(0,t.jsx)("span",{children:e.customerPhone})]}),e.lastMessage&&(0,t.jsx)("p",{className:"text-xs text-muted-foreground truncate mt-1",children:e.lastMessage}),e.lastMessageTime&&(0,t.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:(0,E.format)(new Date(e.lastMessageTime),"HH:mm",{locale:T.faIR})})]})]})},e.id))})})]}),(0,t.jsx)("div",{className:"flex-1 flex flex-col bg-background",children:O?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsxs)("div",{className:"p-4 border-b border-border bg-muted/30 flex items-center justify-between",children:[(0,t.jsxs)("div",{className:"flex items-center gap-3",children:[(0,t.jsx)("div",{className:"w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center",children:(0,t.jsx)(o.User,{className:"h-5 w-5 text-primary"})}),(0,t.jsxs)("div",{children:[(0,t.jsx)("h3",{className:"font-semibold",children:O.customerName}),(0,t.jsxs)("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[(0,t.jsx)(l.Phone,{className:"h-3 w-3"}),(0,t.jsx)("span",{children:O.customerPhone}),O.customerEmail&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(c.Mail,{className:"h-3 w-3 mr-2"}),(0,t.jsx)("span",{children:O.customerEmail})]})]})]})]}),(0,t.jsxs)("div",{className:"flex items-center gap-4",children:[(0,t.jsxs)(a.Button,{variant:"outline",size:"sm",onClick:()=>ee(!0),className:"flex items-center gap-2 text-destructive hover:text-destructive",children:[(0,t.jsx)(h.Ban,{className:"h-4 w-4"}),(0,t.jsx)("span",{className:"hidden sm:inline",children:"مسدود کردن"})]}),(0,t.jsx)(a.Button,{variant:"ghost",size:"icon",onClick:()=>{_(null),H([]),en.current=null},className:"mr-4",children:(0,t.jsx)(d.X,{className:"h-4 w-4"})})]})]}),(0,t.jsxs)(R.ScrollArea,{ref:es,className:"flex-1 p-4",children:[F?(0,t.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,t.jsx)(u.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):0===$.length?(0,t.jsxs)("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[(0,t.jsx)(n.MessageCircle,{className:"h-14 w-14 text-muted-foreground/50 mb-4"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:O.isRegisteredUser||O.isUserWithoutChat?"هنوز پیامی ارسال نشده است. می‌توانید اولین پیام را ارسال کنید.":"هنوز پیامی ارسال نشده است"})]}):(0,t.jsxs)("div",{className:"space-y-3",children:[$.map((e,r)=>(0,t.jsx)(y.MessageBubble,{message:e,index:r,totalMessages:$.length,onReply:ev,onEdit:ew,onDelete:ey},e.id)),J&&(0,t.jsx)(m.motion.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:10},className:"flex justify-start items-end gap-2.5",children:(0,t.jsx)(f.TypingIndicator,{})})]}),(0,t.jsx)("div",{ref:ea})]}),(0,t.jsx)("div",{className:"p-4 border-t border-border bg-muted/30",children:(0,t.jsx)(b.ChatInput,{message:eu.message,onMessageChange:eu.handleMessageChange,onSend:ej,isSending:eu.isSending,attachments:ed.attachments,onRemoveAttachment:ed.handleRemoveAttachment,showAttachmentOptions:ed.showAttachmentOptions,onToggleAttachmentOptions:()=>ed.setShowAttachmentOptions(!ed.showAttachmentOptions),isRecording:ed.isRecording,recordingTime:ed.recordingTime,audioUrl:ed.audioUrl,onStartRecording:ed.startRecording,onStopRecording:ed.stopRecording,onCancelRecording:ed.cancelRecording,onSaveRecording:async()=>{if(!ec.current){ec.current=!0;try{let e=await ed.saveRecording();e&&ed.setAttachments(t=>t.some(t=>t.id===e.id)?t:[...t,e])}finally{ec.current=!1}}},formatTime:ed.formatTime,imageInputRef:ed.imageInputRef,fileInputRef:ed.fileInputRef,onFileSelect:ed.handleFileSelect,onLocationShare:ed.handleLocationShare,onCheckMicrophonePermission:ed.checkMicrophonePermission,toast:A})})]}):(0,t.jsx)("div",{className:"flex-1 flex items-center justify-center",children:(0,t.jsxs)("div",{className:"text-center",children:[(0,t.jsx)(n.MessageCircle,{className:"h-16 w-16 text-muted-foreground/50 mx-auto mb-4"}),(0,t.jsx)("p",{className:"text-muted-foreground",children:"یک مخاطب را انتخاب کنید"})]})})})]})]}),(0,t.jsx)(S.Dialog,{open:Z,onOpenChange:ee,children:(0,t.jsxs)(S.DialogContent,{children:[(0,t.jsxs)(S.DialogHeader,{children:[(0,t.jsx)(S.DialogTitle,{children:"مسدود کردن کاربر"}),(0,t.jsxs)(S.DialogDescription,{children:["آیا مطمئن هستید که می‌خواهید کاربر ",O?.customerName," (",O?.customerPhone,") را مسدود کنید؟",(0,t.jsx)("br",{}),(0,t.jsx)("span",{className:"text-destructive font-medium",children:"این عمل قابل بازگشت نیست."})]})]}),(0,t.jsxs)(S.DialogFooter,{children:[(0,t.jsx)(a.Button,{variant:"outline",onClick:()=>ee(!1),disabled:et,children:"انصراف"}),(0,t.jsx)(a.Button,{variant:"destructive",onClick:eb,disabled:et,children:et?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(u.Loader2,{className:"h-4 w-4 ml-2 animate-spin"}),"در حال مسدود کردن..."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(h.Ban,{className:"h-4 w-4 ml-2"}),"مسدود کردن"]})})]})]})})]})}e.s(["AdminChat",()=>k])}]);