#!/bin/bash

# ğŸš€ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø³Ø±ÛŒØ¹ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ù¾Ø±ÙˆÚ˜Ù‡ Ø¯Ø± Ù‡Ø§Ø³Øª
# Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø± ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ù‡Ø§Ø³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯

set -e  # ØªÙˆÙ‚Ù Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§

echo "ğŸš€ Ø´Ø±ÙˆØ¹ Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ù¾Ø±ÙˆÚ˜Ù‡..."
echo ""

# Ø±Ù†Ú¯â€ŒÙ‡Ø§
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 1: Clone Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÚ˜Ù‡
# ============================================

echo -e "${YELLOW}ğŸ“¥ Ù…Ø±Ø­Ù„Ù‡ 1: Clone Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÚ˜Ù‡...${NC}"

if [ -d "~/public_html/saded" ]; then
    echo "ğŸ“‚ Ù¾Ø±ÙˆÚ˜Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ..."
    cd ~/public_html/saded
    git fetch origin
    git reset --hard origin/main
else
    echo "ğŸ“¥ Clone Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÚ˜Ù‡..."
    cd ~/public_html
    git clone https://github.com/mohamadjavad200024/saded.git
    cd saded
fi

echo -e "${GREEN}âœ… Ù¾Ø±ÙˆÚ˜Ù‡ clone Ø´Ø¯${NC}"
echo ""

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 2: Ù†ØµØ¨ Dependencies
# ============================================

echo -e "${YELLOW}ğŸ“¦ Ù…Ø±Ø­Ù„Ù‡ 2: Ù†ØµØ¨ Dependencies...${NC}"

# Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† npm
NPM_PATH=$(which npm)
if [ -z "$NPM_PATH" ]; then
    echo -e "${RED}âŒ npm Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯!${NC}"
    echo "Ù„Ø·ÙØ§Ù‹ npm Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² nodevenv Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯"
    exit 1
fi

echo "Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² npm: $NPM_PATH"
$NPM_PATH install

echo -e "${GREEN}âœ… Dependencies Ù†ØµØ¨ Ø´Ø¯Ù†Ø¯${NC}"
echo ""

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 3: Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ .env
# ============================================

echo -e "${YELLOW}âš™ï¸  Ù…Ø±Ø­Ù„Ù‡ 3: Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ .env...${NC}"

if [ ! -f ".env" ]; then
    echo -e "${YELLOW}âš ï¸  ÙØ§ÛŒÙ„ .env ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯${NC}"
    echo "Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ .env..."
    
    cat > .env << 'EOF'
# Database Configuration (MySQL)
DB_HOST=localhost
DB_PORT=3306
DB_NAME=shop1111_saded02
DB_USER=shop1111_saded002
DB_PASSWORD=

# Application
NODE_ENV=production
NEXT_PUBLIC_URL=https://yourdomain.com
EOF
    
    echo -e "${YELLOW}âš ï¸  Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ .env Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯:${NC}"
    echo "   nano .env"
    echo ""
    read -p "Ø¢ÛŒØ§ ÙØ§ÛŒÙ„ .env Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯ØŸ (y/n) " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Ù„Ø·ÙØ§Ù‹ ÙØ§ÛŒÙ„ .env Ø±Ø§ ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯ Ùˆ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯"
        exit 1
    fi
else
    echo -e "${GREEN}âœ… ÙØ§ÛŒÙ„ .env Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª${NC}"
fi

echo ""

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 4: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
# ============================================

echo -e "${YELLOW}ğŸ—„ï¸  Ù…Ø±Ø­Ù„Ù‡ 4: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³...${NC}"

read -p "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±Ø§ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯ØŸ (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    $NPM_PATH run setup-mysql
    echo -e "${GREEN}âœ… Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯${NC}"
else
    echo -e "${YELLOW}â­ï¸  Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±Ø¯ Ø´Ø¯${NC}"
fi

echo ""

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 5: Build Ù¾Ø±ÙˆÚ˜Ù‡
# ============================================

echo -e "${YELLOW}ğŸ”¨ Ù…Ø±Ø­Ù„Ù‡ 5: Build Ù¾Ø±ÙˆÚ˜Ù‡...${NC}"

read -p "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ build Ú©Ù†ÛŒØ¯ØŸ (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    $NPM_PATH run build
    echo -e "${GREEN}âœ… Ù¾Ø±ÙˆÚ˜Ù‡ build Ø´Ø¯${NC}"
else
    echo -e "${YELLOW}â­ï¸  Build Ø±Ø¯ Ø´Ø¯${NC}"
fi

echo ""

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 6: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§ PM2
# ============================================

echo -e "${YELLOW}ğŸš€ Ù…Ø±Ø­Ù„Ù‡ 6: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§ PM2...${NC}"

# Ø¨Ø±Ø±Ø³ÛŒ Ù†ØµØ¨ PM2
if ! command -v pm2 &> /dev/null; then
    echo "ğŸ“¦ Ù†ØµØ¨ PM2..."
    $NPM_PATH install -g pm2
fi

read -p "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø§ PM2 Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯ØŸ (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    # ØªÙˆÙ‚Ù Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„ÛŒ (Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
    pm2 delete saded 2>/dev/null || true
    
    # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
    pm2 start ecosystem.config.js
    pm2 save
    
    echo -e "${GREEN}âœ… Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ PM2 Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯${NC}"
    echo ""
    echo "ğŸ“Š Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆØ¶Ø¹ÛŒØª: pm2 status"
    echo "ğŸ“ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§: pm2 logs saded"
    echo "ğŸ”„ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯: pm2 restart saded"
else
    echo -e "${YELLOW}â­ï¸  Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ PM2 Ø±Ø¯ Ø´Ø¯${NC}"
fi

echo ""

# ============================================
# Ø®Ù„Ø§ØµÙ‡
# ============================================

echo -e "${GREEN}âœ… Ø§Ø³ØªÙ‚Ø±Ø§Ø± Ú©Ø§Ù…Ù„ Ø´Ø¯!${NC}"
echo ""
echo "ğŸ“‹ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙÛŒØ¯:"
echo "   pm2 status          - Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆØ¶Ø¹ÛŒØª"
echo "   pm2 logs saded      - Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§"
echo "   pm2 restart saded   - Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯"
echo "   pm2 stop saded      - ØªÙˆÙ‚Ù"
echo ""

