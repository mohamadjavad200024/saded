#!/bin/bash

# ğŸš€ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¯Ø±ÛŒØ§ÙØª Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¯Ø± Ù‡Ø§Ø³Øª
# Ø§ÛŒÙ† ÙØ§ÛŒÙ„ Ø±Ø§ Ø¯Ø± ØªØ±Ù…ÛŒÙ†Ø§Ù„ Ù‡Ø§Ø³Øª Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯

echo "ğŸš€ Ø´Ø±ÙˆØ¹ Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÚ˜Ù‡..."

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 1: Ø¯Ø±ÛŒØ§ÙØª Ù¾Ø±ÙˆÚ˜Ù‡
# ============================================

# Ø§Ú¯Ø± Ù¾Ø±ÙˆÚ˜Ù‡ Ù‚Ø¨Ù„Ø§Ù‹ clone Ø´Ø¯Ù‡ Ø§Ø³Øª
if [ -d "saded" ]; then
    echo "ğŸ“‚ Ù¾Ø±ÙˆÚ˜Ù‡ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª. Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ..."
    cd saded
    git fetch origin
    git reset --hard origin/main
    echo "âœ… Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯"
else
    echo "ğŸ“¥ Clone Ú©Ø±Ø¯Ù† Ù¾Ø±ÙˆÚ˜Ù‡..."
    git clone https://github.com/mohamadjavad200024/saded.git
    cd saded
    echo "âœ… Ù¾Ø±ÙˆÚ˜Ù‡ clone Ø´Ø¯"
fi

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 2: Ù†ØµØ¨ Dependencies
# ============================================

echo "ğŸ“¦ Ù†ØµØ¨ dependencies..."
npm install

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 3: Ø¨Ø±Ø±Ø³ÛŒ ÙØ§ÛŒÙ„ .env
# ============================================

if [ ! -f ".env" ]; then
    echo "âš ï¸  ÙØ§ÛŒÙ„ .env ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯. Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ù†Ù…ÙˆÙ†Ù‡..."
    cat > .env << EOF
# Database Configuration (MySQL)
DB_HOST=localhost
DB_PORT=3306
DB_NAME=shop1111_saded02
DB_USER=shop1111_saded002
DB_PASSWORD=your_password_here

# Application
NODE_ENV=production
NEXT_PUBLIC_URL=https://yourdomain.com
EOF
    echo "âœ… ÙØ§ÛŒÙ„ .env Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯. Ù„Ø·ÙØ§Ù‹ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯:"
    echo "   nano .env"
    echo ""
    echo "âš ï¸  Ù¾Ø³ Ø§Ø² ØªÙ†Ø¸ÛŒÙ… .envØŒ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ±Ø§Øª Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯:"
    echo "   npm run setup-mysql"
    echo "   npm run build"
    echo "   pm2 start ecosystem.config.js"
else
    echo "âœ… ÙØ§ÛŒÙ„ .env Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª"
fi

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 4: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³
# ============================================

echo "ğŸ—„ï¸  Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¯ÛŒØªØ§Ø¨ÛŒØ³..."
read -p "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø±Ø§ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯ØŸ (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    npm run setup-mysql
fi

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 5: Build
# ============================================

echo "ğŸ”¨ Build Ù¾Ø±ÙˆÚ˜Ù‡..."
read -p "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ build Ú©Ù†ÛŒØ¯ØŸ (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    npm run build
fi

# ============================================
# Ù…Ø±Ø­Ù„Ù‡ 6: Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§ PM2
# ============================================

echo "ğŸš€ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø¨Ø§ PM2..."
read -p "Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø§ PM2 Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ù†ÛŒØ¯ØŸ (y/n) " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    # Ø¨Ø±Ø±Ø³ÛŒ Ù†ØµØ¨ PM2
    if ! command -v pm2 &> /dev/null; then
        echo "ğŸ“¦ Ù†ØµØ¨ PM2..."
        npm install -g pm2
    fi
    
    # Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ
    pm2 start ecosystem.config.js
    pm2 save
    pm2 startup
    
    echo "âœ… Ù¾Ø±ÙˆÚ˜Ù‡ Ø¨Ø§ PM2 Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯"
    echo "ğŸ“Š Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆØ¶Ø¹ÛŒØª: pm2 status"
    echo "ğŸ“ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§: pm2 logs saded"
fi

echo ""
echo "âœ… ØªÙ…Ø§Ù…! Ù¾Ø±ÙˆÚ˜Ù‡ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª."
echo ""
echo "ğŸ“‹ Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙÛŒØ¯:"
echo "   pm2 status          - Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆØ¶Ø¹ÛŒØª"
echo "   pm2 logs saded      - Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ø§Ú¯â€ŒÙ‡Ø§"
echo "   pm2 restart saded   - Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù…Ø¬Ø¯Ø¯"
echo "   pm2 stop saded      - ØªÙˆÙ‚Ù"
echo ""

